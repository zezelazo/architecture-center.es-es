---
title: Patrón de particionamiento
titleSuffix: Cloud Design Patterns
description: Divida un almacén de datos en un conjunto de particiones horizontales o particiones de base de datos.
keywords: Patrón de diseño
author: dragon119
ms.date: 06/23/2017
ms.custom: seodec18
ms.openlocfilehash: 52c0579e4b08aa18456e0cc5a26742aab39a1a7e
ms.sourcegitcommit: 680c9cef945dff6fee5e66b38e24f07804510fa9
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 01/04/2019
ms.locfileid: "54010331"
---
# <a name="sharding-pattern"></a><span data-ttu-id="fc3f2-104">Patrón de particionamiento</span><span class="sxs-lookup"><span data-stu-id="fc3f2-104">Sharding pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="fc3f2-105">Divida un almacén de datos en un conjunto de particiones horizontales o particiones de base de datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-105">Divide a data store into a set of horizontal partitions or shards.</span></span> <span data-ttu-id="fc3f2-106">Esta acción puede mejorar la escalabilidad durante el almacenamiento de grandes volúmenes de datos y el acceso a estos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-106">This can improve scalability when storing and accessing large volumes of data.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="fc3f2-107">Contexto y problema</span><span class="sxs-lookup"><span data-stu-id="fc3f2-107">Context and problem</span></span>

<span data-ttu-id="fc3f2-108">Un almacén de datos hospedado por un único servidor puede estar sujeto a las siguientes limitaciones:</span><span class="sxs-lookup"><span data-stu-id="fc3f2-108">A data store hosted by a single server might be subject to the following limitations:</span></span>

- <span data-ttu-id="fc3f2-109">**Espacio de almacenamiento**.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-109">**Storage space**.</span></span> <span data-ttu-id="fc3f2-110">Se espera que un almacén de datos para una aplicación a gran escala en la nube contenga un gran volumen de datos que puede aumentar considerablemente con el tiempo.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-110">A data store for a large-scale cloud application is expected to contain a huge volume of data that could increase significantly over time.</span></span> <span data-ttu-id="fc3f2-111">Normalmente, un servidor proporciona una cantidad finita de almacenamiento en disco, pero puede reemplazar los discos existentes por otros más grandes, o agregar más discos a una máquina a medida que los volúmenes de datos crezcan.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-111">A server typically provides only a finite amount of disk storage, but you can replace existing disks with larger ones, or add further disks to a machine as data volumes grow.</span></span> <span data-ttu-id="fc3f2-112">Sin embargo, es posible que el sistema alcance un límite a partir del cual no sea posible aumentar fácilmente la capacidad de almacenamiento en un determinado servidor.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-112">However, the system will eventually reach a limit where it isn't possible to easily increase the storage capacity on a given server.</span></span>

- <span data-ttu-id="fc3f2-113">**Recursos de computación**.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-113">**Computing resources**.</span></span> <span data-ttu-id="fc3f2-114">Una aplicación en la nube es necesaria para dar soporte a un gran número de usuarios simultáneos, cada uno de los cuales ejecuta consultas que recuperan información del almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-114">A cloud application is required to support a large number of concurrent users, each of which run queries that retrieve information from the data store.</span></span> <span data-ttu-id="fc3f2-115">Un solo servidor que hospede el almacén de datos podría no ser capaz de proporcionar la capacidad de computación necesaria para admitir esta carga, lo que generaría tiempos de respuesta prolongados para usuarios y errores frecuentes, como que se agote el tiempo de espera de aplicaciones que intentan almacenar y recuperar datos. Es posible agregar memoria o actualizar los procesadores, pero el sistema alcanzará un límite que no permitirá aumentar más los recursos de procesos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-115">A single server hosting the data store might not be able to provide the necessary computing power to support this load, resulting in extended response times for users and frequent failures as applications attempting to store and retrieve data time out. It might be possible to add memory or upgrade processors, but the system will reach a limit when it isn't possible to increase the compute resources any further.</span></span>

- <span data-ttu-id="fc3f2-116">**Ancho de banda de red**.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-116">**Network bandwidth**.</span></span> <span data-ttu-id="fc3f2-117">En última instancia, el rendimiento de un almacén de datos que se ejecuta en un solo servidor se rige por la velocidad a la que el servidor puede recibir solicitudes y enviar respuestas.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-117">Ultimately, the performance of a data store running on a single server is governed by the rate the server can receive requests and send replies.</span></span> <span data-ttu-id="fc3f2-118">Es posible que el volumen del tráfico de red supere la capacidad de la red que se usa para establecer conexión con el servidor y dé lugar a solicitudes incorrectas.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-118">It's possible that the volume of network traffic might exceed the capacity of the network used to connect to the server, resulting in failed requests.</span></span>

- <span data-ttu-id="fc3f2-119">**Geografía**.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-119">**Geography**.</span></span> <span data-ttu-id="fc3f2-120">Puede que sea necesario almacenar los datos generados por determinados usuarios en la misma región que esos usuarios por motivos legales, de rendimiento o de cumplimiento, o bien para reducir la latencia del acceso a los datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-120">It might be necessary to store data generated by specific users in the same region as those users for legal, compliance, or performance reasons, or to reduce latency of data access.</span></span> <span data-ttu-id="fc3f2-121">Si los usuarios están dispersos en diferentes países o regiones, puede que no sea posible almacenar todos los datos de la aplicación en un único almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-121">If the users are dispersed across different countries or regions, it might not be possible to store the entire data for the application in a single data store.</span></span>

<span data-ttu-id="fc3f2-122">El escalado vertical mediante la adición de más capacidad de disco, capacidad de procesamiento, memoria y conexiones de red puede posponer los efectos de algunas de estas limitaciones, pero es probable que solo sea una solución temporal.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-122">Scaling vertically by adding more disk capacity, processing power, memory, and network connections can postpone the effects of some of these limitations, but it's likely to only be a temporary solution.</span></span> <span data-ttu-id="fc3f2-123">Una aplicación en la nube comercial que sea capaz de admitir un gran número de usuarios y grandes volúmenes de datos debería poder escalarse casi indefinidamente, por lo que el escalado vertical no es necesariamente la mejor solución.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-123">A commercial cloud application capable of supporting large numbers of users and high volumes of data must be able to scale almost indefinitely, so vertical scaling isn't necessarily the best solution.</span></span>

## <a name="solution"></a><span data-ttu-id="fc3f2-124">Solución</span><span class="sxs-lookup"><span data-stu-id="fc3f2-124">Solution</span></span>

<span data-ttu-id="fc3f2-125">Dividir el almacén de datos en particiones horizontales o particiones de base de datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-125">Divide the data store into horizontal partitions or shards.</span></span> <span data-ttu-id="fc3f2-126">Cada partición tiene el mismo esquema, pero contiene su propio subconjunto distinto de datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-126">Each shard has the same schema, but holds its own distinct subset of the data.</span></span> <span data-ttu-id="fc3f2-127">Una partición es un almacén de datos en sí misma (puede incluir datos de varias entidades de tipos diferentes), que se ejecuta en un servidor que actúa como nodo de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-127">A shard is a data store in its own right (it can contain the data for many entities of different types), running on a server acting as a storage node.</span></span>

<span data-ttu-id="fc3f2-128">Este modelo proporciona las siguientes ventajas:</span><span class="sxs-lookup"><span data-stu-id="fc3f2-128">This pattern has the following benefits:</span></span>

- <span data-ttu-id="fc3f2-129">Puede escalar el sistema horizontalmente mediante la adición de más particiones que se ejecuten en nodos de almacenamiento adicionales.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-129">You can scale the system out by adding further shards running on additional storage nodes.</span></span>

- <span data-ttu-id="fc3f2-130">Un sistema puede utilizar hardware estándar en lugar de equipos especializados y costosos para cada nodo de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-130">A system can use off-the-shelf hardware rather than specialized and expensive computers for each storage node.</span></span>

- <span data-ttu-id="fc3f2-131">Puede reducir la contención y mejorar el rendimiento si equilibra la carga de trabajo entre las particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-131">You can reduce contention and improve performance by balancing the workload across shards.</span></span>

- <span data-ttu-id="fc3f2-132">En la nube, las particiones pueden encontrarse físicamente cerca de los usuarios que accederán a los datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-132">In the cloud, shards can be located physically close to the users that'll access the data.</span></span>

<span data-ttu-id="fc3f2-133">Al dividir un almacén de datos en particiones, deberá decidir qué datos se colocarán en cada partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-133">When dividing a data store up into shards, decide which data should be placed in each shard.</span></span> <span data-ttu-id="fc3f2-134">Normalmente, una partición contiene elementos que se encuentran dentro de un determinado rango, determinado por uno o más atributos de los datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-134">A shard typically contains items that fall within a specified range determined by one or more attributes of the data.</span></span> <span data-ttu-id="fc3f2-135">Estos atributos constituyen la clave de partición,</span><span class="sxs-lookup"><span data-stu-id="fc3f2-135">These attributes form the shard key (sometimes referred to as the partition key).</span></span> <span data-ttu-id="fc3f2-136">que debe ser estática y</span><span class="sxs-lookup"><span data-stu-id="fc3f2-136">The shard key should be static.</span></span> <span data-ttu-id="fc3f2-137">no debe basarse en datos que puedan cambiar.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-137">It shouldn't be based on data that might change.</span></span>

<span data-ttu-id="fc3f2-138">El particionamiento organiza físicamente los datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-138">Sharding physically organizes the data.</span></span> <span data-ttu-id="fc3f2-139">Cuando una aplicación almacena y recupera los datos, la lógica de particionamiento dirige la aplicación a la partición apropiada.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-139">When an application stores and retrieves data, the sharding logic directs the application to the appropriate shard.</span></span> <span data-ttu-id="fc3f2-140">Esta lógica de particionamiento se puede implementar como parte del código de acceso a datos de la aplicación, o podría implementarla el sistema de almacenamiento de datos si admite el particionamiento de forma transparente.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-140">This sharding logic can be implemented as part of the data access code in the application, or it could be implemented by the data storage system if it transparently supports sharding.</span></span>

<span data-ttu-id="fc3f2-141">La abstracción de la ubicación física de los datos en la lógica de particionamiento proporciona un alto nivel de control sobre qué particiones contienen determinados datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-141">Abstracting the physical location of the data in the sharding logic provides a high level of control over which shards contain which data.</span></span> <span data-ttu-id="fc3f2-142">También permite que los datos se migren entre las particiones sin tener que rediseñar la lógica de negocios de una aplicación si los datos de las particiones se deben redistribuir más adelante (por ejemplo, si las particiones se desequilibran).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-142">It also enables data to migrate between shards without reworking the business logic of an application if the data in the shards need to be redistributed later (for example, if the shards become unbalanced).</span></span> <span data-ttu-id="fc3f2-143">La contrapartida es la sobrecarga adicional de acceso a los datos que se necesita para determinar la ubicación de cada elemento de datos a medida que se recupera.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-143">The tradeoff is the additional data access overhead required in determining the location of each data item as it's retrieved.</span></span>

<span data-ttu-id="fc3f2-144">Para asegurar una escalabilidad y un rendimiento óptimos, es importante dividir los datos de una forma adecuada para los tipos de consultas que realiza la aplicación.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-144">To ensure optimal performance and scalability, it's important to split the data in a way that's appropriate for the types of queries that the application performs.</span></span> <span data-ttu-id="fc3f2-145">En muchos casos, es improbable que el esquema de particionamiento coincida exactamente con los requisitos de cada consulta.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-145">In many cases, it's unlikely that the sharding scheme will exactly match the requirements of every query.</span></span> <span data-ttu-id="fc3f2-146">Por ejemplo, en un sistema multiinquilino, una aplicación podría necesitar recuperar datos del inquilino mediante su identificador, pero también puede que se necesiten buscar estos datos en función de algún otro atributo, como el nombre o la ubicación del inquilino.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-146">For example, in a multi-tenant system an application might need to retrieve tenant data using the tenant ID, but it might also need to look up this data based on some other attribute such as the tenant’s name or location.</span></span> <span data-ttu-id="fc3f2-147">Para tratar estas situaciones, implemente una estrategia de particionamiento con una clave de partición que admita las consultas que se realizan más frecuentemente.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-147">To handle these situations, implement a sharding strategy with a shard key that supports the most commonly performed queries.</span></span>

<span data-ttu-id="fc3f2-148">Si las consultas recuperan datos regularmente mediante una combinación de valores de atributo, es probable que pueda definir una clave de partición compuesta mediante la vinculación de atributos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-148">If queries regularly retrieve data using a combination of attribute values, you can likely define a composite shard key by linking attributes together.</span></span> <span data-ttu-id="fc3f2-149">Como alternativa, use un patrón como el [Patrón Index Table](./index-table.md) para proporcionar una búsqueda rápida de datos basada en los atributos que no cubre la clave de partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-149">Alternatively, use a pattern such as [Index Table](./index-table.md) to provide fast lookup to data based on attributes that aren't covered by the shard key.</span></span>

## <a name="sharding-strategies"></a><span data-ttu-id="fc3f2-150">Estrategias de particionamiento</span><span class="sxs-lookup"><span data-stu-id="fc3f2-150">Sharding strategies</span></span>

<span data-ttu-id="fc3f2-151">Se suelen usar tres estrategias a la hora de seleccionar la clave de partición y decidir cómo distribuir los datos entre particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-151">Three strategies are commonly used when selecting the shard key and deciding how to distribute data across shards.</span></span> <span data-ttu-id="fc3f2-152">Tenga en cuenta que no tiene que haber una correspondencia exacta entre las particiones y los servidores que las alojan (un único servidor puede alojar varias particiones).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-152">Note that there doesn't have to be a one-to-one correspondence between shards and the servers that host them&mdash;a single server can host multiple shards.</span></span> <span data-ttu-id="fc3f2-153">Las estrategias son:</span><span class="sxs-lookup"><span data-stu-id="fc3f2-153">The strategies are:</span></span>

<span data-ttu-id="fc3f2-154">**Estrategia de búsqueda**.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-154">**The Lookup strategy**.</span></span> <span data-ttu-id="fc3f2-155">En esta estrategia, la lógica de particionamiento implementa un mapa que enruta una solicitud de datos a la partición que contiene los datos mediante la clave de partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-155">In this strategy the sharding logic implements a map that routes a request for data to the shard that contains that data using the shard key.</span></span> <span data-ttu-id="fc3f2-156">En una aplicación multiinquilino, todos los datos de un inquilino podrían almacenarse de forma conjunta en una partición con el identificador de inquilino como clave de partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-156">In a multi-tenant application all the data for a tenant might be stored together in a shard using the tenant ID as the shard key.</span></span> <span data-ttu-id="fc3f2-157">Varios inquilinos pueden compartir la misma partición, pero los datos de un único inquilino no se distribuirán entre varias particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-157">Multiple tenants might share the same shard, but the data for a single tenant won't be spread across multiple shards.</span></span> <span data-ttu-id="fc3f2-158">En la ilustración se muestran los datos de inquilinos de particionamiento según los identificadores de inquilino.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-158">The figure illustrates sharding tenant data based on tenant IDs.</span></span>

   ![Ilustración 1: Datos de inquilinos de particionamiento basados en identificadores de inquilino](./_images/sharding-tenant.png)

<span data-ttu-id="fc3f2-160">La asignación entre la clave de partición y el almacenamiento físico puede basarse en particiones físicas donde cada clave de partición se asigna a una partición física.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-160">The mapping between the shard key and the physical storage can be based on physical shards where each shard key maps to a physical partition.</span></span> <span data-ttu-id="fc3f2-161">O bien, una técnica más flexible para reequilibrar particiones es el particionamiento virtual, donde las claves de partición se asignan al mismo número de particiones virtuales, que a su vez se asignan a menos particiones físicas.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-161">Alternatively, a more flexible technique for rebalancing shards is virtual partitioning, where shard keys map to the same number of virtual shards, which in turn map to fewer physical partitions.</span></span> <span data-ttu-id="fc3f2-162">En este enfoque, una aplicación busca datos con una clave de partición que hace referencia a una partición virtual, y el sistema asigna de forma transparente particiones virtuales a particiones físicas.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-162">In this approach, an application locates data using a shard key that refers to a virtual shard, and the system transparently maps virtual shards to physical partitions.</span></span> <span data-ttu-id="fc3f2-163">La asignación entre una partición virtual y una partición física puede cambiar sin necesidad de modificar el código de la aplicación para usar un conjunto diferente de claves de partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-163">The mapping between a virtual shard and a physical partition can change without requiring the application code be modified to use a different set of shard keys.</span></span>

<span data-ttu-id="fc3f2-164">**Estrategia de rango**.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-164">**The Range strategy**.</span></span> <span data-ttu-id="fc3f2-165">Esta estrategia agrupa los elementos relacionados en la misma partición y los ordena por clave de partición (las claves de partición son secuenciales).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-165">This strategy groups related items together in the same shard, and orders them by shard key&mdash;the shard keys are sequential.</span></span> <span data-ttu-id="fc3f2-166">Esto es útil para aplicaciones que suelen recuperar conjuntos de elementos mediante consultas por rango (consultas que devuelven un conjunto de elementos de datos de una clave de partición que se encuentra dentro de un rango determinado).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-166">It's useful for applications that frequently retrieve sets of items using range queries (queries that return a set of data items for a shard key that falls within a given range).</span></span> <span data-ttu-id="fc3f2-167">Por ejemplo, si una aplicación suele necesitar buscar todos los pedidos realizados en un determinado mes, estos datos puede recuperarse más rápidamente si todos los pedidos de un mes se almacenan por orden de fecha y hora en la misma partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-167">For example, if an application regularly needs to find all orders placed in a given month, this data can be retrieved more quickly if all orders for a month are stored in date and time order in the same shard.</span></span> <span data-ttu-id="fc3f2-168">Si cada uno de los pedido se almacena en una partición diferente, tendrán que recuperarse individualmente mediante la realización de un gran número de consultas de punto (consultas que devuelven un único elemento de datos).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-168">If each order was stored in a different shard, they'd have to be fetched individually by performing a large number of point queries (queries that return a single data item).</span></span> <span data-ttu-id="fc3f2-169">En la siguiente ilustración se muestra cómo se almacenan conjuntos secuenciales (rangos) de datos en particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-169">The next figure illustrates storing sequential sets (ranges) of data in shard.</span></span>

   ![Ilustración 2: Almacenamiento de conjuntos secuenciales (rangos) de datos en particiones](./_images/sharding-sequential-sets.png)

<span data-ttu-id="fc3f2-171">En este ejemplo, la clave de partición es una clave compuesta que contiene el mes del pedido como el elemento más significativo, seguido por el día y la hora del pedido.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-171">In this example, the shard key is a composite key containing the order month as the most significant element, followed by the order day and the time.</span></span> <span data-ttu-id="fc3f2-172">Naturalmente, los datos de los pedidos se ordenan cuando se crean nuevos pedidos y se agregan a una partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-172">The data for orders is naturally sorted when new orders are created and added to a shard.</span></span> <span data-ttu-id="fc3f2-173">Algunos almacenes de datos admiten claves de partición con dos partes: un elemento de clave de partición que identifica la partición y una clave de fila que identifica de forma única un elemento de la partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-173">Some data stores support two-part shard keys containing a partition key element that identifies the shard and a row key that uniquely identifies an item in the shard.</span></span> <span data-ttu-id="fc3f2-174">Los datos suelen ordenarse por la clave de fila en la partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-174">Data is usually held in row key order in the shard.</span></span> <span data-ttu-id="fc3f2-175">Los elementos que están sujetos a las consultas por rango y necesitan agruparse pueden usar una clave de partición con el mismo valor para la clave de partición, pero un valor único para la clave de fila.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-175">Items that are subject to range queries and need to be grouped together can use a shard key that has the same value for the partition key but a unique value for the row key.</span></span>

<span data-ttu-id="fc3f2-176">**Estrategia de hash**.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-176">**The Hash strategy**.</span></span> <span data-ttu-id="fc3f2-177">El propósito de esta estrategia es reducir la posibilidad de zonas activas (particiones que reciben una cantidad desproporcionada de carga).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-177">The purpose of this strategy is to reduce the chance of hotspots (shards that receive a disproportionate amount of load).</span></span> <span data-ttu-id="fc3f2-178">Distribuye los datos entre las particiones de forma que se consigue un equilibrio entre el tamaño de cada partición y la carga media que tendrá cada partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-178">It distributes the data across the shards in a way that achieves a balance between the size of each shard and the average load that each shard will encounter.</span></span> <span data-ttu-id="fc3f2-179">La lógica de particionamiento calcula la partición para almacenar un elemento en función de un hash de uno o más atributos de los datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-179">The sharding logic computes the shard to store an item in based on a hash of one or more attributes of the data.</span></span> <span data-ttu-id="fc3f2-180">La función de hash elegida debe distribuir los datos uniformemente entre las particiones, posiblemente mediante la introducción de algún elemento aleatorio en el cálculo.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-180">The chosen hashing function should distribute data evenly across the shards, possibly by introducing some random element into the computation.</span></span> <span data-ttu-id="fc3f2-181">En la ilustración siguiente se muestran los datos del inquilino de particionamiento basados en un hash de identificadores de inquilino.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-181">The next figure illustrates sharding tenant data based on a hash of tenant IDs.</span></span>

   ![Ilustración 3: Datos del inquilino de particionamiento basados en un hash de identificadores de inquilino](./_images/sharding-data-hash.png)

<span data-ttu-id="fc3f2-183">Para entender la ventaja de la estrategia de hash con respecto a otras estrategias de particionamiento, considere cómo una aplicación multiinquilino que inscribe nuevos inquilinos secuencialmente podría asignar los inquilinos a las particiones en el almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-183">To understand the advantage of the Hash strategy over other sharding strategies, consider how a multi-tenant application that enrolls new tenants sequentially might assign the tenants to shards in the data store.</span></span> <span data-ttu-id="fc3f2-184">A la hora de usar la estrategia de rango, los datos de los inquilinos de 1 a n se almacenarán en la partición A, los datos de los inquilinos de n+1 a m se almacenarán en la partición B, y así sucesivamente.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-184">When using the Range strategy, the data for tenants 1 to n will all be stored in shard A, the data for tenants n+1 to m will all be stored in shard B, and so on.</span></span> <span data-ttu-id="fc3f2-185">Si los inquilinos registrados más recientemente también son los más activos, la mayoría de la actividad de los datos se producirá en un pequeño número de particiones, lo que podría provocar zonas activas.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-185">If the most recently registered tenants are also the most active, most data activity will occur in a small number of shards, which could cause hotspots.</span></span> <span data-ttu-id="fc3f2-186">En cambio, la estrategia de hash asigna los inquilinos a particiones basándose en un hash de su identificador de inquilino.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-186">In contrast, the Hash strategy allocates tenants to shards based on a hash of their tenant ID.</span></span> <span data-ttu-id="fc3f2-187">Esto significa que es más probable que los inquilinos secuenciales se asignen a particiones diferentes, lo que permitirá distribuir la carga entre ellos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-187">This means that sequential tenants are most likely to be allocated to different shards, which will distribute the load across them.</span></span> <span data-ttu-id="fc3f2-188">En la ilustración anterior se muestra cómo hacerlo para los inquilinos 55 y 56.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-188">The previous figure shows this for tenants 55 and 56.</span></span>

<span data-ttu-id="fc3f2-189">Las tres estrategias de particionamiento tienen las siguientes ventajas y consideraciones:</span><span class="sxs-lookup"><span data-stu-id="fc3f2-189">The three sharding strategies have the following advantages and considerations:</span></span>

- <span data-ttu-id="fc3f2-190">**Búsqueda**.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-190">**Lookup**.</span></span> <span data-ttu-id="fc3f2-191">Ofrece un mayor control sobre la manera en la que se configuran y se utilizan las particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-191">This offers more control over the way that shards are configured and used.</span></span> <span data-ttu-id="fc3f2-192">El uso de particiones virtuales reduce el impacto a la hora de reequilibrar los datos porque se pueden agregar nuevas particiones físicas para igualar la carga de trabajo.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-192">Using virtual shards reduces the impact when rebalancing data because new physical partitions can be added to even out the workload.</span></span> <span data-ttu-id="fc3f2-193">La asignación entre una partición virtual y las particiones físicas que implementan la partición puede modificarse sin alterar el código de la aplicación que utiliza una clave de partición para almacenar y recuperar datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-193">The mapping between a virtual shard and the physical partitions that implement the shard can be modified without affecting application code that uses a shard key to store and retrieve data.</span></span> <span data-ttu-id="fc3f2-194">La búsqueda de ubicaciones de particiones puede imponer una sobrecarga adicional.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-194">Looking up shard locations can impose an additional overhead.</span></span>

- <span data-ttu-id="fc3f2-195">**Rango**.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-195">**Range**.</span></span> <span data-ttu-id="fc3f2-196">Esto es fácil de implementar y funciona bien con las consultas por rango porque a menudo permiten capturar varios elementos de datos de una sola partición en una sola operación.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-196">This is easy to implement and works well with range queries because they can often fetch multiple data items from a single shard in a single operation.</span></span> <span data-ttu-id="fc3f2-197">Esta estrategia ofrece una administración de datos más sencilla.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-197">This strategy offers easier data management.</span></span> <span data-ttu-id="fc3f2-198">Por ejemplo, si los usuarios de la misma región se encuentran en la misma partición, se pueden programar las actualizaciones en cada zona horaria basándose en el patrón de demanda y carga local.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-198">For example, if users in the same region are in the same shard, updates can be scheduled in each time zone based on the local load and demand pattern.</span></span> <span data-ttu-id="fc3f2-199">Sin embargo, esta estrategia no proporciona un equilibrio óptimo entre las particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-199">However, this strategy doesn't provide optimal balancing between shards.</span></span> <span data-ttu-id="fc3f2-200">Reequilibrar las particiones es difícil y puede no resolver el problema de las cargas irregulares si la actividad es mayormente para las claves de partición adyacentes.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-200">Rebalancing shards is difficult and might not resolve the problem of uneven load if the majority of activity is for adjacent shard keys.</span></span>

- <span data-ttu-id="fc3f2-201">**Hash**.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-201">**Hash**.</span></span> <span data-ttu-id="fc3f2-202">Esta estrategia ofrece más posibilidades para realizar distribuciones de cargas y datos más uniformes.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-202">This strategy offers a better chance of more even data and load distribution.</span></span> <span data-ttu-id="fc3f2-203">El enrutamiento de solicitudes puede realizarse directamente mediante la función hash.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-203">Request routing can be accomplished directly by using the hash function.</span></span> <span data-ttu-id="fc3f2-204">No es necesario mantener ningún mapa.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-204">There's no need to maintain a map.</span></span> <span data-ttu-id="fc3f2-205">Tenga en cuenta que el cálculo de hash puede imponer una sobrecarga adicional.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-205">Note that computing the hash might impose an additional overhead.</span></span> <span data-ttu-id="fc3f2-206">Además, es difícil reequilibrar las particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-206">Also, rebalancing shards is difficult.</span></span>

<span data-ttu-id="fc3f2-207">Los sistemas de particionamiento más comunes implementan uno de los métodos descritos anteriormente, pero también debería considerar los requisitos empresariales de las aplicaciones y sus patrones de uso de datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-207">Most common sharding systems implement one of the approaches described above, but you should also consider the business requirements of your applications and their patterns of data usage.</span></span> <span data-ttu-id="fc3f2-208">Por ejemplo, en una aplicación multiinquilino:</span><span class="sxs-lookup"><span data-stu-id="fc3f2-208">For example, in a multi-tenant application:</span></span>

- <span data-ttu-id="fc3f2-209">Puede particionar datos en función de la carga de trabajo.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-209">You can shard data based on workload.</span></span> <span data-ttu-id="fc3f2-210">Puede separar los datos para inquilinos muy volátiles en particiones independientes.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-210">You could segregate the data for highly volatile tenants in separate shards.</span></span> <span data-ttu-id="fc3f2-211">Como resultado, es posible que mejore la velocidad de acceso a datos para otros inquilinos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-211">The speed of data access for other tenants might be improved as a result.</span></span>

- <span data-ttu-id="fc3f2-212">Puede particionar los datos según la ubicación de los inquilinos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-212">You can shard data based on the location of tenants.</span></span> <span data-ttu-id="fc3f2-213">Puede mover los datos de inquilinos de una región geográfica específica a una ubicación sin conexión para realizar copias de seguridad y tareas de mantenimiento durante horas de poca actividad en dicha región, mientras que los datos de inquilinos en otras regiones permanecen en línea y accesibles durante su horario comercial.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-213">You can take the data for tenants in a specific geographic region offline for backup and maintenance during off-peak hours in that region, while the data for tenants in other regions remains online and accessible during their business hours.</span></span>

- <span data-ttu-id="fc3f2-214">A los inquilinos de gran valor se les podrían asignar sus propias particiones privadas de alto rendimiento y poca carga, mientras que puede esperarse que los inquilinos de valor inferior compartan particiones más ocupadas y densamente empaquetadas.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-214">High-value tenants could be assigned their own private, high performing, lightly loaded shards, whereas lower-value tenants might be expected to share more densely-packed, busy shards.</span></span>

- <span data-ttu-id="fc3f2-215">Los datos de los inquilinos que necesitan un alto grado de aislamiento de datos y privacidad pueden almacenarse en un servidor completamente independiente.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-215">The data for tenants that need a high degree of data isolation and privacy can be stored on a completely separate server.</span></span>

## <a name="scaling-and-data-movement-operations"></a><span data-ttu-id="fc3f2-216">Operaciones de movimiento de datos y escalado</span><span class="sxs-lookup"><span data-stu-id="fc3f2-216">Scaling and data movement operations</span></span>

<span data-ttu-id="fc3f2-217">Cada una de las estrategias de particionamiento implica distintas capacidades y niveles de complejidad para administrar la reducción horizontal, la escala horizontal, el movimiento de datos y el estado de mantenimiento.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-217">Each of the sharding strategies implies different capabilities and levels of complexity for managing scale in, scale out, data movement, and maintaining state.</span></span>

<span data-ttu-id="fc3f2-218">La estrategia de búsqueda permite realizar operaciones de movimiento de datos y escalado a nivel de usuario, ya sea en línea o sin conexión.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-218">The Lookup strategy permits scaling and data movement operations to be carried out at the user level, either online or offline.</span></span> <span data-ttu-id="fc3f2-219">La técnica consiste en suspender parte o toda la actividad del usuario (quizás durante los períodos de poca actividad), mover los datos a la nueva partición virtual o a la partición física, cambiar las asignaciones, invalidar o actualizar todas las cachés que contienen estos datos y, después, permitir que la actividad del usuario se reanude.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-219">The technique is to suspend some or all user activity (perhaps during off-peak periods), move the data to the new virtual partition or physical shard, change the mappings, invalidate or refresh any caches that hold this data, and then allow user activity to resume.</span></span> <span data-ttu-id="fc3f2-220">A menudo este tipo de operación puede administrarse de forma centralizada.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-220">Often this type of operation can be centrally managed.</span></span> <span data-ttu-id="fc3f2-221">La estrategia de búsqueda requiere que el estado sea altamente almacenable en caché y fácil de replicar.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-221">The Lookup strategy requires state to be highly cacheable and replica friendly.</span></span>

<span data-ttu-id="fc3f2-222">La estrategia de rango impone algunas limitaciones en las operaciones de movimiento de datos y escalado, que normalmente se llevarán a cabo cuando una parte o la totalidad del almacén de datos esté sin conexión porque los datos deben dividirse y combinarse entre las particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-222">The Range strategy imposes some limitations on scaling and data movement operations, which must typically be carried out when a part or all of the data store is offline because the data must be split and merged across the shards.</span></span> <span data-ttu-id="fc3f2-223">Mover los datos para reequilibrar particiones puede que no resuelva el problema de carga irregular si la mayor parte de la actividad es para claves de partición adyacentes o identificadores de datos que están dentro del mismo rango.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-223">Moving the data to rebalance shards might not resolve the problem of uneven load if the majority of activity is for adjacent shard keys or data identifiers that are within the same range.</span></span> <span data-ttu-id="fc3f2-224">La estrategia de rango también podría requerir el mantenimiento de algún estado para asignar los rangos a las particiones físicas.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-224">The Range strategy might also require some state to be maintained in order to map ranges to the physical partitions.</span></span>

<span data-ttu-id="fc3f2-225">La estrategia de hash hace que las operaciones de movimiento de datos y escalado sean más complejas porque las claves de partición son hash de los identificadores de datos o claves de partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-225">The Hash strategy makes scaling and data movement operations more complex because the partition keys are hashes of the shard keys or data identifiers.</span></span> <span data-ttu-id="fc3f2-226">La nueva ubicación de cada partición se debe determinar a partir de la función de hash o la función modificada para proporcionar las asignaciones correctas.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-226">The new location of each shard must be determined from the hash function, or the function modified to provide the correct mappings.</span></span> <span data-ttu-id="fc3f2-227">Sin embargo, la estrategia de hash no requiere mantenimiento del estado.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-227">However, the Hash strategy doesn't require maintenance of state.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="fc3f2-228">Problemas y consideraciones</span><span class="sxs-lookup"><span data-stu-id="fc3f2-228">Issues and considerations</span></span>

<span data-ttu-id="fc3f2-229">Tenga en cuenta los puntos siguientes al decidir cómo implementar este patrón:</span><span class="sxs-lookup"><span data-stu-id="fc3f2-229">Consider the following points when deciding how to implement this pattern:</span></span>

- <span data-ttu-id="fc3f2-230">El particionamiento es adicional a otras formas de crear particiones, como el particionamiento vertical y el particionamiento funcional.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-230">Sharding is complementary to other forms of partitioning, such as vertical partitioning and functional partitioning.</span></span> <span data-ttu-id="fc3f2-231">Por ejemplo, una sola partición puede contener entidades que han sido particionadas verticalmente, y se puede implementar una partición funcional como varias particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-231">For example, a single shard can contain entities that have been partitioned vertically, and a functional partition can be implemented as multiple shards.</span></span> <span data-ttu-id="fc3f2-232">Para obtener más información acerca de las particiones, vea [Guía de creación de particiones de datos](https://msdn.microsoft.com/library/dn589795.aspx).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-232">For more information about partitioning, see the [Data Partitioning Guidance](https://msdn.microsoft.com/library/dn589795.aspx).</span></span>

- <span data-ttu-id="fc3f2-233">Se recomienda mantener las particiones equilibradas para que todas controlen un volumen similar de E/S.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-233">Keep shards balanced so they all handle a similar volume of I/O.</span></span> <span data-ttu-id="fc3f2-234">Dado que los datos se insertan y eliminan, es necesario volver a equilibrar periódicamente las particiones para garantizar una distribución uniforme y reducir la posibilidad de zonas activas.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-234">As data is inserted and deleted, it's necessary to periodically rebalance the shards to guarantee an even distribution and to reduce the chance of hotspots.</span></span> <span data-ttu-id="fc3f2-235">La operaciones de reequilibrio pueden ser costosas.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-235">Rebalancing can be an expensive operation.</span></span> <span data-ttu-id="fc3f2-236">Para reducir la necesidad de reequilibrio, planee el crecimiento y asegúrese de que cada partición contiene suficiente espacio libre como para controlar el volumen esperado de cambios.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-236">To reduce the necessity of rebalancing, plan for growth by ensuring that each shard contains sufficient free space to handle the expected volume of changes.</span></span> <span data-ttu-id="fc3f2-237">También se deben desarrollar estrategias y scripts que puedan usarse para volver a equilibrar rápidamente las particiones si es necesario.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-237">You should also develop strategies and scripts you can use to quickly rebalance shards if this becomes necessary.</span></span>

- <span data-ttu-id="fc3f2-238">Use datos estables para la clave de partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-238">Use stable data for the shard key.</span></span> <span data-ttu-id="fc3f2-239">Si la clave de partición cambia, será necesario mover el elemento de datos correspondiente entre las particiones, lo que aumenta el trabajo que realizan las operaciones de actualización.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-239">If the shard key changes, the corresponding data item might have to move between shards, increasing the amount of work performed by update operations.</span></span> <span data-ttu-id="fc3f2-240">Por esta razón, evite basar la clave de partición en información potencialmente volátil.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-240">For this reason, avoid basing the shard key on potentially volatile information.</span></span> <span data-ttu-id="fc3f2-241">En su lugar, busque atributos invariables o que formen una clave de manera natural.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-241">Instead, look for attributes that are invariant or that naturally form a key.</span></span>

- <span data-ttu-id="fc3f2-242">Asegúrese de que las claves de partición sean únicas.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-242">Ensure that shard keys are unique.</span></span> <span data-ttu-id="fc3f2-243">Por ejemplo, evite usar campos de incremento automático como la clave de partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-243">For example, avoid using autoincrementing fields as the shard key.</span></span> <span data-ttu-id="fc3f2-244">En algunos sistemas, los campos de incremento automático no pueden coordinarse entre las particiones, lo cual puede provocar que elementos de diferentes particiones tengan la misma clave de partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-244">Is some systems, autoincremented fields can't be coordinated across shards, possibly resulting in items in different shards having the same shard key.</span></span>

    >  <span data-ttu-id="fc3f2-245">Los valores de incremento automático de otros campos que no son claves de partición también pueden causar problemas.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-245">Autoincremented values in other fields that are not shard keys can also cause problems.</span></span> <span data-ttu-id="fc3f2-246">Por ejemplo, si usa campos de incremento automático para generar identificadores únicos, es posible que dos elementos diferentes que se encuentran en diferentes particiones se asignen al mismo identificador.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-246">For example, if you use autoincremented fields to generate unique IDs, then two different items located in different shards might be assigned the same ID.</span></span>

- <span data-ttu-id="fc3f2-247">Puede que no sea posible diseñar una clave de partición que coincida con los requisitos de cada consulta posible en relación con los datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-247">It might not be possible to design a shard key that matches the requirements of every possible query against the data.</span></span> <span data-ttu-id="fc3f2-248">Particione los datos para que admitan las consultas que más se realizan y, si es necesario, cree tablas de índice secundarias para admitir las consultas que recuperan datos mediante criterios basados en atributos que no forman parte de la clave de partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-248">Shard the data to support the most frequently performed queries, and if necessary create secondary index tables to support queries that retrieve data using criteria based on attributes that aren't part of the shard key.</span></span> <span data-ttu-id="fc3f2-249">Para obtener más información, consulte [Patrón Index Table](./index-table.md).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-249">For more information, see the [Index Table pattern](./index-table.md).</span></span>

- <span data-ttu-id="fc3f2-250">Las consultas que solo tienen acceso a una partición son más eficaces que las que recuperan datos de varias particiones, así que evite la implementación de un sistema de particionamiento que dé como resultado aplicaciones que realicen un gran número de consultas para combinar datos contenidos en diferentes particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-250">Queries that access only a single shard are more efficient than those that retrieve data from multiple shards, so avoid implementing a sharding system that results in applications performing large numbers of queries that join data held in different shards.</span></span> <span data-ttu-id="fc3f2-251">Recuerde que una sola partición puede contener datos de varios tipos de entidades.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-251">Remember that a single shard can contain the data for multiple types of entities.</span></span> <span data-ttu-id="fc3f2-252">Considere la posibilidad de desnormalizar sus datos para mantener las entidades relacionadas que suelen consultarse juntas (por ejemplo, los detalles de los clientes y los pedidos que han realizado) en la misma partición, a fin de reducir el número de lecturas independientes que realiza una aplicación.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-252">Consider denormalizing your data to keep related entities that are commonly queried together (such as the details of customers and the orders that they have placed) in the same shard to reduce the number of separate reads that an application performs.</span></span>

    >  <span data-ttu-id="fc3f2-253">Si una entidad en una partición hace referencia a una entidad almacenada en otra partición, incluya la clave de partición de la segunda entidad como parte del esquema de la primera entidad.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-253">If an entity in one shard references an entity stored in another shard, include the shard key for the second entity as part of the schema for the first entity.</span></span> <span data-ttu-id="fc3f2-254">Esto puede ayudar a mejorar el rendimiento de las consultas que hacen referencia a datos relacionados entre particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-254">This can help to improve the performance of queries that reference related data across shards.</span></span>

- <span data-ttu-id="fc3f2-255">Si una aplicación debe llevar a cabo consultas que recuperan datos de varias particiones, es posible recuperar estos datos mediante tareas paralelas.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-255">If an application must perform queries that retrieve data from multiple shards, it might be possible to fetch this data by using parallel tasks.</span></span> <span data-ttu-id="fc3f2-256">Algunos ejemplos son consultas de distribución ramificada, donde los datos de varias particiones se recuperan paralelamente y, después, se agregan en un único resultado.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-256">Examples include fan-out queries, where data from multiple shards is retrieved in parallel and then aggregated into a single result.</span></span> <span data-ttu-id="fc3f2-257">Sin embargo, este enfoque agrega inevitablemente cierta complejidad a la lógica de acceso a datos de una solución.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-257">However, this approach inevitably adds some complexity to the data access logic of a solution.</span></span>

- <span data-ttu-id="fc3f2-258">Para muchas aplicaciones, la creación de un mayor número de particiones pequeñas puede ser más eficaz que tener un número reducido de particiones grandes, ya que esto puede ofrecer mayores oportunidades para equilibrar la carga.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-258">For many applications, creating a larger number of small shards can be more efficient than having a small number of large shards because they can offer increased opportunities for load balancing.</span></span> <span data-ttu-id="fc3f2-259">Esto también puede ser útil si prevé la necesidad de migrar particiones de una ubicación física a otra.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-259">This can also be useful if you anticipate the need to migrate shards from one physical location to another.</span></span> <span data-ttu-id="fc3f2-260">Mover una partición pequeña es más rápido que mover una grande.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-260">Moving a small shard is quicker than moving a large one.</span></span>

- <span data-ttu-id="fc3f2-261">Asegúrese de que los recursos disponibles para cada nodo de almacenamiento de partición sean suficientes para controlar los requisitos de escalabilidad en términos de rendimiento y tamaño de datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-261">Make sure the resources available to each shard storage node are sufficient to handle the scalability requirements in terms of data size and throughput.</span></span> <span data-ttu-id="fc3f2-262">Para obtener más información, vea la sección "Diseño de particiones para obtener escalabilidad" de [Guía de creación de particiones de datos](https://msdn.microsoft.com/library/dn589795.aspx).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-262">For more information, see the section “Designing Partitions for Scalability” in the [Data Partitioning Guidance](https://msdn.microsoft.com/library/dn589795.aspx).</span></span>

- <span data-ttu-id="fc3f2-263">Considere la posibilidad de replicar los datos de referencia en todas las particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-263">Consider replicating reference data to all shards.</span></span> <span data-ttu-id="fc3f2-264">Si una operación que recupera datos de una partición también hace referencia a datos estáticos o de movimiento lento como parte de la misma consulta, agregue estos datos a la partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-264">If an operation that retrieves data from a shard also references static or slow-moving data as part of the same query, add this data to the shard.</span></span> <span data-ttu-id="fc3f2-265">Esto permitirá que la aplicación capture fácilmente todos los datos de la consulta, sin tener que realizar un viaje de ida y vuelta a un almacén de datos independiente.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-265">The application can then fetch all of the data for the query easily, without having to make an additional round trip to a separate data store.</span></span>

    >  <span data-ttu-id="fc3f2-266">Si los datos de referencia que se conservan en varias particiones cambian, el sistema debe sincronizar estos cambios entre todas las particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-266">If reference data held in multiple shards changes, the system must synchronize these changes across all shards.</span></span> <span data-ttu-id="fc3f2-267">El sistema puede experimentar un grado de incoherencia mientras se realiza la sincronización.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-267">The system can experience a degree of inconsistency while this synchronization occurs.</span></span> <span data-ttu-id="fc3f2-268">Si lo hace, debe diseñar sus aplicaciones para que puedan gestionarlo.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-268">If you do this, you should design your applications to be able to handle it.</span></span>

- <span data-ttu-id="fc3f2-269">Puede ser difícil mantener la integridad referencial y la coherencia entre las particiones, por lo que debería minimizar las operaciones que afectan a datos de varias particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-269">It can be difficult to maintain referential integrity and consistency between shards, so you should minimize operations that affect data in multiple shards.</span></span> <span data-ttu-id="fc3f2-270">Si una aplicación debe modificar datos de diferentes particiones, evalúe si es necesaria una coherencia completa de los datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-270">If an application must modify data across shards, evaluate whether complete data consistency is actually required.</span></span> <span data-ttu-id="fc3f2-271">En su lugar, un enfoque común en la nube es implementar la coherencia eventual.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-271">Instead, a common approach in the cloud is to implement eventual consistency.</span></span> <span data-ttu-id="fc3f2-272">Los datos de cada partición se actualizan por separado, y la lógica de aplicación debe asumir la responsabilidad de garantizar que todas las actualizaciones concluyan correctamente y de gestionar las incoherencias que pueden resultar de la consulta de datos mientras se ejecuta una operación de coherencia.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-272">The data in each partition is updated separately, and the application logic must take responsibility for ensuring that the updates all complete successfully, as well as handling the inconsistencies that can arise from querying data while an eventually consistent operation is running.</span></span> <span data-ttu-id="fc3f2-273">Para obtener más información acerca de la implementación de la coherencia eventual, consulte [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) (Manual básico de coherencia de datos).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-273">For more information about implementing eventual consistency, see the [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx).</span></span>

- <span data-ttu-id="fc3f2-274">Configurar y administrar un gran número de particiones puede ser un desafío.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-274">Configuring and managing a large number of shards can be a challenge.</span></span> <span data-ttu-id="fc3f2-275">Tareas como la supervisión, la creación de copias de seguridad, la comprobación de coherencia y el registro o la auditoría deben realizarse en varios servidores y particiones, que es posible que se encuentren en diferentes ubicaciones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-275">Tasks such as monitoring, backing up, checking for consistency, and logging or auditing must be accomplished on multiple shards and servers, possibly held in multiple locations.</span></span> <span data-ttu-id="fc3f2-276">Estas tareas suelen implementarse usando scripts u otras soluciones de automatización, pero esto podría no eliminar por completo los requisitos administrativos adicionales.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-276">These tasks are likely to be implemented using scripts or other automation solutions, but that might not completely eliminate the additional administrative requirements.</span></span>

- <span data-ttu-id="fc3f2-277">Las particiones pueden geolocalizarse para que los datos que contienen estén cerca de las instancias de una aplicación que los usa.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-277">Shards can be geolocated so that the data that they contain is close to the instances of an application that use it.</span></span> <span data-ttu-id="fc3f2-278">Este enfoque puede mejorar considerablemente el rendimiento, pero requiere una consideración adicional para las tareas que deben tener acceso a varias particiones en diferentes ubicaciones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-278">This approach can considerably improve performance, but requires additional consideration for tasks that must access multiple shards in different locations.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="fc3f2-279">Cuándo usar este patrón</span><span class="sxs-lookup"><span data-stu-id="fc3f2-279">When to use this pattern</span></span>

<span data-ttu-id="fc3f2-280">Utilice este patrón cuando sea probable que un almacén de datos necesite escalar más allá de los recursos disponibles para un único nodo de almacenamiento o para mejorar el rendimiento mediante la reducción de la contención en un almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-280">Use this pattern when a data store is likely to need to scale beyond the resources available to a single storage node, or to improve performance by reducing contention in a data store.</span></span>

> [!NOTE]
<span data-ttu-id="fc3f2-281">El objetivo principal del particionamiento es mejorar el rendimiento y la escalabilidad de un sistema, pero, en consecuencia, puede mejorar la disponibilidad debido a la forma en la que los datos se dividen en particiones independientes.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-281">The primary focus of sharding is to improve the performance and scalability of a system, but as a by-product it can also improve availability due to how the data is divided into separate partitions.</span></span> <span data-ttu-id="fc3f2-282">Un error en una partición no impide necesariamente que una aplicación acceda a los datos contenidos en otras particiones y un operador puede realizar las tareas de mantenimiento o recuperación de una o más particiones sin hacer que todos los datos de una aplicación sean inaccesibles.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-282">A failure in one partition doesn't necessarily prevent an application from accessing data held in other partitions, and an operator can perform maintenance or recovery of one or more partitions without making the entire data for an application inaccessible.</span></span> <span data-ttu-id="fc3f2-283">Para obtener más información, consulte [Guía de creación de particiones de datos](https://msdn.microsoft.com/library/dn589795.aspx).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-283">For more information, see the [Data Partitioning Guidance](https://msdn.microsoft.com/library/dn589795.aspx).</span></span>

## <a name="example"></a><span data-ttu-id="fc3f2-284">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="fc3f2-284">Example</span></span>

<span data-ttu-id="fc3f2-285">En el siguiente ejemplo de C# se usa un conjunto de bases de datos de SQL Server que actúan como particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-285">The following example in C# uses a set of SQL Server databases acting as shards.</span></span> <span data-ttu-id="fc3f2-286">Cada base de datos contiene un subconjunto de los datos que usa una aplicación.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-286">Each database holds a subset of the data used by an application.</span></span> <span data-ttu-id="fc3f2-287">La aplicación recupera los datos que se distribuyen entre las particiones mediante su propia lógica de particionamiento (este es un ejemplo de una consulta de distribución ramificada).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-287">The application retrieves data that's distributed across the shards using its own sharding logic (this is an example of a fan-out query).</span></span> <span data-ttu-id="fc3f2-288">Los detalles de los datos que se encuentran en cada partición se devuelven mediante un método denominado `GetShards`.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-288">The details of the data that's located in each shard is returned by a method called `GetShards`.</span></span> <span data-ttu-id="fc3f2-289">Este método devuelve una lista enumerable de objetos `ShardInformation`, donde el tipo `ShardInformation` contiene un identificador para cada partición y la cadena de conexión de SQL Server que una aplicación debe utilizar para conectarse a la partición (las cadenas de conexión no se muestran en el código de ejemplo).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-289">This method returns an enumerable list of `ShardInformation` objects, where the `ShardInformation` type contains an identifier for each shard and the SQL Server connection string that an application should use to connect to the shard (the connection strings aren't shown in the code example).</span></span>

```csharp
private IEnumerable<ShardInformation> GetShards()
{
  // This retrieves the connection information from a shard store
  // (commonly a root database).
  return new[]
  {
    new ShardInformation
    {
      Id = 1,
      ConnectionString = ...
    },
    new ShardInformation
    {
      Id = 2,
      ConnectionString = ...
    }
  };
}
```

<span data-ttu-id="fc3f2-290">El código siguiente muestra cómo la aplicación usa la lista de objetos `ShardInformation` para realizar una consulta que captura los datos de cada partición en paralelo.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-290">The code below shows how the application uses the list of `ShardInformation` objects to perform a query that fetches data from each shard in parallel.</span></span> <span data-ttu-id="fc3f2-291">No se muestran los detalles de la consulta, pero en este ejemplo los datos que se recuperan contienen una cadena que podría contener información como el nombre de un cliente si las particiones contienen los detalles de los clientes.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-291">The details of the query aren't shown, but in this example the data that's retrieved contains a string that could hold information such as the name of a customer if the shards contain the details of customers.</span></span> <span data-ttu-id="fc3f2-292">Los resultados se agregan a una colección `ConcurrentBag` para que los procese la aplicación.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-292">The results are aggregated into a `ConcurrentBag` collection for processing by the application.</span></span>

```csharp
// Retrieve the shards as a ShardInformation[] instance.
var shards = GetShards();

var results = new ConcurrentBag<string>();

// Execute the query against each shard in the shard list.
// This list would typically be retrieved from configuration
// or from a root/master shard store.
Parallel.ForEach(shards, shard =>
{
  // NOTE: Transient fault handling isn't included,
  // but should be incorporated when used in a real world application.
  using (var con = new SqlConnection(shard.ConnectionString))
  {
    con.Open();
    var cmd = new SqlCommand("SELECT ... FROM ...", con);

    Trace.TraceInformation("Executing command against shard: {0}", shard.Id);

    var reader = cmd.ExecuteReader();
    // Read the results in to a thread-safe data structure.
    while (reader.Read())
    {
      results.Add(reader.GetString(0));
    }
  }
});

Trace.TraceInformation("Fanout query complete - Record Count: {0}",
                        results.Count);
```

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="fc3f2-293">Orientación y patrones relacionados</span><span class="sxs-lookup"><span data-stu-id="fc3f2-293">Related patterns and guidance</span></span>

<span data-ttu-id="fc3f2-294">Los patrones y las directrices siguientes también pueden ser importantes a la hora de implementar este modelo:</span><span class="sxs-lookup"><span data-stu-id="fc3f2-294">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="fc3f2-295">[Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) (Manual básico de coherencia de datos).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-295">[Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx).</span></span> <span data-ttu-id="fc3f2-296">Podría ser necesario mantener la coherencia de los datos distribuidos en diferentes particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-296">It might be necessary to maintain consistency for data distributed across different shards.</span></span> <span data-ttu-id="fc3f2-297">Resume los problemas relacionados al mismo tiempo que mantiene la coherencia sobre los datos distribuidos y describe las ventajas e inconvenientes de los diferentes modelos de coherencia.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-297">Summarizes the issues surrounding maintaining consistency over distributed data, and describes the benefits and tradeoffs of different consistency models.</span></span>
- <span data-ttu-id="fc3f2-298">[Guía de creación de particiones de datos](https://msdn.microsoft.com/library/dn589795.aspx).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-298">[Data Partitioning Guidance](https://msdn.microsoft.com/library/dn589795.aspx).</span></span> <span data-ttu-id="fc3f2-299">El particionamiento de un almacén de datos puede introducir diferentes problemas adicionales.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-299">Sharding a data store can introduce a range of additional issues.</span></span> <span data-ttu-id="fc3f2-300">Describe estos problemas en relación con el particionamiento de los almacenes de datos en la nube para mejorar la escalabilidad, reducir la contención y optimizar el rendimiento.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-300">Describes these issues in relation to partitioning data stores in the cloud to improve scalability, reduce contention, and optimize performance.</span></span>
- <span data-ttu-id="fc3f2-301">[Patrón Index Table](./index-table.md).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-301">[Index Table pattern](./index-table.md).</span></span> <span data-ttu-id="fc3f2-302">A veces no es posible dar soporte completo a las consultas solo con el diseño de la clave de partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-302">Sometimes it isn't possible to completely support queries just through the design of the shard key.</span></span> <span data-ttu-id="fc3f2-303">Permite que una aplicación recupere rápidamente los datos de un almacén de datos de gran tamaño mediante la especificación de una clave distinta de la clave de partición.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-303">Enables an application to quickly retrieve data from a large data store by specifying a key other than the shard key.</span></span>
- <span data-ttu-id="fc3f2-304">[Patrón Materialized View](./materialized-view.md).</span><span class="sxs-lookup"><span data-stu-id="fc3f2-304">[Materialized View pattern](./materialized-view.md).</span></span> <span data-ttu-id="fc3f2-305">Para mantener el rendimiento de algunas operaciones de consulta, es útil crear vistas materializadas que agreguen y resuman los datos, especialmente si estos datos de resumen se basan en información que se distribuye entre las particiones.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-305">To maintain the performance of some query operations, it's useful to create materialized views that aggregate and summarize data, especially if this summary data is based on information that's distributed across shards.</span></span> <span data-ttu-id="fc3f2-306">Describe cómo generar y rellenar estas vistas.</span><span class="sxs-lookup"><span data-stu-id="fc3f2-306">Describes how to generate and populate these views.</span></span>
