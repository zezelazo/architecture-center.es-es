---
title: Patrón Leader Election
titleSuffix: Cloud Design Patterns
description: Coordina las acciones realizadas por una colección de instancias de tareas de colaboración de una aplicación distribuida mediante la elección de una instancia como líder que asume la responsabilidad de administrar las demás instancias.
keywords: Patrón de diseño
author: dragon119
ms.date: 06/23/2017
ms.custom: seodec18
ms.openlocfilehash: cfc29e3490735c16b41c494e6cecbb8972cdc705
ms.sourcegitcommit: 680c9cef945dff6fee5e66b38e24f07804510fa9
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 01/04/2019
ms.locfileid: "54010146"
---
# <a name="leader-election-pattern"></a><span data-ttu-id="ae845-104">Patrón Leader Election</span><span class="sxs-lookup"><span data-stu-id="ae845-104">Leader Election pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="ae845-105">Coordina las acciones realizadas por una colección de instancias de colaboración de una aplicación distribuida mediante la elección de una instancia como líder que asume la responsabilidad de administrar las otras.</span><span class="sxs-lookup"><span data-stu-id="ae845-105">Coordinate the actions performed by a collection of collaborating instances in a distributed application by electing one instance as the leader that assumes responsibility for managing the others.</span></span> <span data-ttu-id="ae845-106">Esto puede ayudar a garantizar que las instancias no entren en conflicto, provoquen la contención de recursos compartidos o interfieran por accidente con el trabajo que realizan otras instancias.</span><span class="sxs-lookup"><span data-stu-id="ae845-106">This can help to ensure that instances don't conflict with each other, cause contention for shared resources, or inadvertently interfere with the work that other instances are performing.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="ae845-107">Contexto y problema</span><span class="sxs-lookup"><span data-stu-id="ae845-107">Context and problem</span></span>

<span data-ttu-id="ae845-108">Una aplicación en la nube típica tiene muchas tareas que actúan de manera coordinada.</span><span class="sxs-lookup"><span data-stu-id="ae845-108">A typical cloud application has many tasks acting in a coordinated manner.</span></span> <span data-ttu-id="ae845-109">Estas instancias podrían ser todas instancias que ejecutan el mismo código y que requieren acceso a los mismos recursos, o podría estar funcionando juntas en paralelo para realizar las partes individuales de un cálculo complejo.</span><span class="sxs-lookup"><span data-stu-id="ae845-109">These tasks could all be instances running the same code and requiring access to the same resources, or they might be working together in parallel to perform the individual parts of a complex calculation.</span></span>

<span data-ttu-id="ae845-110">Las instancias de tarea podrían ejecutarse por separado la mayor parte del tiempo, pero también podría ser necesario coordinar las acciones de cada una para garantizar que no entren en conflicto, provoquen la contención de recursos compartidos o interfieran por accidente con el trabajo que realizan otras instancias de tarea.</span><span class="sxs-lookup"><span data-stu-id="ae845-110">The task instances might run separately for much of the time, but it might also be necessary to coordinate the actions of each instance to ensure that they don’t conflict, cause contention for shared resources, or accidentally interfere with the work that other task instances are performing.</span></span>

<span data-ttu-id="ae845-111">Por ejemplo: </span><span class="sxs-lookup"><span data-stu-id="ae845-111">For example:</span></span>

- <span data-ttu-id="ae845-112">En un sistema basado en la nube que implementa escalado horizontal, varias instancias de la misma tarea podrían estar ejecutándose al mismo tiempo y cada instancia atender a un usuario diferente.</span><span class="sxs-lookup"><span data-stu-id="ae845-112">In a cloud-based system that implements horizontal scaling, multiple instances of the same task could be running at the same time with each instance serving a different user.</span></span> <span data-ttu-id="ae845-113">Si estas instancias escriben en un recurso compartido, es necesario coordinar sus acciones para evitar que cada instancia sobrescriba los cambios realizados por las demás.</span><span class="sxs-lookup"><span data-stu-id="ae845-113">If these instances write to a shared resource, it's necessary to coordinate their actions to prevent each instance from overwriting the changes made by the others.</span></span>
- <span data-ttu-id="ae845-114">Si las tareas ejecutan elementos individuales de un cálculo complejo en paralelo, los resultados deben agregarse cuando dichos cálculos finalicen.</span><span class="sxs-lookup"><span data-stu-id="ae845-114">If the tasks are performing individual elements of a complex calculation in parallel, the results need to be aggregated when they all complete.</span></span>

<span data-ttu-id="ae845-115">Las instancia de tarea son todas del mismo nivel, por lo que no hay un líder natural que actúe como coordinador o agregador.</span><span class="sxs-lookup"><span data-stu-id="ae845-115">The task instances are all peers, so there isn't a natural leader that can act as the coordinator or aggregator.</span></span>

## <a name="solution"></a><span data-ttu-id="ae845-116">Solución</span><span class="sxs-lookup"><span data-stu-id="ae845-116">Solution</span></span>

<span data-ttu-id="ae845-117">Se debe elegir una única instancia de tarea para que actúe como líder, y esta instancia debe coordinar las acciones de las demás instancias de tarea subordinadas.</span><span class="sxs-lookup"><span data-stu-id="ae845-117">A single task instance should be elected to act as the leader, and this instance should coordinate the actions of the other subordinate task instances.</span></span> <span data-ttu-id="ae845-118">Si todas las instancias de tarea ejecutan el mismo código, cada una de ellas tiene la capacidad para actuar como líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-118">If all of the task instances are running the same code, they are each capable of acting as the leader.</span></span> <span data-ttu-id="ae845-119">Por lo tanto, el proceso de elección debe administrarse con cuidado para evitar que dos o más instancias asuman el rol de líder al mismo tiempo.</span><span class="sxs-lookup"><span data-stu-id="ae845-119">Therefore, the election process must be managed carefully to prevent two or more instances taking over the leader role at the same time.</span></span>

<span data-ttu-id="ae845-120">El sistema debe proporcionar un mecanismo eficaz para seleccionar el líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-120">The system must provide a robust mechanism for selecting the leader.</span></span> <span data-ttu-id="ae845-121">Este método tiene que hacer frente a eventos, como interrupciones de red o errores de proceso.</span><span class="sxs-lookup"><span data-stu-id="ae845-121">This method has to cope with events such as network outages or process failures.</span></span> <span data-ttu-id="ae845-122">En muchas de las soluciones, las instancias de tarea subordinadas supervisan el líder a través de algún tipo de método de latido o mediante sondeo.</span><span class="sxs-lookup"><span data-stu-id="ae845-122">In many solutions, the subordinate task instances monitor the leader through some type of heartbeat method, or by polling.</span></span> <span data-ttu-id="ae845-123">Si el líder designado termina de forma inesperada, o un error de red hace que el líder no esté disponible para las instancias de tarea subordinadas, será necesario elegir un nuevo líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-123">If the designated leader terminates unexpectedly, or a network failure makes the leader unavailable to the subordinate task instances, it's necessary for them to elect a new leader.</span></span>

<span data-ttu-id="ae845-124">Existen varias estrategias para elegir un líder entre un conjunto de tareas en un entorno distribuido, como son:</span><span class="sxs-lookup"><span data-stu-id="ae845-124">There are several strategies for electing a leader among a set of tasks in a distributed environment, including:</span></span>

- <span data-ttu-id="ae845-125">Seleccionar la instancia de tarea con el identificador de proceso o de instancia peor clasificados.</span><span class="sxs-lookup"><span data-stu-id="ae845-125">Selecting the task instance with the lowest-ranked instance or process ID.</span></span>
- <span data-ttu-id="ae845-126">Competir para adquirir una exclusión mutua compartida y distribuida.</span><span class="sxs-lookup"><span data-stu-id="ae845-126">Racing to acquire a shared, distributed mutex.</span></span> <span data-ttu-id="ae845-127">La primera instancia de tarea que adquiere la exclusión mutua es el líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-127">The first task instance that acquires the mutex is the leader.</span></span> <span data-ttu-id="ae845-128">Sin embargo, el sistema debe asegurarse de que, si el líder finaliza o se desconecta del resto del sistema, se libere la exclusión mutua para permitir que otra instancia de tarea se convierta en el líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-128">However, the system must ensure that, if the leader terminates or becomes disconnected from the rest of the system, the mutex is released to allow another task instance to become the leader.</span></span>
- <span data-ttu-id="ae845-129">Implementar uno de los algoritmos de Leader Electrion comunes como el [algoritmo Bully](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html) o el [algoritmo Ring](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span><span class="sxs-lookup"><span data-stu-id="ae845-129">Implementing one of the common leader election algorithms such as the [Bully Algorithm](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html) or the [Ring Algorithm](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span></span> <span data-ttu-id="ae845-130">Estos algoritmos dan por supuesto que cada candidato de la elección tiene un identificador único y que puede comunicarse con los otros candidatos de manera confiable.</span><span class="sxs-lookup"><span data-stu-id="ae845-130">These algorithms assume that each candidate in the election has a unique ID, and that it can communicate with the other candidates reliably.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="ae845-131">Problemas y consideraciones</span><span class="sxs-lookup"><span data-stu-id="ae845-131">Issues and considerations</span></span>

<span data-ttu-id="ae845-132">Tenga en cuenta los puntos siguientes al decidir cómo implementar este patrón:</span><span class="sxs-lookup"><span data-stu-id="ae845-132">Consider the following points when deciding how to implement this pattern:</span></span>

- <span data-ttu-id="ae845-133">El proceso de elegir un líder debería ser resistente a errores transitorios y persistentes.</span><span class="sxs-lookup"><span data-stu-id="ae845-133">The process of electing a leader should be resilient to transient and persistent failures.</span></span>
- <span data-ttu-id="ae845-134">Tiene que ser posible detectar cuándo el líder ha generado un error o ha dejado de estar disponible (por ejemplo, debido a un error de comunicación).</span><span class="sxs-lookup"><span data-stu-id="ae845-134">It must be possible to detect when the leader has failed or has become otherwise unavailable (such as due to a communications failure).</span></span> <span data-ttu-id="ae845-135">La rapidez con que se necesite la detección depende del sistema.</span><span class="sxs-lookup"><span data-stu-id="ae845-135">How quickly detection is needed is system dependent.</span></span> <span data-ttu-id="ae845-136">Algunos sistemas podrían funcionar durante un corto espacio de tiempo sin un líder, en cuyo transcurso un error transitorio podría corregirse.</span><span class="sxs-lookup"><span data-stu-id="ae845-136">Some systems might be able to function for a short time without a leader, during which a transient fault might be fixed.</span></span> <span data-ttu-id="ae845-137">En otros casos, podría ser necesario detectar el error del líder inmediatamente y desencadenar una nueva elección.</span><span class="sxs-lookup"><span data-stu-id="ae845-137">In other cases, it might be necessary to detect leader failure immediately and trigger a new election.</span></span>
- <span data-ttu-id="ae845-138">En un sistema que implementa el escalado automático horizontal, el líder podría finalizarse si el sistema se reduce y cierra algunos de los recursos de computación.</span><span class="sxs-lookup"><span data-stu-id="ae845-138">In a system that implements horizontal autoscaling, the leader could be terminated if the system scales back and shuts down some of the computing resources.</span></span>
- <span data-ttu-id="ae845-139">El uso de una exclusión mutua compartida distribuida introduce una dependencia en el servicio externo que proporciona la exclusión mutua.</span><span class="sxs-lookup"><span data-stu-id="ae845-139">Using a shared, distributed mutex introduces a dependency on the external service that provides the mutex.</span></span> <span data-ttu-id="ae845-140">El servicio constituye un punto único de error.</span><span class="sxs-lookup"><span data-stu-id="ae845-140">The service constitutes a single point of failure.</span></span> <span data-ttu-id="ae845-141">Si por algún motivo deja de estar disponible, el sistema no podrá elegir un líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-141">If it becomes unavailable for any reason, the system won't be able to elect a leader.</span></span>
- <span data-ttu-id="ae845-142">El uso de un único proceso dedicado como líder es un enfoque sencillo.</span><span class="sxs-lookup"><span data-stu-id="ae845-142">Using a single dedicated process as the leader is a straightforward approach.</span></span> <span data-ttu-id="ae845-143">Sin embargo, si el proceso produce un error, podría haber un considerable retraso mientras se reinicia.</span><span class="sxs-lookup"><span data-stu-id="ae845-143">However, if the process fails there could be a significant delay while it's restarted.</span></span> <span data-ttu-id="ae845-144">La latencia resultante puede afectar al rendimiento y a los tiempos de respuesta de otros procesos si están a la espera de que el líder coordine una operación.</span><span class="sxs-lookup"><span data-stu-id="ae845-144">The resulting latency can affect the performance and response times of other processes if they're waiting for the leader to coordinate an operation.</span></span>
- <span data-ttu-id="ae845-145">La implementación de uno de los algoritmos de Leader Election proporciona manualmente la máxima flexibilidad para optimizar y ajustar el código.</span><span class="sxs-lookup"><span data-stu-id="ae845-145">Implementing one of the leader election algorithms manually provides the greatest flexibility for tuning and optimizing the code.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="ae845-146">Cuándo usar este patrón</span><span class="sxs-lookup"><span data-stu-id="ae845-146">When to use this pattern</span></span>

<span data-ttu-id="ae845-147">Use este patrón cuando las tareas de una aplicación distribuida, como una solución hospedada en las nube, necesiten una cuidadosa coordinación y no haya un líder natural.</span><span class="sxs-lookup"><span data-stu-id="ae845-147">Use this pattern when the tasks in a distributed application, such as a cloud-hosted solution, need careful coordination and there's no natural leader.</span></span>

> <span data-ttu-id="ae845-148">Evite convertir el líder en un cuello de botella en el sistema.</span><span class="sxs-lookup"><span data-stu-id="ae845-148">Avoid making the leader a bottleneck in the system.</span></span> <span data-ttu-id="ae845-149">La finalidad del líder es coordinar el trabajo de las tareas subordinadas, y no tiene que participar necesariamente en este trabajo&mdash;aunque debería poder hacerlo si la tarea no se elige como líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-149">The purpose of the leader is to coordinate the work of the subordinate tasks, and it doesn't necessarily have to participate in this work itself&mdash;although it should be able to do so if the task isn't elected as the leader.</span></span>

<span data-ttu-id="ae845-150">Este patrón puede ser útil en los siguientes casos:</span><span class="sxs-lookup"><span data-stu-id="ae845-150">This pattern might not be useful if:</span></span>

- <span data-ttu-id="ae845-151">Hay un líder natural o un proceso dedicado que puede actuar siempre como líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-151">There's a natural leader or dedicated process that can always act as the leader.</span></span> <span data-ttu-id="ae845-152">Por ejemplo, podría implementarse un proceso de singleton que coordine las instancias de tarea.</span><span class="sxs-lookup"><span data-stu-id="ae845-152">For example, it might be possible to implement a singleton process that coordinates the task instances.</span></span> <span data-ttu-id="ae845-153">Si se produce un error en este proceso o su estado no es correcto, el sistema puede cerrarlo y reiniciarlo.</span><span class="sxs-lookup"><span data-stu-id="ae845-153">If this process fails or becomes unhealthy, the system can shut it down and restart it.</span></span>
- <span data-ttu-id="ae845-154">La coordinación entre las tareas se puede lograr con un método más ligero.</span><span class="sxs-lookup"><span data-stu-id="ae845-154">The coordination between tasks can be achieved using a more lightweight method.</span></span> <span data-ttu-id="ae845-155">Por ejemplo, si varias instancias de tarea solo necesitan acceso coordinado a un recurso compartido, una solución mejor es usar bloqueo optimista o pesimista para controlar el acceso.</span><span class="sxs-lookup"><span data-stu-id="ae845-155">For example, if several task instances simply need coordinated access to a shared resource, a better solution is to use optimistic or pessimistic locking to control access.</span></span>
- <span data-ttu-id="ae845-156">Una solución de terceros es más adecuada.</span><span class="sxs-lookup"><span data-stu-id="ae845-156">A third-party solution is more appropriate.</span></span> <span data-ttu-id="ae845-157">Por ejemplo, el servicio Microsoft Azure HDInsight (basado en Apache Hadoop) usa los servicios que proporciona Apache Zookeeper para coordinar las tareas de asignación y reducción que recopilan y resumen los datos.</span><span class="sxs-lookup"><span data-stu-id="ae845-157">For example, the Microsoft Azure HDInsight service (based on Apache Hadoop) uses the services provided by Apache Zookeeper to coordinate the map and reduce tasks that collect and summarize data.</span></span>

## <a name="example"></a><span data-ttu-id="ae845-158">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="ae845-158">Example</span></span>

<span data-ttu-id="ae845-159">El proyecto DistributedMutex de la solución LeaderElection (se puede encontrar un ejemplo que demuestra este patrón en [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election)) muestra cómo usar una concesión en un blob de Azure Storage para proporcionar un mecanismo a fin de implementar una exclusión mutua distribuida compartida.</span><span class="sxs-lookup"><span data-stu-id="ae845-159">The DistributedMutex project in the LeaderElection solution (a sample that demonstrates this pattern is available on [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election)) shows how to use a lease on an Azure Storage blob to provide a mechanism for implementing a shared, distributed mutex.</span></span> <span data-ttu-id="ae845-160">Esta exclusión mutua puede usarse para elegir un líder entre un grupo de instancias de rol de un servicio en la nube de Azure.</span><span class="sxs-lookup"><span data-stu-id="ae845-160">This mutex can be used to elect a leader among a group of role instances in an Azure cloud service.</span></span> <span data-ttu-id="ae845-161">La primera instancia de rol en adquirir la concesión se elige como líder y lo sigue siendo hasta que libera la concesión o es incapaz de renovarla.</span><span class="sxs-lookup"><span data-stu-id="ae845-161">The first role instance to acquire the lease is elected the leader, and remains the leader until it releases the lease or isn't able to renew the lease.</span></span> <span data-ttu-id="ae845-162">Otras instancias de rol pueden continuar con la supervisión de la concesión del blob en caso de que el líder ya no esté disponible.</span><span class="sxs-lookup"><span data-stu-id="ae845-162">Other role instances can continue to monitor the blob lease in case the leader is no longer available.</span></span>

> <span data-ttu-id="ae845-163">Una concesión de blob es un bloqueo exclusivo de escritura sobre un blob.</span><span class="sxs-lookup"><span data-stu-id="ae845-163">A blob lease is an exclusive write lock over a blob.</span></span> <span data-ttu-id="ae845-164">Un único blob solo puede ser el sujeto de una concesión en cualquier momento en el tiempo.</span><span class="sxs-lookup"><span data-stu-id="ae845-164">A single blob can be the subject of only one lease at any point in time.</span></span> <span data-ttu-id="ae845-165">Una instancia de rol puede solicitar una concesión sobre un blob especificado y se le concederá la concesión si ninguna otra instancia de rol mantiene una concesión sobre el mismo blob.</span><span class="sxs-lookup"><span data-stu-id="ae845-165">A role instance can request a lease over a specified blob, and it'll be granted the lease if no other role instance holds a lease over the same blob.</span></span> <span data-ttu-id="ae845-166">En caso contrario, la solicitud inicia una excepción.</span><span class="sxs-lookup"><span data-stu-id="ae845-166">Otherwise the request will throw an exception.</span></span>
>
> <span data-ttu-id="ae845-167">Para evitar que una instancia de rol con errores conserve la concesión de forma indefinida, especifique una duración para la concesión.</span><span class="sxs-lookup"><span data-stu-id="ae845-167">To avoid a faulted role instance retaining the lease indefinitely, specify a lifetime for the lease.</span></span> <span data-ttu-id="ae845-168">Cuando expire, la concesión estará disponible.</span><span class="sxs-lookup"><span data-stu-id="ae845-168">When this expires, the lease becomes available.</span></span> <span data-ttu-id="ae845-169">Sin embargo, mientras una instancia de rol mantenga la concesión puede solicitar que ésta se renueve, así que se le otorgará durante un periodo de tiempo adicional.</span><span class="sxs-lookup"><span data-stu-id="ae845-169">However, while a role instance holds the lease it can request that the lease is renewed, and it'll be granted the lease for a further period of time.</span></span> <span data-ttu-id="ae845-170">La instancia de rol puede repetir continuamente este proceso si desea conservar la concesión.</span><span class="sxs-lookup"><span data-stu-id="ae845-170">The role instance can continually repeat this process if it wants to retain the lease.</span></span>
> <span data-ttu-id="ae845-171">Para más información sobre cómo conceder un blob, consulte [Lease Blob (API de REST)](https://msdn.microsoft.com/library/azure/ee691972.aspx).</span><span class="sxs-lookup"><span data-stu-id="ae845-171">For more information on how to lease a blob, see [Lease Blob (REST API)](https://msdn.microsoft.com/library/azure/ee691972.aspx).</span></span>

<span data-ttu-id="ae845-172">La clase `BlobDistributedMutex` del ejemplo de C# contiene el método `RunTaskWhenMutexAquired` que permite que una instancia de rol intente adquirir una concesión sobre un blob especificado.</span><span class="sxs-lookup"><span data-stu-id="ae845-172">The `BlobDistributedMutex` class in the C# example below contains the `RunTaskWhenMutexAquired` method that enables a role instance to attempt to acquire a lease over a specified blob.</span></span> <span data-ttu-id="ae845-173">Los detalles del blog (el nombre, el contenedor y la cuenta de almacenamiento) se pasan al constructor en un objeto `BlobSettings` cuando se crea el objeto `BlobDistributedMutex` (este objeto es una estructura sencilla que se incluye el código de ejemplo).</span><span class="sxs-lookup"><span data-stu-id="ae845-173">The details of the blob (the name, container, and storage account) are passed to the constructor in a `BlobSettings` object when the `BlobDistributedMutex` object is created (this object is a simple struct that is included in the sample code).</span></span> <span data-ttu-id="ae845-174">El constructor también acepta un elemento `Task` que hace referencia al código que debe ejecutar la instancia de rol si adquiere correctamente la concesión sobre el blob y se elige como líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-174">The constructor also accepts a `Task` that references the code that the role instance should run if it successfully acquires the lease over the blob and is elected the leader.</span></span> <span data-ttu-id="ae845-175">Tenga en cuenta que el código que administra los detalles de bajo nivel de adquisición de la concesión se implementa en una clase auxiliar independiente llamada `BlobLeaseManager`.</span><span class="sxs-lookup"><span data-stu-id="ae845-175">Note that the code that handles the low-level details of acquiring the lease is implemented in a separate helper class named `BlobLeaseManager`.</span></span>

```csharp
public class BlobDistributedMutex
{
  ...
  private readonly BlobSettings blobSettings;
  private readonly Func<CancellationToken, Task> taskToRunWhenLeaseAcquired;
  ...

  public BlobDistributedMutex(BlobSettings blobSettings,
           Func<CancellationToken, Task> taskToRunWhenLeaseAquired)
  {
    this.blobSettings = blobSettings;
    this.taskToRunWhenLeaseAquired = taskToRunWhenLeaseAquired;
  }

  public async Task RunTaskWhenMutexAcquired(CancellationToken token)
  {
    var leaseManager = new BlobLeaseManager(blobSettings);
    await this.RunTaskWhenBlobLeaseAcquired(leaseManager, token);
  }
  ...
```

<span data-ttu-id="ae845-176">El método `RunTaskWhenMutexAquired` del código de ejemplo anterior invoca el método `RunTaskWhenBlobLeaseAcquired` mostrado en el código de ejemplo siguiente para adquirir realmente la concesión.</span><span class="sxs-lookup"><span data-stu-id="ae845-176">The `RunTaskWhenMutexAquired` method in the code sample above invokes the `RunTaskWhenBlobLeaseAcquired` method shown in the following code sample to actually acquire the lease.</span></span> <span data-ttu-id="ae845-177">El método `RunTaskWhenBlobLeaseAcquired` se ejecuta de forma asincrónica.</span><span class="sxs-lookup"><span data-stu-id="ae845-177">The `RunTaskWhenBlobLeaseAcquired` method runs asynchronously.</span></span> <span data-ttu-id="ae845-178">Si la concesión se adquirió correctamente, la instancia de rol se elige como líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-178">If the lease is successfully acquired, the role instance has been elected the leader.</span></span> <span data-ttu-id="ae845-179">El propósito del delegado `taskToRunWhenLeaseAcquired` es realizar el trabajo que coordina las otras instancias de rol.</span><span class="sxs-lookup"><span data-stu-id="ae845-179">The purpose of the `taskToRunWhenLeaseAcquired` delegate is to perform the work that coordinates the other role instances.</span></span> <span data-ttu-id="ae845-180">Si la concesión no se adquiere, otra instancia de rol se elije como líder y la instancia de rol actual queda como la subordinada.</span><span class="sxs-lookup"><span data-stu-id="ae845-180">If the lease isn't acquired, another role instance has been elected as the leader and the current role instance remains a subordinate.</span></span> <span data-ttu-id="ae845-181">Tenga en cuenta que el método `TryAcquireLeaseOrWait` es un método auxiliar que utiliza el objeto `BlobLeaseManager` para adquirir la concesión.</span><span class="sxs-lookup"><span data-stu-id="ae845-181">Note that the `TryAcquireLeaseOrWait` method is a helper method that uses the `BlobLeaseManager` object to acquire the lease.</span></span>

```csharp
  private async Task RunTaskWhenBlobLeaseAcquired(
    BlobLeaseManager leaseManager, CancellationToken token)
  {
    while (!token.IsCancellationRequested)
    {
      // Try to acquire the blob lease.
      // Otherwise wait for a short time before trying again.
      string leaseId = await this.TryAquireLeaseOrWait(leaseManager, token);

      if (!string.IsNullOrEmpty(leaseId))
      {
        // Create a new linked cancellation token source so that if either the
        // original token is canceled or the lease can't be renewed, the
        // leader task can be canceled.
        using (var leaseCts =
          CancellationTokenSource.CreateLinkedTokenSource(new[] { token }))
        {
          // Run the leader task.
          var leaderTask = this.taskToRunWhenLeaseAquired.Invoke(leaseCts.Token);
          ...
        }
      }
    }
    ...
  }
```

<span data-ttu-id="ae845-182">La tarea iniciada por el líder también se ejecuta de manera asincrónica.</span><span class="sxs-lookup"><span data-stu-id="ae845-182">The task started by the leader also runs asynchronously.</span></span> <span data-ttu-id="ae845-183">Mientras se ejecuta esta tarea, el método `RunTaskWhenBlobLeaseAquired` mostrado en el siguiente código de ejemplo intenta periódicamente renovar la concesión.</span><span class="sxs-lookup"><span data-stu-id="ae845-183">While this task is running, the `RunTaskWhenBlobLeaseAquired` method shown in the following code sample periodically attempts to renew the lease.</span></span> <span data-ttu-id="ae845-184">Esto ayuda a garantizar que la instancia de rol sigue siendo el líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-184">This helps to ensure that the role instance remains the leader.</span></span> <span data-ttu-id="ae845-185">En la solución de ejemplo, el retraso entre solicitudes de renovación es menor que el tiempo especificado para la duración de la concesión a fin de evitar que otra instancia de rol se elija como líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-185">In the sample solution, the delay between renewal requests is less than the time specified for the duration of the lease in order to prevent another role instance from being elected the leader.</span></span> <span data-ttu-id="ae845-186">Si se produce un error en la renovación por cualquier motivo, se cancela la tarea.</span><span class="sxs-lookup"><span data-stu-id="ae845-186">If the renewal fails for any reason, the task is canceled.</span></span>

<span data-ttu-id="ae845-187">Si no se renueva la concesión o se cancela la tarea (probablemente debido al cierre de la instancia de rol), se libera la concesión.</span><span class="sxs-lookup"><span data-stu-id="ae845-187">If the lease fails to be renewed or the task is canceled (possibly as a result of the role instance shutting down), the lease is released.</span></span> <span data-ttu-id="ae845-188">En este momento, esta u otra instancia de rol podrían elegirse como líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-188">At this point, this or another role instance might be elected as the leader.</span></span> <span data-ttu-id="ae845-189">El extracto de código siguiente muestra esta parte del proceso.</span><span class="sxs-lookup"><span data-stu-id="ae845-189">The code extract below shows this part of the process.</span></span>

```csharp
  private async Task RunTaskWhenBlobLeaseAcquired(
    BlobLeaseManager leaseManager, CancellationToken token)
  {
    while (...)
    {
      ...
      if (...)
      {
        ...
        using (var leaseCts = ...)
        {
          ...
          // Keep renewing the lease in regular intervals.
          // If the lease can't be renewed, then the task completes.
          var renewLeaseTask =
            this.KeepRenewingLease(leaseManager, leaseId, leaseCts.Token);

          // When any task completes (either the leader task itself or when it
          // couldn't renew the lease) then cancel the other task.
          await CancelAllWhenAnyCompletes(leaderTask, renewLeaseTask, leaseCts);
        }
      }
    }
  }
  ...
}
```

<span data-ttu-id="ae845-190">El método `KeepRenewingLease` es otro método auxiliar que usa el objeto `BlobLeaseManager` para renovar la concesión.</span><span class="sxs-lookup"><span data-stu-id="ae845-190">The `KeepRenewingLease` method is another helper method that uses the `BlobLeaseManager` object to renew the lease.</span></span> <span data-ttu-id="ae845-191">El método `CancelAllWhenAnyCompletes` cancela las tareas especificadas como los dos primeros parámetros.</span><span class="sxs-lookup"><span data-stu-id="ae845-191">The `CancelAllWhenAnyCompletes` method cancels the tasks specified as the first two parameters.</span></span> <span data-ttu-id="ae845-192">En el diagrama siguiente se ilustra el uso de la clase `BlobDistributedMutex` para elegir un líder y ejecutar una tarea que coordina las operaciones.</span><span class="sxs-lookup"><span data-stu-id="ae845-192">The following diagram illustrates using the `BlobDistributedMutex` class to elect a leader and run a task that coordinates operations.</span></span>

![La figura 1 muestra las funciones de la clase BlobDistributedMutex.](./_images/leader-election-diagram.png)

<span data-ttu-id="ae845-194">En el código de ejemplo siguiente se muestra cómo usar la clase `BlobDistributedMutex` en un rol de trabajo.</span><span class="sxs-lookup"><span data-stu-id="ae845-194">The following code example shows how to use the `BlobDistributedMutex` class in a worker role.</span></span> <span data-ttu-id="ae845-195">Este código adquiere una concesión sobre un blob denominado `MyLeaderCoordinatorTask` en el contenedor de la concesión en el almacenamiento de desarrollo y especifica que el código definido en el método `MyLeaderCoordinatorTask` debe ejecutarse si la instancia de rol se elige como líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-195">This code acquires a lease over a blob named `MyLeaderCoordinatorTask` in the lease's container in development storage, and specifies that the code defined in the `MyLeaderCoordinatorTask` method should run if the role instance is elected the leader.</span></span>

```csharp
var settings = new BlobSettings(CloudStorageAccount.DevelopmentStorageAccount,
  "leases", "MyLeaderCoordinatorTask");
var cts = new CancellationTokenSource();
var mutex = new BlobDistributedMutex(settings, MyLeaderCoordinatorTask);
mutex.RunTaskWhenMutexAcquired(this.cts.Token);
...

// Method that runs if the role instance is elected the leader
private static async Task MyLeaderCoordinatorTask(CancellationToken token)
{
  ...
}
```

<span data-ttu-id="ae845-196">Tenga en cuenta los siguientes puntos acerca de la solución de ejemplo:</span><span class="sxs-lookup"><span data-stu-id="ae845-196">Note the following points about the sample solution:</span></span>

- <span data-ttu-id="ae845-197">El blob es un posible único punto de error.</span><span class="sxs-lookup"><span data-stu-id="ae845-197">The blob is a potential single point of failure.</span></span> <span data-ttu-id="ae845-198">Si el servicio de blob deja de estar disponible, o no es accesible, el líder no podrá renovar la concesión y ninguna otra instancia de rol podrá adquirirla.</span><span class="sxs-lookup"><span data-stu-id="ae845-198">If the blob service becomes unavailable, or is inaccessible, the leader won't be able to renew the lease and no other role instance will be able to acquire the lease.</span></span> <span data-ttu-id="ae845-199">En este caso, ninguna instancia de rol podrá funcionar como líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-199">In this case, no role instance will be able to act as the leader.</span></span> <span data-ttu-id="ae845-200">Sin embargo, el servicio de blob está diseñado para ser resistente, por lo que se considera improbable el error completo de dicho servicio.</span><span class="sxs-lookup"><span data-stu-id="ae845-200">However, the blob service is designed to be resilient, so complete failure of the blob service is considered to be extremely unlikely.</span></span>
- <span data-ttu-id="ae845-201">Si la tarea que realiza el líder se detiene, el líder puede continuar y renovar la concesión, lo que impide que cualquier otra instancia de rol pueda adquirirla y asuma el rol de líder para coordinar las tareas.</span><span class="sxs-lookup"><span data-stu-id="ae845-201">If the task being performed by the leader stalls, the leader might continue to renew the lease, preventing any other role instance from acquiring the lease and taking over the leader role in order to coordinate tasks.</span></span> <span data-ttu-id="ae845-202">En el mundo real, se debe comprobar el mantenimiento del líder a intervalos frecuentes.</span><span class="sxs-lookup"><span data-stu-id="ae845-202">In the real world, the health of the leader should be checked at frequent intervals.</span></span>
- <span data-ttu-id="ae845-203">El proceso de elección es no determinista.</span><span class="sxs-lookup"><span data-stu-id="ae845-203">The election process is nondeterministic.</span></span> <span data-ttu-id="ae845-204">No se puede realizar ninguna suposición acerca de qué instancia de rol adquirirá la concesión del blob y se convertirá en líder.</span><span class="sxs-lookup"><span data-stu-id="ae845-204">You can't make any assumptions about which role instance will acquire the blob lease and become the leader.</span></span>
- <span data-ttu-id="ae845-205">El blob que se usa como el destino de la concesión no debe usarse para otros fines.</span><span class="sxs-lookup"><span data-stu-id="ae845-205">The blob used as the target of the blob lease shouldn't be used for any other purpose.</span></span> <span data-ttu-id="ae845-206">Si una instancia de rol intenta almacenar datos en este blob, estos datos no podrán estar accesibles a menos que la instancia de rol sea el líder y mantenga la concesión del blob.</span><span class="sxs-lookup"><span data-stu-id="ae845-206">If a role instance attempts to store data in this blob, this data won't be accessible unless the role instance is the leader and holds the blob lease.</span></span>

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="ae845-207">Orientación y patrones relacionados</span><span class="sxs-lookup"><span data-stu-id="ae845-207">Related patterns and guidance</span></span>

<span data-ttu-id="ae845-208">Las directrices siguientes también pueden ser importantes a la hora de implementar este patrón:</span><span class="sxs-lookup"><span data-stu-id="ae845-208">The following guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="ae845-209">Este patrón tiene una [aplicación de ejemplo](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election) descargable.</span><span class="sxs-lookup"><span data-stu-id="ae845-209">This pattern has a downloadable [sample application](https://github.com/mspnp/cloud-design-patterns/tree/master/leader-election).</span></span>
- <span data-ttu-id="ae845-210">[Guía de escalado automático](https://msdn.microsoft.com/library/dn589774.aspx).</span><span class="sxs-lookup"><span data-stu-id="ae845-210">[Autoscaling Guidance](https://msdn.microsoft.com/library/dn589774.aspx).</span></span> <span data-ttu-id="ae845-211">Es posible iniciar y detener instancias de los hosts de las tareas a medida que varía la carga de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="ae845-211">It's possible to start and stop instances of the task hosts as the load on the application varies.</span></span> <span data-ttu-id="ae845-212">El escalado automático puede ayudar a mantener el rendimiento y la capacidad de proceso durante los períodos de procesamiento máximo.</span><span class="sxs-lookup"><span data-stu-id="ae845-212">Autoscaling can help to maintain throughput and performance during times of peak processing.</span></span>
- <span data-ttu-id="ae845-213">[Compute Partitioning Guidance](https://msdn.microsoft.com/library/dn589773.aspx) (Orientación sobre la creación de particiones de proceso).</span><span class="sxs-lookup"><span data-stu-id="ae845-213">[Compute Partitioning Guidance](https://msdn.microsoft.com/library/dn589773.aspx).</span></span> <span data-ttu-id="ae845-214">En esta guía se describe cómo asignar tareas a los hosts de un servicio en la nube de tal forma que ayude a reducir los costes de ejecución mientras se mantiene la escalabilidad, el rendimiento, la disponibilidad y la seguridad del servicio.</span><span class="sxs-lookup"><span data-stu-id="ae845-214">This guidance describes how to allocate tasks to hosts in a cloud service in a way that helps to minimize running costs while maintaining the scalability, performance, availability, and security of the service.</span></span>
- <span data-ttu-id="ae845-215">El [patrón Task-based Asynchronous](https://msdn.microsoft.com/library/hh873175.aspx).</span><span class="sxs-lookup"><span data-stu-id="ae845-215">The [Task-based Asynchronous Pattern](https://msdn.microsoft.com/library/hh873175.aspx).</span></span>
- <span data-ttu-id="ae845-216">Un ejemplo que ilustra el [algoritmo Bully](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html).</span><span class="sxs-lookup"><span data-stu-id="ae845-216">An example illustrating the [Bully Algorithm](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/BullyExample.html).</span></span>
- <span data-ttu-id="ae845-217">Un ejemplo que ilustra el [algoritmo Ring](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span><span class="sxs-lookup"><span data-stu-id="ae845-217">An example illustrating the [Ring Algorithm](https://www.cs.colostate.edu/~cs551/CourseNotes/Synchronization/RingElectExample.html).</span></span>
- <span data-ttu-id="ae845-218">[Apache Curator](https://curator.apache.org/) una biblioteca cliente de Apache ZooKeeper.</span><span class="sxs-lookup"><span data-stu-id="ae845-218">[Apache Curator](https://curator.apache.org/) a client library for Apache ZooKeeper.</span></span>
- <span data-ttu-id="ae845-219">El artículo [Lease Blob (API de REST)](https://msdn.microsoft.com/library/azure/ee691972.aspx) en MSDN.</span><span class="sxs-lookup"><span data-stu-id="ae845-219">The article [Lease Blob (REST API)](https://msdn.microsoft.com/library/azure/ee691972.aspx) on MSDN.</span></span>
