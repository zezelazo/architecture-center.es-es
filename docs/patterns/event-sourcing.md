---
title: Patrón Event Sourcing
titleSuffix: Cloud Design Patterns
description: Usa un almacén de solo anexar para registrar la serie completa de eventos que describen las acciones realizadas en los datos de un dominio.
keywords: Patrón de diseño
author: dragon119
ms.date: 06/23/2017
ms.custom: seodec18
ms.openlocfilehash: 56db321e33ecef17704eda4eda971ff3c7e44133
ms.sourcegitcommit: 680c9cef945dff6fee5e66b38e24f07804510fa9
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 01/04/2019
ms.locfileid: "54011640"
---
# <a name="event-sourcing-pattern"></a><span data-ttu-id="a797e-104">Patrón Event Sourcing</span><span class="sxs-lookup"><span data-stu-id="a797e-104">Event Sourcing pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="a797e-105">En lugar de almacenar simplemente el estado actual de los datos de un dominio, use un almacén de solo anexar para registrar toda la serie de acciones realizadas en los datos.</span><span class="sxs-lookup"><span data-stu-id="a797e-105">Instead of storing just the current state of the data in a domain, use an append-only store to record the full series of actions taken on that data.</span></span>
<span data-ttu-id="a797e-106">El almacén actúa como el sistema de registro y puede usarse para materializar los objetos de dominio.</span><span class="sxs-lookup"><span data-stu-id="a797e-106">The store acts as the system of record and can be used to materialize the domain objects.</span></span> <span data-ttu-id="a797e-107">Esto puede simplificar las tareas en los dominios complejos, al evitar la necesidad de sincronizar el modelo de datos y el dominio empresarial, al tiempo que mejora el rendimiento, la escalabilidad y la capacidad de respuesta.</span><span class="sxs-lookup"><span data-stu-id="a797e-107">This can simplify tasks in complex domains, by avoiding the need to synchronize the data model and the business domain, while improving performance, scalability, and responsiveness.</span></span> <span data-ttu-id="a797e-108">También proporciona coherencia a los datos transaccionales y conserva trazas de auditoría e historiales completos que permiten acciones de compensación.</span><span class="sxs-lookup"><span data-stu-id="a797e-108">It can also provide consistency for transactional data, and maintain full audit trails and history that can enable compensating actions.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="a797e-109">Contexto y problema</span><span class="sxs-lookup"><span data-stu-id="a797e-109">Context and problem</span></span>

<span data-ttu-id="a797e-110">La mayoría de las aplicaciones trabajan con datos; el enfoque típico es que la aplicación mantenga el estado actual de los datos mediante su actualización conforme los usuarios trabajan con ellos.</span><span class="sxs-lookup"><span data-stu-id="a797e-110">Most applications work with data, and the typical approach is for the application to maintain the current state of the data by updating it as users work with it.</span></span> <span data-ttu-id="a797e-111">Por ejemplo, en el modelo tradicional de creación, lectura, actualización y eliminación (CRUD), un proceso de datos típico consiste en leer datos del almacén, realizar algunas modificaciones en ellos y actualizar su estado actual con los nuevos valores (a menudo mediante transacciones que bloquean los datos).</span><span class="sxs-lookup"><span data-stu-id="a797e-111">For example, in the traditional create, read, update, and delete (CRUD) model a typical data process is to read data from the store, make some modifications to it, and update the current state of the data with the new values&mdash;often by using transactions that lock the data.</span></span>

<span data-ttu-id="a797e-112">El enfoque CRUD tiene algunas limitaciones:</span><span class="sxs-lookup"><span data-stu-id="a797e-112">The CRUD approach has some limitations:</span></span>

- <span data-ttu-id="a797e-113">Los sistemas CRUD realizan operaciones de actualización directamente en un almacén de datos, lo que ralentiza el rendimiento y la capacidad de respuesta y limita la escalabilidad, a causa de la sobrecarga de procesamiento que requiere.</span><span class="sxs-lookup"><span data-stu-id="a797e-113">CRUD systems perform update operations directly against a data store, which can slow down performance and responsiveness, and limit scalability, due to the processing overhead it requires.</span></span>

- <span data-ttu-id="a797e-114">En un dominio de colaboración con muchos usuarios simultáneos, los conflictos de actualización de datos son más probables, dado que las operaciones de actualización tienen lugar en un solo elemento de datos.</span><span class="sxs-lookup"><span data-stu-id="a797e-114">In a collaborative domain with many concurrent users, data update conflicts are more likely because the update operations take place on a single item of data.</span></span>

- <span data-ttu-id="a797e-115">A menos que exista un mecanismo de auditoría adicional que registre los detalles de cada operación en un registro independiente, el historial se pierde.</span><span class="sxs-lookup"><span data-stu-id="a797e-115">Unless there's an additional auditing mechanism that records the details of each operation in a separate log, history is lost.</span></span>

> <span data-ttu-id="a797e-116">Para una mejor comprensión de los límites del enfoque CRUD, consulte [CRUD, Only When You Can Afford It](https://blogs.msdn.microsoft.com/maarten_mullender/2004/07/23/crud-only-when-you-can-afford-it-revisited/) (CRUD, solo cuando se lo pueda permitir).</span><span class="sxs-lookup"><span data-stu-id="a797e-116">For a deeper understanding of the limits of the CRUD approach see [CRUD, Only When You Can Afford It](https://blogs.msdn.microsoft.com/maarten_mullender/2004/07/23/crud-only-when-you-can-afford-it-revisited/).</span></span>

## <a name="solution"></a><span data-ttu-id="a797e-117">Solución</span><span class="sxs-lookup"><span data-stu-id="a797e-117">Solution</span></span>

<span data-ttu-id="a797e-118">El patrón Event Sourcing define un enfoque para controlar las operaciones basado en una secuencia de eventos, cada uno de los cuales se registra en un almacén de solo anexar.</span><span class="sxs-lookup"><span data-stu-id="a797e-118">The Event Sourcing pattern defines an approach to handling operations on data that's driven by a sequence of events, each of which is recorded in an append-only store.</span></span> <span data-ttu-id="a797e-119">El código de la aplicación envía una serie de eventos que imperativamente describen cada acción que se ha producido en los datos del almacén de eventos, donde se conservan.</span><span class="sxs-lookup"><span data-stu-id="a797e-119">Application code sends a series of events that imperatively describe each action that has occurred on the data to the event store, where they're persisted.</span></span> <span data-ttu-id="a797e-120">Cada evento representa un conjunto de cambios en los datos (como `AddedItemToOrder`).</span><span class="sxs-lookup"><span data-stu-id="a797e-120">Each event represents a set of changes to the data (such as `AddedItemToOrder`).</span></span>

<span data-ttu-id="a797e-121">Los eventos se conservan en un almacén de eventos que actúa como sistema de registro (origen de datos acreditado) del estado actual de los datos.</span><span class="sxs-lookup"><span data-stu-id="a797e-121">The events are persisted in an event store that acts as the system of record (the authoritative data source) about the current state of the data.</span></span> <span data-ttu-id="a797e-122">Normalmente, el almacén de eventos publica estos eventos para que los consumidores pueden recibir notificaciones y controlarlos si lo necesitan.</span><span class="sxs-lookup"><span data-stu-id="a797e-122">The event store typically publishes these events so that consumers can be notified and can handle them if needed.</span></span> <span data-ttu-id="a797e-123">Los consumidores podrían, por ejemplo, iniciar tareas que se aplican las operaciones en los eventos a otros sistemas o realizar cualquier acción asociada que se necesita para completar la operación.</span><span class="sxs-lookup"><span data-stu-id="a797e-123">Consumers could, for example, initiate tasks that apply the operations in the events to other systems, or perform any other associated action that's required to complete the operation.</span></span> <span data-ttu-id="a797e-124">Tenga en cuenta que el código de aplicación que genera los eventos es independiente de los sistemas que se suscriben a los eventos.</span><span class="sxs-lookup"><span data-stu-id="a797e-124">Notice that the application code that generates the events is decoupled from the systems that subscribe to the events.</span></span>

<span data-ttu-id="a797e-125">Los usos típicos de los eventos publicados por el almacén de eventos son el mantenimiento de vistas materializadas de entidades según las cambian las acciones de la aplicación y la integración con sistemas externos.</span><span class="sxs-lookup"><span data-stu-id="a797e-125">Typical uses of the events published by the event store are to maintain materialized views of entities as actions in the application change them, and for integration with external systems.</span></span> <span data-ttu-id="a797e-126">Por ejemplo, un sistema puede mantener una vista materializada de todos los pedidos de cliente que se usa para rellenar elementos de la interfaz de usuario.</span><span class="sxs-lookup"><span data-stu-id="a797e-126">For example, a system can maintain a materialized view of all customer orders that's used to populate parts of the UI.</span></span> <span data-ttu-id="a797e-127">Cuando la aplicación agrega pedidos nuevos, agrega o quita elementos del pedido y agrega información de envío, los eventos que describen estos cambios pueden se controlan y se utilizan para actualizar la [vista materializada](./materialized-view.md).</span><span class="sxs-lookup"><span data-stu-id="a797e-127">As the application adds new orders, adds or removes items on the order, and adds shipping information, the events that describe these changes can be handled and used to update the [materialized view](./materialized-view.md).</span></span>

<span data-ttu-id="a797e-128">Además, las aplicaciones pueden leer el historial de eventos en cualquier momento y usarlo para materializar el estado actual de una entidad al reproducir y consumir todos los eventos relacionados con esa entidad.</span><span class="sxs-lookup"><span data-stu-id="a797e-128">In addition, at any point it's possible for applications to read the history of events, and use it to materialize the current state of an entity by playing back and consuming all the events related to that entity.</span></span> <span data-ttu-id="a797e-129">Esto puede ocurrir a petición para materializar un objeto de dominio al controlar una solicitud, o a través de una tarea programada para que se puede almacenar el estado de la entidad como vista materializada para admitir la capa de presentación.</span><span class="sxs-lookup"><span data-stu-id="a797e-129">This can occur on demand to materialize a domain object when handling a request, or through a scheduled task so that the state of the entity can be stored as a materialized view to support the presentation layer.</span></span>

<span data-ttu-id="a797e-130">La ilustración muestra una introducción al patrón, incluidas algunas de las opciones de uso del flujo de eventos, como la creación de una vista materializada, la integración de eventos con aplicaciones y sistemas externos y la reproducción de eventos para crear proyecciones del estado actual de entidades específicas.</span><span class="sxs-lookup"><span data-stu-id="a797e-130">The figure shows an overview of the pattern, including some of the options for using the event stream such as creating a materialized view, integrating events with external applications and systems, and replaying events to create projections of the current state of specific entities.</span></span>

![Introducción y ejemplo del patrón Event Sourcing](./_images/event-sourcing-overview.png)

<span data-ttu-id="a797e-132">El patrón Event Sourcing proporciona las siguientes ventajas:</span><span class="sxs-lookup"><span data-stu-id="a797e-132">The Event Sourcing pattern provides the following advantages:</span></span>

- <span data-ttu-id="a797e-133">Los eventos son inmutables y pueden almacenarse mediante una operación de solo anexar.</span><span class="sxs-lookup"><span data-stu-id="a797e-133">Events are immutable and can be stored using an append-only operation.</span></span> <span data-ttu-id="a797e-134">La interfaz de usuario, el flujo de trabajo o el proceso que iniciaran un evento pueden continuar y las tareas que controlan los eventos se pueden ejecutar en segundo plano.</span><span class="sxs-lookup"><span data-stu-id="a797e-134">The user interface, workflow, or process that initiated an event can continue, and tasks that handle the events can run in the background.</span></span> <span data-ttu-id="a797e-135">Esto, junto con el hecho de que no hay ningún contención durante el procesamiento de transacciones, puede mejorar considerablemente el rendimiento y la escalabilidad de las aplicaciones, especialmente el nivel de presentación o la interfaz de usuario.</span><span class="sxs-lookup"><span data-stu-id="a797e-135">This, combined with the fact that there's no contention during the processing of transactions, can vastly improve performance and scalability for applications, especially for the presentation level or user interface.</span></span>

- <span data-ttu-id="a797e-136">Los eventos son objetos simples que describen alguna acción que se ha producido, junto con los datos asociados necesarios para describir la acción que representa el evento.</span><span class="sxs-lookup"><span data-stu-id="a797e-136">Events are simple objects that describe some action that occurred, together with any associated data required to describe the action represented by the event.</span></span> <span data-ttu-id="a797e-137">Los eventos no actualizan directamente un almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="a797e-137">Events don't directly update a data store.</span></span> <span data-ttu-id="a797e-138">Simplemente se registran para el control en el momento adecuado.</span><span class="sxs-lookup"><span data-stu-id="a797e-138">They're simply recorded for handling at the appropriate time.</span></span> <span data-ttu-id="a797e-139">Esto puede simplificar la implementación y la administración.</span><span class="sxs-lookup"><span data-stu-id="a797e-139">This can simplify implementation and management.</span></span>

- <span data-ttu-id="a797e-140">Los eventos suelen tener significado para un experto de dominio, mientras que los [errores de coincidencia de impedancia relacional de objetos](https://en.wikipedia.org/wiki/Object-relational_impedance_mismatch) pueden dificultar la comprensión de las tablas de base de datos complejas.</span><span class="sxs-lookup"><span data-stu-id="a797e-140">Events typically have meaning for a domain expert, whereas [object-relational impedance mismatch](https://en.wikipedia.org/wiki/Object-relational_impedance_mismatch) can make complex database tables hard to understand.</span></span> <span data-ttu-id="a797e-141">Las tablas son construcciones artificiales que representan el estado actual del sistema, no los eventos que se han producido.</span><span class="sxs-lookup"><span data-stu-id="a797e-141">Tables are artificial constructs that represent the current state of the system, not the events that occurred.</span></span>

- <span data-ttu-id="a797e-142">Event Sourcing puede ayudar a impedir que las actualizaciones simultáneas causen conflictos, ya que evita la necesidad de actualizar directamente los objetos en el almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="a797e-142">Event sourcing can help prevent concurrent updates from causing conflicts because it avoids the requirement to directly update objects in the data store.</span></span> <span data-ttu-id="a797e-143">Sin embargo, el modelo de dominio debe diseñarse aún para protegerlo de las solicitudes que puedan generar incoherencias.</span><span class="sxs-lookup"><span data-stu-id="a797e-143">However, the domain model must still be designed to protect itself from requests that might result in an inconsistent state.</span></span>

- <span data-ttu-id="a797e-144">El almacenamiento de solo anexar eventos proporciona una traza de auditoría para supervisar las acciones realizadas en un almacén de datos, volver a crear el estado actual como vista materializada o proyecciones (al reproducir los eventos en cualquier momento) y ayudar a probar y depurar el sistema.</span><span class="sxs-lookup"><span data-stu-id="a797e-144">The append-only storage of events provides an audit trail that can be used to monitor actions taken against a data store, regenerate the current state as materialized views or projections by replaying the events at any time, and assist in testing and debugging the system.</span></span> <span data-ttu-id="a797e-145">Además, el requisito de usar eventos de compensación para cancelar cambios proporciona un historial de los cambios revertidos, que no sería el caso si el modelo simplemente almacenara el estado actual.</span><span class="sxs-lookup"><span data-stu-id="a797e-145">In addition, the requirement to use compensating events to cancel changes provides a history of changes that were reversed, which wouldn't be the case if the model simply stored the current state.</span></span> <span data-ttu-id="a797e-146">La lista de eventos también puede utilizarse para analizar el rendimiento de la aplicación y detectar las tendencias de comportamiento de los usuarios o para obtener otra información empresarial de utilidad.</span><span class="sxs-lookup"><span data-stu-id="a797e-146">The list of events can also be used to analyze application performance and detect user behavior trends, or to obtain other useful business information.</span></span>

- <span data-ttu-id="a797e-147">El almacén de eventos genera eventos y las tareas realizan operaciones en respuesta a esos eventos.</span><span class="sxs-lookup"><span data-stu-id="a797e-147">The event store raises events, and tasks perform operations in response to those events.</span></span> <span data-ttu-id="a797e-148">Esta separación de las tareas de los eventos proporciona flexibilidad y extensibilidad.</span><span class="sxs-lookup"><span data-stu-id="a797e-148">This decoupling of the tasks from the events provides flexibility and extensibility.</span></span> <span data-ttu-id="a797e-149">Las tareas conocen el tipo de evento y los datos del evento, pero no la operación que lo desencadenó.</span><span class="sxs-lookup"><span data-stu-id="a797e-149">Tasks know about the type of event and the event data, but not about the operation that triggered the event.</span></span> <span data-ttu-id="a797e-150">Además, varias tareas pueden controlar el mismo evento.</span><span class="sxs-lookup"><span data-stu-id="a797e-150">In addition, multiple tasks can handle each event.</span></span> <span data-ttu-id="a797e-151">Esto facilita la integración con otros servicios y sistemas que solo escuchen los nuevos eventos que genere el almacén de eventos.</span><span class="sxs-lookup"><span data-stu-id="a797e-151">This enables easy integration with other services and systems that only listen for new events raised by the event store.</span></span> <span data-ttu-id="a797e-152">Sin embargo, los eventos de Event Sourcing tienden a ser de muy bajo nivel, por lo que podría ser necesaria la creación de eventos de integración específicos en su lugar.</span><span class="sxs-lookup"><span data-stu-id="a797e-152">However, the event sourcing events tend to be very low level, and it might be necessary to generate specific integration events instead.</span></span>

> <span data-ttu-id="a797e-153">Event Sourcing suele combinarse con el patrón CQRS, ya que realiza las tareas de administración de datos en respuesta a los eventos y materializa las vistas de los eventos almacenados.</span><span class="sxs-lookup"><span data-stu-id="a797e-153">Event sourcing is commonly combined with the CQRS pattern by performing the data management tasks in response to the events, and by materializing views from the stored events.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="a797e-154">Problemas y consideraciones</span><span class="sxs-lookup"><span data-stu-id="a797e-154">Issues and considerations</span></span>

<span data-ttu-id="a797e-155">Tenga en cuenta los puntos siguientes al decidir cómo implementar este patrón:</span><span class="sxs-lookup"><span data-stu-id="a797e-155">Consider the following points when deciding how to implement this pattern:</span></span>

<span data-ttu-id="a797e-156">El sistema solo será coherente al crear vistas materializadas o proyecciones de los datos mediante la reproducción de eventos.</span><span class="sxs-lookup"><span data-stu-id="a797e-156">The system will only be eventually consistent when creating materialized views or generating projections of data by replaying events.</span></span> <span data-ttu-id="a797e-157">Existe cierto retardo desde que la aplicación agrega eventos al almacén tras administrar una solicitud, hasta que se publican los eventos y los consumidores de estos los controlan.</span><span class="sxs-lookup"><span data-stu-id="a797e-157">There's some delay between an application adding events to the event store as the result of handling a request, the events being published, and consumers of the events handling them.</span></span> <span data-ttu-id="a797e-158">Durante este período pueden haber llegado al almacén eventos nuevos que describan más cambios en las entidades.</span><span class="sxs-lookup"><span data-stu-id="a797e-158">During this period, new events that describe further changes to entities might have arrived at the event store.</span></span>

> [!NOTE]
> <span data-ttu-id="a797e-159">Consulte [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx)(Manual básico de coherencia de datos) para información sobre la coherencia final.</span><span class="sxs-lookup"><span data-stu-id="a797e-159">See the [Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) for information about eventual consistency.</span></span>

<span data-ttu-id="a797e-160">El almacén de eventos es la fuente permanente de información, por lo que los datos de los eventos no deben actualizarse.</span><span class="sxs-lookup"><span data-stu-id="a797e-160">The event store is the permanent source of information, and so the event data should never be updated.</span></span> <span data-ttu-id="a797e-161">Es la única manera de actualizar una entidad para deshacer un cambio es agregar un evento de compensación al almacén de eventos.</span><span class="sxs-lookup"><span data-stu-id="a797e-161">The only way to update an entity to undo a change is to add a compensating event to the event store.</span></span> <span data-ttu-id="a797e-162">Si necesita cambiar el formato (en lugar de los propios datos) de los eventos persistentes, quizás durante una migración, puede ser difícil combinar los eventos existentes en el almacén con la nueva versión.</span><span class="sxs-lookup"><span data-stu-id="a797e-162">If the format (rather than the data) of the persisted events needs to change, perhaps during a migration, it can be difficult to combine existing events in the store with the new version.</span></span> <span data-ttu-id="a797e-163">Podría ser necesario recorrer en iteración todos los eventos con cambios para que sean compatibles con el nuevo formato o agregar nuevos eventos que utilicen el nuevo formato.</span><span class="sxs-lookup"><span data-stu-id="a797e-163">It might be necessary to iterate through all the events making changes so they're compliant with the new format, or add new events that use the new format.</span></span> <span data-ttu-id="a797e-164">Considere el uso de una marca de versión para cada versión del esquema de evento para mantener el formato antiguo y el nuevo.</span><span class="sxs-lookup"><span data-stu-id="a797e-164">Consider using a version stamp on each version of the event schema to maintain both the old and the new event formats.</span></span>

<span data-ttu-id="a797e-165">En el almacén de eventos pueden guardar eventos las aplicaciones multiproceso y varias instancias de aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="a797e-165">Multi-threaded applications and multiple instances of applications might be storing events in the event store.</span></span> <span data-ttu-id="a797e-166">La coherencia de los eventos del almacén es muy importante, ya que supone el orden de los eventos que afectan a una entidad específica (el orden en que se producen los cambios en una entidad afecta a su estado actual).</span><span class="sxs-lookup"><span data-stu-id="a797e-166">The consistency of events in the event store is vital, as is the order of events that affect a specific entity (the order that changes occur to an entity affects its current state).</span></span> <span data-ttu-id="a797e-167">Agregar una marca de tiempo para cada evento puede ayudar a evitar problemas.</span><span class="sxs-lookup"><span data-stu-id="a797e-167">Adding a timestamp to every event can help to avoid issues.</span></span> <span data-ttu-id="a797e-168">Otra práctica común consiste en anotar cada evento derivado de una solicitud con un identificador incremental.</span><span class="sxs-lookup"><span data-stu-id="a797e-168">Another common practice is to annotate each event resulting from a request with an incremental identifier.</span></span> <span data-ttu-id="a797e-169">Si dos acciones intentan agregar eventos a la misma entidad al mismo tiempo, el almacén de eventos puede rechazar uno cuyo identificador de entidad existente coincida con el identificador de evento.</span><span class="sxs-lookup"><span data-stu-id="a797e-169">If two actions attempt to add events for the same entity at the same time, the event store can reject an event that matches an existing entity identifier and event identifier.</span></span>

<span data-ttu-id="a797e-170">No hay ningún enfoque estándar ni mecanismos existentes como consultas SQL para leer los eventos y obtener información.</span><span class="sxs-lookup"><span data-stu-id="a797e-170">There's no standard approach, or existing mechanisms such as SQL queries, for reading the events to obtain information.</span></span> <span data-ttu-id="a797e-171">Los únicos datos que se pueden extraer son un flujo de eventos con un identificador de evento como criterio.</span><span class="sxs-lookup"><span data-stu-id="a797e-171">The only data that can be extracted is a stream of events using an event identifier as the criteria.</span></span> <span data-ttu-id="a797e-172">El identificador de evento normalmente se asigna a entidades individuales.</span><span class="sxs-lookup"><span data-stu-id="a797e-172">The event ID typically maps to individual entities.</span></span> <span data-ttu-id="a797e-173">Se puede determinar el estado actual de una entidad solo mediante la reproducción de todos los eventos relacionados con ella en comparación con el estado original de la entidad.</span><span class="sxs-lookup"><span data-stu-id="a797e-173">The current state of an entity can be determined only by replaying all of the events that relate to it against the original state of that entity.</span></span>

<span data-ttu-id="a797e-174">La longitud de los flujos de eventos afecta a la administración y la actualización del sistema.</span><span class="sxs-lookup"><span data-stu-id="a797e-174">The length of each event stream affects managing and updating the system.</span></span> <span data-ttu-id="a797e-175">Si son grandes, considere la posibilidad de crear instantáneas a intervalos específicos, como de un número determinado de eventos.</span><span class="sxs-lookup"><span data-stu-id="a797e-175">If the streams are large, consider creating snapshots at specific intervals such as a specified number of events.</span></span> <span data-ttu-id="a797e-176">El estado actual de la entidad puede obtenerse de la instantánea y al reproducir los eventos que se produjeran después de ese momento.</span><span class="sxs-lookup"><span data-stu-id="a797e-176">The current state of the entity can be obtained from the snapshot and by replaying any events that occurred after that point in time.</span></span> <span data-ttu-id="a797e-177">Para más información sobre la creación de instantáneas de datos, consulte [Snapshot](https://martinfowler.com/eaaDev/Snapshot.html) (Instantáneas) en el sitio web de la arquitectura de las aplicaciones empresariales de Martin Fowler y [Master-Subordinate Snapshot Replication](https://msdn.microsoft.com/library/ff650012.aspx) (Replicación maestro-subordinado de instantáneas).</span><span class="sxs-lookup"><span data-stu-id="a797e-177">For more information about creating snapshots of data, see [Snapshot on Martin Fowler’s Enterprise Application Architecture website](https://martinfowler.com/eaaDev/Snapshot.html) and [Master-Subordinate Snapshot Replication](https://msdn.microsoft.com/library/ff650012.aspx).</span></span>

<span data-ttu-id="a797e-178">Aunque Event Sourcing reduce la posibilidad de conflicto entre actualizaciones de los datos, la aplicación sigue teniendo que procesar las incoherencias derivadas de la coherencia final y la falta de transacciones.</span><span class="sxs-lookup"><span data-stu-id="a797e-178">Even though event sourcing minimizes the chance of conflicting updates to the data, the application must still be able to deal with inconsistencies that result from eventual consistency and the lack of transactions.</span></span> <span data-ttu-id="a797e-179">Por ejemplo, un evento que indica una reducción en el inventario estándar puede llegar al almacén de datos mientras se realiza un pedido de ese elemento, lo que requeriría una conciliación de las dos operaciones mediante un aviso al cliente o la creación de un pedido en espera.</span><span class="sxs-lookup"><span data-stu-id="a797e-179">For example, an event that indicates a reduction in stock inventory might arrive in the data store while an order for that item is being placed, resulting in a requirement to reconcile the two operations either by advising the customer or creating a back order.</span></span>

<span data-ttu-id="a797e-180">La publicación de eventos podría ser "al menos una vez", de manera que los consumidores de los eventos deben ser idempotentes.</span><span class="sxs-lookup"><span data-stu-id="a797e-180">Event publication might be “at least once,” and so consumers of the events must be idempotent.</span></span> <span data-ttu-id="a797e-181">No debe volver a aplicar la actualización descrita en un evento si este se controla más de una vez.</span><span class="sxs-lookup"><span data-stu-id="a797e-181">They must not reapply the update described in an event if the event is handled more than once.</span></span> <span data-ttu-id="a797e-182">Por ejemplo, si varias instancias de un consumidor mantienen un agregado de propiedades de una entidad, como el total de pedidos realizados, solo una debe incrementar correctamente el agregado cuando se produzca un evento de pedido realizado.</span><span class="sxs-lookup"><span data-stu-id="a797e-182">For example, if multiple instances of a consumer maintain an aggregate an entity's property, such as the total number of orders placed, only one must succeed in incrementing the aggregate when an order placed event occurs.</span></span> <span data-ttu-id="a797e-183">Aunque esto no es una característica clave de Event Sourcing, es la decisión de implementación habitual.</span><span class="sxs-lookup"><span data-stu-id="a797e-183">While this isn't a key characteristic of event sourcing, it's the usual implementation decision.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="a797e-184">Cuándo usar este patrón</span><span class="sxs-lookup"><span data-stu-id="a797e-184">When to use this pattern</span></span>

<span data-ttu-id="a797e-185">Use este patrón en los escenarios siguientes:</span><span class="sxs-lookup"><span data-stu-id="a797e-185">Use this pattern in the following scenarios:</span></span>

- <span data-ttu-id="a797e-186">Si desea capturar la intención, el propósito o el motivo en los datos.</span><span class="sxs-lookup"><span data-stu-id="a797e-186">When you want to capture intent, purpose, or reason in the data.</span></span> <span data-ttu-id="a797e-187">Por ejemplo, los cambios en una entidad de cliente se pueden capturar como una serie de tipos de evento específicos como _Cambio de domicilio_, _Cierre de cuenta_ o _Fallecimiento_.</span><span class="sxs-lookup"><span data-stu-id="a797e-187">For example, changes to a customer entity can be captured as a series of specific event types such as _Moved home_, _Closed account_, or _Deceased_.</span></span>

- <span data-ttu-id="a797e-188">Cuando es vital reducir o evitar por completo la aparición de actualizaciones de datos en conflicto.</span><span class="sxs-lookup"><span data-stu-id="a797e-188">When it's vital to minimize or completely avoid the occurrence of conflicting updates to data.</span></span>

- <span data-ttu-id="a797e-189">Si desea registrar los eventos que se produzcan y poder reproducirlos para restaurar el estado de un sistema, revertir cambios o mantener un historial y un registro de auditoría.</span><span class="sxs-lookup"><span data-stu-id="a797e-189">When you want to record events that occur, and be able to replay them to restore the state of a system, roll back changes, or keep a history and audit log.</span></span> <span data-ttu-id="a797e-190">Por ejemplo, cuando una tarea implica varios pasos, quizá deba ejecutar acciones para revertir las actualizaciones y, a continuación, reproducir algunos pasos para devolver los datos a un estado coherente.</span><span class="sxs-lookup"><span data-stu-id="a797e-190">For example, when a task involves multiple steps you might need to execute actions to revert updates and then replay some steps to bring the data back into a consistent state.</span></span>

- <span data-ttu-id="a797e-191">Cuando el uso de eventos es una característica natural de la operación de la aplicación y requiere poco esfuerzo de implementación o desarrollo adicional.</span><span class="sxs-lookup"><span data-stu-id="a797e-191">When using events is a natural feature of the operation of the application, and requires little additional development or implementation effort.</span></span>

- <span data-ttu-id="a797e-192">Cuando necesite desacoplar el proceso de entrada o actualización de datos de las tareas necesarias para aplicar estas acciones.</span><span class="sxs-lookup"><span data-stu-id="a797e-192">When you need to decouple the process of inputting or updating data from the tasks required to apply these actions.</span></span> <span data-ttu-id="a797e-193">Quizá para mejorar el rendimiento de la interfaz de usuario o para distribuir eventos a otros agentes de escucha que realicen acciones cuando se producen los eventos.</span><span class="sxs-lookup"><span data-stu-id="a797e-193">This might be to improve UI performance, or to distribute events to other listeners that take action when the events occur.</span></span> <span data-ttu-id="a797e-194">Por ejemplo, la integración de un sistema de nóminas con un sitio web de envío de gastos para que los eventos generados por el almacén de eventos en respuesta a las actualizaciones de datos en el sitio web los consuma tanto el sistema de nóminas como el sistema de nóminas.</span><span class="sxs-lookup"><span data-stu-id="a797e-194">For example, integrating a payroll system with an expense submission website so that events raised by the event store in response to data updates made in the website are consumed by both the website and the payroll system.</span></span>

- <span data-ttu-id="a797e-195">Si desea flexibilidad para cambiar el formato de los modelos materializados y los datos de la entidad si cambian los requisitos o cuando tenga que adaptar un modelo de lectura o las vistas que exponen los datos (cuando se utiliza junto con CQRS).</span><span class="sxs-lookup"><span data-stu-id="a797e-195">When you want flexibility to be able to change the format of materialized models and entity data if requirements change, or&mdash;when used in conjunction with CQRS&mdash;you need to adapt a read model or the views that expose the data.</span></span>

- <span data-ttu-id="a797e-196">Cuando se usa junto con CQRS y la coherencia final es aceptable mientras se actualiza un modelo de lectura o si el impacto sobre el rendimiento de rehidratar las entidades y los datos de un flujo de eventos es aceptable.</span><span class="sxs-lookup"><span data-stu-id="a797e-196">When used in conjunction with CQRS, and eventual consistency is acceptable while a read model is updated, or the performance impact of rehydrating entities and data from an event stream is acceptable.</span></span>

<span data-ttu-id="a797e-197">Este patrón podría no ser útil en las siguientes situaciones:</span><span class="sxs-lookup"><span data-stu-id="a797e-197">This pattern might not be useful in the following situations:</span></span>

- <span data-ttu-id="a797e-198">Dominios pequeños o simples, sistemas con poca o ninguna lógica de negocios o sistemas sin dominio que funcionan bien naturalmente con mecanismos de administración de datos CRUD tradicionales.</span><span class="sxs-lookup"><span data-stu-id="a797e-198">Small or simple domains, systems that have little or no business logic, or nondomain systems that naturally work well with traditional CRUD data management mechanisms.</span></span>

- <span data-ttu-id="a797e-199">Sistemas en los que se necesite coherencia y actualizaciones en las vistas de los datos en tiempo real.</span><span class="sxs-lookup"><span data-stu-id="a797e-199">Systems where consistency and real-time updates to the views of the data are required.</span></span>

- <span data-ttu-id="a797e-200">Sistemas donde no se necesiten trazas de auditoría, historial y capacidades para revertir y reproducir acciones.</span><span class="sxs-lookup"><span data-stu-id="a797e-200">Systems where audit trails, history, and capabilities to roll back and replay actions are not required.</span></span>

- <span data-ttu-id="a797e-201">Sistemas donde la cantidad de actualizaciones en conflicto en los datos subyacentes es muy baja.</span><span class="sxs-lookup"><span data-stu-id="a797e-201">Systems where there's only a very low occurrence of conflicting updates to the underlying data.</span></span> <span data-ttu-id="a797e-202">Por ejemplo, los sistemas que fundamentalmente agregan datos en lugar de actualizarlos.</span><span class="sxs-lookup"><span data-stu-id="a797e-202">For example, systems that predominantly add data rather than updating it.</span></span>

## <a name="example"></a><span data-ttu-id="a797e-203">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="a797e-203">Example</span></span>

<span data-ttu-id="a797e-204">Un sistema de administración de conferencias necesita realizar un seguimiento del número de reservas completadas para una conferencia con el fin de comprobar si hay plazas disponibles cuando un posible asistente intenta realizar una reserva.</span><span class="sxs-lookup"><span data-stu-id="a797e-204">A conference management system needs to track the number of completed bookings for a conference so that it can check whether there are seats still available when a potential attendee tries to make a booking.</span></span> <span data-ttu-id="a797e-205">El sistema puede almacenar el número total de reservas para una conferencia de al menos dos formas:</span><span class="sxs-lookup"><span data-stu-id="a797e-205">The system could store the total number of bookings for a conference in at least two ways:</span></span>

- <span data-ttu-id="a797e-206">Almacenar la información sobre el número total de reservas como una entidad independiente en una base de datos con la información de reserva.</span><span class="sxs-lookup"><span data-stu-id="a797e-206">The system could store the information about the total number of bookings as a separate entity in a database that holds booking information.</span></span> <span data-ttu-id="a797e-207">Como las reservas se realizan o se cancelan, el sistema puede incrementar o disminuir este número según corresponda.</span><span class="sxs-lookup"><span data-stu-id="a797e-207">As bookings are made or canceled, the system could increment or decrement this number as appropriate.</span></span> <span data-ttu-id="a797e-208">En teoría, este enfoque es sencillo, pero puede causar problemas de escalabilidad si un gran número de asistentes intenta reservar plaza en un tiempo breve.</span><span class="sxs-lookup"><span data-stu-id="a797e-208">This approach is simple in theory, but can cause scalability issues if a large number of attendees are attempting to book seats during a short period of time.</span></span> <span data-ttu-id="a797e-209">Por ejemplo, en el último día o dos antes del cierre del período de reserva.</span><span class="sxs-lookup"><span data-stu-id="a797e-209">For example, in the last day or so prior to the booking period closing.</span></span>

- <span data-ttu-id="a797e-210">El sistema podría almacenar información acerca de las reservas y cancelaciones como eventos que se encuentran en un almacén de eventos.</span><span class="sxs-lookup"><span data-stu-id="a797e-210">The system could store information about bookings and cancellations as events held in an event store.</span></span> <span data-ttu-id="a797e-211">A continuación, calcularía el número de plazas disponibles mediante la reproducción de estos eventos.</span><span class="sxs-lookup"><span data-stu-id="a797e-211">It could then calculate the number of seats available by replaying these events.</span></span> <span data-ttu-id="a797e-212">Este enfoque puede ser más escalable debido a la inmutabilidad de los eventos.</span><span class="sxs-lookup"><span data-stu-id="a797e-212">This approach can be more scalable due to the immutability of events.</span></span> <span data-ttu-id="a797e-213">El sistema solo necesita leer los datos del almacén de eventos o anexarlos al almacén de eventos.</span><span class="sxs-lookup"><span data-stu-id="a797e-213">The system only needs to be able to read data from the event store, or append data to the event store.</span></span> <span data-ttu-id="a797e-214">La información de reservas y cancelaciones de eventos nunca se modifica.</span><span class="sxs-lookup"><span data-stu-id="a797e-214">Event information about bookings and cancellations is never modified.</span></span>

<span data-ttu-id="a797e-215">El siguiente diagrama ilustra cómo se podría implementar con Event Sourcing el subsistema de reserva plazas del sistema de administración de conferencias.</span><span class="sxs-lookup"><span data-stu-id="a797e-215">The following diagram illustrates how the seat reservation subsystem of the conference management system might be implemented using event sourcing.</span></span>

![Captura de información sobre las reservas de plaza en un sistema de administración de conferencias con Event Sourcing](./_images/event-sourcing-bounded-context.png)

<span data-ttu-id="a797e-217">La secuencia de acciones para reservar dos plazas es la siguiente:</span><span class="sxs-lookup"><span data-stu-id="a797e-217">The sequence of actions for reserving two seats is as follows:</span></span>

1. <span data-ttu-id="a797e-218">La interfaz de usuario emite un comando para reservar plaza a dos asistentes.</span><span class="sxs-lookup"><span data-stu-id="a797e-218">The user interface issues a command to reserve seats for two attendees.</span></span> <span data-ttu-id="a797e-219">El comando lo controla un controlador de comandos independiente.</span><span class="sxs-lookup"><span data-stu-id="a797e-219">The command is handled by a separate command handler.</span></span> <span data-ttu-id="a797e-220">Se separa una parte de la lógica de la interfaz de usuario y es responsable de controlar las solicitudes que se publican como comandos.</span><span class="sxs-lookup"><span data-stu-id="a797e-220">A piece of logic that is decoupled from the user interface and is responsible for handling requests posted as commands.</span></span>

2. <span data-ttu-id="a797e-221">Al consultar los eventos que se describen las reservas y las cancelaciones se crea un agregado que contiene información sobre todas las reservas de la conferencia.</span><span class="sxs-lookup"><span data-stu-id="a797e-221">An aggregate containing information about all reservations for the conference is constructed by querying the events that describe bookings and cancellations.</span></span> <span data-ttu-id="a797e-222">Este agregado se denomina `SeatAvailability` y se encuentra dentro de un modelo de dominio que expone métodos para consultar y modificar sus datos.</span><span class="sxs-lookup"><span data-stu-id="a797e-222">This aggregate is called `SeatAvailability`, and is contained within a domain model that exposes methods for querying and modifying the data in the aggregate.</span></span>

    > <span data-ttu-id="a797e-223">Algunas optimizaciones que tener en cuenta son el uso de instantáneas (para no tener que consultar y reproducir la lista completa de eventos para obtener el estado actual del agregado) y la conservación de una copia en caché del agregado en la memoria.</span><span class="sxs-lookup"><span data-stu-id="a797e-223">Some optimizations to consider are using snapshots (so that you don’t need to query and replay the full list of events to obtain the current state of the aggregate), and maintaining a cached copy of the aggregate in memory.</span></span>

3. <span data-ttu-id="a797e-224">El controlador de comandos invoca un método expuesto por el modelo de dominio para realizar las reservas.</span><span class="sxs-lookup"><span data-stu-id="a797e-224">The command handler invokes a method exposed by the domain model to make the reservations.</span></span>

4. <span data-ttu-id="a797e-225">El agregado `SeatAvailability` registra un evento que contiene el número de plazas que se han reservado.</span><span class="sxs-lookup"><span data-stu-id="a797e-225">The `SeatAvailability` aggregate records an event containing the number of seats that were reserved.</span></span> <span data-ttu-id="a797e-226">La próxima vez que el agregado aplique eventos, todas las reservas se utilizarán para calcular el número de plazas restantes.</span><span class="sxs-lookup"><span data-stu-id="a797e-226">The next time the aggregate applies events, all the reservations will be used to compute how many seats remain.</span></span>

5. <span data-ttu-id="a797e-227">El sistema anexa el nuevo evento a la lista del almacén de eventos.</span><span class="sxs-lookup"><span data-stu-id="a797e-227">The system appends the new event to the list of events in the event store.</span></span>

<span data-ttu-id="a797e-228">Si un usuario cancela una plaza, el sistema sigue un proceso similar, salvo que el controlador de comandos emite un comando que genera un evento de cancelación de plaza y lo anexa al almacén de eventos.</span><span class="sxs-lookup"><span data-stu-id="a797e-228">If a user cancels a seat, the system follows a similar process except the command handler issues a command that generates a seat cancellation event and appends it to the event store.</span></span>

<span data-ttu-id="a797e-229">Además de proporcionar un ámbito más escalabilidad, un almacén de eventos también proporciona un historial completo (o traza de auditoría) de las reservas y las cancelaciones de una conferencia.</span><span class="sxs-lookup"><span data-stu-id="a797e-229">As well as providing more scope for scalability, using an event store also provides a complete history, or audit trail, of the bookings and cancellations for a conference.</span></span> <span data-ttu-id="a797e-230">Los eventos del almacén son el registro exacto.</span><span class="sxs-lookup"><span data-stu-id="a797e-230">The events in the event store are the accurate record.</span></span> <span data-ttu-id="a797e-231">No es necesario conservar los agregados de otra manera, ya que el sistema puede reproducir fácilmente los eventos y restaurar el estado a cualquier punto en el tiempo.</span><span class="sxs-lookup"><span data-stu-id="a797e-231">There is no need to persist aggregates in any other way because the system can easily replay the events and restore the state to any point in time.</span></span>

> <span data-ttu-id="a797e-232">Más información acerca de este ejemplo en el artículo de [introducción Event Sourcing](https://msdn.microsoft.com/library/jj591559.aspx).</span><span class="sxs-lookup"><span data-stu-id="a797e-232">You can find more information about this example in [Introducing Event Sourcing](https://msdn.microsoft.com/library/jj591559.aspx).</span></span>

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="a797e-233">Orientación y patrones relacionados</span><span class="sxs-lookup"><span data-stu-id="a797e-233">Related patterns and guidance</span></span>

<span data-ttu-id="a797e-234">Los patrones y las directrices siguientes también pueden ser importantes a la hora de implementar este modelo:</span><span class="sxs-lookup"><span data-stu-id="a797e-234">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="a797e-235">[Patrón Command and Query Responsibility Segregation (CQRS)](./cqrs.md).</span><span class="sxs-lookup"><span data-stu-id="a797e-235">[Command and Query Responsibility Segregation (CQRS) pattern](./cqrs.md).</span></span> <span data-ttu-id="a797e-236">El almacén de escritura que proporciona el origen de información permanente para una implementación de CQRS a menudo se basa en una implementación del patrón Event Sourcing.</span><span class="sxs-lookup"><span data-stu-id="a797e-236">The write store that provides the permanent source of information for a CQRS implementation is often based on an implementation of the Event Sourcing pattern.</span></span> <span data-ttu-id="a797e-237">Describe cómo se segregan las operaciones de lectura de las de actualización de datos mediante interfaces independientes en una aplicación.</span><span class="sxs-lookup"><span data-stu-id="a797e-237">Describes how to segregate the operations that read data in an application from the operations that update data by using separate interfaces.</span></span>

- <span data-ttu-id="a797e-238">[Patrón Materialized View](./materialized-view.md).</span><span class="sxs-lookup"><span data-stu-id="a797e-238">[Materialized View pattern](./materialized-view.md).</span></span> <span data-ttu-id="a797e-239">Normalmente, el almacén de datos que se utiliza en un sistema basado en Event Sourcing no se adapta perfectamente para una consulta eficaz.</span><span class="sxs-lookup"><span data-stu-id="a797e-239">The data store used in a system based on event sourcing is typically not well suited to efficient querying.</span></span> <span data-ttu-id="a797e-240">En su lugar, un enfoque común consiste en generar vistas rellenadas previamente con los datos a intervalos regulares o cuando los datos cambian.</span><span class="sxs-lookup"><span data-stu-id="a797e-240">Instead, a common approach is to generate prepopulated views of the data at regular intervals, or when the data changes.</span></span> <span data-ttu-id="a797e-241">Muestra la manera de hacerlo.</span><span class="sxs-lookup"><span data-stu-id="a797e-241">Shows how this can be done.</span></span>

- <span data-ttu-id="a797e-242">[Patrón Compensating Transaction](./compensating-transaction.md).</span><span class="sxs-lookup"><span data-stu-id="a797e-242">[Compensating Transaction pattern](./compensating-transaction.md).</span></span> <span data-ttu-id="a797e-243">Los datos existentes en un almacén de Event Sourcing no se actualizan; en su lugar, se agregan entradas nuevas de transición del estado de las entidades a los nuevos valores.</span><span class="sxs-lookup"><span data-stu-id="a797e-243">The existing data in an event sourcing store is not updated, instead new entries are added that transition the state of entities to the new values.</span></span> <span data-ttu-id="a797e-244">Para invertir un cambio, se usan las entradas de compensación, puesto que no es posible revertir simplemente el cambio.</span><span class="sxs-lookup"><span data-stu-id="a797e-244">To reverse a change, compensating entries are used because it isn't possible to simply reverse the previous change.</span></span> <span data-ttu-id="a797e-245">Describe cómo deshacer el trabajo que realizó una operación anterior.</span><span class="sxs-lookup"><span data-stu-id="a797e-245">Describes how to undo the work that was performed by a previous operation.</span></span>

- <span data-ttu-id="a797e-246">[Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx) (Manual básico de coherencia de datos).</span><span class="sxs-lookup"><span data-stu-id="a797e-246">[Data Consistency Primer](https://msdn.microsoft.com/library/dn589800.aspx).</span></span> <span data-ttu-id="a797e-247">Al usar Event Sourcing con otro almacén de lectura o vistas materializadas independientes, los datos de lectura no serán coherentes de manera inmediata, sino que tendrán coherencia final.</span><span class="sxs-lookup"><span data-stu-id="a797e-247">When using event sourcing with a separate read store or materialized views, the read data won't be immediately consistent, instead it'll be only eventually consistent.</span></span> <span data-ttu-id="a797e-248">Resume los problemas que pueden surgir sobre el mantenimiento de la coherencia en los datos distribuidos.</span><span class="sxs-lookup"><span data-stu-id="a797e-248">Summarizes the issues surrounding maintaining consistency over distributed data.</span></span>

- <span data-ttu-id="a797e-249">[Guía de creación de particiones de datos](https://msdn.microsoft.com/library/dn589795.aspx).</span><span class="sxs-lookup"><span data-stu-id="a797e-249">[Data Partitioning Guidance](https://msdn.microsoft.com/library/dn589795.aspx).</span></span> <span data-ttu-id="a797e-250">Se suelen generar particiones en los datos al usar Event Sourcing para mejorar la escalabilidad, reducir la contención y optimizar el rendimiento.</span><span class="sxs-lookup"><span data-stu-id="a797e-250">Data is often partitioned when using event sourcing to improve scalability, reduce contention, and optimize performance.</span></span> <span data-ttu-id="a797e-251">Describe cómo dividir los datos en particiones discretas y los problemas que pueden surgir.</span><span class="sxs-lookup"><span data-stu-id="a797e-251">Describes how to divide data into discrete partitions, and the issues that can arise.</span></span>
