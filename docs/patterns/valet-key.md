---
title: Valet Key
description: Usa un token o clave que proporciona a los clientes acceso directo restringido a un recurso o servicio específico.
keywords: Patrón de diseño
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- data-management
- security
ms.openlocfilehash: 791132eabf926cc285567454c60f894efa286433
ms.sourcegitcommit: b0482d49aab0526be386837702e7724c61232c60
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 11/14/2017
---
# <a name="valet-key-pattern"></a><span data-ttu-id="531a7-104">Patrón Valet Key</span><span class="sxs-lookup"><span data-stu-id="531a7-104">Valet Key pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="531a7-105">Usa un token que proporciona a los clientes acceso directo restringido a un recurso específico, con el fin de descargar la transferencia de datos desde la aplicación.</span><span class="sxs-lookup"><span data-stu-id="531a7-105">Use a token that provides clients with restricted direct access to a specific resource, in order to offload data transfer from the application.</span></span> <span data-ttu-id="531a7-106">Esto es especialmente útil en aplicaciones que usan sistemas o colas de almacenamiento hospedado en la nube, ya que puede minimizar los costes y maximizar la escalabilidad y el rendimiento.</span><span class="sxs-lookup"><span data-stu-id="531a7-106">This is particularly useful in applications that use cloud-hosted storage systems or queues, and can minimize cost and maximize scalability and performance.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="531a7-107">Contexto y problema</span><span class="sxs-lookup"><span data-stu-id="531a7-107">Context and problem</span></span>

<span data-ttu-id="531a7-108">Los programas cliente y los exploradores web necesitan a menudo leer y escribir flujos de datos a y desde el almacenamiento de una aplicación.</span><span class="sxs-lookup"><span data-stu-id="531a7-108">Client programs and web browsers often need to read and write files or data streams to and from an application’s storage.</span></span> <span data-ttu-id="531a7-109">Normalmente, la aplicación administra el movimiento de los datos &mdash; o bien los captura del almacenamiento y los transmite al cliente o lee el flujo cargado del cliente y lo almacena en el almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="531a7-109">Typically, the application will handle the movement of the data &mdash; either by fetching it from storage and streaming it to the client, or by reading the uploaded stream from the client and storing it in the data store.</span></span> <span data-ttu-id="531a7-110">Sin embargo, este enfoque consume recursos valiosos, como proceso, memoria y ancho de banda.</span><span class="sxs-lookup"><span data-stu-id="531a7-110">However, this approach absorbs valuable resources such as compute, memory, and bandwidth.</span></span>

<span data-ttu-id="531a7-111">Los almacenes de datos disponen de la posibilidad de cargar y descargar los datos directamente, sin necesidad de que la aplicación realice ningún procesamiento para mover estos datos.</span><span class="sxs-lookup"><span data-stu-id="531a7-111">Data stores have the ability to handle upload and download of data directly, without requiring that the application perform any processing to move this data.</span></span> <span data-ttu-id="531a7-112">Sin embargo, para lograr esto es necesario normalmente que el cliente tenga acceso a las credenciales de seguridad del almacén.</span><span class="sxs-lookup"><span data-stu-id="531a7-112">But, this typically requires the client to have access to the security credentials for the store.</span></span> <span data-ttu-id="531a7-113">Esta técnica puede ser útil para reducir los costes de transferencia de datos y el requisito de escalado horizontal de la aplicación, y para aumentar el rendimiento.</span><span class="sxs-lookup"><span data-stu-id="531a7-113">This can be a useful technique to minimize data transfer costs and the requirement to scale out the application, and to maximize performance.</span></span> <span data-ttu-id="531a7-114">Sin embargo, significa que la aplicación ya no es capaz de administrar la seguridad de los datos.</span><span class="sxs-lookup"><span data-stu-id="531a7-114">It means, though, that the application is no longer able to manage the security of the data.</span></span> <span data-ttu-id="531a7-115">Una vez que el cliente tiene una conexión al almacén de datos para el acceso directo, la aplicación no puede actuar como equipo selector.</span><span class="sxs-lookup"><span data-stu-id="531a7-115">After the client has a connection to the data store for direct access, the application can't act as the gatekeeper.</span></span> <span data-ttu-id="531a7-116">Ya no tiene el control del proceso y no puede impedir las sucesivas cargas o descargas del almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="531a7-116">It's no longer in control of the process and can't prevent subsequent uploads or downloads from the data store.</span></span>

<span data-ttu-id="531a7-117">Este no es un enfoque realista en sistemas distribuidos que deben atender a clientes en los que no se confía.</span><span class="sxs-lookup"><span data-stu-id="531a7-117">This isn't a realistic approach in distributed systems that need to serve untrusted clients.</span></span> <span data-ttu-id="531a7-118">Por el contrario, las aplicaciones deben poder controlar con seguridad el acceso a los datos de forma granular, y aun así reducir la carga en el servidor, para lo cual configuran esta conexión y luego permiten que el cliente se comunique directamente con el almacén de datos para realizar las operaciones de lectura y escritura necesarias.</span><span class="sxs-lookup"><span data-stu-id="531a7-118">Instead, applications must be able to securely control access to data in a granular way, but still reduce the load on the server by setting up this connection and then allowing the client to communicate directly with the data store to perform the required read or write operations.</span></span>

## <a name="solution"></a><span data-ttu-id="531a7-119">Solución</span><span class="sxs-lookup"><span data-stu-id="531a7-119">Solution</span></span>

<span data-ttu-id="531a7-120">Debe resolver el problema de controlar el acceso a un almacén de datos cuando el almacén no pueda administrar la autenticación y la autorización de los clientes.</span><span class="sxs-lookup"><span data-stu-id="531a7-120">You need to resolve the problem of controlling access to a data store where the store can't manage authentication and authorization of clients.</span></span> <span data-ttu-id="531a7-121">Una solución típica consiste en restringir el acceso a la conexión pública del almacén de datos y proporcionar al cliente una clave o un token que pueda validar dicho almacén.</span><span class="sxs-lookup"><span data-stu-id="531a7-121">One typical solution is to restrict access to the data store’s public connection and provide the client with a key or token that the data store can validate.</span></span>

<span data-ttu-id="531a7-122">Esta clave o token se conoce normalmente como clave auxiliar.</span><span class="sxs-lookup"><span data-stu-id="531a7-122">This key or token is usually referred to as a valet key.</span></span> <span data-ttu-id="531a7-123">Esta clave proporciona acceso limitado a recursos específicos y permite únicamente operaciones predefinidas, como lectura y escritura en almacenamiento o colas, o carga y descarga en un explorador web.</span><span class="sxs-lookup"><span data-stu-id="531a7-123">It provides time-limited access to specific resources and allows only predefined operations such as reading and writing to storage or queues, or uploading and downloading in a web browser.</span></span> <span data-ttu-id="531a7-124">Las aplicaciones pueden crear y emitir claves auxiliares a dispositivos cliente y exploradores web de manera rápida y fácil, lo que permite que los clientes realicen las operaciones necesarias sin necesidad de que la aplicación administre directamente la transferencia de datos.</span><span class="sxs-lookup"><span data-stu-id="531a7-124">Applications can create and issue valet keys to client devices and web browsers quickly and easily, allowing clients to perform the required operations without requiring the application to directly handle the data transfer.</span></span> <span data-ttu-id="531a7-125">De esta manera, se elimina la sobrecarga de procesamiento, y el impacto sobre el rendimiento y la escalabilidad, de la aplicación y el servidor.</span><span class="sxs-lookup"><span data-stu-id="531a7-125">This removes the processing overhead, and the impact on performance and scalability, from the application and the server.</span></span>

<span data-ttu-id="531a7-126">El cliente usa este token para acceder a un recurso concreto en el almacén de datos durante un período de tiempo específico, y con restricciones específicas sobre los permisos de acceso, como se muestra en la ilustración.</span><span class="sxs-lookup"><span data-stu-id="531a7-126">The client uses this token to access a specific resource in the data store for only a specific period, and with specific restrictions on access permissions, as shown in the figure.</span></span> <span data-ttu-id="531a7-127">Tras el período especificado, la clave deja de ser válida y no permite el acceso al recurso.</span><span class="sxs-lookup"><span data-stu-id="531a7-127">After the specified period, the key becomes invalid and won't allow access to the resource.</span></span>

![Figura 1: Información general del patrón](./_images/valet-key-pattern.png)

<span data-ttu-id="531a7-129">También es posible configurar una clave que tenga otras dependencias, como el ámbito de los datos.</span><span class="sxs-lookup"><span data-stu-id="531a7-129">It's also possible to configure a key that has other dependencies, such as the scope of the data.</span></span> <span data-ttu-id="531a7-130">Por ejemplo, según las capacidades del almacén de datos, la clave puede especificar una tabla completa de un almacén de datos o solo filas específicas de una tabla.</span><span class="sxs-lookup"><span data-stu-id="531a7-130">For example, depending on the data store capabilities, the key can specify a complete table in a data store, or only specific rows in a table.</span></span> <span data-ttu-id="531a7-131">En sistemas de almacenamiento de nube, la clave puede especificar un contenedor o simplemente un elemento específico dentro de un contenedor.</span><span class="sxs-lookup"><span data-stu-id="531a7-131">In cloud storage systems the key can specify a container, or just a specific item within a container.</span></span>

<span data-ttu-id="531a7-132">La clave también se puede invalidar mediante la aplicación.</span><span class="sxs-lookup"><span data-stu-id="531a7-132">The key can also be invalidated by the application.</span></span> <span data-ttu-id="531a7-133">Este enfoque es útil si el cliente notifica al servidor que la operación de transferencia de datos ha finalizado.</span><span class="sxs-lookup"><span data-stu-id="531a7-133">This is a useful approach if the client notifies the server that the data transfer operation is complete.</span></span> <span data-ttu-id="531a7-134">El servidor puede invalidar luego esa clave para impedir que se siga usando.</span><span class="sxs-lookup"><span data-stu-id="531a7-134">The server can then invalidate that key to prevent further.</span></span>

<span data-ttu-id="531a7-135">Mediante este patrón, puede simplificar la administración del acceso a los recursos porque no hay ningún requisito para crear y autenticar a un usuario, conceder permisos y luego quitar de nuevo el usuario.</span><span class="sxs-lookup"><span data-stu-id="531a7-135">Using this pattern can simplify managing access to resources because there's no requirement to create and authenticate a user, grant permissions, and then remove the user again.</span></span> <span data-ttu-id="531a7-136">También permite limitar de forma fácil la ubicación, el permiso y el período de validez&mdash;todo ello mediante la simple generación de una clave en tiempo de ejecución.</span><span class="sxs-lookup"><span data-stu-id="531a7-136">It also makes it easy to limit the location, the permission, and the validity period&mdash;all by simply generating a key at runtime.</span></span> <span data-ttu-id="531a7-137">Los factores importantes son limitar el período de validez, y especialmente la ubicación del recurso, lo más estrictamente posible para que el destinatario solo pueda usarse para el fin que se ha previsto.</span><span class="sxs-lookup"><span data-stu-id="531a7-137">The important factors are to limit the validity period, and especially the location of the resource, as tightly as possible so that the recipient can only use it for the intended purpose.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="531a7-138">Problemas y consideraciones</span><span class="sxs-lookup"><span data-stu-id="531a7-138">Issues and considerations</span></span>

<span data-ttu-id="531a7-139">Tenga en cuenta los puntos siguientes al decidir cómo implementar este patrón:</span><span class="sxs-lookup"><span data-stu-id="531a7-139">Consider the following points when deciding how to implement this pattern:</span></span>

<span data-ttu-id="531a7-140">**Administrar el estado de validez y el período de la clave**.</span><span class="sxs-lookup"><span data-stu-id="531a7-140">**Manage the validity status and period of the key**.</span></span> <span data-ttu-id="531a7-141">Si se ha filtrado o puesto en peligro, la clave desbloquea de manera efectiva el elemento de destino y permite que esté disponible para su uso malintencionado durante el período de validez.</span><span class="sxs-lookup"><span data-stu-id="531a7-141">If leaked or compromised, the key effectively unlocks the target item and makes it available for malicious use during the validity period.</span></span> <span data-ttu-id="531a7-142">Una clave normalmente se puede revocar o deshabilitar, dependiendo de cómo se emitiera.</span><span class="sxs-lookup"><span data-stu-id="531a7-142">A key can usually be revoked or disabled, depending on how it was issued.</span></span> <span data-ttu-id="531a7-143">Las directivas del lado servidor se pueden cambiar, o la clave de servidor con la que se han firmado se puede invalidar.</span><span class="sxs-lookup"><span data-stu-id="531a7-143">Server-side policies can be changed or, the server key it was signed with can be invalidated.</span></span> <span data-ttu-id="531a7-144">Especifique un período de validez corto para minimizar el riesgo de permitir que tengan lugar operaciones no autorizadas contra el almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="531a7-144">Specify a short validity period to minimize the risk of allowing unauthorized operations to take place against the data store.</span></span> <span data-ttu-id="531a7-145">Sin embargo, si el período de validez es demasiado corto, el cliente no podrá completar la operación antes de que expire la clave.</span><span class="sxs-lookup"><span data-stu-id="531a7-145">However, if the validity period is too short, the client might not be able to complete the operation before the key expires.</span></span> <span data-ttu-id="531a7-146">Permita que los usuarios autorizados renueven la clave antes de que expire el período de validez si se requieren varios accesos al recurso protegido.</span><span class="sxs-lookup"><span data-stu-id="531a7-146">Allow authorized users to renew the key before the validity period expires if multiple accesses to the protected resource are required.</span></span>

<span data-ttu-id="531a7-147">**Controlar el nivel de acceso que proporcionará la clave**.</span><span class="sxs-lookup"><span data-stu-id="531a7-147">**Control the level of access the key will provide**.</span></span> <span data-ttu-id="531a7-148">Normalmente, la clave debe permitir al usuario realizar únicamente las acciones necesarias para completar la operación, como el acceso de solo lectura si el cliente no debería poder cargar los datos en el almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="531a7-148">Typically, the key should allow the user to only perform the actions necessary to complete the operation, such as read-only access if the client shouldn't be able to upload data to the data store.</span></span> <span data-ttu-id="531a7-149">Con las cargas de archivos, es habitual especificar una clave que proporcione permisos de solo escritura, así como la ubicación y el período de validez.</span><span class="sxs-lookup"><span data-stu-id="531a7-149">For file uploads, it's common to specify a key that provides write-only permission, as well as the location and the validity period.</span></span> <span data-ttu-id="531a7-150">Es fundamental especificar con precisión el recurso o el conjunto de recursos a los que se aplica la clave.</span><span class="sxs-lookup"><span data-stu-id="531a7-150">It's critical to accurately specify the resource or the set of resources to which the key applies.</span></span>

<span data-ttu-id="531a7-151">**Considerar cómo controlar el comportamiento de los usuarios**.</span><span class="sxs-lookup"><span data-stu-id="531a7-151">**Consider how to control users’ behavior**.</span></span> <span data-ttu-id="531a7-152">Implementar este patrón significa cierta pérdida de control sobre los recursos a los que se concede acceso a los usuarios.</span><span class="sxs-lookup"><span data-stu-id="531a7-152">Implementing this pattern means some loss of control over the resources users are granted access to.</span></span> <span data-ttu-id="531a7-153">El nivel de control que se puede ejercer está limitado por las funcionalidades de las directivas y los permisos disponibles para el servicio o el almacén de datos de destino.</span><span class="sxs-lookup"><span data-stu-id="531a7-153">The level of control that can be exerted is limited by the capabilities of the policies and permissions available for the service or the target data store.</span></span> <span data-ttu-id="531a7-154">Por ejemplo, lo habitual es que no sea posible crear una clave que limite el tamaño de los datos que se van a escribir en el almacenamiento, o el número de veces que se puede usar la clave para acceder a un archivo.</span><span class="sxs-lookup"><span data-stu-id="531a7-154">For example, it's usually not possible to create a key that limits the size of the data to be written to storage, or the number of times the key can be used to access a file.</span></span> <span data-ttu-id="531a7-155">Esta situación puede dar lugar a que aumenten los costes de transferencia de datos de forma inesperada, incluso cuando esta clave la usa el cliente previsto, y podría deberse a un error en el código que provoca cargas y descargas repetidas.</span><span class="sxs-lookup"><span data-stu-id="531a7-155">This can result in huge unexpected costs for data transfer, even when used by the intended client, and might be caused by an error in the code that causes repeated upload or download.</span></span> <span data-ttu-id="531a7-156">Para limitar el número de veces que se puede cargar un archivo, siempre que sea posible, obligue al cliente a que notifique a la aplicación cuando una operación finalice.</span><span class="sxs-lookup"><span data-stu-id="531a7-156">To limit the number of times a file can be uploaded, where possible, force the client to notify the application when one operation has completed.</span></span> <span data-ttu-id="531a7-157">Por ejemplo, algunos almacenes de datos generan eventos que el código de aplicación puede usar para supervisar las operaciones y controlar el comportamiento del usuario.</span><span class="sxs-lookup"><span data-stu-id="531a7-157">For example, some data stores raise events the application code can use to monitor operations and control user behavior.</span></span> <span data-ttu-id="531a7-158">Sin embargo, resulta difícil exigir cuotas para usuarios individuales en un escenario multiinquilino donde todos los usuarios de un mismo inquilino usan la misma clave.</span><span class="sxs-lookup"><span data-stu-id="531a7-158">However, it's hard to enforce quotas for individual users in a multi-tenant scenario where the same key is used by all the users from one tenant.</span></span>

<span data-ttu-id="531a7-159">**Validar y, opcionalmente, corregir, todos los datos cargados**.</span><span class="sxs-lookup"><span data-stu-id="531a7-159">**Validate, and optionally sanitize, all uploaded data**.</span></span> <span data-ttu-id="531a7-160">Un usuario malintencionado que consiga acceso a la clave podría cargar datos diseñados para poner en peligro el sistema.</span><span class="sxs-lookup"><span data-stu-id="531a7-160">A malicious user that gains access to the key could upload data designed to compromise the system.</span></span> <span data-ttu-id="531a7-161">También, los usuarios autorizados podrían cargar datos que no son válidos que, cuando se procesan, dan lugar a un error o un error del sistema.</span><span class="sxs-lookup"><span data-stu-id="531a7-161">Alternatively, authorized users might upload data that's invalid and, when processed, could result in an error or system failure.</span></span> <span data-ttu-id="531a7-162">Para evitar este problema, asegúrese de que todos los datos cargados se validen y se comprueben en busca de contenido malintencionado antes de su uso.</span><span class="sxs-lookup"><span data-stu-id="531a7-162">To protect against this, ensure that all uploaded data is validated and checked for malicious content before use.</span></span>

<span data-ttu-id="531a7-163">**Auditar todas las operaciones**.</span><span class="sxs-lookup"><span data-stu-id="531a7-163">**Audit all operations**.</span></span> <span data-ttu-id="531a7-164">Numerosos mecanismos basados en claves pueden registrar operaciones como cargas, descargas y errores.</span><span class="sxs-lookup"><span data-stu-id="531a7-164">Many key-based mechanisms can log operations such as uploads, downloads, and failures.</span></span> <span data-ttu-id="531a7-165">Estos registros se pueden incorporar normalmente a un proceso de auditoría y también se usan para facturación si el usuario paga según el volumen de datos o el tamaño de los archivos.</span><span class="sxs-lookup"><span data-stu-id="531a7-165">These logs can usually be incorporated into an audit process, and also used for billing if the user is charged based on file size or data volume.</span></span> <span data-ttu-id="531a7-166">Use los registros para detectar errores de autenticación que podrían deberse a problemas con el proveedor de claves o a la eliminación accidental de una directiva de acceso almacenada.</span><span class="sxs-lookup"><span data-stu-id="531a7-166">Use the logs to detect authentication failures that might be caused by issues with the key provider, or accidental removal of a stored access policy.</span></span>

<span data-ttu-id="531a7-167">**Entregar la clave de forma segura**.</span><span class="sxs-lookup"><span data-stu-id="531a7-167">**Deliver the key securely**.</span></span> <span data-ttu-id="531a7-168">Se puede insertar en una dirección URL que el usuario activa en una página web, o se puede usar en una operación de redireccionamiento del servidor para que la descarga se produzca automáticamente.</span><span class="sxs-lookup"><span data-stu-id="531a7-168">It can be embedded in a URL that the user activates in a web page, or it can be used in a server redirection operation so that the download occurs automatically.</span></span> <span data-ttu-id="531a7-169">Use siempre HTTPS para entregar la clave por un canal seguro.</span><span class="sxs-lookup"><span data-stu-id="531a7-169">Always use HTTPS to deliver the key over a secure channel.</span></span>

<span data-ttu-id="531a7-170">**Proteger los datos confidenciales en tránsito**.</span><span class="sxs-lookup"><span data-stu-id="531a7-170">**Protect sensitive data in transit**.</span></span> <span data-ttu-id="531a7-171">La entrega de los datos confidenciales a través de la aplicación tiene lugar normalmente mediante SSL o TLS, y es así como debe ser para los clientes que acceden al almacén de datos directamente.</span><span class="sxs-lookup"><span data-stu-id="531a7-171">Sensitive data delivered through the application will usually take place using SSL or TLS, and this should be enforced for clients accessing the data store directly.</span></span>

<span data-ttu-id="531a7-172">Otros aspectos que se deben tener en cuenta al implementar este patrón son:</span><span class="sxs-lookup"><span data-stu-id="531a7-172">Other issues to be aware of when implementing this pattern are:</span></span>

- <span data-ttu-id="531a7-173">Si el cliente no notifica, o no puede notificar, al servidor el fin de la operación y el único límite es el período de expiración de la clave, la aplicación no podrá realizar operaciones de auditoría, como contar el número de cargas o descargas o impedir varias cargas o descargas.</span><span class="sxs-lookup"><span data-stu-id="531a7-173">If the client doesn't, or can't, notify the server of completion of the operation, and the only limit is the expiration period of the key, the application won't be able to perform auditing operations such as counting the number of uploads or downloads, or preventing multiple uploads or downloads.</span></span>

- <span data-ttu-id="531a7-174">La flexibilidad de las directivas de clave que se pueden generar podría ser limitada.</span><span class="sxs-lookup"><span data-stu-id="531a7-174">The flexibility of key policies that can be generated might be limited.</span></span> <span data-ttu-id="531a7-175">Por ejemplo, algunos mecanismos solo permiten el uso de un período de expiración con un tiempo fijado.</span><span class="sxs-lookup"><span data-stu-id="531a7-175">For example, some mechanisms only allow the use of a timed expiration period.</span></span> <span data-ttu-id="531a7-176">Otros usuarios no pueden especificar una granularidad suficiente de permisos de lectura y escritura.</span><span class="sxs-lookup"><span data-stu-id="531a7-176">Others aren't able to specify a sufficient granularity of read/write permissions.</span></span>

- <span data-ttu-id="531a7-177">Si se especifica la hora de inicio del período de validez del token o de la clave, asegúrese de que sea un poco anterior a la hora actual del servidor para permitir que se sincronicen los relojes del cliente que podrían estar ligeramente fuera de sincronización.</span><span class="sxs-lookup"><span data-stu-id="531a7-177">If the start time for the key or token validity period is specified, ensure that it's a little earlier than the current server time to allow for client clocks that might be slightly out of synchronization.</span></span> <span data-ttu-id="531a7-178">Si no se especifica, el valor predeterminado es normalmente la hora actual del servidor.</span><span class="sxs-lookup"><span data-stu-id="531a7-178">The default, if not specified, is usually the current server time.</span></span>

- <span data-ttu-id="531a7-179">La dirección URL que contiene la clave se registrará en los archivos de registro del servidor.</span><span class="sxs-lookup"><span data-stu-id="531a7-179">The URL containing the key will be recorded in server log files.</span></span> <span data-ttu-id="531a7-180">Si bien la clave habrá expirado normalmente antes de que los archivos de registro se utilicen para el análisis, asegúrese de limitar el acceso a ellos.</span><span class="sxs-lookup"><span data-stu-id="531a7-180">While the key will typically have expired before the log files are used for analysis, ensure that you limit access to them.</span></span> <span data-ttu-id="531a7-181">Si los datos de registro se trasmiten a un sistema de supervisión o se almacenan en otra ubicación, considere la posibilidad de implementar un retraso para impedir la fuga de claves hasta después de que haya expirado el periodo de validez.</span><span class="sxs-lookup"><span data-stu-id="531a7-181">If log data is transmitted to a monitoring system or stored in another location, consider implementing a delay to prevent leakage of keys until after their validity period has expired.</span></span>

- <span data-ttu-id="531a7-182">Si el código de cliente se ejecuta en un explorador web, es posible que el explorador tenga que ser compatible con el uso compartido de recursos entre orígenes (CORS) para permitir que el código que se ejecuta en él acceda a los datos de un dominio diferente a aquel que entregó la página.</span><span class="sxs-lookup"><span data-stu-id="531a7-182">If the client code runs in a web browser, the browser might need to support cross-origin resource sharing (CORS) to enable code that executes within the web browser to access data in a different domain from the one that served the page.</span></span> <span data-ttu-id="531a7-183">Algunos exploradores más antiguos y algunos almacenes de datos no son compatibles con CORS, y el código que se ejecuta en estos exploradores podría usar una clave auxiliar para proporcionar acceso a los datos de un dominio diferente, como una cuenta de almacenamiento en la nube.</span><span class="sxs-lookup"><span data-stu-id="531a7-183">Some older browsers and some data stores don't support CORS, and code that runs in these browsers might be able to use a valet key to provide access to data in a different domain, such as a cloud storage account.</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="531a7-184">Cuándo usar este patrón</span><span class="sxs-lookup"><span data-stu-id="531a7-184">When to use this pattern</span></span>

<span data-ttu-id="531a7-185">Este patrón es útil en las situaciones siguientes:</span><span class="sxs-lookup"><span data-stu-id="531a7-185">This pattern is useful for the following situations:</span></span>

- <span data-ttu-id="531a7-186">Para minimizar la carga de recursos y maximizar el rendimiento y la escalabilidad.</span><span class="sxs-lookup"><span data-stu-id="531a7-186">To minimize resource loading and maximize performance and scalability.</span></span> <span data-ttu-id="531a7-187">Con una clave auxiliar, no es necesario bloquear el recurso, no se requiere ninguna llamada al servidor remoto, no hay ningún límite en el número de claves auxiliares que se pueden emitir y se evita que exista un único punto de error derivado de realizar la transferencia de datos a través del código de aplicación.</span><span class="sxs-lookup"><span data-stu-id="531a7-187">Using a valet key doesn't require the resource to be locked, no remote server call is required, there's no limit on the number of valet keys that can be issued, and it avoids a single point of failure resulting from performing the data transfer through the application code.</span></span> <span data-ttu-id="531a7-188">La creación de una clave auxiliar es normalmente una operación criptográfica sencilla que consiste en firmar una cadena con una clave.</span><span class="sxs-lookup"><span data-stu-id="531a7-188">Creating a valet key is typically a simple cryptographic operation of signing a string with a key.</span></span>

- <span data-ttu-id="531a7-189">Para minimizar el coste operativo.</span><span class="sxs-lookup"><span data-stu-id="531a7-189">To minimize operational cost.</span></span> <span data-ttu-id="531a7-190">Habilitar el acceso directo a los almacenes y las colas resulta rentable y permite hacer un uso eficiente de los recursos, puede dar lugar a menos recorridos de ida y vuelta en la red y podría permitir una reducción en el número de recursos de proceso necesarios.</span><span class="sxs-lookup"><span data-stu-id="531a7-190">Enabling direct access to stores and queues is resource and cost efficient, can result in fewer network round trips, and might allow for a reduction in the number of compute resources required.</span></span>

- <span data-ttu-id="531a7-191">Cuando los clientes cargan o descargan datos de forma periódica, en especial en caso de grandes volúmenes o cuando en cada operación intervienen archivos de gran tamaño.</span><span class="sxs-lookup"><span data-stu-id="531a7-191">When clients regularly upload or download data, particularly where there's a large volume or when each operation involves large files.</span></span>

- <span data-ttu-id="531a7-192">Cuando la aplicación tiene recursos de proceso limitados disponibles, debido a las limitaciones de hospedaje o a aspectos relacionados con el coste.</span><span class="sxs-lookup"><span data-stu-id="531a7-192">When the application has limited compute resources available, either due to hosting limitations or cost considerations.</span></span> <span data-ttu-id="531a7-193">En este escenario, el patrón es incluso más útil si hay muchas cargas o descargas de datos simultáneas, ya que libera a la aplicación de tener que administrar la transferencia de datos.</span><span class="sxs-lookup"><span data-stu-id="531a7-193">In this scenario, the pattern is even more helpful if there are many concurrent data uploads or downloads because it relieves the application from handling the data transfer.</span></span>

- <span data-ttu-id="531a7-194">Cuando los datos se almacenan en un almacén de datos remoto o en otro centro de datos.</span><span class="sxs-lookup"><span data-stu-id="531a7-194">When the data is stored in a remote data store or a different datacenter.</span></span> <span data-ttu-id="531a7-195">Si uno de los requisitos fuera que la aplicación funcionara como equipo selector, podría haber un cargo por el uso de ancho de banda adicional que supone transferir los datos entre los centros de datos o, en redes públicas y privadas, entre el cliente y la aplicación y luego entre la aplicación y el almacén de datos.</span><span class="sxs-lookup"><span data-stu-id="531a7-195">If the application was required to act as a gatekeeper, there might be a charge for the additional bandwidth of transferring the data between datacenters, or across public or private networks between the client and the application, and then between the application and the data store.</span></span>

<span data-ttu-id="531a7-196">Este patrón podría no ser útil en las siguientes situaciones:</span><span class="sxs-lookup"><span data-stu-id="531a7-196">This pattern might not be useful in the following situations:</span></span>

- <span data-ttu-id="531a7-197">Si la aplicación debe realizar alguna tarea en los datos antes de que se almacenen o antes de enviarlos al cliente.</span><span class="sxs-lookup"><span data-stu-id="531a7-197">If the application must perform some task on the data before it's stored or before it's sent to the client.</span></span> <span data-ttu-id="531a7-198">Por ejemplo, si la aplicación necesita realizar la validación, registrar el éxito de acceso o ejecutar una transformación en los datos.</span><span class="sxs-lookup"><span data-stu-id="531a7-198">For example, if the application needs to perform validation, log access success, or execute a transformation on the data.</span></span> <span data-ttu-id="531a7-199">Sin embargo, algunos almacenes de datos y clientes pueden negociar y llevar a cabo transformaciones sencillas, como la compresión y descompresión (por ejemplo, un explorador web normalmente puede administrar formatos GZip).</span><span class="sxs-lookup"><span data-stu-id="531a7-199">However, some data stores and clients are able to negotiate and carry out simple transformations such as compression and decompression (for example, a web browser can usually handle GZip formats).</span></span>

- <span data-ttu-id="531a7-200">Si el diseño de una aplicación existente dificulta incorporar el patrón.</span><span class="sxs-lookup"><span data-stu-id="531a7-200">If the design of an existing application makes it difficult to incorporate the pattern.</span></span> <span data-ttu-id="531a7-201">El uso de este patrón normalmente requiere un enfoque de arquitectura diferente en la entrega y recepción de los datos.</span><span class="sxs-lookup"><span data-stu-id="531a7-201">Using this pattern typically requires a different architectural approach for delivering and receiving data.</span></span>

- <span data-ttu-id="531a7-202">Si es necesario mantener registros de auditoría o controlar la cantidad de veces que se ejecuta una operación de transferencia de datos, y el mecanismo de clave auxiliar en uso no admite notificaciones que el servidor pueda usar para administrar estas operaciones.</span><span class="sxs-lookup"><span data-stu-id="531a7-202">If it's necessary to maintain audit trails or control the number of times a data transfer operation is executed, and the valet key mechanism in use doesn't support notifications that the server can use to manage these operations.</span></span>

- <span data-ttu-id="531a7-203">Si es necesario limitar el tamaño de los datos, especialmente durante las operaciones de carga.</span><span class="sxs-lookup"><span data-stu-id="531a7-203">If it's necessary to limit the size of the data, especially during upload operations.</span></span> <span data-ttu-id="531a7-204">La única solución a ello es que la aplicación compruebe el tamaño de los datos después de que la operación finaliza, o comprobar el tamaño de las cargas tras un período especificado o según una programación.</span><span class="sxs-lookup"><span data-stu-id="531a7-204">The only solution to this is for the application to check the data size after the operation is complete, or check the size of uploads after a specified period or on a scheduled basis.</span></span>

## <a name="example"></a><span data-ttu-id="531a7-205">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="531a7-205">Example</span></span>

<span data-ttu-id="531a7-206">Azure admite firmas de acceso compartido en Azure Storage que permiten un mejor control del acceso a los datos de blobs, tablas y colas, y de colas y temas de Service Bus.</span><span class="sxs-lookup"><span data-stu-id="531a7-206">Azure supports shared access signatures on Azure Storage for granular access control to data in blobs, tables, and queues, and for Service Bus queues and topics.</span></span> <span data-ttu-id="531a7-207">Un token de firma de acceso compartido se puede configurar para proporcionar derechos de acceso específicos, como lectura, escritura, actualización y eliminación para una tabla específica; un intervalo de claves dentro de una tabla; una cola; un blob; o un contenedor de blobs.</span><span class="sxs-lookup"><span data-stu-id="531a7-207">A shared access signature token can be configured to provide specific access rights such as read, write, update, and delete to a specific table; a key range within a table; a queue; a blob; or a blob container.</span></span> <span data-ttu-id="531a7-208">La validez puede ser un período de tiempo especificado o sin límite de tiempo.</span><span class="sxs-lookup"><span data-stu-id="531a7-208">The validity can be a specified time period or with no time limit.</span></span>

<span data-ttu-id="531a7-209">Las firmas de acceso compartido de Azure también admiten directivas de acceso almacenadas por el servidor que se pueden asociar a un recurso específico, como una tabla o un blob.</span><span class="sxs-lookup"><span data-stu-id="531a7-209">Azure shared access signatures also support server-stored access policies that can be associated with a specific resource such as a table or blob.</span></span> <span data-ttu-id="531a7-210">Esta característica proporciona mayor control y flexibilidad en comparación con los tokens de firma de acceso compartido generados por la aplicación, y debe utilizarse siempre que sea posible.</span><span class="sxs-lookup"><span data-stu-id="531a7-210">This feature provides additional control and flexibility compared to application-generated shared access signature tokens, and should be used whenever possible.</span></span> <span data-ttu-id="531a7-211">La configuración definida en una directiva almacenada por el servidor se puede cambiar y se refleja en el token sin necesidad de emitir uno nuevo, pero la configuración definida en el token no se puede cambiar sin emitir uno nuevo.</span><span class="sxs-lookup"><span data-stu-id="531a7-211">Settings defined in a server-stored policy can be changed and are reflected in the token without requiring a new token to be issued, but settings defined in the token can't be changed without issuing a new token.</span></span> <span data-ttu-id="531a7-212">Este enfoque también permite revocar un token de firma de acceso compartido válido antes de que haya expirado.</span><span class="sxs-lookup"><span data-stu-id="531a7-212">This approach also makes it possible to revoke a valid shared access signature token before it's expired.</span></span>

> <span data-ttu-id="531a7-213">Para más información, consulte [Introducing Table SAS (Shared Access Signature), Queue SAS and update to Blob SAS](https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/12/introducing-table-sas-shared-access-signature-queue-sas-and-update-to-blob-sas/) (Introducción a SAS [firma de acceso compartido] de Table, SAS de Queue y actualización a SAS de Blob) y [Uso de firmas de acceso compartido](https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/) en MSDN.</span><span class="sxs-lookup"><span data-stu-id="531a7-213">For more information see [Introducing Table SAS (Shared Access Signature), Queue SAS and update to Blob SAS](https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/12/introducing-table-sas-shared-access-signature-queue-sas-and-update-to-blob-sas/) and [Using Shared Access Signatures](https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/) on MSDN.</span></span>

<span data-ttu-id="531a7-214">El código siguiente muestra cómo crear un token de firma de acceso compartido que sea válido durante cinco minutos.</span><span class="sxs-lookup"><span data-stu-id="531a7-214">The following code shows how to create a shared access signature token that's valid for five minutes.</span></span> <span data-ttu-id="531a7-215">El método `GetSharedAccessReferenceForUpload` devuelve un token de firmas de acceso compartido que puede usarse para cargar un archivo en Azure Blob Storage.</span><span class="sxs-lookup"><span data-stu-id="531a7-215">The `GetSharedAccessReferenceForUpload` method returns a shared access signatures token that can be used to upload a file to Azure Blob Storage.</span></span>

```csharp
public class ValuesController : ApiController
{
  private readonly CloudStorageAccount account;
  private readonly string blobContainer;
  ...
  /// <summary>
  /// Return a limited access key that allows the caller to upload a file
  /// to this specific destination for a defined period of time.
  /// </summary>
  private StorageEntitySas GetSharedAccessReferenceForUpload(string blobName)
  {
    var blobClient = this.account.CreateCloudBlobClient();
    var container = blobClient.GetContainerReference(this.blobContainer);

    var blob = container.GetBlockBlobReference(blobName);

    var policy = new SharedAccessBlobPolicy
    {
      Permissions = SharedAccessBlobPermissions.Write,

      // Specify a start time five minutes earlier to allow for client clock skew.
      SharedAccessStartTime = DateTime.UtcNow.AddMinutes(-5),

      // Specify a validity period of five minutes starting from now.
      SharedAccessExpiryTime = DateTime.UtcNow.AddMinutes(5)
    };

    // Create the signature.
    var sas = blob.GetSharedAccessSignature(policy);

    return new StorageEntitySas
    {
      BlobUri = blob.Uri,
      Credentials = sas,
      Name = blobName
    };
  }

  public struct StorageEntitySas
  {
    public string Credentials;
    public Uri BlobUri;
    public string Name;
  }
}
```

> <span data-ttu-id="531a7-216">El ejemplo completo está disponible en la solución de ValetKey, que se puede descargar en [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/valet-key).</span><span class="sxs-lookup"><span data-stu-id="531a7-216">The complete sample is available in the ValetKey solution available for download from [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/valet-key).</span></span> <span data-ttu-id="531a7-217">El proyecto ValetKey.Web de esta solución contiene una aplicación web que incluye la clase `ValuesController` mostrada anteriormente.</span><span class="sxs-lookup"><span data-stu-id="531a7-217">The ValetKey.Web project in this solution contains a web application that includes the `ValuesController` class shown above.</span></span> <span data-ttu-id="531a7-218">Hay una aplicación cliente de ejemplo que usa esta aplicación web para recuperar una clave de firmas de acceso compartido y cargar un archivo en el almacenamiento de blobs, que se puede encontrar en el proyecto ValetKey.Client.</span><span class="sxs-lookup"><span data-stu-id="531a7-218">A sample client application that uses this web application to retrieve a shared access signatures key and upload a file to blob storage is available in the ValetKey.Client project.</span></span>

## <a name="next-steps"></a><span data-ttu-id="531a7-219">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="531a7-219">Next steps</span></span>

<span data-ttu-id="531a7-220">Los patrones y las directrices siguientes también pueden ser importantes a la hora de implementar este modelo:</span><span class="sxs-lookup"><span data-stu-id="531a7-220">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>
- <span data-ttu-id="531a7-221">Se encuentra disponible un ejemplo que demuestra este patrón en [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/valet-key).</span><span class="sxs-lookup"><span data-stu-id="531a7-221">A sample that demonstrates this pattern is available on [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/valet-key).</span></span>
- <span data-ttu-id="531a7-222">[Patrón Gatekeeper](gatekeeper.md).</span><span class="sxs-lookup"><span data-stu-id="531a7-222">[Gatekeeper pattern](gatekeeper.md).</span></span> <span data-ttu-id="531a7-223">Este patrón se puede usar junto con el patrón Valet Key para proteger las aplicaciones y los servicios mediante una instancia de host dedicada que actúa como intermediario entre los clientes y la aplicación o el servicio.</span><span class="sxs-lookup"><span data-stu-id="531a7-223">This pattern can be used in conjunction with the Valet Key pattern to protect applications and services by using a dedicated host instance that acts as a broker between clients and the application or service.</span></span> <span data-ttu-id="531a7-224">El equipo selector valida y corrige las solicitudes y pasa las solicitudes y los datos entre el cliente y la aplicación.</span><span class="sxs-lookup"><span data-stu-id="531a7-224">The gatekeeper validates and sanitizes requests, and passes requests and data between the client and the application.</span></span> <span data-ttu-id="531a7-225">Esto puede proporcionar una capa de seguridad adicional y reducir la superficie expuesta a ataques del sistema.</span><span class="sxs-lookup"><span data-stu-id="531a7-225">Can provide an additional layer of security, and reduce the attack surface of the system.</span></span>
- <span data-ttu-id="531a7-226">[Patrón Static Content Hosting](static-content-hosting.md).</span><span class="sxs-lookup"><span data-stu-id="531a7-226">[Static Content Hosting pattern](static-content-hosting.md).</span></span> <span data-ttu-id="531a7-227">Describe cómo implementar recursos estáticos en un servicio de almacenamiento basado en la nube que puede proporcionar estos recursos directamente al cliente para reducir la necesidad de instancias de proceso costosas.</span><span class="sxs-lookup"><span data-stu-id="531a7-227">Describes how to deploy static resources to a cloud-based storage service that can deliver these resources directly to the client to reduce the requirement for expensive compute instances.</span></span> <span data-ttu-id="531a7-228">Cuando la finalidad de los recursos no es que estén públicamente disponibles, el patrón Vale Key se puede usar para protegerlos.</span><span class="sxs-lookup"><span data-stu-id="531a7-228">Where the resources aren't intended to be publicly available, the Valet Key pattern can be used to secure them.</span></span>
- <span data-ttu-id="531a7-229">[Introducing Table SAS (Shared Access Signature), Queue SAS and update to Blob SAS](https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/12/introducing-table-sas-shared-access-signature-queue-sas-and-update-to-blob-sas/) (Introducción a SAS [firma de acceso compartido] de Table, SAS de Queue y actualización a SAS de Blob)</span><span class="sxs-lookup"><span data-stu-id="531a7-229">[Introducing Table SAS (Shared Access Signature), Queue SAS and update to Blob SAS](https://blogs.msdn.microsoft.com/windowsazurestorage/2012/06/12/introducing-table-sas-shared-access-signature-queue-sas-and-update-to-blob-sas/)</span></span>
- [<span data-ttu-id="531a7-230">Uso de firmas de acceso compartido</span><span class="sxs-lookup"><span data-stu-id="531a7-230">Using Shared Access Signatures</span></span>](https://azure.microsoft.com/documentation/articles/storage-dotnet-shared-access-signature-part-1/)
- [<span data-ttu-id="531a7-231">Autenticación con firma de acceso compartido en Service Bus</span><span class="sxs-lookup"><span data-stu-id="531a7-231">Shared Access Signature Authentication with Service Bus</span></span>](https://azure.microsoft.com/documentation/articles/service-bus-shared-access-signature-authentication/)
