---
title: Cola con prioridad
description: Clasifica por orden de prioridad las solicitudes enviadas a los servicios para que aquellas con una prioridad más alta se reciban y procesen más rápidamente que las que tienen una prioridad más baja.
keywords: Patrón de diseño
author: dragon119
ms.date: 06/23/2017
pnp.series.title: Cloud Design Patterns
pnp.pattern.categories:
- messaging
- performance-scalability
ms.openlocfilehash: 400bfbc03cf5640ff32a551636b01d60e6c0ec50
ms.sourcegitcommit: 94d50043db63416c4d00cebe927a0c88f78c3219
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 09/28/2018
ms.locfileid: "47428506"
---
# <a name="priority-queue-pattern"></a><span data-ttu-id="43c65-104">Patrón de cola de prioridad</span><span class="sxs-lookup"><span data-stu-id="43c65-104">Priority Queue pattern</span></span>

[!INCLUDE [header](../_includes/header.md)]

<span data-ttu-id="43c65-105">Clasifica por orden de prioridad las solicitudes enviadas a los servicios para que aquellas con una prioridad más alta se reciban y procesen más rápidamente que las que tienen una prioridad más baja.</span><span class="sxs-lookup"><span data-stu-id="43c65-105">Prioritize requests sent to services so that requests with a higher priority are received and processed more quickly than those with a lower priority.</span></span> <span data-ttu-id="43c65-106">Este patrón es útil en aplicaciones que ofrecen garantías de nivel de servicio diferentes a los clientes individuales.</span><span class="sxs-lookup"><span data-stu-id="43c65-106">This pattern is useful in applications that offer different service level guarantees to individual clients.</span></span>

## <a name="context-and-problem"></a><span data-ttu-id="43c65-107">Contexto y problema</span><span class="sxs-lookup"><span data-stu-id="43c65-107">Context and Problem</span></span>

<span data-ttu-id="43c65-108">Las aplicaciones pueden delegar tareas específicas a otros servicios, por ejemplo, para realizar el procesamiento en segundo plano o para integrarse con otras aplicaciones o servicios.</span><span class="sxs-lookup"><span data-stu-id="43c65-108">Applications can delegate specific tasks to other services, for example, to perform background processing or to integrate with other applications or services.</span></span> <span data-ttu-id="43c65-109">En la nube, una cola de mensajes se utiliza normalmente para delegar tareas al procesamiento en segundo plano.</span><span class="sxs-lookup"><span data-stu-id="43c65-109">In the cloud, a message queue is typically used to delegate tasks to background processing.</span></span> <span data-ttu-id="43c65-110">En muchos casos, el orden en que se reciben las solicitudes en un servicio no es importante.</span><span class="sxs-lookup"><span data-stu-id="43c65-110">In many cases the order requests are received in by a service isn't important.</span></span> <span data-ttu-id="43c65-111">Sin embargo, en algunos casos, es necesario dar prioridad a solicitudes específicas.</span><span class="sxs-lookup"><span data-stu-id="43c65-111">In some cases, though, it's necessary to prioritize specific requests.</span></span> <span data-ttu-id="43c65-112">Estas solicitudes deben procesarse antes que las solicitudes de menor prioridad enviadas anteriormente por la aplicación.</span><span class="sxs-lookup"><span data-stu-id="43c65-112">These requests should be processed earlier than lower priority requests that were sent previously by the application.</span></span>

## <a name="solution"></a><span data-ttu-id="43c65-113">Solución</span><span class="sxs-lookup"><span data-stu-id="43c65-113">Solution</span></span>

<span data-ttu-id="43c65-114">Una cola suele tener una estructura basada en el criterio primero en entrar, primero en salir, y los consumidores normalmente reciben mensajes en el mismo orden en que se publicaron en la cola.</span><span class="sxs-lookup"><span data-stu-id="43c65-114">A queue is usually a first-in, first-out (FIFO) structure, and consumers typically receive messages in the same order that they were posted to the queue.</span></span> <span data-ttu-id="43c65-115">Sin embargo, algunas colas de mensajes admiten mensajería de prioridad.</span><span class="sxs-lookup"><span data-stu-id="43c65-115">However, some message queues support priority messaging.</span></span> <span data-ttu-id="43c65-116">La aplicación que envía un mensaje puede asignar una prioridad y los mensajes de la cola se reordenan automáticamente para que los que tienen una prioridad más alta se reciban antes que aquellos con una prioridad más baja.</span><span class="sxs-lookup"><span data-stu-id="43c65-116">The application posting a message can assign a priority and the messages in the queue are automatically reordered so that those with a higher priority will be received before those with a lower priority.</span></span> <span data-ttu-id="43c65-117">En la figura se ilustra una cola con mensajes prioritarios.</span><span class="sxs-lookup"><span data-stu-id="43c65-117">The figure illustrates a queue with priority messaging.</span></span>

![Figura 1: Uso de un mecanismo de cola que admite la asignación de prioridad a los mensajes](./_images/priority-queue-pattern.png)

> <span data-ttu-id="43c65-119">La mayoría de las implementaciones de cola de mensajes admiten varios consumidores (siguiendo el [patrón de consumidores en competencia](https://msdn.microsoft.com/library/dn568101.aspx)), y el número de procesos de consumidor se puede escalar o reducir verticalmente en función de la demanda.</span><span class="sxs-lookup"><span data-stu-id="43c65-119">Most message queue implementations support multiple consumers (following the [Competing Consumers pattern](https://msdn.microsoft.com/library/dn568101.aspx)), and the number of consumer processes can be scaled up or down depending on demand.</span></span>

<span data-ttu-id="43c65-120">En los sistemas que no admiten colas de mensajes basadas en prioridad, una solución alternativa consiste en mantener una cola independiente para cada prioridad.</span><span class="sxs-lookup"><span data-stu-id="43c65-120">In systems that don't support priority-based message queues, an alternative solution is to maintain a separate queue for each priority.</span></span> <span data-ttu-id="43c65-121">La aplicación es responsable de enviar mensajes a la cola adecuada.</span><span class="sxs-lookup"><span data-stu-id="43c65-121">The application is responsible for posting messages to the appropriate queue.</span></span> <span data-ttu-id="43c65-122">Cada cola puede tener un grupo independiente de consumidores.</span><span class="sxs-lookup"><span data-stu-id="43c65-122">Each queue can have a separate pool of consumers.</span></span> <span data-ttu-id="43c65-123">Las colas de más prioridad pueden tener un grupo más grande de consumidores en ejecución en hardware más rápido que las colas de menor prioridad.</span><span class="sxs-lookup"><span data-stu-id="43c65-123">Higher priority queues can have a larger pool of consumers running on faster hardware than lower priority queues.</span></span> <span data-ttu-id="43c65-124">En la ilustración siguiente se muestra cómo utilizar las colas de mensajes independientes para cada prioridad.</span><span class="sxs-lookup"><span data-stu-id="43c65-124">The next figure illustrates using separate message queues for each priority.</span></span>

![Figura 2: Uso de las colas de mensajes independientes para cada prioridad](./_images/priority-queue-separate.png)


<span data-ttu-id="43c65-126">Una variación de esta estrategia es disponer de un único grupo de consumidores que primero comprueba los mensajes en las colas de alta prioridad, y solo después inicia la captura de los mensajes de colas de prioridad más baja.</span><span class="sxs-lookup"><span data-stu-id="43c65-126">A variation on this strategy is to have a single pool of consumers that check for messages on high priority queues first, and only then start to fetch messages from lower priority queues.</span></span> <span data-ttu-id="43c65-127">Hay algunas diferencias semánticas entre una solución que utiliza un único grupo de procesos de consumidor (ya sea con una sola cola que admite mensajes con prioridades diferentes o con varias colas donde cada una controla los mensajes de una única prioridad) y una solución que usa varias colas con un grupo independiente para cada cola.</span><span class="sxs-lookup"><span data-stu-id="43c65-127">There are some semantic differences between a solution that uses a single pool of consumer processes (either with a single queue that supports messages with different priorities or with multiple queues that each handle messages of a single priority), and a solution that uses multiple queues with a separate pool for each queue.</span></span>

<span data-ttu-id="43c65-128">En el enfoque de grupo único, los mensajes con prioridad más alta siempre se reciben y procesan antes que los mensajes de prioridad más baja.</span><span class="sxs-lookup"><span data-stu-id="43c65-128">In the single pool approach, higher priority messages are always received and processed before lower priority messages.</span></span> <span data-ttu-id="43c65-129">En teoría, los mensajes que tienen una prioridad muy baja pueden reemplazarse continuamente y puede que nunca se procesen.</span><span class="sxs-lookup"><span data-stu-id="43c65-129">In theory, messages that have a very low priority could be continually superseded and might never be processed.</span></span> <span data-ttu-id="43c65-130">En el enfoque de varios grupos, los mensajes de prioridad más baja siempre se procesarán, pero no tan rápido como los de más prioridad (en función del tamaño relativo de los grupos y los recursos que tienen disponibles).</span><span class="sxs-lookup"><span data-stu-id="43c65-130">In the multiple pool approach, lower priority messages will always be processed, just not as quickly as those of a higher priority (depending on the relative size of the pools and the resources that they have available).</span></span>

<span data-ttu-id="43c65-131">El uso de un mecanismo de puesta en cola según prioridad puede ofrecer las ventajas siguientes:</span><span class="sxs-lookup"><span data-stu-id="43c65-131">Using a priority queuing mechanism can provide the following advantages:</span></span>

- <span data-ttu-id="43c65-132">Permite a las aplicaciones satisfacer los requisitos empresariales que requieren la asignación de prioridades de disponibilidad o rendimiento, por ejemplo, ofrecer distintos niveles de servicio a grupos concretos de clientes.</span><span class="sxs-lookup"><span data-stu-id="43c65-132">It allows applications to meet business requirements that require prioritization of availability or performance, such as offering different levels of service to specific groups of customers.</span></span>

- <span data-ttu-id="43c65-133">Puede ayudar a minimizar los costos operativos.</span><span class="sxs-lookup"><span data-stu-id="43c65-133">It can help to minimize operational costs.</span></span> <span data-ttu-id="43c65-134">En el enfoque de cola única, se puede reducir el número de consumidores si es necesario.</span><span class="sxs-lookup"><span data-stu-id="43c65-134">In the single queue approach, you can scale back the number of consumers if necessary.</span></span> <span data-ttu-id="43c65-135">Los mensajes con prioridad alta se seguirán procesando en primer lugar (aunque posiblemente más lentos), y los mensajes de menor prioridad podrían tardar más.</span><span class="sxs-lookup"><span data-stu-id="43c65-135">High priority messages will still be processed first (although possibly more slowly), and lower priority messages might be delayed for longer.</span></span> <span data-ttu-id="43c65-136">Si ha implementado el enfoque de varias colas de mensajes con grupos independientes de consumidores para cada cola, puede reducir el grupo de consumidores para las colas de menor prioridad, o incluso suspender el procesamiento de algunas colas de prioridad muy baja al detener a todos los consumidores que escuchan mensajes en dichas colas.</span><span class="sxs-lookup"><span data-stu-id="43c65-136">If you've implemented the multiple message queue approach with separate pools of consumers for each queue, you can reduce the pool of consumers for lower priority queues, or even suspend processing for some very low priority queues by stopping all the consumers that listen for messages on those queues.</span></span>

- <span data-ttu-id="43c65-137">El enfoque de varias colas de mensajes puede ayudar a maximizar el rendimiento y la escalabilidad de la aplicación mediante la partición de mensajes en función de los requisitos de procesamiento.</span><span class="sxs-lookup"><span data-stu-id="43c65-137">The multiple message queue approach can help maximize application performance and scalability by partitioning messages based on processing requirements.</span></span> <span data-ttu-id="43c65-138">Por ejemplo, se puede dar prioridad a tareas vitales para que las controlen los receptores que se ejecutan inmediatamente, mientras que las tareas en segundo plano menos importantes pueden controlarlas los receptores programados para ejecutarse en períodos menos saturados.</span><span class="sxs-lookup"><span data-stu-id="43c65-138">For example, vital tasks can be prioritized to be handled by receivers that run immediately while less important background tasks can be handled by receivers that are scheduled to run at less busy periods.</span></span>

## <a name="issues-and-considerations"></a><span data-ttu-id="43c65-139">Problemas y consideraciones</span><span class="sxs-lookup"><span data-stu-id="43c65-139">Issues and Considerations</span></span>

<span data-ttu-id="43c65-140">Tenga en cuenta los puntos siguientes al decidir cómo implementar este patrón:</span><span class="sxs-lookup"><span data-stu-id="43c65-140">Consider the following points when deciding how to implement this pattern:</span></span>

<span data-ttu-id="43c65-141">Defina las prioridades en el contexto de la solución.</span><span class="sxs-lookup"><span data-stu-id="43c65-141">Define the priorities in the context of the solution.</span></span> <span data-ttu-id="43c65-142">Por ejemplo, una prioridad alta puede significar que se deben procesar los mensajes en diez segundos.</span><span class="sxs-lookup"><span data-stu-id="43c65-142">For example, high priority could mean that messages should be processed within ten seconds.</span></span> <span data-ttu-id="43c65-143">Identifique los requisitos para administrar elementos de prioridad alta y los otros recursos que se deben asignar a fin de cumplir estos criterios.</span><span class="sxs-lookup"><span data-stu-id="43c65-143">Identify the requirements for handling high priority items, and the other resources that should be allocated to meet these criteria.</span></span>

<span data-ttu-id="43c65-144">Decida si se deben procesar todos los elementos de prioridad alta antes que los elementos de menor prioridad.</span><span class="sxs-lookup"><span data-stu-id="43c65-144">Decide if all high priority items must be processed before any lower priority items.</span></span> <span data-ttu-id="43c65-145">Si los mensajes los procesa un único grupo de consumidores, tendrá que proporcionar un mecanismo que pueda dar prioridad y suspender una tarea que administra un mensaje de prioridad baja si hay disponible un mensaje de mayor prioridad.</span><span class="sxs-lookup"><span data-stu-id="43c65-145">If the messages are being processed by a single pool of consumers, you have to provide a mechanism that can preempt and suspend a task that's handling a low priority message if a higher priority message becomes available.</span></span>

<span data-ttu-id="43c65-146">En el enfoque de varias colas, al usar un único grupo de procesos de consumidores que escuchan en todas las colas en lugar de un grupo de consumidores dedicado para cada cola, el consumidor debe aplicar un algoritmo que asegure que siempre pueda administrar los mensajes de colas de prioridad más alta antes que los de las colas de prioridad más baja.</span><span class="sxs-lookup"><span data-stu-id="43c65-146">In the multiple queue approach, when using a single pool of consumer processes that listen on all queues rather than a dedicated consumer pool for each queue, the consumer must apply an algorithm that ensures it always services messages from higher priority queues before those from lower priority queues.</span></span>

<span data-ttu-id="43c65-147">Supervise la velocidad de procesamiento en colas de alta y baja prioridad para garantizar que los mensajes de estas colas se procesan a la velocidad esperada.</span><span class="sxs-lookup"><span data-stu-id="43c65-147">Monitor the processing speed on high and low priority queues to ensure that messages in these queues are processed at the expected rates.</span></span>

<span data-ttu-id="43c65-148">Si necesita garantizar que se procesarán los mensajes con prioridad baja, es necesario implementar el enfoque de varias colas de mensajes con varios grupos de consumidores.</span><span class="sxs-lookup"><span data-stu-id="43c65-148">If you need to guarantee that low priority messages will be processed, it's necessary to implement the multiple message queue approach with multiple pools of consumers.</span></span> <span data-ttu-id="43c65-149">Como alternativa, en una cola que admite la concesión de prioridad a los mensajes, es posible aumentar de forma dinámica la prioridad de un mensaje en cola, conforme avanza el tiempo.</span><span class="sxs-lookup"><span data-stu-id="43c65-149">Alternatively, in a queue that supports message prioritization, it's possible to dynamically increase the priority of a queued message as it ages.</span></span> <span data-ttu-id="43c65-150">Sin embargo, este enfoque depende de la cola de mensajes que ofrece esta característica.</span><span class="sxs-lookup"><span data-stu-id="43c65-150">However, this approach depends on the message queue providing this feature.</span></span>

<span data-ttu-id="43c65-151">Usar una cola independiente para cada prioridad de mensajes funciona mejor para los sistemas que tener un número pequeño de prioridades bien definidas.</span><span class="sxs-lookup"><span data-stu-id="43c65-151">Using a separate queue for each message priority works best for systems that have a small number of well-defined priorities.</span></span>

<span data-ttu-id="43c65-152">El sistema puede determinar de manera lógica las prioridades de los mensajes.</span><span class="sxs-lookup"><span data-stu-id="43c65-152">Message priorities can be determined logically by the system.</span></span> <span data-ttu-id="43c65-153">Por ejemplo, en lugar de tener mensajes explícitos con prioridad alta y baja, se podrían designar como "cliente que paga las cuotas" o "cliente que no paga las cuotas".</span><span class="sxs-lookup"><span data-stu-id="43c65-153">For example, rather than having explicit high and low priority messages, they could be designated as “fee paying customer,” or “non-fee paying customer.”</span></span> <span data-ttu-id="43c65-154">Dependiendo del modelo de negocio, el sistema puede asignar más recursos para procesar los mensajes de los clientes que pagan las cuotas que para los clientes que no las pagan.</span><span class="sxs-lookup"><span data-stu-id="43c65-154">Depending on your business model, your system can allocate more resources to processing messages from fee paying customers than non-fee paying ones.</span></span>

<span data-ttu-id="43c65-155">Puede haber un costo financiero y de procesamiento asociado con la comprobación de un mensaje en una cola (algunos sistemas de mensajería comerciales cargan una tarifa reducida cada vez que se envía o recupera un mensaje y cada vez que se consultan mensajes en una cola).</span><span class="sxs-lookup"><span data-stu-id="43c65-155">There might be a financial and processing cost associated with checking a queue for a message (some commercial messaging systems charge a small fee each time a message is posted or retrieved, and each time a queue is queried for messages).</span></span> <span data-ttu-id="43c65-156">Este costo aumenta si se comprueban varias colas.</span><span class="sxs-lookup"><span data-stu-id="43c65-156">This cost increases when checking multiple queues.</span></span>

<span data-ttu-id="43c65-157">Es posible ajustar dinámicamente el tamaño de un grupo de consumidores en función de la longitud de la cola que atiende al grupo.</span><span class="sxs-lookup"><span data-stu-id="43c65-157">It's possible to dynamically adjust the size of a pool of consumers based on the length of the queue that the pool is servicing.</span></span> <span data-ttu-id="43c65-158">Para más información, vea la [Guía de escalado automático](https://msdn.microsoft.com/library/dn589774.aspx).</span><span class="sxs-lookup"><span data-stu-id="43c65-158">For more information, see the [Autoscaling Guidance](https://msdn.microsoft.com/library/dn589774.aspx).</span></span>

## <a name="when-to-use-this-pattern"></a><span data-ttu-id="43c65-159">Cuándo usar este patrón</span><span class="sxs-lookup"><span data-stu-id="43c65-159">When to use this pattern</span></span>

<span data-ttu-id="43c65-160">Este patrón es útil en escenarios donde:</span><span class="sxs-lookup"><span data-stu-id="43c65-160">This pattern is useful in scenarios where:</span></span>

- <span data-ttu-id="43c65-161">El sistema debe controlar varias tareas que tengan diferentes prioridades.</span><span class="sxs-lookup"><span data-stu-id="43c65-161">The system must handle multiple tasks that have different priorities.</span></span>

- <span data-ttu-id="43c65-162">Los distintos usuarios o inquilinos deben atender las solicitudes con otra prioridad.</span><span class="sxs-lookup"><span data-stu-id="43c65-162">Different users or tenants should be served with different priority.</span></span>

## <a name="example"></a><span data-ttu-id="43c65-163">Ejemplo</span><span class="sxs-lookup"><span data-stu-id="43c65-163">Example</span></span>

<span data-ttu-id="43c65-164">Microsoft Azure no proporciona un mecanismo de puesta en cola que admita de forma nativa la asignación de prioridad a los mensajes a través de la ordenación.</span><span class="sxs-lookup"><span data-stu-id="43c65-164">Microsoft Azure doesn't provide a queuing mechanism that natively supports automatic prioritization of messages through sorting.</span></span> <span data-ttu-id="43c65-165">Sin embargo, proporciona temas y suscripciones de Azure Service Bus que admiten un mecanismo de puesta en cola que ofrece filtrado de mensajes, además de un amplio conjunto de funcionalidades flexibles que lo hacen ideal para usarlo en las implementaciones de colas con la máxima prioridad.</span><span class="sxs-lookup"><span data-stu-id="43c65-165">However, it does provide Azure Service Bus topics and subscriptions that support a queuing mechanism that provides message filtering, together with a wide range of flexible capabilities that make it ideal for use in most priority queue implementations.</span></span>

<span data-ttu-id="43c65-166">Una solución de Azure puede implementar un tema de Service Bus en el que una aplicación puede publicar mensajes, de la misma manera que una cola.</span><span class="sxs-lookup"><span data-stu-id="43c65-166">An Azure solution can implement a Service Bus topic an application can post messages to, in the same way as a queue.</span></span> <span data-ttu-id="43c65-167">Los mensajes pueden contener metadatos en forma de propiedades personalizadas definidas por la aplicación.</span><span class="sxs-lookup"><span data-stu-id="43c65-167">Messages can contain metadata in the form of application-defined custom properties.</span></span> <span data-ttu-id="43c65-168">Las suscripciones de Service Bus se pueden asociar con el tema, y estas suscripciones pueden filtrar los mensajes en función de sus propiedades.</span><span class="sxs-lookup"><span data-stu-id="43c65-168">Service Bus subscriptions can be associated with the topic, and these subscriptions can filter messages based on their properties.</span></span> <span data-ttu-id="43c65-169">Cuando una aplicación envía un mensaje a un tema, el mensaje se dirige a la suscripción correspondiente donde lo puede leer un consumidor.</span><span class="sxs-lookup"><span data-stu-id="43c65-169">When an application sends a message to a topic, the message is directed to the appropriate subscription where it can be read by a consumer.</span></span> <span data-ttu-id="43c65-170">Los procesos del consumidor pueden recuperar mensajes de una suscripción utilizando la misma semántica que una cola de mensajes (una suscripción es una cola lógica).</span><span class="sxs-lookup"><span data-stu-id="43c65-170">Consumer processes can retrieve messages from a subscription using the same semantics as a message queue (a subscription is a logical queue).</span></span> <span data-ttu-id="43c65-171">En la ilustración siguiente se muestra cómo implementar una cola de prioridad con temas y suscripciones de Azure Service Bus.</span><span class="sxs-lookup"><span data-stu-id="43c65-171">The following figure illustrates implementing a priority queue with Azure Service Bus topics and subscriptions.</span></span>

![Figura 3: Implementación de una cola de prioridad con temas y suscripciones de Azure Service Bus](./_images/priority-queue-service-bus.png)


<span data-ttu-id="43c65-173">En la figura anterior, la aplicación crea varios mensajes y asigna una propiedad personalizada denominada `Priority` en cada mensaje con un valor, `High` o `Low`.</span><span class="sxs-lookup"><span data-stu-id="43c65-173">In the figure above, the application creates several messages and assigns a custom property called `Priority` in each message with a value, either `High` or `Low`.</span></span> <span data-ttu-id="43c65-174">La aplicación envía estos mensajes a un tema.</span><span class="sxs-lookup"><span data-stu-id="43c65-174">The application posts these messages to a topic.</span></span> <span data-ttu-id="43c65-175">El tema tiene dos suscripciones asociadas que filtran los mensajes examinando la propiedad `Priority`.</span><span class="sxs-lookup"><span data-stu-id="43c65-175">The topic has two associated subscriptions that both filter messages by examining the `Priority` property.</span></span> <span data-ttu-id="43c65-176">Una suscripción acepta mensajes donde la propiedad `Priority` está establecida en `High`, y la otra acepta mensajes donde la propiedad `Priority` está establecida en `Low`.</span><span class="sxs-lookup"><span data-stu-id="43c65-176">One subscription accepts messages where the `Priority` property is set to `High`, and the other accepts messages where the `Priority` property is set to `Low`.</span></span> <span data-ttu-id="43c65-177">Un grupo de consumidores lee los mensajes de cada suscripción.</span><span class="sxs-lookup"><span data-stu-id="43c65-177">A pool of consumers reads messages from each subscription.</span></span> <span data-ttu-id="43c65-178">La suscripción de alta prioridad tiene un grupo más grande, y estos consumidores podrían estar ejecutándose en equipos más eficaces con más recursos disponibles que los consumidores del grupo de prioridad baja.</span><span class="sxs-lookup"><span data-stu-id="43c65-178">The high priority subscription has a larger pool, and these consumers might be running on more powerful computers with more resources available than the consumers in the low priority pool.</span></span>

<span data-ttu-id="43c65-179">Tenga en cuenta que no hay nada especial acerca de la designación de mensajes con prioridad alta y baja en este ejemplo.</span><span class="sxs-lookup"><span data-stu-id="43c65-179">Note that there's nothing special about the designation of high and low priority messages in this example.</span></span> <span data-ttu-id="43c65-180">Son simplemente etiquetas especificadas como propiedades en cada mensaje, que se utilizan para dirigir mensajes a una suscripción específica.</span><span class="sxs-lookup"><span data-stu-id="43c65-180">They're simply labels specified as properties in each message, and are used to direct messages to a specific subscription.</span></span> <span data-ttu-id="43c65-181">Si se requieren prioridades adicionales, es relativamente fácil crear más suscripciones y grupos de procesos de consumidor para controlar estas prioridades.</span><span class="sxs-lookup"><span data-stu-id="43c65-181">If additional priorities are required, it's relatively easy to create further subscriptions and pools of consumer processes to handle these priorities.</span></span>

<span data-ttu-id="43c65-182">La solución PriorityQueue disponible en [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/priority-queue) contiene una implementación de este enfoque.</span><span class="sxs-lookup"><span data-stu-id="43c65-182">The PriorityQueue solution available on [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/priority-queue) contains an implementation of this approach.</span></span> <span data-ttu-id="43c65-183">Esta solución contiene dos proyectos de rol de trabajo denominados `PriorityQueue.High` y `PriorityQueue.Low`.</span><span class="sxs-lookup"><span data-stu-id="43c65-183">This solution contains two worker role projects named `PriorityQueue.High` and `PriorityQueue.Low`.</span></span> <span data-ttu-id="43c65-184">Estos roles de trabajo se heredan de la clase `PriorityWorkerRole` que contiene la funcionalidad para conectarse a una suscripción especificada en el método `OnStart`.</span><span class="sxs-lookup"><span data-stu-id="43c65-184">These worker roles inherit from the `PriorityWorkerRole` class that contains the functionality for connecting to a specified subscription in the `OnStart` method.</span></span>

<span data-ttu-id="43c65-185">Los roles de trabajo `PriorityQueue.High` y `PriorityQueue.Low` se conectan a distintas suscripciones, definidas por sus valores de configuración.</span><span class="sxs-lookup"><span data-stu-id="43c65-185">The `PriorityQueue.High` and `PriorityQueue.Low` worker roles connect to different subscriptions, defined by their configuration settings.</span></span> <span data-ttu-id="43c65-186">Un administrador puede configurar un número diferente de cada rol para ejecutarlo.</span><span class="sxs-lookup"><span data-stu-id="43c65-186">An administrator can configure different numbers of each role to be run.</span></span> <span data-ttu-id="43c65-187">Normalmente, habrá más instancias del rol de trabajo `PriorityQueue.High` que del rol de trabajo `PriorityQueue.Low`.</span><span class="sxs-lookup"><span data-stu-id="43c65-187">Typically there'll be more instances of the `PriorityQueue.High` worker role than the `PriorityQueue.Low` worker role.</span></span>

<span data-ttu-id="43c65-188">El método `Run` de la clase `PriorityWorkerRole` se encarga de que el método virtual `ProcessMessage` (también definido en la clase `PriorityWorkerRole`) se ejecute para cada mensaje recibido en la cola.</span><span class="sxs-lookup"><span data-stu-id="43c65-188">The `Run` method in the `PriorityWorkerRole` class arranges for the virtual `ProcessMessage` method (also defined in the `PriorityWorkerRole` class) to be run for each message received on the queue.</span></span> <span data-ttu-id="43c65-189">El siguiente código muestra los métodos `Run` y `ProcessMessage`.</span><span class="sxs-lookup"><span data-stu-id="43c65-189">The following code shows the `Run` and `ProcessMessage` methods.</span></span> <span data-ttu-id="43c65-190">La clase `QueueManager`, definida en el proyecto PriorityQueue.Shared, proporciona métodos auxiliares para usar colas de Azure Service Bus.</span><span class="sxs-lookup"><span data-stu-id="43c65-190">The `QueueManager` class, defined in the PriorityQueue.Shared project, provides helper methods for using Azure Service Bus queues.</span></span>

```csharp
public class PriorityWorkerRole : RoleEntryPoint
{
  private QueueManager queueManager;
  ...

  public override void Run()
  {
    // Start listening for messages on the subscription.
    var subscriptionName = CloudConfigurationManager.GetSetting("SubscriptionName");
    this.queueManager.ReceiveMessages(subscriptionName, this.ProcessMessage);
    ...;
  }
  ...

  protected virtual async Task ProcessMessage(BrokeredMessage message)
  {
    // Simulating processing.
    await Task.Delay(TimeSpan.FromSeconds(2));
  }
}
```
<span data-ttu-id="43c65-191">Los roles de trabajo `PriorityQueue.High` y `PriorityQueue.Low` invalidan la funcionalidad predeterminada del método `ProcessMessage`.</span><span class="sxs-lookup"><span data-stu-id="43c65-191">The `PriorityQueue.High` and `PriorityQueue.Low` worker roles both override the default functionality of the `ProcessMessage` method.</span></span> <span data-ttu-id="43c65-192">El código siguiente muestra el método `ProcessMessage` para el rol de trabajo `PriorityQueue.High`.</span><span class="sxs-lookup"><span data-stu-id="43c65-192">The code below shows the `ProcessMessage` method for the `PriorityQueue.High` worker role.</span></span>

```csharp
protected override async Task ProcessMessage(BrokeredMessage message)
{
  // Simulate message processing for High priority messages.
  await base.ProcessMessage(message);
  Trace.TraceInformation("High priority message processed by " +
    RoleEnvironment.CurrentRoleInstance.Id + " MessageId: " + message.MessageId);
}
```

<span data-ttu-id="43c65-193">Cuando una aplicación envía mensajes al tema asociado con las suscripciones utilizadas por los roles de trabajo `PriorityQueue.High` y `PriorityQueue.Low`, especifica la prioridad con el uso de la propiedad personalizada `Priority`, como se muestra en el siguiente ejemplo de código.</span><span class="sxs-lookup"><span data-stu-id="43c65-193">When an application posts messages to the topic associated with the subscriptions used by the `PriorityQueue.High` and `PriorityQueue.Low` worker roles, it specifies the priority by using the `Priority` custom property, as shown in the following code example.</span></span> <span data-ttu-id="43c65-194">Este código (implementado en la clase `WorkerRole` en el proyecto PriorityQueue.Sender), utiliza el método auxiliar `SendBatchAsync` de la clase `QueueManager` para enviar mensajes a un tema en lotes.</span><span class="sxs-lookup"><span data-stu-id="43c65-194">This code (implemented in the `WorkerRole` class in the PriorityQueue.Sender project), uses the `SendBatchAsync` helper method of the `QueueManager` class to post messages to a topic in batches.</span></span>

```csharp
// Send a low priority batch.
var lowMessages = new List<BrokeredMessage>();

for (int i = 0; i < 10; i++)
{
  var message = new BrokeredMessage() { MessageId = Guid.NewGuid().ToString() };
  message.Properties["Priority"] = Priority.Low;
  lowMessages.Add(message);
}

this.queueManager.SendBatchAsync(lowMessages).Wait();
...

// Send a high priority batch.
var highMessages = new List<BrokeredMessage>();

for (int i = 0; i < 10; i++)
{
  var message = new BrokeredMessage() { MessageId = Guid.NewGuid().ToString() };
  message.Properties["Priority"] = Priority.High;
  highMessages.Add(message);
}

this.queueManager.SendBatchAsync(highMessages).Wait();
```

## <a name="related-patterns-and-guidance"></a><span data-ttu-id="43c65-195">Orientación y patrones relacionados</span><span class="sxs-lookup"><span data-stu-id="43c65-195">Related patterns and guidance</span></span>

<span data-ttu-id="43c65-196">Los patrones y las directrices siguientes también pueden ser importantes a la hora de implementar este modelo:</span><span class="sxs-lookup"><span data-stu-id="43c65-196">The following patterns and guidance might also be relevant when implementing this pattern:</span></span>

- <span data-ttu-id="43c65-197">Se encuentra disponible un ejemplo que demuestra este patrón en [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/priority-queue).</span><span class="sxs-lookup"><span data-stu-id="43c65-197">A sample that demonstrates this pattern is available on [GitHub](https://github.com/mspnp/cloud-design-patterns/tree/master/priority-queue).</span></span>

- <span data-ttu-id="43c65-198">[Manual de mensajería asincrónica](https://msdn.microsoft.com/library/dn589781.aspx).</span><span class="sxs-lookup"><span data-stu-id="43c65-198">[Asynchronous Messaging Primer](https://msdn.microsoft.com/library/dn589781.aspx).</span></span> <span data-ttu-id="43c65-199">Un servicio de consumidor que procesa una solicitud puede necesitar enviar una respuesta a la instancia de la aplicación que publicó la solicitud.</span><span class="sxs-lookup"><span data-stu-id="43c65-199">A consumer service that processes a request might need to send a reply to the instance of the application that posted the request.</span></span> <span data-ttu-id="43c65-200">Proporciona información sobre las estrategias que puede usar para implementar la mensajería de solicitud/respuesta.</span><span class="sxs-lookup"><span data-stu-id="43c65-200">Provides information on the strategies that you can use to implement request/response messaging.</span></span>

- <span data-ttu-id="43c65-201">[Patrón de consumidores de la competencia](competing-consumers.md).</span><span class="sxs-lookup"><span data-stu-id="43c65-201">[Competing Consumers pattern](competing-consumers.md).</span></span> <span data-ttu-id="43c65-202">Para mejorar el rendimiento de las colas, es posible tener varios consumidores que escuchen en la misma cola y procesen las tareas en paralelo.</span><span class="sxs-lookup"><span data-stu-id="43c65-202">To increase the throughput of the queues, it’s possible to have multiple consumers that listen on the same queue, and process the tasks in parallel.</span></span> <span data-ttu-id="43c65-203">Estos consumidores competirán por los mensajes, pero solo uno debe ser capaz de procesar cada mensaje.</span><span class="sxs-lookup"><span data-stu-id="43c65-203">These consumers will compete for messages, but only one should be able to process each message.</span></span> <span data-ttu-id="43c65-204">Proporciona más información sobre las ventajas y los inconvenientes de la implementación de este enfoque.</span><span class="sxs-lookup"><span data-stu-id="43c65-204">Provides more information on the benefits and tradeoffs of implementing this approach.</span></span>

- <span data-ttu-id="43c65-205">[Patrón de limitación](throttling.md).</span><span class="sxs-lookup"><span data-stu-id="43c65-205">[Throttling pattern](throttling.md).</span></span> <span data-ttu-id="43c65-206">Puede implementar la limitación mediante el uso de colas.</span><span class="sxs-lookup"><span data-stu-id="43c65-206">You can implement throttling by using queues.</span></span> <span data-ttu-id="43c65-207">La mensajería de prioridad puede usarse para asegurarse de que se concede prioridad a las solicitudes que proceden de aplicaciones críticas o de aplicaciones ejecutadas por clientes de alto valor con respecto a las solicitudes de aplicaciones menos importantes.</span><span class="sxs-lookup"><span data-stu-id="43c65-207">Priority messaging can be used to ensure that requests from critical applications, or applications being run by high-value customers, are given priority over requests from less important applications.</span></span>

- <span data-ttu-id="43c65-208">[Guía de escalado automático](https://msdn.microsoft.com/library/dn589774.aspx).</span><span class="sxs-lookup"><span data-stu-id="43c65-208">[Autoscaling Guidance](https://msdn.microsoft.com/library/dn589774.aspx).</span></span> <span data-ttu-id="43c65-209">Es posible escalar el tamaño del grupo de procesos de consumidor que controlan una cola en función de la longitud de la cola.</span><span class="sxs-lookup"><span data-stu-id="43c65-209">It might be possible to scale the size of the pool of consumer processes handling a queue depending on the length of the queue.</span></span> <span data-ttu-id="43c65-210">Esta estrategia puede ayudar a mejorar el rendimiento, especialmente para los grupos que controlan los mensajes con prioridad alta.</span><span class="sxs-lookup"><span data-stu-id="43c65-210">This strategy can help to improve performance, especially for pools handling high priority messages.</span></span>

- <span data-ttu-id="43c65-211">[Patrones de Integración empresarial con Service Bus](https://abhishekrlal.com/2013/01/11/enterprise-integration-patterns-with-service-bus-part-2/) en el blog de Abhishek Lal.</span><span class="sxs-lookup"><span data-stu-id="43c65-211">[Enterprise Integration Patterns with Service Bus](https://abhishekrlal.com/2013/01/11/enterprise-integration-patterns-with-service-bus-part-2/) on Abhishek Lal’s blog.</span></span>

