---
title: "Ejecución de máquinas virtuales de carga equilibrada en Azure para conseguir escalabilidad y disponibilidad"
description: "Cómo ejecutar varias máquinas virtuales Linux en Azure para conseguir escalabilidad y disponibilidad."
author: telmosampaio
ms.date: 11/16/2017
pnp.series.title: Linux VM workloads
pnp.series.next: n-tier
pnp.series.prev: single-vm
ms.openlocfilehash: 8f081baa40355b4f02b83c308466df8333d7ad87
ms.sourcegitcommit: c9e6d8edb069b8c513de748ce8114c879bad5f49
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 01/08/2018
---
# <a name="run-load-balanced-vms-for-scalability-and-availability"></a><span data-ttu-id="220f9-103">Ejecución de máquinas virtuales de carga equilibrada para conseguir escalabilidad y disponibilidad</span><span class="sxs-lookup"><span data-stu-id="220f9-103">Run load-balanced VMs for scalability and availability</span></span>

<span data-ttu-id="220f9-104">En esta arquitectura de referencia se muestra un conjunto de procedimientos de demostrada eficacia para ejecutar varias máquinas virtuales (VM) Linux en un conjunto de escalado detrás de un equilibrador de carga, con el fin de mejorar la disponibilidad y la escalabilidad.</span><span class="sxs-lookup"><span data-stu-id="220f9-104">This reference architecture shows a set of proven practices for running multiple Linux virtual machines (VMs) in a scale set behind a load balancer, to improve availability and scalability.</span></span> <span data-ttu-id="220f9-105">Esta arquitectura puede usarse para cualquier carga de trabajo sin estado, como un servidor web, y es una base para implementar aplicaciones de n niveles.</span><span class="sxs-lookup"><span data-stu-id="220f9-105">This architecture can be used for any stateless workload, such as a web server, and is a foundation for deploying n-tier applications.</span></span> [<span data-ttu-id="220f9-106">**Implemente esta solución**.</span><span class="sxs-lookup"><span data-stu-id="220f9-106">**Deploy this solution**.</span></span>](#deploy-the-solution)

<span data-ttu-id="220f9-107">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="220f9-107">![[0]][0]</span></span>

<span data-ttu-id="220f9-108">*Descargue un [archivo Visio][visio-download] de esta arquitectura.*</span><span class="sxs-lookup"><span data-stu-id="220f9-108">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="220f9-109">Architecture</span><span class="sxs-lookup"><span data-stu-id="220f9-109">Architecture</span></span>

<span data-ttu-id="220f9-110">Esta arquitectura se basa en la [arquitectura de referencia de una única máquina virtual][single-vm].</span><span class="sxs-lookup"><span data-stu-id="220f9-110">This architecture builds on the [Single VM reference architecture][single-vm].</span></span> <span data-ttu-id="220f9-111">Estas recomendaciones se aplican también a esta arquitectura.</span><span class="sxs-lookup"><span data-stu-id="220f9-111">Those recommendations also apply to this architecture.</span></span>

<span data-ttu-id="220f9-112">En esta arquitectura, una carga de trabajo se distribuye entre varias instancias de máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="220f9-112">In this architecture, a workload is distributed across multiple VM instances.</span></span> <span data-ttu-id="220f9-113">Hay una única dirección IP pública, y el tráfico de Internet se distribuye a las máquinas virtuales con un equilibrador de carga.</span><span class="sxs-lookup"><span data-stu-id="220f9-113">There is a single public IP address, and Internet traffic is distributed to the VMs using a load balancer.</span></span> <span data-ttu-id="220f9-114">Esta arquitectura puede usarse para una aplicación de nivel único, como una aplicación web sin estado.</span><span class="sxs-lookup"><span data-stu-id="220f9-114">This architecture can be used for a single-tier application, such as a stateless web application.</span></span>

<span data-ttu-id="220f9-115">La arquitectura consta de los siguientes componentes:</span><span class="sxs-lookup"><span data-stu-id="220f9-115">The architecture has the following components:</span></span>

* <span data-ttu-id="220f9-116">**Grupo de recursos.**</span><span class="sxs-lookup"><span data-stu-id="220f9-116">**Resource group.**</span></span> <span data-ttu-id="220f9-117">Los [grupos de recursos][resource-manager-overview] se utilizan para agrupar los recursos, para que puedan administrarse según su duración, su propietario u otros criterios.</span><span class="sxs-lookup"><span data-stu-id="220f9-117">[Resource groups][resource-manager-overview] are used to group resources so they can be managed by lifetime, owner, or other criteria.</span></span>
* <span data-ttu-id="220f9-118">**Red virtual y subred.**</span><span class="sxs-lookup"><span data-stu-id="220f9-118">**Virtual network (VNet) and subnet.**</span></span> <span data-ttu-id="220f9-119">Cada máquina virtual de Azure se implementa en una red virtual que se puede dividir en varias subredes.</span><span class="sxs-lookup"><span data-stu-id="220f9-119">Every Azure VM is deployed into a VNet that can be segmented into multiple subnets.</span></span>
* <span data-ttu-id="220f9-120">**Azure Load Balancer**.</span><span class="sxs-lookup"><span data-stu-id="220f9-120">**Azure Load Balancer**.</span></span> <span data-ttu-id="220f9-121">El [equilibrador de carga][load-balancer] distribuye las solicitudes entrantes de Internet a las instancias de máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="220f9-121">The [load balancer][load-balancer] distributes incoming Internet requests to the VM instances.</span></span> 
* <span data-ttu-id="220f9-122">**Dirección IP pública**.</span><span class="sxs-lookup"><span data-stu-id="220f9-122">**Public IP address**.</span></span> <span data-ttu-id="220f9-123">Se necesita una dirección IP pública para que el equilibrador de carga reciba tráfico de Internet.</span><span class="sxs-lookup"><span data-stu-id="220f9-123">A public IP address is needed for the load balancer to receive Internet traffic.</span></span>
* <span data-ttu-id="220f9-124">**Azure DNS**.</span><span class="sxs-lookup"><span data-stu-id="220f9-124">**Azure DNS**.</span></span> <span data-ttu-id="220f9-125">[Azure DNS][azure-dns] es un servicio de hospedaje para dominios DNS que permite resolver nombres mediante la infraestructura de Microsoft Azure.</span><span class="sxs-lookup"><span data-stu-id="220f9-125">[Azure DNS][azure-dns] is a hosting service for DNS domains, providing name resolution using Microsoft Azure infrastructure.</span></span> <span data-ttu-id="220f9-126">Al hospedar dominios en Azure, puede administrar los registros DNS con las mismas credenciales, API, herramientas y facturación que con los demás servicios de Azure.</span><span class="sxs-lookup"><span data-stu-id="220f9-126">By hosting your domains in Azure, you can manage your DNS records using the same credentials, APIs, tools, and billing as your other Azure services.</span></span>
* <span data-ttu-id="220f9-127">**Conjunto de escalado de máquinas virtuales**.</span><span class="sxs-lookup"><span data-stu-id="220f9-127">**VM scale set**.</span></span> <span data-ttu-id="220f9-128">Un [conjunto de escalado de máquinas virtuales][vm-scaleset] es un conjunto de máquinas virtuales idénticas que se utiliza para hospedar una carga de trabajo.</span><span class="sxs-lookup"><span data-stu-id="220f9-128">A [VM scale set][vm-scaleset] is a set of identical VMs used to host a workload.</span></span> <span data-ttu-id="220f9-129">Los conjuntos de escalado permiten reducir o escalar horizontalmente el número de máquinas virtuales de forma manual, o bien automáticamente en función de reglas predefinidas.</span><span class="sxs-lookup"><span data-stu-id="220f9-129">Scale sets allow the number of VMs to be scaled in or out manually, or automatically based on predefined rules.</span></span>
* <span data-ttu-id="220f9-130">**Conjunto de disponibilidad**.</span><span class="sxs-lookup"><span data-stu-id="220f9-130">**Availability set**.</span></span> <span data-ttu-id="220f9-131">El [conjunto de disponibilidad][availability-set] contiene las máquinas virtuales, por lo que estas son aptas para un [Acuerdo de Nivel de Servicio (SLA)][vm-sla] superior.</span><span class="sxs-lookup"><span data-stu-id="220f9-131">The [availability set][availability-set] contains the VMs, making the VMs eligible for a higher [service level agreement (SLA)][vm-sla].</span></span> <span data-ttu-id="220f9-132">Para que el SLA superior se aplique, el conjunto de disponibilidad debe incluir un mínimo de dos máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="220f9-132">For the higher SLA to apply, the availability set must include a minimum of two VMs.</span></span> <span data-ttu-id="220f9-133">Los conjuntos de disponibilidad están implícitos en los conjuntos de escalado.</span><span class="sxs-lookup"><span data-stu-id="220f9-133">Availability sets are implicit in scale sets.</span></span> <span data-ttu-id="220f9-134">Si crea máquinas virtuales fuera de un conjunto de escalado, debe crear un conjunto de disponibilidad independiente.</span><span class="sxs-lookup"><span data-stu-id="220f9-134">If you create VMs outside a scale set, you need to create the availability set independently.</span></span>
* <span data-ttu-id="220f9-135">**Managed Disks**.</span><span class="sxs-lookup"><span data-stu-id="220f9-135">**Managed disks**.</span></span> <span data-ttu-id="220f9-136">Azure Managed Disks administra los archivos de disco duro virtual (VHD) de los discos de máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="220f9-136">Azure Managed Disks manage the virtual hard disk (VHD) files for the VM disks.</span></span> 
* <span data-ttu-id="220f9-137">**Storage**.</span><span class="sxs-lookup"><span data-stu-id="220f9-137">**Storage**.</span></span> <span data-ttu-id="220f9-138">Cree una cuenta de Azure Storage para almacenar registros de diagnóstico de las máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="220f9-138">Create an Azure Storage acount to hold diagnostic logs for the VMs.</span></span>

## <a name="recommendations"></a><span data-ttu-id="220f9-139">Recomendaciones</span><span class="sxs-lookup"><span data-stu-id="220f9-139">Recommendations</span></span>

<span data-ttu-id="220f9-140">Es posible que sus requisitos no se ajusten completamente a la arquitectura que se describe aquí.</span><span class="sxs-lookup"><span data-stu-id="220f9-140">Your requirements may not align completely with the architecture described here.</span></span> <span data-ttu-id="220f9-141">Use estas recomendaciones como punto de partida.</span><span class="sxs-lookup"><span data-stu-id="220f9-141">Use these recommendations as a starting point.</span></span> 

### <a name="availability-and-scalability-recommendations"></a><span data-ttu-id="220f9-142">Recomendaciones de disponibilidad y escalabilidad</span><span class="sxs-lookup"><span data-stu-id="220f9-142">Availability and scalability recommendations</span></span>

<span data-ttu-id="220f9-143">Una opción para la disponibilidad y escalabilidad es el uso del [conjunto de escalado de máquinas virtuales][vmss].</span><span class="sxs-lookup"><span data-stu-id="220f9-143">An option for availability and scalability is to use a [virtual machine scale set][vmss].</span></span> <span data-ttu-id="220f9-144">Los conjuntos de escalado de máquinas virtuales permiten implementar y administrar un conjunto de máquinas virtuales idénticas.</span><span class="sxs-lookup"><span data-stu-id="220f9-144">VM scale sets help you to deploy and manage a set of identical VMs.</span></span> <span data-ttu-id="220f9-145">Los conjuntos de escalado admiten el escalado automático en función de las métricas de rendimiento.</span><span class="sxs-lookup"><span data-stu-id="220f9-145">Scale sets support autoscaling based on performance metrics.</span></span> <span data-ttu-id="220f9-146">A medida que aumenta la carga en las máquinas virtuales, se agregan más máquinas virtuales automáticamente al equilibrador de carga.</span><span class="sxs-lookup"><span data-stu-id="220f9-146">As the load on the VMs increases, additional VMs are automatically added to the load balancer.</span></span> <span data-ttu-id="220f9-147">Considere la posibilidad de usar conjuntos de escalado si necesita escalar horizontalmente las máquinas virtuales de inmediato o si necesita realizar el escalado automático.</span><span class="sxs-lookup"><span data-stu-id="220f9-147">Consider scale sets if you need to quickly scale out VMs, or need to autoscale.</span></span>

<span data-ttu-id="220f9-148">De forma predeterminada, los conjuntos de escalado usan el "sobreaprovisionamiento", lo que significa que el conjunto de escalado inicialmente aprovisiona más máquinas virtuales de las solicitadas y después elimina las máquinas virtuales adicionales.</span><span class="sxs-lookup"><span data-stu-id="220f9-148">By default, scale sets use "overprovisioning," which means the scale set initially provisions more VMs than you ask for, then deletes the extra VMs.</span></span> <span data-ttu-id="220f9-149">Esto mejora la tasa de éxito general al aprovisionar las máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="220f9-149">This improves the overall success rate when provisioning the VMs.</span></span> <span data-ttu-id="220f9-150">Si no usa [Managed Disks](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-managed-disks), se recomienda no tener más de veinte máquinas virtuales por cuenta de almacenamiento con el sobreaprovisionamiento habilitado ni más de cuarenta máquinas virtuales con el sobreaprovisionamiento deshabilitado.</span><span class="sxs-lookup"><span data-stu-id="220f9-150">If you are not using [managed disks](/azure/virtual-machine-scale-sets/virtual-machine-scale-sets-managed-disks), we recommend no more than 20 VMs per storage account with overprovisioning enabled, and no more than 40 VMs with overprovisioning disabled.</span></span>

<span data-ttu-id="220f9-151">Hay dos maneras básicas de configurar máquinas virtuales implementadas en un conjunto de escalado:</span><span class="sxs-lookup"><span data-stu-id="220f9-151">There are two basic ways to configure VMs deployed in a scale set:</span></span>

- <span data-ttu-id="220f9-152">Use extensiones para configurar la máquina virtual después de aprovisionarla.</span><span class="sxs-lookup"><span data-stu-id="220f9-152">Use extensions to configure the VM after it is provisioned.</span></span> <span data-ttu-id="220f9-153">Con este método, las nuevas instancias de máquina virtual pueden tardar más en iniciarse que una máquina virtual sin extensiones.</span><span class="sxs-lookup"><span data-stu-id="220f9-153">With this approach, new VM instances may take longer to start up than a VM with no extensions.</span></span>

- <span data-ttu-id="220f9-154">Implemente un [disco administrado](/azure/storage/storage-managed-disks-overview) con una imagen de disco personalizada.</span><span class="sxs-lookup"><span data-stu-id="220f9-154">Deploy a [managed disk](/azure/storage/storage-managed-disks-overview) with a custom disk image.</span></span> <span data-ttu-id="220f9-155">Esta opción puede ser más rápida de implementar.</span><span class="sxs-lookup"><span data-stu-id="220f9-155">This option may be quicker to deploy.</span></span> <span data-ttu-id="220f9-156">Sin embargo, requiere mantener la imagen actualizada.</span><span class="sxs-lookup"><span data-stu-id="220f9-156">However, it requires you to keep the image up to date.</span></span>

<span data-ttu-id="220f9-157">Para obtener consideraciones adicionales, consulte [Consideraciones de diseño para conjuntos de escalado][vmss-design].</span><span class="sxs-lookup"><span data-stu-id="220f9-157">For additional considerations, see [Design considerations for scale sets][vmss-design].</span></span>

> [!TIP]
> <span data-ttu-id="220f9-158">Cuando utilice cualquier solución de escalado automático, pruébela con antelación con cargas de trabajo de nivel de producción.</span><span class="sxs-lookup"><span data-stu-id="220f9-158">When using any autoscale solution, test it with production-level workloads well in advance.</span></span>

<span data-ttu-id="220f9-159">Si no utiliza un conjunto de escalado, considere la posibilidad de usar al menos un conjunto de disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="220f9-159">If you do not use a scale set, consider at least using an availability set.</span></span> <span data-ttu-id="220f9-160">Cree al menos dos máquinas virtuales en el conjunto de disponibilidad, para admitir el [SLA de disponibilidad para máquinas virtuales de Azure][vm-sla].</span><span class="sxs-lookup"><span data-stu-id="220f9-160">Create at least two VMs in the availability set to support the [availability SLA for Azure VMs][vm-sla].</span></span> <span data-ttu-id="220f9-161">Azure Load Balancer también requiere que las máquinas virtuales de carga equilibrada pertenezcan al mismo conjunto de disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="220f9-161">The Azure load balancer also requires that load-balanced VMs belong to the same availability set.</span></span>

<span data-ttu-id="220f9-162">Cada suscripción de Azure tiene límites predeterminados establecidos, incluido un número máximo de máquinas virtuales por región.</span><span class="sxs-lookup"><span data-stu-id="220f9-162">Each Azure subscription has default limits in place, including a maximum number of VMs per region.</span></span> <span data-ttu-id="220f9-163">Puede aumentar el límite si rellena una solicitud de soporte técnico.</span><span class="sxs-lookup"><span data-stu-id="220f9-163">You can increase the limit by filing a support request.</span></span> <span data-ttu-id="220f9-164">Para más información, consulte [Límites, cuotas y restricciones de suscripción y servicios de Microsoft Azure][subscription-limits].</span><span class="sxs-lookup"><span data-stu-id="220f9-164">For more information, see [Azure subscription and service limits, quotas, and constraints][subscription-limits].</span></span>

### <a name="network-recommendations"></a><span data-ttu-id="220f9-165">Recomendaciones de red</span><span class="sxs-lookup"><span data-stu-id="220f9-165">Network recommendations</span></span>

<span data-ttu-id="220f9-166">Implemente las máquinas virtuales en la misma subred.</span><span class="sxs-lookup"><span data-stu-id="220f9-166">Deploy the VMs within the same subnet.</span></span> <span data-ttu-id="220f9-167">No exponga las máquinas virtuales directamente a Internet; en su lugar, asigne una dirección IP privada a cada máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="220f9-167">Do not expose the VMs directly to the Internet, but instead give each VM a private IP address.</span></span> <span data-ttu-id="220f9-168">Los clientes se conectan con la dirección IP pública del equilibrador de carga.</span><span class="sxs-lookup"><span data-stu-id="220f9-168">Clients connect using the public IP address of the load balancer.</span></span>

<span data-ttu-id="220f9-169">Si tiene que iniciar sesión en las máquinas virtuales detrás del equilibrador de carga, considere la posibilidad de agregar una sola máquina virtual como un JumpBox (también denominado host bastión) con una dirección IP pública en la que pueda iniciar sesión.</span><span class="sxs-lookup"><span data-stu-id="220f9-169">If you need to log into the VMs behind the load balancer, consider adding a single VM as a jumpbox (also called a bastion host) with a public IP address you can log into.</span></span> <span data-ttu-id="220f9-170">Después, inicie sesión en las máquinas virtuales detrás del equilibrador de carga desde el JumpBox.</span><span class="sxs-lookup"><span data-stu-id="220f9-170">And then log into the VMs behind the load balancer from the jumpbox.</span></span> <span data-ttu-id="220f9-171">Como alternativa, puede configurar las reglas de traducción de direcciones de red (NAT) de entrada del equilibrador de carga.</span><span class="sxs-lookup"><span data-stu-id="220f9-171">Alternatively, you can configure the load balancer's inbound network address translation (NAT) rules.</span></span> <span data-ttu-id="220f9-172">Sin embargo, tener un JumpBox es una solución mejor si hospeda cargas de trabajo de n niveles o varias cargas de trabajo.</span><span class="sxs-lookup"><span data-stu-id="220f9-172">However, having a jumpbox is a better solution when you are hosting n-tier workloads or multiple workloads.</span></span>

### <a name="load-balancer-recommendations"></a><span data-ttu-id="220f9-173">Recomendaciones para el equilibrador de carga</span><span class="sxs-lookup"><span data-stu-id="220f9-173">Load balancer recommendations</span></span>

<span data-ttu-id="220f9-174">Agregue todas las máquinas virtuales del conjunto de disponibilidad al grupo de direcciones de back-end del equilibrador de carga.</span><span class="sxs-lookup"><span data-stu-id="220f9-174">Add all VMs in the availability set to the back-end address pool of the load balancer.</span></span>

<span data-ttu-id="220f9-175">Defina reglas del equilibrador de carga para dirigir el tráfico de red a las máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="220f9-175">Define load balancer rules to direct network traffic to the VMs.</span></span> <span data-ttu-id="220f9-176">Por ejemplo, para habilitar el tráfico HTTP, cree una regla que asigne el puerto 80 de la configuración de front-end al puerto 80 del grupo de direcciones de back-end.</span><span class="sxs-lookup"><span data-stu-id="220f9-176">For example, to enable HTTP traffic, create a rule that maps port 80 from the front-end configuration to port 80 on the back-end address pool.</span></span> <span data-ttu-id="220f9-177">Cuando un cliente envía una solicitud HTTP al puerto 80, el equilibrador de carga selecciona una dirección IP de back-end mediante un [algoritmo hash][load-balancer-hashing] que incluye la dirección IP de origen.</span><span class="sxs-lookup"><span data-stu-id="220f9-177">When a client sends an HTTP request to port 80, the load balancer selects a back-end IP address by using a [hashing algorithm][load-balancer-hashing] that includes the source IP address.</span></span> <span data-ttu-id="220f9-178">De ese modo, las solicitudes de cliente se distribuyen entre todas las máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="220f9-178">In that way, client requests are distributed across all the VMs.</span></span>

<span data-ttu-id="220f9-179">Para enrutar el tráfico a una máquina virtual específica, use las reglas NAT.</span><span class="sxs-lookup"><span data-stu-id="220f9-179">To route traffic to a specific VM, use NAT rules.</span></span> <span data-ttu-id="220f9-180">Por ejemplo, para habilitar RDP en las máquinas virtuales, cree una regla NAT distinta para cada máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="220f9-180">For example, to enable RDP to the VMs, create a separate NAT rule for each VM.</span></span> <span data-ttu-id="220f9-181">Cada regla debe asignar un número de puerto distinto al puerto 3389, el puerto predeterminado para RDP.</span><span class="sxs-lookup"><span data-stu-id="220f9-181">Each rule should map a distinct port number to port 3389, the default port for RDP.</span></span> <span data-ttu-id="220f9-182">Por ejemplo, use el puerto 50001 para "VM1," el puerto 50002 para "VM2", y así sucesivamente.</span><span class="sxs-lookup"><span data-stu-id="220f9-182">For example, use port 50001 for "VM1," port 50002 for "VM2," and so on.</span></span> <span data-ttu-id="220f9-183">Asigne las reglas NAT a las NIC en las máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="220f9-183">Assign the NAT rules to the NICs on the VMs.</span></span>

### <a name="storage-account-recommendations"></a><span data-ttu-id="220f9-184">Recomendaciones sobre las cuentas de almacenamiento</span><span class="sxs-lookup"><span data-stu-id="220f9-184">Storage account recommendations</span></span>

<span data-ttu-id="220f9-185">Se recomienda usar [Managed Disks](/azure/storage/storage-managed-disks-overview) con [Premium Storage][premium].</span><span class="sxs-lookup"><span data-stu-id="220f9-185">We recommend the use of [managed disks](/azure/storage/storage-managed-disks-overview) with [premium storage][premium].</span></span> <span data-ttu-id="220f9-186">Los discos administrados no requieren una cuenta de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="220f9-186">Managed disks do not require a storage account.</span></span> <span data-ttu-id="220f9-187">Solo debe especificar el tamaño y el tipo de disco, y se implementará como un recurso de alta disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="220f9-187">You simply specify the size and type of disk and it is deployed as a highly available resource.</span></span>

<span data-ttu-id="220f9-188">Si usa discos no administrados, cree cuentas de almacenamiento de Azure distintas para cada máquina virtual para almacenar los discos duros virtuales (VHD) con el fin de evitar alcanzar los límites de operaciones de entrada/salida por segundo [(IOPS)][vm-disk-limits] para cuentas de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="220f9-188">If you are using unmanaged disks, create separate Azure storage accounts for each VM to hold the virtual hard disks (VHDs), in order to avoid hitting the input/output operations per second [(IOPS) limits][vm-disk-limits] for storage accounts.</span></span>

<span data-ttu-id="220f9-189">Cree una cuenta de almacenamiento para los registros de diagnóstico.</span><span class="sxs-lookup"><span data-stu-id="220f9-189">Create one storage account for diagnostic logs.</span></span> <span data-ttu-id="220f9-190">Todas las máquinas virtuales pueden compartir esta cuenta de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="220f9-190">This storage account can be shared by all the VMs.</span></span> <span data-ttu-id="220f9-191">Puede tratarse de una cuenta de almacenamiento no administrada con discos estándar.</span><span class="sxs-lookup"><span data-stu-id="220f9-191">This can be an unmanaged storage account using standard disks.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="220f9-192">Consideraciones sobre disponibilidad</span><span class="sxs-lookup"><span data-stu-id="220f9-192">Availability considerations</span></span>

<span data-ttu-id="220f9-193">El conjunto de disponibilidad hace que la aplicación sea más resistente a eventos de mantenimiento planeado y no planeado.</span><span class="sxs-lookup"><span data-stu-id="220f9-193">The availability set makes your application more resilient to both planned and unplanned maintenance events.</span></span>

* <span data-ttu-id="220f9-194">El *mantenimiento planeado* se produce cuando Microsoft actualiza la plataforma subyacente, lo que, en ocasiones, provoca el reinicio de las máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="220f9-194">*Planned maintenance* occurs when Microsoft updates the underlying platform, sometimes causing VMs to be restarted.</span></span> <span data-ttu-id="220f9-195">Azure se asegura de que no todas las máquinas virtuales de un conjunto de disponibilidad se reinicien al mismo tiempo.</span><span class="sxs-lookup"><span data-stu-id="220f9-195">Azure makes sure the VMs in an availability set are not all restarted at the same time.</span></span> <span data-ttu-id="220f9-196">Al menos una se mantiene en ejecución mientras las demás se reinician.</span><span class="sxs-lookup"><span data-stu-id="220f9-196">At least one is kept running while others are restarting.</span></span>
* <span data-ttu-id="220f9-197">El *mantenimiento no planeado* ocurre si se produce un error de hardware.</span><span class="sxs-lookup"><span data-stu-id="220f9-197">*Unplanned maintenance* happens if there is a hardware failure.</span></span> <span data-ttu-id="220f9-198">Azure se asegura de que las máquinas virtuales de un conjunto de disponibilidad se aprovisionen en más de un bastidor del servidor.</span><span class="sxs-lookup"><span data-stu-id="220f9-198">Azure makes sure that VMs in an availability set are provisioned across more than one server rack.</span></span> <span data-ttu-id="220f9-199">Esto ayuda a reducir el impacto de los errores de hardware, las interrupciones de red y las interrupciones de energía, entre otros.</span><span class="sxs-lookup"><span data-stu-id="220f9-199">This helps to reduce the impact of hardware failures, network outages, power interruptions, and so on.</span></span>

<span data-ttu-id="220f9-200">Para más información, consulte [Administración de la disponibilidad de las máquinas virtuales][availability-set].</span><span class="sxs-lookup"><span data-stu-id="220f9-200">For more information, see [Manage the availability of virtual machines][availability-set].</span></span> <span data-ttu-id="220f9-201">En el vídeo siguiente también se proporciona información general útil sobre los conjuntos de disponibilidad: [How Do I Configure an Availability Set to Scale VMs][availability-set-ch9] (Configuración de un conjunto de disponibilidad para escalar máquinas virtuales).</span><span class="sxs-lookup"><span data-stu-id="220f9-201">The following video also provides a good overview of availability sets: [How Do I Configure an Availability Set to Scale VMs][availability-set-ch9].</span></span>

> [!WARNING]
> <span data-ttu-id="220f9-202">Asegúrese de configurar el conjunto de disponibilidad cuando aprovisione la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="220f9-202">Make sure to configure the availability set when you provision the VM.</span></span> <span data-ttu-id="220f9-203">Actualmente, no hay ninguna manera de agregar una máquina virtual de Resource Manager a un conjunto de disponibilidad después de aprovisionar la máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="220f9-203">Currently, there is no way to add a Resource Manager VM to an availability set after the VM is provisioned.</span></span>

<span data-ttu-id="220f9-204">El equilibrador de carga usa [sondeos de mantenimiento][health-probes] para supervisar la disponibilidad de las instancias de máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="220f9-204">The load balancer uses [health probes][health-probes] to monitor the availability of VM instances.</span></span> <span data-ttu-id="220f9-205">Si un sondeo no puede conectar con una instancia durante un período de tiempo de espera, el equilibrador de carga deja de enviar tráfico a esa máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="220f9-205">If a probe cannot reach an instance within a timeout period, the load balancer stops sending traffic to that VM.</span></span> <span data-ttu-id="220f9-206">Sin embargo, el equilibrador de carga continuará con el sondeo y, si la máquina virtual vuelve a estar disponible, el equilibrador de carga reanudará el envío del tráfico a esa máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="220f9-206">However, the load balancer will continue to probe, and if the VM becomes available again, the load balancer resumes sending traffic to that VM.</span></span>

<span data-ttu-id="220f9-207">A continuación, se presentan algunas recomendaciones sobre los sondeos de mantenimiento del equilibrador de carga:</span><span class="sxs-lookup"><span data-stu-id="220f9-207">Here are some recommendations on load balancer health probes:</span></span>

* <span data-ttu-id="220f9-208">Los sondeos pueden probar los protocolos HTTP o TCP.</span><span class="sxs-lookup"><span data-stu-id="220f9-208">Probes can test either HTTP or TCP.</span></span> <span data-ttu-id="220f9-209">Si las máquinas virtuales ejecutan un servidor HTTP, cree un sondeo HTTP.</span><span class="sxs-lookup"><span data-stu-id="220f9-209">If your VMs run an HTTP server, create an HTTP probe.</span></span> <span data-ttu-id="220f9-210">De lo contrario, cree un sondeo TCP.</span><span class="sxs-lookup"><span data-stu-id="220f9-210">Otherwise create a TCP probe.</span></span>
* <span data-ttu-id="220f9-211">Para un sondeo HTTP, especifique la ruta de acceso a un punto de conexión HTTP.</span><span class="sxs-lookup"><span data-stu-id="220f9-211">For an HTTP probe, specify the path to an HTTP endpoint.</span></span> <span data-ttu-id="220f9-212">El sondeo comprueba si hay una respuesta HTTP 200 desde esta ruta de acceso.</span><span class="sxs-lookup"><span data-stu-id="220f9-212">The probe checks for an HTTP 200 response from this path.</span></span> <span data-ttu-id="220f9-213">Puede ser la ruta de acceso raíz ("/") o un punto de conexión de supervisión de mantenimiento que implementa alguna lógica personalizada para comprobar el mantenimiento de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="220f9-213">This can be the root path ("/"), or a health-monitoring endpoint that implements some custom logic to check the health of the application.</span></span> <span data-ttu-id="220f9-214">El punto de conexión debe permitir solicitudes HTTP anónimas.</span><span class="sxs-lookup"><span data-stu-id="220f9-214">The endpoint must allow anonymous HTTP requests.</span></span>
* <span data-ttu-id="220f9-215">El sondeo se envía desde una [dirección IP conocida][health-probe-ip], 168.63.129.16.</span><span class="sxs-lookup"><span data-stu-id="220f9-215">The probe is sent from a [known IP address][health-probe-ip], 168.63.129.16.</span></span> <span data-ttu-id="220f9-216">Asegúrese de que no bloquear el tráfico hacia o desde esta dirección IP en las directivas de firewall o en las reglas de grupo de seguridad de red (NSG).</span><span class="sxs-lookup"><span data-stu-id="220f9-216">Make sure you don't block traffic to or from this IP address in any firewall policies or network security group (NSG) rules.</span></span>
* <span data-ttu-id="220f9-217">Use [registros de sondeo de mantenimiento][health-probe-log] para ver el estado de los sondeos de mantenimiento.</span><span class="sxs-lookup"><span data-stu-id="220f9-217">Use [health probe logs][health-probe-log] to view the status of the health probes.</span></span> <span data-ttu-id="220f9-218">Habilite el registro en Azure Portal para cada equilibrador de carga.</span><span class="sxs-lookup"><span data-stu-id="220f9-218">Enable logging in the Azure portal for each load balancer.</span></span> <span data-ttu-id="220f9-219">Los registros se escriben en Azure Blob Storage.</span><span class="sxs-lookup"><span data-stu-id="220f9-219">Logs are written to Azure Blob storage.</span></span> <span data-ttu-id="220f9-220">Los registros muestran cuántas máquinas virtuales del back-end no reciben tráfico de red debido a las respuestas de sondeo con error.</span><span class="sxs-lookup"><span data-stu-id="220f9-220">The logs show how many VMs on the back end are not receiving network traffic due to failed probe responses.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="220f9-221">Consideraciones sobre la manejabilidad</span><span class="sxs-lookup"><span data-stu-id="220f9-221">Manageability considerations</span></span>

<span data-ttu-id="220f9-222">Con varias máquinas virtuales, es importante automatizar los procesos, para que sean confiables y repetibles.</span><span class="sxs-lookup"><span data-stu-id="220f9-222">With multiple VMs, it is important to automate processes so they are reliable and repeatable.</span></span> <span data-ttu-id="220f9-223">Puede usar [Azure Automation][azure-automation] para automatizar la implementación, la aplicación de revisiones al SO y otras tareas.</span><span class="sxs-lookup"><span data-stu-id="220f9-223">You can use [Azure Automation][azure-automation] to automate deployment, OS patching, and other tasks.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="220f9-224">Consideraciones sobre la seguridad</span><span class="sxs-lookup"><span data-stu-id="220f9-224">Security considerations</span></span>

<span data-ttu-id="220f9-225">Las redes virtuales son un límite de aislamiento del tráfico de Azure.</span><span class="sxs-lookup"><span data-stu-id="220f9-225">Virtual networks are a traffic isolation boundary in Azure.</span></span> <span data-ttu-id="220f9-226">Las máquinas virtuales de una red virtual no se pueden comunicar directamente con las máquinas virtuales de una red virtual diferente.</span><span class="sxs-lookup"><span data-stu-id="220f9-226">VMs in one VNet cannot communicate directly with VMs in a different VNet.</span></span> <span data-ttu-id="220f9-227">Las máquinas virtuales que se encuentran en la misma red virtual se pueden comunicar entre sí, a menos que se creen [grupos de seguridad de red][nsg] (NSG) para restringir el tráfico.</span><span class="sxs-lookup"><span data-stu-id="220f9-227">VMs within the same VNet can communicate, unless you create [network security groups][nsg] (NSGs) to restrict traffic.</span></span> <span data-ttu-id="220f9-228">Para más información, consulte [Servicios en la nube de Microsoft y seguridad de red][network-security].</span><span class="sxs-lookup"><span data-stu-id="220f9-228">For more information, see [Microsoft cloud services and network security][network-security].</span></span>

<span data-ttu-id="220f9-229">Para el tráfico entrante de Internet, las reglas del equilibrador de carga definen qué tráfico puede alcanzar el back-end.</span><span class="sxs-lookup"><span data-stu-id="220f9-229">For incoming Internet traffic, the load balancer rules define which traffic can reach the back end.</span></span> <span data-ttu-id="220f9-230">Sin embargo, las reglas del equilibrador de carga no son compatibles con las listas seguras de IP, por lo que si desea agregar determinadas direcciones IP públicas a una lista segura, agregue un NSG a la subred.</span><span class="sxs-lookup"><span data-stu-id="220f9-230">However, load balancer rules don't support IP safe lists, so if you want to add certain public IP addresses to a safe list, add an NSG to the subnet.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="220f9-231">Implementación de la solución</span><span class="sxs-lookup"><span data-stu-id="220f9-231">Deploy the solution</span></span>

<span data-ttu-id="220f9-232">Hay disponible una implementación de esta arquitectura en [GitHub][github-folder].</span><span class="sxs-lookup"><span data-stu-id="220f9-232">A deployment for this architecture is available on [GitHub][github-folder].</span></span> <span data-ttu-id="220f9-233">Implementa lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="220f9-233">It deploys the following:</span></span>

  * <span data-ttu-id="220f9-234">Una red virtual con una sola subred denominada **web** que contiene las máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="220f9-234">A virtual network with a single subnet named **web** that contains the VMs.</span></span>
  * <span data-ttu-id="220f9-235">Un conjunto de escalado de máquinas virtuales que contiene máquinas virtuales que ejecutan la última versión de Ubuntu 16.04.3 LTS.</span><span class="sxs-lookup"><span data-stu-id="220f9-235">A VM scale set that contains VMs running the latest version of Ubuntu 16.04.3 LTS.</span></span> <span data-ttu-id="220f9-236">El escalado automático está habilitado.</span><span class="sxs-lookup"><span data-stu-id="220f9-236">Autoscale is enabled.</span></span>
  * <span data-ttu-id="220f9-237">Un equilibrador de carga que se encuentra delante del conjunto de escalado de máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="220f9-237">A load balancer that sits in front of the VM scale set.</span></span>
  * <span data-ttu-id="220f9-238">Un NSG con reglas de entrada que permiten el tráfico HTTP al conjunto de escalado de máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="220f9-238">An NSG with incoming rules that allow HTTP traffic to the VM scale set.</span></span>

### <a name="prerequisites"></a><span data-ttu-id="220f9-239">Requisitos previos</span><span class="sxs-lookup"><span data-stu-id="220f9-239">Prerequisites</span></span>

<span data-ttu-id="220f9-240">Antes de poder implementar la arquitectura de referencia en su propia suscripción, debe realizar los pasos siguientes.</span><span class="sxs-lookup"><span data-stu-id="220f9-240">Before you can deploy the reference architecture to your own subscription, you must perform the following steps.</span></span>

1. <span data-ttu-id="220f9-241">Clone, bifurque o descargue el archivo ZIP para el repositorio de GitHub de [arquitecturas de referencia de AzureCAT][ref-arch-repo].</span><span class="sxs-lookup"><span data-stu-id="220f9-241">Clone, fork, or download the zip file for the [AzureCAT reference architectures][ref-arch-repo] GitHub repository.</span></span>

2. <span data-ttu-id="220f9-242">Asegúrese de que tiene la CLI de Azure 2.0 instalada en el equipo.</span><span class="sxs-lookup"><span data-stu-id="220f9-242">Make sure you have the Azure CLI 2.0 installed on your computer.</span></span> <span data-ttu-id="220f9-243">Para obtener instrucciones sobre la instalación de la CLI, consulte [Instalación de la CLI de Azure 2.0][azure-cli-2].</span><span class="sxs-lookup"><span data-stu-id="220f9-243">For CLI installation instructions, see [Install Azure CLI 2.0][azure-cli-2].</span></span>

3. <span data-ttu-id="220f9-244">Instale el paquete de NPM de [Azure Building Blocks][azbb].</span><span class="sxs-lookup"><span data-stu-id="220f9-244">Install the [Azure building blocks][azbb] npm package.</span></span>

4. <span data-ttu-id="220f9-245">Desde un símbolo del sistema, un símbolo del sistema de Bash o un símbolo del sistema de PowerShell, inicie sesión en la cuenta de Azure con alguno de los comandos siguientes y siga las indicaciones.</span><span class="sxs-lookup"><span data-stu-id="220f9-245">From a command prompt, bash prompt, or PowerShell prompt, login to your Azure account by using one of the commands below, and follow the prompts.</span></span>

  ```bash
  az login
  ```

### <a name="deploy-the-solution-using-azbb"></a><span data-ttu-id="220f9-246">Implementación de la solución con AZBB</span><span class="sxs-lookup"><span data-stu-id="220f9-246">Deploy the solution using azbb</span></span>

<span data-ttu-id="220f9-247">Para implementar el ejemplo de carga de trabajo con una única máquina virtual, siga estos pasos:</span><span class="sxs-lookup"><span data-stu-id="220f9-247">To deploy the sample single VM workload, follow these steps:</span></span>

1. <span data-ttu-id="220f9-248">Navegue hasta la carpeta `virtual-machines\multi-vm\parameters\linux` del repositorio que descargó en el paso de requisitos previos anterior.</span><span class="sxs-lookup"><span data-stu-id="220f9-248">Navigate to the `virtual-machines\multi-vm\parameters\linux` folder for the repository you downloaded in the pre-requisites step above.</span></span>

2. <span data-ttu-id="220f9-249">Abra el archivo `multi-vm-v2.json`, escriba un nombre de usuario y la clave SSH entre comillas, tal y como se muestra a continuación, y después guarde el archivo.</span><span class="sxs-lookup"><span data-stu-id="220f9-249">Open the `multi-vm-v2.json` file and enter a username and SSH key between the quotes, as shown below, then save the file.</span></span>

  ```bash
  "adminUsername": "",
  "sshPublicKey": "",
  ```

3. <span data-ttu-id="220f9-250">Ejecute `azbb` para implementar las máquinas virtuales, tal y como se muestra a continuación.</span><span class="sxs-lookup"><span data-stu-id="220f9-250">Run `azbb` to deploy the VMs as shown below.</span></span>

  ```bash
  azbb -s <subscription_id> -g <resource_group_name> -l <location> -p multi-vm-v2.json --deploy
  ```

<span data-ttu-id="220f9-251">Para más información sobre la implementación de esta arquitectura de referencia de ejemplo, visite el [repositorio de GitHub][git].</span><span class="sxs-lookup"><span data-stu-id="220f9-251">For more information on deploying this sample reference architecture, visit our [GitHub repository][git].</span></span>

<!-- links -->

[availability-set]: /azure/virtual-machines/virtual-machines-windows-manage-availability
[availability-set-ch9]: https://channel9.msdn.com/Series/Microsoft-Azure-Fundamentals-Virtual-Machines/08
[azbb]: https://github.com/mspnp/template-building-blocks/wiki/Install-Azure-Building-Blocks
[azure-automation]: /azure/automation/automation-intro
[azure-cli]: /azure/virtual-machines-command-line-tools
[azure-cli-2]: /azure/install-azure-cli?view=azure-cli-latest
[azure-dns]: /azure/dns/dns-overview
[git]: https://github.com/mspnp/reference-architectures/tree/master/virtual-machines/multi-vm
[github-folder]: https://github.com/mspnp/reference-architectures/tree/master/virtual-machines/multi-vm
[health-probe-log]: /azure/load-balancer/load-balancer-monitor-log
[health-probes]: /azure/load-balancer/load-balancer-overview#load-balancer-features
[health-probe-ip]: /azure/virtual-network/virtual-networks-nsg#special-rules
[load-balancer]: /azure/load-balancer/load-balancer-get-started-internet-arm-cli
[load-balancer-hashing]: /azure/load-balancer/load-balancer-overview#load-balancer-features
[naming-conventions]: ../../best-practices/naming-conventions.md
[network-security]: /azure/best-practices-network-security
[nsg]: /azure/virtual-network/virtual-networks-nsg
[premium]: /azure/storage/common/storage-premium-storage
[ref-arch-repo]: https://github.com/mspnp/reference-architectures
[resource-manager-overview]: /azure/azure-resource-manager/resource-group-overview 
[runbook-gallery]: /azure/automation/automation-runbook-gallery#runbooks-in-runbook-gallery
[single-vm]: single-vm.md
[subscription-limits]: /azure/azure-subscription-service-limits
[visio-download]: https://archcenter.azureedge.net/cdn/vm-reference-architectures.vsdx
[vm-disk-limits]: /azure/azure-subscription-service-limits#virtual-machine-disk-limits
[vm-scaleset]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview
[vm-sizes]: https://azure.microsoft.com/documentation/articles/virtual-machines-windows-sizes/
[vm-sla]: https://azure.microsoft.com/support/legal/sla/virtual-machines/v1_2/
[vmss]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-overview
[vmss-design]: /azure/virtual-machine-scale-sets/virtual-machine-scale-sets-design-overview
[vmss-quickstart]: https://azure.microsoft.com/documentation/templates/?term=scale+set
[0]: ./images/multi-vm-diagram.png "Arquitectura de una solución de varias máquinas virtuales en Azure que componen un conjunto de disponibilidad con dos máquinas virtuales y un equilibrador de carga"
