---
title: Puntuación de Batch para modelos de aprendizaje profundo
titleSuffix: Azure Reference Architectures
description: Esta arquitectura de referencia muestra cómo aplicar una transferencia de estilo neuronal a un vídeo con Azure Batch AI.
author: jiata
ms.date: 10/02/2018
ms.custom: azcat-ai
ms.openlocfilehash: 0396903a39d00a4131df65872a63f4b3fde8dce7
ms.sourcegitcommit: 88a68c7e9b6b772172b7faa4b9fd9c061a9f7e9d
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 12/08/2018
ms.locfileid: "53119887"
---
# <a name="batch-scoring-on-azure-for-deep-learning-models"></a><span data-ttu-id="4f1f3-103">Puntuación de Batch en Azure para modelos de aprendizaje profundo</span><span class="sxs-lookup"><span data-stu-id="4f1f3-103">Batch scoring on Azure for deep learning models</span></span>

<span data-ttu-id="4f1f3-104">Esta arquitectura de referencia muestra cómo aplicar una transferencia de estilo neuronal a un vídeo con Azure Batch AI.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-104">This reference architecture shows how to apply neural style transfer to a video, using Azure Batch AI.</span></span> <span data-ttu-id="4f1f3-105">La *transferencia de estilo* es una técnica de aprendizaje profundo que se compone de una imagen existente con el estilo de otra imagen.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-105">*Style transfer* is a deep learning technique that composes an existing image in the style of another image.</span></span> <span data-ttu-id="4f1f3-106">Esta arquitectura se puede generalizar para cualquier escenario que usa la puntuación de Batch con el aprendizaje profundo.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-106">This architecture can be generalized for any scenario that uses batch scoring with deep learning.</span></span> <span data-ttu-id="4f1f3-107">[**Implemente esta solución**](#deploy-the-solution).</span><span class="sxs-lookup"><span data-stu-id="4f1f3-107">[**Deploy this solution**](#deploy-the-solution).</span></span>

![Diagrama de arquitectura para los modelos de aprendizaje profundo con Azure Batch AI](./_images/batch-ai-deep-learning.png)

<span data-ttu-id="4f1f3-109">**Escenario**: Una empresa mediática tiene un vídeo cuyo estilo quiere cambiar para que se parezca a una pintura específica.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-109">**Scenario**: A media organization has a video whose style they want to change to look like a specific painting.</span></span> <span data-ttu-id="4f1f3-110">La organización quiere poder aplicar este estilo a todos los fotogramas del vídeo de manera oportuna y automática.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-110">The organization wants to be able to apply this style to all frames of the video in a timely manner and in an automated fashion.</span></span> <span data-ttu-id="4f1f3-111">Para más información sobre los algoritmos de transferencia de estilo neuronal, vea [Image Style Transfer Using Convolutional Neural Networks][image-style-transfer] (Transferencia de estilo de imagen con redes neuronales convolucionales) (PDF).</span><span class="sxs-lookup"><span data-stu-id="4f1f3-111">For more background about neural style transfer algorithms, see [Image Style Transfer Using Convolutional Neural Networks][image-style-transfer] (PDF).</span></span>

| <span data-ttu-id="4f1f3-112">Imagen con estilo:</span><span class="sxs-lookup"><span data-stu-id="4f1f3-112">Style image:</span></span> | <span data-ttu-id="4f1f3-113">Vídeo de contenido/entrada:</span><span class="sxs-lookup"><span data-stu-id="4f1f3-113">Input/content video:</span></span> | <span data-ttu-id="4f1f3-114">Vídeo de salida:</span><span class="sxs-lookup"><span data-stu-id="4f1f3-114">Output video:</span></span> |
|--------|--------|---------|
| <img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/style_image.jpg" width="300"> | <span data-ttu-id="4f1f3-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Vídeo de entrada") *Haga clic para ver el vídeo*</span><span class="sxs-lookup"><span data-stu-id="4f1f3-115">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/input_video.mp4 "Input Video") *click to view video*</span></span> | <span data-ttu-id="4f1f3-116">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Vídeo de salida") *Haga clic para ver el vídeo*</span><span class="sxs-lookup"><span data-stu-id="4f1f3-116">[<img src="https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video_image_0.jpg" width="300" height="300">](https://happypathspublic.blob.core.windows.net/assets/batch_scoring_for_dl/output_video.mp4 "Output Video") *click to view video*</span></span> |

<span data-ttu-id="4f1f3-117">Esta arquitectura de referencia está diseñada para cargas de trabajo que se desencadenan por la presencia de nuevo contenido multimedia en Azure Storage.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-117">This reference architecture is designed for workloads that are triggered by the presence of new media in Azure storage.</span></span> <span data-ttu-id="4f1f3-118">El procesamiento implica los siguientes pasos:</span><span class="sxs-lookup"><span data-stu-id="4f1f3-118">Processing involves the following steps:</span></span>

1. <span data-ttu-id="4f1f3-119">Cargue una imagen del estilo seleccionado (como una pintura de Van Gogh) y un script de transferencia de estilo para Blob Storage.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-119">Upload a selected style image (like a Van Gogh painting) and a style transfer script to Blob Storage.</span></span>
1. <span data-ttu-id="4f1f3-120">Cree un clúster de Batch AI de escalado automático que esté listo para comenzar a realizar el trabajo.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-120">Create an autoscaling Batch AI cluster that is ready to start taking work.</span></span>
1. <span data-ttu-id="4f1f3-121">Divida el archivo de vídeo en fotogramas individuales y cárguelos en Blob Storage.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-121">Split the video file into individual frames and upload those frames into Blob Storage.</span></span>
1. <span data-ttu-id="4f1f3-122">Una vez cargados todos los fotogramas, cargue un archivo de desencadenador en Blob Storage.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-122">Once all frames are uploaded, upload a trigger file to Blob Storage.</span></span>
1. <span data-ttu-id="4f1f3-123">Este archivo desencadena una aplicación lógica que crea un contenedor que se ejecuta en Azure Container Instances.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-123">This file triggers a Logic App that creates a container running in Azure Container Instances.</span></span>
1. <span data-ttu-id="4f1f3-124">El contenedor ejecuta un script que crea los trabajos de Batch AI.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-124">The container runs a script that creates the Batch AI jobs.</span></span> <span data-ttu-id="4f1f3-125">Cada trabajo aplica la transferencia de estilo neuronal en paralelo en todos los nodos del clúster de Batch AI.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-125">Each job applies the neural style transfer in parallel across the nodes of the Batch AI cluster.</span></span>
1. <span data-ttu-id="4f1f3-126">Una vez generadas las imágenes, se vuelven a guardar en Blob Storage.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-126">Once the images are generated, they are saved back to Blob Storage.</span></span>
1. <span data-ttu-id="4f1f3-127">Descargue los fotogramas generados y una de nuevo las imágenes en un vídeo.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-127">Download the generated frames, and stitch back the images into a video.</span></span>

## <a name="architecture"></a><span data-ttu-id="4f1f3-128">Arquitectura</span><span class="sxs-lookup"><span data-stu-id="4f1f3-128">Architecture</span></span>

<span data-ttu-id="4f1f3-129">Esta arquitectura consta de los siguientes componentes.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-129">This architecture consists of the following components.</span></span>

### <a name="compute"></a><span data-ttu-id="4f1f3-130">Proceso</span><span class="sxs-lookup"><span data-stu-id="4f1f3-130">Compute</span></span>

<span data-ttu-id="4f1f3-131">**[Azure Batch AI][batch-ai]** se usa para ejecutar el algoritmo de transferencia de estilo neuronal.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-131">**[Azure Batch AI][batch-ai]** is used to run the neural style transfer algorithm.</span></span> <span data-ttu-id="4f1f3-132">Batch AI admite cargas de trabajo de aprendizaje profundo al ofrecer entornos en contenedores que están preconfigurados para marcos de aprendizaje profundo, en máquinas virtuales habilitadas para GPU.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-132">Batch AI supports deep learning workloads by providing containerized environments that are pre-configured for deep learning frameworks, on GPU-enabled VMs.</span></span> <span data-ttu-id="4f1f3-133">Batch AI también puede conectar el clúster de proceso con Blob Storage.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-133">Batch AI can also connect the compute cluster to Blob storage.</span></span>

### <a name="storage"></a><span data-ttu-id="4f1f3-134">Storage</span><span class="sxs-lookup"><span data-stu-id="4f1f3-134">Storage</span></span>

<span data-ttu-id="4f1f3-135">**[Blob Storage][blob-storage]** se usa para almacenar todas las imágenes (imágenes de entrada, imágenes de estilo e imágenes de salida) y todos los registros generados por Batch AI.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-135">**[Blob storage][blob-storage]** is used to store all images (input images, style images, and output images) as well as all logs produced from Batch AI.</span></span> <span data-ttu-id="4f1f3-136">Blob Storage se integra con Batch AI mediante [blobfuse][blobfuse], un sistema de archivos virtual de código abierto respaldado por Blob Storage.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-136">Blob storage integrates with Batch AI via [blobfuse][blobfuse], an open-source virtual filesystem that is backed by Blob storage.</span></span> <span data-ttu-id="4f1f3-137">Blob Storage también es muy rentable por el rendimiento que requiere esta carga de trabajo.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-137">Blob storage is also very cost-effective for the performance that this workload requires.</span></span>

### <a name="trigger--scheduling"></a><span data-ttu-id="4f1f3-138">Desencadenador/programación</span><span class="sxs-lookup"><span data-stu-id="4f1f3-138">Trigger / scheduling</span></span>

<span data-ttu-id="4f1f3-139">**[Azure Logic Apps][logic-apps]** se usa para desencadenar el flujo de trabajo.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-139">**[Azure Logic Apps][logic-apps]** is used to trigger the workflow.</span></span> <span data-ttu-id="4f1f3-140">Cuando la aplicación lógica detecta que se ha agregado un blob al contenedor, desencadena el proceso de Batch AI.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-140">When the Logic App detects that a blob has been added to the container, it triggers the Batch AI process.</span></span> <span data-ttu-id="4f1f3-141">Logic Apps es una buena elección para esta arquitectura de referencia porque es una manera fácil de detectar los cambios en Blob Storage y proporciona un proceso sencillo para cambiar el desencadenador.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-141">Logic Apps is a good fit for this reference architecture because it's an easy way to detect changes to blob storage and provides an easy process for changing the trigger.</span></span>

<span data-ttu-id="4f1f3-142">**[Azure Container Instances][container-instances]** se usa para ejecutar los scripts de Python que crean los trabajos de Batch AI.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-142">**[Azure Container Instances][container-instances]** is used to run the Python scripts that create the Batch AI jobs.</span></span> <span data-ttu-id="4f1f3-143">Ejecutar estos scripts dentro de un contenedor de Docker es una manera cómoda de ejecutarlos a petición.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-143">Running these scripts inside a Docker container is a convenient way to run them on demand.</span></span> <span data-ttu-id="4f1f3-144">Para esta arquitectura, usamos Container Instances porque hay un conector de la aplicación lógica precompilado para ello, que permite que la aplicación lógica desencadene el trabajo de Batch AI.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-144">For this architecture, we use Container Instances because there is a pre-built Logic App connector for it, which allows the Logic App to trigger the Batch AI job.</span></span> <span data-ttu-id="4f1f3-145">Container Instances puede iniciar los procesos sin estado rápidamente.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-145">Container Instances can spin up stateless processes quickly.</span></span>

<span data-ttu-id="4f1f3-146">**[DockerHub][dockerhub]** se usa para almacenar la imagen de Docker que Container Instances usa para ejecutar el proceso de creación del trabajo.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-146">**[DockerHub][dockerhub]** is used to store the Docker image that Container Instances uses to execute the job creation process.</span></span> <span data-ttu-id="4f1f3-147">DockerHub se eligió para esta arquitectura porque es fácil de usar y porque es el repositorio de imágenes predeterminado para los usuarios de Docker.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-147">DockerHub was chosen for this architecture because it's easy to use and is the default image repository for Docker users.</span></span> <span data-ttu-id="4f1f3-148">[Azure Container Registry][container-registry] también se puede usar.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-148">[Azure Container Registry][container-registry] can also be used.</span></span>

### <a name="data-preparation"></a><span data-ttu-id="4f1f3-149">Preparación de los datos</span><span class="sxs-lookup"><span data-stu-id="4f1f3-149">Data preparation</span></span>

<span data-ttu-id="4f1f3-150">Esta arquitectura de referencia usa secuencias de vídeo de un orangután en un árbol.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-150">This reference architecture uses video footage of an orangutan in a tree.</span></span> <span data-ttu-id="4f1f3-151">Puede descargar la secuencia [aquí][source-video] y procesarla para el flujo de trabajo siguiendo estos pasos:</span><span class="sxs-lookup"><span data-stu-id="4f1f3-151">You can download the footage from [here][source-video] and process it for the workflow by following these steps:</span></span>

1. <span data-ttu-id="4f1f3-152">Use [AzCopy][azcopy] para descargar el vídeo del blob público.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-152">Use [AzCopy][azcopy] to download the video from the public blob.</span></span>
2. <span data-ttu-id="4f1f3-153">Use [FFmpeg][ffmpeg] para extraer el archivo de audio, para que poder unir el archivo de audio en el vídeo de salida más adelante.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-153">Use [FFmpeg][ffmpeg] to extract the audio file, so that the audio file can be stitched back into the output video later.</span></span>
3. <span data-ttu-id="4f1f3-154">Use FFmpeg para dividir el vídeo en fotogramas individuales.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-154">Use FFmpeg to break the video into individual frames.</span></span> <span data-ttu-id="4f1f3-155">Los fotogramas se procesarán de forma independiente, en paralelo.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-155">The frames will be processed independently, in parallel.</span></span>
4. <span data-ttu-id="4f1f3-156">Use AzCopy para copiar los fotogramas individuales en el contenedor de blobs.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-156">Use AzCopy to copy the individual frames into your blob container.</span></span>

<span data-ttu-id="4f1f3-157">En esta fase, la secuencia de vídeo está en un formato que se puede usar para la transferencia de estilo neuronal.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-157">At this stage, the video footage is in a form that can be used for neural style transfer.</span></span>

## <a name="performance-considerations"></a><span data-ttu-id="4f1f3-158">Consideraciones sobre rendimiento</span><span class="sxs-lookup"><span data-stu-id="4f1f3-158">Performance considerations</span></span>

### <a name="gpu-vs-cpu"></a><span data-ttu-id="4f1f3-159">GPU frente a CPU</span><span class="sxs-lookup"><span data-stu-id="4f1f3-159">GPU vs CPU</span></span>

<span data-ttu-id="4f1f3-160">Para cargas de trabajo de aprendizaje profundo, las GPU normalmente tendrán un rendimiento bastante más alto que las CPU, en la medida en que un clúster del tamaño de las CPU suele ser necesario para obtener un rendimiento comparable.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-160">For deep learning workloads, GPUs will generally out-perform CPUs by a considerable amount, to the extent that a sizeable cluster of CPUs is usually needed to get comparable performance.</span></span> <span data-ttu-id="4f1f3-161">Si bien existe la opción de usar solo CPU en esta arquitectura, las GPU ofrecerán un perfil bastante mejorado de costo/rendimiento.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-161">While it's an option to use only CPUs in this architecture, GPUs will provide a much better cost/performance profile.</span></span> <span data-ttu-id="4f1f3-162">Se recomienda utilizar la última instancia de [NCv3 series]vm-sizes-gpu de máquinas virtuales optimizadas para GPU.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-162">We recommend using the latest [NCv3 series]vm-sizes-gpu of GPU optimized VMs.</span></span>

<span data-ttu-id="4f1f3-163">Las GPU no están habilitadas de forma predeterminada en todas las regiones.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-163">GPUs are not enabled by default in all regions.</span></span> <span data-ttu-id="4f1f3-164">Asegúrese de seleccionar una región que tenga GPU habilitadas.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-164">Make sure to select a region with GPUs enabled.</span></span> <span data-ttu-id="4f1f3-165">Además, las suscripciones tienen una cuota predeterminada de cero núcleos para máquinas virtuales optimizadas para GPU.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-165">In addition, subscriptions have a default quota of zero cores for GPU-optimized VMs.</span></span> <span data-ttu-id="4f1f3-166">Puede aumentar esta cuota si abre una solicitud de soporte técnico.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-166">You can raise this quota by opening a support request.</span></span> <span data-ttu-id="4f1f3-167">Asegúrese de que la suscripción tiene una cuota suficiente para ejecutar la carga de trabajo.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-167">Make sure that your subscription has enough quota to run your workload.</span></span>

### <a name="parallelizing-across-vms-vs-cores"></a><span data-ttu-id="4f1f3-168">Poner en paralelo las máquinas virtuales con los núcleos</span><span class="sxs-lookup"><span data-stu-id="4f1f3-168">Parallelizing across VMs vs cores</span></span>

<span data-ttu-id="4f1f3-169">Al ejecutar un proceso de transferencia de estilo como un trabajo por lotes, los trabajos que se ejecutan principalmente en GPU tendrán que ejecutarse en paralelo en todas las máquinas virtuales.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-169">When running a style transfer process as a batch job, the jobs that run primarily on GPUs will have to be parallelized across VMs.</span></span> <span data-ttu-id="4f1f3-170">Son posibles dos enfoques: Puede crear un clúster más grande con máquinas virtuales que tengan una sola GPU o crear un clúster más pequeño con máquinas virtuales con muchas GPU.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-170">Two approaches are possible: You can create a larger cluster using VMs that have a single GPU, or create a smaller cluster using VMs with many GPUs.</span></span>

<span data-ttu-id="4f1f3-171">Para esta carga de trabajo, estas dos opciones presentan un rendimiento comparable.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-171">For this workload, these two options will have comparable performance.</span></span> <span data-ttu-id="4f1f3-172">El uso de menos máquinas virtuales con más GPU por máquina virtual puede ayudar a reducir el movimiento de datos.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-172">Using fewer VMs with more GPUs per VM can help to reduce data movement.</span></span> <span data-ttu-id="4f1f3-173">Sin embargo, el volumen de datos por trabajo para esta carga de trabajo no es muy grande, por lo que no observará demasiadas limitaciones por Blob Storage.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-173">However, the data volume per job for this workload is not very big, so you won't observe much throttling by blob storage.</span></span>

### <a name="images-batch-size-per-batch-ai-job"></a><span data-ttu-id="4f1f3-174">Tamaño del lote de imágenes por trabajo de Batch AI</span><span class="sxs-lookup"><span data-stu-id="4f1f3-174">Images batch size per Batch AI job</span></span>

<span data-ttu-id="4f1f3-175">Otro parámetro que se debe configurar es el número de imágenes que hay que procesar por cada trabajo de Batch AI.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-175">Another parameter that must be configured is the number of images to process per Batch AI job.</span></span> <span data-ttu-id="4f1f3-176">Por un lado, desea asegurarse de que el trabajo se extiende por todos los nodos y que, si el trabajo genera errores, no tenga que volver a realizar reintentos con demasiadas imágenes.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-176">On the one hand, you want to ensure that work is spread broadly across the nodes and that if a job fails, you don't have to retry too many images.</span></span> <span data-ttu-id="4f1f3-177">Eso conlleva tener muchos trabajos de Batch AI y, en consecuencia, un número reducido de imágenes que procesar por trabajo.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-177">That points to having many Batch AI jobs and thus a low number of images to process per job.</span></span> <span data-ttu-id="4f1f3-178">Por otro lado, si se procesan muy pocas imágenes por trabajo, el tiempo de configuración/inicio llega a ser desproporcionadamente largo.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-178">On the other hand, if too few images are processed per job, the setup/startup time becomes disproportionately large.</span></span> <span data-ttu-id="4f1f3-179">Puede establecer el número de trabajo con un valor igual al número máximo de nodos del clúster.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-179">You can set the number of jobs to equal the maximum number of nodes in the cluster.</span></span> <span data-ttu-id="4f1f3-180">Se tratará de la opción más rentable, suponiendo que no se produzca ningún error en los trabajos, ya que se minimizan los costos de configuración/inicio.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-180">This will be the most performant assuming that no jobs fail, because it minimizes the amount of setup/startup cost.</span></span> <span data-ttu-id="4f1f3-181">Sin embargo, si se produce algún error en el trabajo, puede que sea necesario volver a procesar un número elevado de imágenes.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-181">However, if a job fails, a large number of images might need to be reprocessed.</span></span>

### <a name="file-servers"></a><span data-ttu-id="4f1f3-182">Servidores de archivos</span><span class="sxs-lookup"><span data-stu-id="4f1f3-182">File servers</span></span>

<span data-ttu-id="4f1f3-183">Al usar Batch AI, puede elegir varias opciones de almacenamiento según el rendimiento necesario para el escenario.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-183">When using Batch AI, you can choose multiple storage options depending on the throughput needed for your scenario.</span></span> <span data-ttu-id="4f1f3-184">Para cargas de trabajo con requisitos de rendimiento bajo, debe ser suficiente con Blob Storage (mediante blobfuse).</span><span class="sxs-lookup"><span data-stu-id="4f1f3-184">For workloads with low throughput requirements, using blob storage (via blobfuse) should be enough.</span></span> <span data-ttu-id="4f1f3-185">De forma alternativa, Batch AI también admite un servidor de archivos de Batch AI, un NFS administrado de un solo nodo que se pueden montar automáticamente en nodos del clúster para proporcionar una ubicación de almacenamiento centralmente accesible para los trabajos.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-185">Alternatively, Batch AI also supports a Batch AI File Server, a managed single-node NFS, which can be automatically mounted on cluster nodes to provide a centrally accessible storage location for jobs.</span></span> <span data-ttu-id="4f1f3-186">Para la mayoría de los casos, se necesita un solo servidor de archivos en un área de trabajo y se pueden separar los datos para los trabajos de aprendizaje en directorios distintos.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-186">For most cases, only one file server is needed in a workspace, and you can separate data for your training jobs into different directories.</span></span> <span data-ttu-id="4f1f3-187">Si un NFS de un solo nodo no es adecuado para las cargas de trabajo, Batch AI admite otras opciones de almacenamiento, como Azure Files, o soluciones personalizadas, como un sistema de archivos Gluster o Lustre.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-187">If a single-node NFS isn't appropriate for your workloads, Batch AI supports other storage options, including Azure Files or custom solutions such as a Gluster or Lustre file system.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="4f1f3-188">Consideraciones sobre la seguridad</span><span class="sxs-lookup"><span data-stu-id="4f1f3-188">Security considerations</span></span>

### <a name="restricting-access-to-azure-blob-storage"></a><span data-ttu-id="4f1f3-189">Restricción de acceso a Azure Blob Storage</span><span class="sxs-lookup"><span data-stu-id="4f1f3-189">Restricting access to Azure blob storage</span></span>

<span data-ttu-id="4f1f3-190">En esta arquitectura de referencia, Azure Blob Storage es el componente de almacenamiento principal que debe protegerse.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-190">In this reference architecture, Azure blob storage is the main storage component that needs to be protected.</span></span> <span data-ttu-id="4f1f3-191">La implementación de línea base que se muestra en el repositorio de GitHub usa las claves de la cuenta de almacenamiento para acceder a Blob Storage.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-191">The baseline deployment shown in the GitHub repo uses storage account keys to access the blob storage.</span></span> <span data-ttu-id="4f1f3-192">Para obtener más control y protección, en su lugar, considere la posibilidad de usar una firma de acceso compartido (SAS).</span><span class="sxs-lookup"><span data-stu-id="4f1f3-192">For further control and protection, consider using a shared access signature (SAS) instead.</span></span> <span data-ttu-id="4f1f3-193">Esto concede acceso limitado a los objetos de almacenamiento, sin necesidad de codificar de forma rígida las claves de cuenta ni de guardarlas como texto no cifrado.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-193">This grants limited access to objects in storage, without needing to hard code the account keys or save them in plaintext.</span></span> <span data-ttu-id="4f1f3-194">Este enfoque es especialmente útil porque las claves de cuenta están visibles como texto no cifrado dentro de la interfaz del diseñador de la aplicación lógica.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-194">This approach is especially useful because account keys are visible in plaintext inside of Logic App's designer interface.</span></span> <span data-ttu-id="4f1f3-195">Mediante una SAS también ayuda a asegurarse de que la cuenta de almacenamiento tiene un control corporativo adecuado y que se concede acceso solo a las personas que deben tenerlo.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-195">Using an SAS also helps to ensure that the storage account has proper governance, and that access is granted only to the people intended to have it.</span></span>

<span data-ttu-id="4f1f3-196">Para escenarios con información más confidencial, asegúrese de que todas las claves de almacenamiento están protegidas, ya que estas claves conceden acceso total a todos los datos de entrada y salida de la carga de trabajo.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-196">For scenarios with more sensitive data, make sure that all of your storage keys are protected, because these keys grant full access to all input and output data from the workload.</span></span>

### <a name="data-encryption-and-data-movement"></a><span data-ttu-id="4f1f3-197">Cifrado de datos y movimiento de datos</span><span class="sxs-lookup"><span data-stu-id="4f1f3-197">Data encryption and data movement</span></span>

<span data-ttu-id="4f1f3-198">Esta arquitectura de referencia usa la transferencia de estilo como un ejemplo de un proceso de puntuación de Batch.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-198">This reference architecture uses style transfer as an example of a batch scoring process.</span></span> <span data-ttu-id="4f1f3-199">Para escenarios de información más confidencial, los datos del almacenamiento deben cifrarse en reposo.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-199">For more data-sensitive scenarios, the data in storage should be encrypted at rest.</span></span> <span data-ttu-id="4f1f3-200">Cada vez que los datos se muevan de una ubicación a la siguiente, use SSL para proteger la transferencia de datos.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-200">Each time data is moved from one location to the next, use SSL to secure the data transfer.</span></span> <span data-ttu-id="4f1f3-201">Para más información, vea la [Guía de seguridad de Azure Storage][storage-security].</span><span class="sxs-lookup"><span data-stu-id="4f1f3-201">For more information, see [Azure Storage security guide][storage-security].</span></span>

### <a name="securing-data-in-a-virtual-network"></a><span data-ttu-id="4f1f3-202">Protección de datos de una red virtual</span><span class="sxs-lookup"><span data-stu-id="4f1f3-202">Securing data in a virtual network</span></span>

<span data-ttu-id="4f1f3-203">Al implementar el clúster de Batch AI, puede configurar el clúster para que se aprovisione dentro de una subred de una red virtual.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-203">When deploying your Batch AI cluster, you can configure your cluster to be provisioned inside a subnet of a virtual network.</span></span> <span data-ttu-id="4f1f3-204">Esto permite que los nodos de proceso del clúster se comuniquen de forma segura con otras máquinas virtuales, o incluso con una red local.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-204">This allows the compute nodes in the cluster to communicate securely with other virtual machines, or even with an on-premises network.</span></span> <span data-ttu-id="4f1f3-205">También puede usar [puntos de conexión de servicio][service-endpoints] con Blob Storage para conceder acceso desde una red virtual o usar un NFS de un solo nodo dentro de la red virtual con Batch AI para garantizar que los datos siempre estén protegidos.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-205">You can also use [service endpoints][service-endpoints] with blob storage to grant access from a virtual network or use a single-node NFS inside the VNET with Batch AI to ensure that the data is always protected.</span></span>

### <a name="protecting-against-malicious-activity"></a><span data-ttu-id="4f1f3-206">Protección contra la actividad malintencionada</span><span class="sxs-lookup"><span data-stu-id="4f1f3-206">Protecting against malicious activity</span></span>

<span data-ttu-id="4f1f3-207">En escenarios donde hay varios usuarios, asegúrese de que los datos confidenciales estén protegidos contra la actividad malintencionada.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-207">In scenarios where there are multiple users, make sure that sensitive data is protected against malicious activity.</span></span> <span data-ttu-id="4f1f3-208">Si otros usuarios obtienen acceso a esta implementación para personalizar los datos de entrada, tenga en cuenta las siguientes precauciones y consideraciones:</span><span class="sxs-lookup"><span data-stu-id="4f1f3-208">If other users are given access to this deployment to customize the input data, take note of the following precautions and considerations:</span></span>

- <span data-ttu-id="4f1f3-209">Utilice RBAC para limitar el acceso de los usuarios a solo los recursos que necesitan.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-209">Use RBAC to limit users' access to only the resources they need.</span></span>
- <span data-ttu-id="4f1f3-210">Aprovisione dos cuentas de almacenamiento independientes.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-210">Provision two separate storage accounts.</span></span> <span data-ttu-id="4f1f3-211">Almacene los datos de entrada y salida en la primera cuenta.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-211">Store input and output data in the first account.</span></span> <span data-ttu-id="4f1f3-212">Los usuarios externos pueden acceder a esta cuenta.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-212">External users can be given access to this account.</span></span> <span data-ttu-id="4f1f3-213">Almacene los scripts ejecutables y los archivos de registro de salida en la otra cuenta.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-213">Store executable scripts and output log files in the other account.</span></span> <span data-ttu-id="4f1f3-214">Los usuarios externos no deben tener acceso a esta cuenta.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-214">External users should not have access to this account.</span></span> <span data-ttu-id="4f1f3-215">Esto garantizará que los usuarios externos no puedan modificar los archivos ejecutables (para insertar código malintencionado) ni acceder a los archivos de registro, que podrían contener información confidencial.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-215">This will ensure that external users cannot modify any executable files (to inject malicious code), and don't have access to logfiles, which could hold sensitive information.</span></span>
- <span data-ttu-id="4f1f3-216">Los usuarios malintencionados pueden realizar ataques de denegación de servicio distribuido en la cola de trabajos o insertar mensajes dudosos con formato incorrecto en dicha cola, provocando así el bloqueo del sistema o errores al quitar los mensajes de la cola.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-216">Malicious users can DDOS the job queue or inject malformed poison messages in the job queue, causing the system to lock up or causing dequeuing errors.</span></span>

## <a name="monitoring-and-logging"></a><span data-ttu-id="4f1f3-217">Supervisión y registro</span><span class="sxs-lookup"><span data-stu-id="4f1f3-217">Monitoring and logging</span></span>

### <a name="monitoring-batch-ai-jobs"></a><span data-ttu-id="4f1f3-218">Supervisión de trabajos de Batch AI</span><span class="sxs-lookup"><span data-stu-id="4f1f3-218">Monitoring Batch AI jobs</span></span>

<span data-ttu-id="4f1f3-219">Mientras se ejecuta el trabajo, es importante supervisar el progreso y asegurarse de que todo funciona según lo previsto.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-219">While running your job, it's important to monitor the progress and make sure that things are working as expected.</span></span> <span data-ttu-id="4f1f3-220">Sin embargo, puede resultar complicado supervisar un clúster de nodos activos.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-220">However, it can be a challenge to monitor across a cluster of active nodes.</span></span>

<span data-ttu-id="4f1f3-221">Para obtener una idea del estado general del clúster, vaya a la hoja de Batch AI de Azure Portal para inspeccionar el estado de los nodos del clúster.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-221">To get a sense of the overall state of the cluster, go to the Batch AI blade of the Azure Portal to inspect the state of the nodes in the cluster.</span></span> <span data-ttu-id="4f1f3-222">Si un nodo está inactivo o un trabajo presenta algún error, los registros de errores se guardan en Blob Storage y también se puede acceder a ellos en la hoja Trabajos de Azure Portal.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-222">If a node is inactive or a job has failed, the error logs are saved to blob storage, and are also accessible in the Jobs blade in the Azure Portal.</span></span>

<span data-ttu-id="4f1f3-223">La supervisión puede enriquecerse aún más conectando los registros a Application Insights o ejecutando procesos independientes para sondear el estado del clúster de Batch AI y sus trabajos.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-223">Monitoring can be further enriched by connecting logs to Application Insights or by running separate processes to poll for the state of the Batch AI cluster and its jobs.</span></span>

### <a name="logging-in-batch-ai"></a><span data-ttu-id="4f1f3-224">Registros en Batch AI</span><span class="sxs-lookup"><span data-stu-id="4f1f3-224">Logging in Batch AI</span></span>

<span data-ttu-id="4f1f3-225">Batch AI registrará automáticamente todos los procesos stdout y stderr en la cuenta de Blob Storage asociada.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-225">Batch AI will automatically log all stdout/stderr to the associate blob storage account.</span></span> <span data-ttu-id="4f1f3-226">Mediante una herramienta de exploración de almacenamiento, como el Explorador de Storage, se ofrecerá una experiencia mucho más sencilla para explorar los archivos de registro.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-226">Using a storage navigation tool such as Storage Explorer will provide a much easier experience for navigating log files.</span></span>

<span data-ttu-id="4f1f3-227">Los pasos de implementación para esta arquitectura de referencia también muestran cómo configurar un sistema de registro más sencillo, de tal forma que todos los registros de los distintos trabajos se guarden en el mismo directorio, en el contenedor de blobs, tal como se muestra a continuación.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-227">The deployment steps for this reference architecture also shows how to set up a more simple logging system, such that all the logs across the different jobs are saved to the same directory in your blob container, as shown below.</span></span> <span data-ttu-id="4f1f3-228">Use estos registros para supervisar cuánto tarda cada trabajo y cada imagen en procesarse.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-228">Use these logs to monitor how long it takes for each job and each image to process.</span></span> <span data-ttu-id="4f1f3-229">Esto le permitirá hacerse una idea mejor de cómo optimizar más el proceso.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-229">This will give you a better sense of how to optimize the process even further.</span></span>

![Captura de pantalla del registro de Azure Batch AI](./_images/batch-ai-logging.png)

## <a name="cost-considerations"></a><span data-ttu-id="4f1f3-231">Consideraciones sobre el costo</span><span class="sxs-lookup"><span data-stu-id="4f1f3-231">Cost considerations</span></span>

<span data-ttu-id="4f1f3-232">En comparación con los componentes de almacenamiento y programación, los recursos de proceso utilizados en esta arquitectura de referencia predominan sin duda en términos de costos.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-232">Compared to the storage and scheduling components, the compute resources used in this reference architecture by far dominate in terms of costs.</span></span> <span data-ttu-id="4f1f3-233">Uno de los principales desafíos es paralelizar eficazmente el trabajo en un clúster de máquinas habilitadas para GPU.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-233">One of the main challenges is effectively parallelizing the work across a cluster of GPU-enabled machines.</span></span>

<span data-ttu-id="4f1f3-234">El tamaño del clúster de Batch AI puede escalarse y reducirse verticalmente de manera automática en función de los trabajos existentes en la cola.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-234">The Batch AI cluster size can automatically scale up and down depending on the jobs in the queue.</span></span> <span data-ttu-id="4f1f3-235">Puede habilitar el escalado automático con Batch AI de una de estas dos formas.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-235">You can enable auto-scale with Batch AI in one of two ways.</span></span> <span data-ttu-id="4f1f3-236">Puede hacerlo mediante programación, que se puede configurar en el archivo `.env` que forma parte de los [pasos de implementación][deployment], o bien puede cambiar la fórmula de escalado directamente en el portal después de haber creado el clúster.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-236">You can do so programmatically, which can be configured in the `.env` file that is part of the [deployment steps][deployment], or you can change the scale formula directly in the portal after the cluster is created.</span></span>

<span data-ttu-id="4f1f3-237">Para el trabajo que no requiere un procesamiento inmediato, configure la fórmula de escalado automático para que el estado predeterminado (mínimo) sea un clúster de cero nodos.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-237">For work that doesn't require immediate processing, configure the auto-scale formula so the default state (minimum) is a cluster of zero nodes.</span></span> <span data-ttu-id="4f1f3-238">Con esta configuración, el clúster empieza con cero nodos y solo se escala verticalmente si detecta trabajos en la cola.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-238">With this configuration, the cluster starts with zero nodes and only scales up when it detects jobs in the queue.</span></span> <span data-ttu-id="4f1f3-239">Si el proceso de puntuación de Batch solo se produce algunas veces al día o menos, esta configuración permite obtener importantes ahorros.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-239">If the batch scoring process only happens a few times a day or less, this setting enables significant cost savings.</span></span>

<span data-ttu-id="4f1f3-240">El escalado automático puede no resultar apropiado para trabajo por lotes que se producen demasiado próximos entre sí.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-240">Auto-scaling may not be appropriate for batch jobs that happen too close to each other.</span></span> <span data-ttu-id="4f1f3-241">El tiempo que tarda un clúster en agilizarse y ralentizarse también incurre en costos, por tanto, si una carga de trabajo por lotes empieza solo unos minutos después de que el trabajo anterior termine, puede resultar más rentable mantener el clúster en ejecución entre los trabajos.</span><span class="sxs-lookup"><span data-stu-id="4f1f3-241">The time that it takes for a cluster to spin up and spin down also incur a cost, so if a batch workload begins only a few minutes after the previous job ends, it might be more cost effective to keep the cluster running between jobs.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="4f1f3-242">Implementación de la solución</span><span class="sxs-lookup"><span data-stu-id="4f1f3-242">Deploy the solution</span></span>

<span data-ttu-id="4f1f3-243">Para implementar esta arquitectura de referencia, siga los pasos descritos en el [repositorio de GitHub][deployment].</span><span class="sxs-lookup"><span data-stu-id="4f1f3-243">To deploy this reference architecture, follow the steps described in the [GitHub repo][deployment].</span></span>

<!-- links -->

[azcopy]: /azure/storage/common/storage-use-azcopy-linux
[batch-ai]: /azure/batch-ai/
[blobfuse]: https://github.com/Azure/azure-storage-fuse
[blob-storage]: /azure/storage/blobs/storage-blobs-introduction
[container-instances]: /azure/container-instances/
[container-registry]: /azure/container-registry/
[deployment]: https://github.com/Azure/batch-scoring-for-dl-models
[dockerhub]: https://hub.docker.com/
[ffmpeg]: https://www.ffmpeg.org/
[image-style-transfer]: https://www.cv-foundation.org/openaccess/content_cvpr_2016/papers/Gatys_Image_Style_Transfer_CVPR_2016_paper.pdf
[logic-apps]: /azure/logic-apps/
[service-endpoints]: /azure/storage/common/storage-network-security?toc=%2fazure%2fvirtual-network%2ftoc.json#grant-access-from-a-virtual-network
[source-video]: https://happypathspublic.blob.core.windows.net/videos/orangutan.mp4
[storage-security]: /azure/storage/common/storage-security-guide
[vm-sizes-gpu]: /azure/virtual-machines/windows/sizes-gpu