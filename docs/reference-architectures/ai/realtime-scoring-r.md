---
title: Puntuación en tiempo real de los modelos de Machine Learning para R
description: Implemente un servicio de predicción en tiempo real en R mediante una instancia de Machine Learning Server que se ejecuta en Azure Kubernetes Service (AKS).
author: njray
ms.date: 12/12/2018
ms.custom: azcat-ai
ms.openlocfilehash: 6f3447d1dcab801ccdaf4cf88611725cc00eb68d
ms.sourcegitcommit: 1f4cdb08fe73b1956e164ad692f792f9f635b409
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 01/08/2019
ms.locfileid: "54112284"
---
# <a name="real-time-scoring-of-r-machine-learning-models"></a><span data-ttu-id="f2c7d-103">Puntuación en tiempo real de los modelos de Machine Learning para R</span><span class="sxs-lookup"><span data-stu-id="f2c7d-103">Real-time scoring of R machine learning models</span></span>

<span data-ttu-id="f2c7d-104">Esta arquitectura de referencia muestra cómo implementar un servicio de predicción en tiempo real (sincrónico) en R mediante Microsoft Machine Learning Server que se ejecuta en Azure Kubernetes Service (AKS).</span><span class="sxs-lookup"><span data-stu-id="f2c7d-104">This reference architecture shows how to implement a real-time (synchronous) prediction service in R using Microsoft Machine Learning Server running in Azure Kubernetes Service (AKS).</span></span> <span data-ttu-id="f2c7d-105">Esta arquitectura está pensada para ser genérica y adecuada para cualquier modelo predictivo creado en R que desee implementar como un servicio en tiempo real.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-105">This architecture is intended to be generic and suited for any predictive model built in R that you want to deploy as a real-time service.</span></span> <span data-ttu-id="f2c7d-106">**[Implemente la solución][github]**.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-106">**[Deploy this solution][github]**.</span></span>

## <a name="architecture"></a><span data-ttu-id="f2c7d-107">Arquitectura</span><span class="sxs-lookup"><span data-stu-id="f2c7d-107">Architecture</span></span>

![Puntuación en tiempo real de los modelos de Machine Learning para R en Azure][0]

<span data-ttu-id="f2c7d-109">Esta arquitectura de referencia adopta un enfoque basado en contenedores.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-109">This reference architecture takes a container-based approach.</span></span> <span data-ttu-id="f2c7d-110">Se construye una imagen de Docker que contiene R, así como los diversos artefactos necesarios para obtener nuevos datos.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-110">A Docker image is built containing R, as well as the various artifacts needed to score new data.</span></span> <span data-ttu-id="f2c7d-111">Estos incluyen el objeto modelo en sí y un script de puntuación.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-111">These include the model object itself and a scoring script.</span></span> <span data-ttu-id="f2c7d-112">Esta imagen se envía a un registro de Docker hospedado en Azure, y después se implementa en un clúster de Kubernetes, también en Azure.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-112">This image is pushed to a Docker registry hosted in Azure, and then deployed to a Kubernetes cluster, also in Azure.</span></span>

<span data-ttu-id="f2c7d-113">La arquitectura de este flujo de trabajo incluye los siguientes componentes.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-113">The architecture of this workflow includes the following components.</span></span>

- <span data-ttu-id="f2c7d-114">**[Azure Container Registry][acr]** se utiliza para almacenar las imágenes para este flujo de trabajo.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-114">**[Azure Container Registry][acr]** is used to store the images for this workflow.</span></span> <span data-ttu-id="f2c7d-115">Los registros creados con Container Registry se pueden administrar a través de la API estándar [Docker Registry V2 API][docker] y el cliente.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-115">Registries created with Container Registry can be managed via the standard [Docker Registry V2 API][docker] and client.</span></span>

- <span data-ttu-id="f2c7d-116">**[Azure Kubernetes Service][aks]** se utiliza para hospedar el servicio y la implementación.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-116">**[Azure Kubernetes Service][aks]** is used to host the deployment and service.</span></span> <span data-ttu-id="f2c7d-117">Los clústeres creados con AKS se pueden administrar mediante la API estándar [Kubernetes API][k-api] y el cliente (kubectl).</span><span class="sxs-lookup"><span data-stu-id="f2c7d-117">Clusters created with AKS can be managed using the standard [Kubernetes API][k-api] and client (kubectl).</span></span>

- <span data-ttu-id="f2c7d-118">**[Microsoft Machine Learning Server][mmls]** se utiliza para definir la API REST para el servicio e incluye la [operacionalización del modelo][operationalization].</span><span class="sxs-lookup"><span data-stu-id="f2c7d-118">**[Microsoft Machine Learning Server][mmls]** is used to define the REST API for the service and includes [Model Operationalization][operationalization].</span></span> <span data-ttu-id="f2c7d-119">Este proceso de servidor web orientado al servicio escucha las solicitudes, que después se transfieren a otros procesos en segundo plano que ejecutan el código R real para generar los resultados.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-119">This service-oriented web server process listens for requests, which are then handed off to other background processes that run the actual R code to generate the results.</span></span> <span data-ttu-id="f2c7d-120">Todos estos procesos se ejecutan en un único nodo de esta configuración, que se encapsula en un contenedor.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-120">All these processes run on a single node in this configuration, which is wrapped in a container.</span></span> <span data-ttu-id="f2c7d-121">Para más información sobre el uso de este servicio fuera de un entorno de desarrollo o de prueba, póngase en contacto con su representante de Microsoft.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-121">For details about using this service outside a dev or test environment, contact your Microsoft representative.</span></span>

## <a name="performance-considerations"></a><span data-ttu-id="f2c7d-122">Consideraciones sobre rendimiento</span><span class="sxs-lookup"><span data-stu-id="f2c7d-122">Performance considerations</span></span>

<span data-ttu-id="f2c7d-123">Las cargas de trabajo de aprendizaje automático tienden a ser muy intensivas, tanto cuando se trata del entrenamiento como cuando se obtienen nuevos datos.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-123">Machine learning workloads tend to be compute-intensive, both when training and when scoring new data.</span></span> <span data-ttu-id="f2c7d-124">Como regla general, trate de no ejecutar más de un proceso de puntuación por núcleo.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-124">As a rule of thumb, try not to run more than one scoring process per core.</span></span> <span data-ttu-id="f2c7d-125">Machine Learning Server le permite definir el número de procesos de R que se ejecutan en cada contenedor.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-125">Machine Learning Server lets you define the number of R processes running in each container.</span></span> <span data-ttu-id="f2c7d-126">El valor predeterminado es de cinco procesos.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-126">The default is five processes.</span></span> <span data-ttu-id="f2c7d-127">Cuando se crea un modelo relativamente simple, como una regresión lineal con un pequeño número de variables, o un pequeño árbol de decisión, se puede aumentar el número de procesos.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-127">When creating a relatively simple model, such as a linear regression with a small number of variables, or a small decision tree, you can increase the number of processes.</span></span> <span data-ttu-id="f2c7d-128">Supervise la carga de la CPU en los nodos del clúster para determinar el límite apropiado en el número de contenedores.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-128">Monitor the CPU load on your cluster nodes to determine the appropriate limit on the number of containers.</span></span>

<span data-ttu-id="f2c7d-129">Un clúster compatible con la GPU puede acelerar algunos tipos de cargas de trabajo y, en particular, los modelos de aprendizaje profundo.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-129">A GPU-enabled cluster can speed up some types of workloads, and deep learning models in particular.</span></span> <span data-ttu-id="f2c7d-130">No todas las cargas de trabajo pueden aprovechar las GPU &mdash;, solo aquellas que hacen un uso intensivo del álgebra de matrices.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-130">Not all workloads can take advantage of GPUs &mdash; only those that make heavy use of matrix algebra.</span></span> <span data-ttu-id="f2c7d-131">Por ejemplo, los modelos basados en árboles, incluidos los bosques aleatorios y los modelos de boosting, no suelen obtener ninguna ventaja de las GPU.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-131">For example, tree-based models, including random forests and boosting models, generally derive no advantage from GPUs.</span></span>

<span data-ttu-id="f2c7d-132">Algunos tipos de modelos como los bosques aleatorios se pueden paralelizar de forma masiva en las CPU.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-132">Some model types such as random forests are massively parallelizable on CPUs.</span></span> <span data-ttu-id="f2c7d-133">En estos casos, acelere la puntuación de una única solicitud al distribuir la carga de trabajo entre varios núcleos.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-133">In these cases, speed up the scoring of a single request by distributing the workload across multiple cores.</span></span> <span data-ttu-id="f2c7d-134">Sin embargo, hacerlo reduce su capacidad para tratar varias solicitudes de puntuación dado un tamaño de clúster fijo.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-134">However, doing so reduces your capacity to handle multiple scoring requests given a fixed cluster size.</span></span>

<span data-ttu-id="f2c7d-135">En general, los modelos de R de código abierto almacenan todos los datos en la memoria, de modo que asegúrese de que los nodos tengan suficiente memoria para acomodar los procesos que planea ejecutar simultáneamente.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-135">In general, open-source R models store all their data in memory, so ensure that your nodes have enough memory to accommodate the processes you plan to run concurrently.</span></span> <span data-ttu-id="f2c7d-136">Si utiliza Machine Learning Server para adaptarlo a sus modelos, utilice las bibliotecas que pueden procesar datos en disco, en lugar de leerlos todos en memoria.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-136">If you are using Machine Learning Server to fit your models, use the libraries that can process data on disk, rather than reading it all into memory.</span></span> <span data-ttu-id="f2c7d-137">Esto puede ayudar a reducir significativamente los requisitos de memoria.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-137">This can help reduce memory requirements significantly.</span></span> <span data-ttu-id="f2c7d-138">Con independencia de si utiliza Machine Learning Server o R de código abierto, supervise los nodos para asegurarse de que los procesos de puntuación no se queden sin memoria.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-138">Regardless of whether you use Machine Learning Server or open-source R, monitor your nodes to ensure that your scoring processes are not memory-starved.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="f2c7d-139">Consideraciones sobre la seguridad</span><span class="sxs-lookup"><span data-stu-id="f2c7d-139">Security considerations</span></span>

### <a name="network-encryption"></a><span data-ttu-id="f2c7d-140">Cifrado de red</span><span class="sxs-lookup"><span data-stu-id="f2c7d-140">Network encryption</span></span>

<span data-ttu-id="f2c7d-141">En esta arquitectura de referencia, HTTPS se habilita para la comunicación con el clúster, y se utiliza un certificado de almacenamiento provisional de [Let's Encrypt][encrypt].</span><span class="sxs-lookup"><span data-stu-id="f2c7d-141">In this reference architecture, HTTPS is enabled for communication with the cluster, and a staging certificate from [Let’s Encrypt][encrypt] is used.</span></span> <span data-ttu-id="f2c7d-142">Para fines de producción, sustituya su propio certificado por el de una autoridad de firma apropiada.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-142">For production purposes, substitute your own certificate from an appropriate signing authority.</span></span>

### <a name="authentication-and-authorization"></a><span data-ttu-id="f2c7d-143">Autenticación y autorización</span><span class="sxs-lookup"><span data-stu-id="f2c7d-143">Authentication and authorization</span></span>

<span data-ttu-id="f2c7d-144">La [operacionalización de modelos][operationalization] de Machine Learning Server requiere la autenticación de las solicitudes de puntuación.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-144">Machine Learning Server [Model Operationalization][operationalization] requires scoring requests to be authenticated.</span></span> <span data-ttu-id="f2c7d-145">En esta implementación, se utilizan un nombre de usuario y una contraseña.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-145">In this deployment, a username and password are used.</span></span> <span data-ttu-id="f2c7d-146">En un entorno empresarial, puede habilitar la autenticación mediante [Azure Active Directory][AAD] o crear un front-end independiente mediante [Azure API Management][API].</span><span class="sxs-lookup"><span data-stu-id="f2c7d-146">In an enterprise setting, you can enable authentication using [Azure Active Directory][AAD] or create a separate front end using [Azure API Management][API].</span></span>

<span data-ttu-id="f2c7d-147">Para que la operacionalización del modelo funcione correctamente con Machine Learning Server en contenedores, debe instalar un certificado JSON Web Token (JWT).</span><span class="sxs-lookup"><span data-stu-id="f2c7d-147">For Model Operationalization to work correctly with Machine Learning Server on containers, you must install a JSON Web Token (JWT) certificate.</span></span> <span data-ttu-id="f2c7d-148">Esta implementación utiliza un certificado proporcionado por Microsoft.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-148">This deployment uses a certificate supplied by Microsoft.</span></span> <span data-ttu-id="f2c7d-149">En un entorno de producción, proporcione los suyos propios.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-149">In a production setting, supply your own.</span></span>

<span data-ttu-id="f2c7d-150">Para el tráfico entre Container Registry y AKS, considere la posibilidad de habilitar [un control de acceso basado en rol][rbac] (RBAC) para limitar los privilegios de acceso solo a los necesarios.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-150">For traffic between Container Registry and AKS, consider enabling [role-based access control][rbac] (RBAC) to limit access privileges to only those needed.</span></span>

### <a name="separate-storage"></a><span data-ttu-id="f2c7d-151">Almacenamiento independiente</span><span class="sxs-lookup"><span data-stu-id="f2c7d-151">Separate storage</span></span>

<span data-ttu-id="f2c7d-152">Esta arquitectura de referencia agrupa la aplicación (R) y los datos (objeto de modelo y script de puntuación) en una sola imagen.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-152">This reference architecture bundles the application (R) and the data (model object and scoring script) into a single image.</span></span> <span data-ttu-id="f2c7d-153">En algunos casos, puede resultar útil separarlos.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-153">In some cases, it may be beneficial to separate these.</span></span> <span data-ttu-id="f2c7d-154">Puede colocar los datos y el código del modelo en el blob de Azure o en [almacenamiento][storage] de archivos, y recuperarlos al inicializar el contenedor.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-154">You can place the model data and code into Azure blob or file [storage][storage], and retrieve them at container initialization.</span></span> <span data-ttu-id="f2c7d-155">En este caso, asegúrese de que la cuenta de almacenamiento esté configurada para permitir únicamente el acceso autenticado y que requiera HTTPS.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-155">In this case, ensure that the storage account is set to allow authenticated access only and require HTTPS.</span></span>

## <a name="monitoring-and-logging-considerations"></a><span data-ttu-id="f2c7d-156">Consideraciones acerca de la supervisión y el registro</span><span class="sxs-lookup"><span data-stu-id="f2c7d-156">Monitoring and logging considerations</span></span>

<span data-ttu-id="f2c7d-157">Utilice el [panel de Kubernetes][dashboard] para supervisar el estado general del clúster de AKS.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-157">Use the [Kubernetes dashboard][dashboard] to monitor the overall status of your AKS cluster.</span></span> <span data-ttu-id="f2c7d-158">Consulte la hoja de información general del clúster en Azure Portal para obtener más detalles.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-158">See the cluster’s overview blade in Azure portal for more details.</span></span> <span data-ttu-id="f2c7d-159">Los recursos de [GitHub][github] también muestran cómo abrir el panel desde R.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-159">The [GitHub][github] resources also show how to bring up the dashboard from R.</span></span>

<span data-ttu-id="f2c7d-160">Aunque el panel le ofrece una visión del estado general del clúster, también es importante hacer un seguimiento del estado de los contenedores individuales.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-160">Although the dashboard gives you a view of the overall health of your cluster, it’s also important to track the status of individual containers.</span></span> <span data-ttu-id="f2c7d-161">Para ello, habilite [Azure Monitor Insights][monitor] desde la hoja de información general del clúster en Azure Portal, o consulte [Azure Monitor para contenedores][monitor-containers] (en versión preliminar).</span><span class="sxs-lookup"><span data-stu-id="f2c7d-161">To do this, enable [Azure Monitor Insights][monitor] from the cluster overview blade in Azure portal, or see [Azure Monitor for containers][monitor-containers] (in preview).</span></span>

## <a name="cost-considerations"></a><span data-ttu-id="f2c7d-162">Consideraciones sobre el costo</span><span class="sxs-lookup"><span data-stu-id="f2c7d-162">Cost considerations</span></span>

<span data-ttu-id="f2c7d-163">Machine Learning Server tiene licencia por núcleo, y todos los núcleos del clúster que van a ejecutar Machine Learning Server cuentan para ello.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-163">Machine Learning Server is licensed on a per-core basis, and all the cores in the cluster that will run Machine Learning  Server count towards this.</span></span> <span data-ttu-id="f2c7d-164">Si es un cliente empresarial de Machine Learning Server o Microsoft SQL Server, póngase en contacto con su representante de Microsoft para obtener información sobre precios.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-164">If you are an enterprise Machine Learning Server or Microsoft SQL Server customer, contact your Microsoft representative for pricing details.</span></span>

<span data-ttu-id="f2c7d-165">Una alternativa de código abierto a Machine Learning Server es [Plumber][plumber], un paquete de R que convierte el código en una API REST.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-165">An open-source alternative to Machine Learning Server is [Plumber][plumber], an R package that turns your code into a REST API.</span></span> <span data-ttu-id="f2c7d-166">Plumber tiene menos funciones que Machine Learning Server.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-166">Plumber is less fully featured than Machine Learning Server.</span></span> <span data-ttu-id="f2c7d-167">Por ejemplo, de forma predeterminada no incluye ninguna característica que proporcione autenticación de solicitudes.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-167">For example, by default it doesn't include any features that provide request authentication.</span></span> <span data-ttu-id="f2c7d-168">Si se utiliza Plumber, se recomienda que habilite [Azure API Management][API] para tratar los detalles de autenticación.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-168">If you use Plumber, it’s recommended that you enable [Azure API Management][API] to handle authentication details.</span></span>

<span data-ttu-id="f2c7d-169">Además de la concesión de licencias, la principal consideración de costos son los recursos de proceso del clúster de Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-169">Besides licensing, the main cost consideration is the Kubernetes cluster's compute resources.</span></span> <span data-ttu-id="f2c7d-170">El clúster debe ser lo suficientemente grande como para controlar el volumen de solicitudes previsto en las horas punta, pero este enfoque deja los recursos inactivos en otros momentos.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-170">The cluster must be large enough to handle the expected request volume at peak times, but this approach leaves resources idle at other times.</span></span> <span data-ttu-id="f2c7d-171">Para limitar el impacto de los recursos inactivos, habilite la [escalabilidad automática horizontal][autoscaler] para el clúster mediante la herramienta kubectl.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-171">To limit the impact of idle resources, enable the [horizontal autoscaler][autoscaler] for the cluster using the kubectl tool.</span></span> <span data-ttu-id="f2c7d-172">O bien, utilice la [escalabilidad automática de clústeres][cluster-autoscaler] de AKS.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-172">Or use the AKS [cluster autoscaler][cluster-autoscaler].</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="f2c7d-173">Implementación de la solución</span><span class="sxs-lookup"><span data-stu-id="f2c7d-173">Deploy the solution</span></span>

<span data-ttu-id="f2c7d-174">Hay disponible una implementación de referencia de esta arquitectura en [GitHub][github].</span><span class="sxs-lookup"><span data-stu-id="f2c7d-174">The reference implementation of this architecture is available on [GitHub][github].</span></span> <span data-ttu-id="f2c7d-175">Siga los pasos descritos para implementar un modelo predictivo simple como servicio.</span><span class="sxs-lookup"><span data-stu-id="f2c7d-175">Follow the steps described there to deploy a simple predictive model as a service.</span></span>

<!-- links -->
[AAD]: /azure/active-directory/fundamentals/active-directory-whatis
[API]: /azure/api-management/api-management-key-concepts
[ACR]: /azure/container-registry/container-registry-intro
[AKS]: /azure/aks/intro-kubernetes
[autoscaler]: https://kubernetes.io/docs/tasks/run-application/horizontal-pod-autoscale/
[cluster-autoscaler]: /azure/aks/autoscaler
[monitor]: /azure/monitoring/monitoring-container-insights-overview
[dashboard]: /azure/aks/kubernetes-dashboard
[docker]: https://docs.docker.com/registry/spec/api/
[encrypt]: https://letsencrypt.org/
[gitHub]: https://github.com/Azure/RealtimeRDeployment
[K-API]: https://kubernetes.io/docs/reference/
[MMLS]: /machine-learning-server/what-is-machine-learning-server
[monitor-containers]: /azure/azure-monitor/insights/container-insights-overview
[operationalization]: /machine-learning-server/what-is-operationalization
[plumber]: https://www.rplumber.io
[RBAC]: /azure/role-based-access-control/overview
[storage]: /azure/storage/common/storage-introduction
[0]: ./_images/realtime-scoring-r.png
