---
title: Arquitectura de microservicios en Azure Kubernetes Service (AKS)
description: Implementación de una arquitectura de microservicios en Azure Kubernetes Service (AKS)
author: MikeWasson
ms.date: 12/10/2018
ms.openlocfilehash: c8fa92e012374882e3af89f7ef8f7d800a52dacb
ms.sourcegitcommit: a0a9981e7586bed8d876a54e055dea1e392118f8
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 12/11/2018
ms.locfileid: "53233921"
---
# <a name="microservices-architecture-on-azure-kubernetes-service-aks"></a><span data-ttu-id="37cf8-103">Arquitectura de microservicios en Azure Kubernetes Service (AKS)</span><span class="sxs-lookup"><span data-stu-id="37cf8-103">Microservices architecture on Azure Kubernetes Service (AKS)</span></span>

<span data-ttu-id="37cf8-104">Esta arquitectura de referencia muestra una aplicación de microservicios implementada en Azure Kubernetes Service (AKS).</span><span class="sxs-lookup"><span data-stu-id="37cf8-104">This reference architectures shows a microservices application deployed to Azure Kubernetes Service (AKS).</span></span> <span data-ttu-id="37cf8-105">Muestra una configuración básica de AKS que puede ser el punto de partida para la mayoría de las implementaciones.</span><span class="sxs-lookup"><span data-stu-id="37cf8-105">It shows a basic AKS configuration that can be the starting point for most deployments.</span></span> <span data-ttu-id="37cf8-106">Las opciones más avanzadas, incluidas las opciones de redes avanzadas, se tratarán en una arquitectura de referencia independiente.</span><span class="sxs-lookup"><span data-stu-id="37cf8-106">More advanced options, including advanced networking options, will be covered in a separate reference architecture.</span></span>

<span data-ttu-id="37cf8-107">En este artículo se da por supuesto un conocimiento básico de Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-107">This article assumes basic knowledge of Kubernetes.</span></span> <span data-ttu-id="37cf8-108">El artículo se centra principalmente en la infraestructura y las consideraciones sobre DevOps de la ejecución de una arquitectura de microservicios en AKS.</span><span class="sxs-lookup"><span data-stu-id="37cf8-108">The article focuses mainly on the infrastructure and DevOps considerations of running a microservices architecture on AKS.</span></span> <span data-ttu-id="37cf8-109">Para obtener instrucciones sobre cómo diseñar microservicios desde una perspectiva de diseño controlado por dominio (DDD), consulte [Diseño, creación y operación de microservicios en Azure](/azure/architecture/microservices).</span><span class="sxs-lookup"><span data-stu-id="37cf8-109">For guidance on how to design microservices from a Domain Driven Design (DDD) perspective, see [Designing, building, and operating microservices on Azure](/azure/architecture/microservices).</span></span>

> [!NOTE]
> <span data-ttu-id="37cf8-110">Estamos trabajando en una implementación de referencia (RI) para acompañar a este artículo que esperamos publicar a principios de 2019.</span><span class="sxs-lookup"><span data-stu-id="37cf8-110">We are working on a reference implementation (RI) to accompany this article, which we expect to publish in early 2019.</span></span> <span data-ttu-id="37cf8-111">Este artículo se actualizará para incorporar los procedimientos recomendados adicionales de dicha RI.</span><span class="sxs-lookup"><span data-stu-id="37cf8-111">This article will be updated to incorporate additional best practices from that RI.</span></span>

![Arquitectura de referencia de AKS](./_images/aks.png)

## <a name="architecture"></a><span data-ttu-id="37cf8-113">Arquitectura</span><span class="sxs-lookup"><span data-stu-id="37cf8-113">Architecture</span></span>

<span data-ttu-id="37cf8-114">La arquitectura consta de los siguientes componentes:</span><span class="sxs-lookup"><span data-stu-id="37cf8-114">The architecture consists of the following components.</span></span>

<span data-ttu-id="37cf8-115">**Azure Kubernetes Service** (AKS).</span><span class="sxs-lookup"><span data-stu-id="37cf8-115">**Azure Kubernetes Service** (AKS).</span></span> <span data-ttu-id="37cf8-116">AKS es un servicio de Azure que implementa un clúster de Kubernetes administrado.</span><span class="sxs-lookup"><span data-stu-id="37cf8-116">AKS is an Azure service that deploys a managed Kubernetes cluster.</span></span> 

<span data-ttu-id="37cf8-117">**Clúster de Kubernetes**.</span><span class="sxs-lookup"><span data-stu-id="37cf8-117">**Kubernetes cluster**.</span></span> <span data-ttu-id="37cf8-118">AKS es responsable de implementar el clúster de Kubernetes y de administrar los maestros de Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-118">AKS is responsible for deploying the Kubernetes cluster and for managing the Kubernetes masters.</span></span> <span data-ttu-id="37cf8-119">Solo debe administrar los nodos de agente.</span><span class="sxs-lookup"><span data-stu-id="37cf8-119">You only manage the agent nodes.</span></span>

<span data-ttu-id="37cf8-120">**Red virtual**.</span><span class="sxs-lookup"><span data-stu-id="37cf8-120">**Virtual network**.</span></span> <span data-ttu-id="37cf8-121">De forma predeterminada, AKS crea una red virtual para implementar en ella los nodos de agente.</span><span class="sxs-lookup"><span data-stu-id="37cf8-121">By default, AKS creates a virtual network to deploy the agent nodes into.</span></span> <span data-ttu-id="37cf8-122">Para escenarios más avanzados, puede crear la red virtual en primer lugar, lo que le permite controlar elementos como la configuración de las subredes, la conectividad local y el direccionamiento IP.</span><span class="sxs-lookup"><span data-stu-id="37cf8-122">For more advanced scenarios, you can create the virtual network first, which lets you control things like how the subnets are configured, on-premises connectivity, and IP addressing.</span></span> <span data-ttu-id="37cf8-123">Para más información, consulte [Configuración de redes avanzadas en Azure Kubernetes Service (AKS)](/azure/aks/configure-advanced-networking).</span><span class="sxs-lookup"><span data-stu-id="37cf8-123">For more information, see [Configure advanced networking in Azure Kubernetes Service (AKS)](/azure/aks/configure-advanced-networking).</span></span>

<span data-ttu-id="37cf8-124">**Entrada**.</span><span class="sxs-lookup"><span data-stu-id="37cf8-124">**Ingress**.</span></span> <span data-ttu-id="37cf8-125">Una entrada expone rutas HTTP(S) a servicios dentro del clúster.</span><span class="sxs-lookup"><span data-stu-id="37cf8-125">An ingress exposes HTTP(S) routes to services inside the cluster.</span></span> <span data-ttu-id="37cf8-126">Para más información, consulte la sección [Puerta de enlace de API](#api-gateway) a continuación.</span><span class="sxs-lookup"><span data-stu-id="37cf8-126">For more information, see the section [API Gateway](#api-gateway) below.</span></span>

<span data-ttu-id="37cf8-127">**Almacenes de datos externos**.</span><span class="sxs-lookup"><span data-stu-id="37cf8-127">**External data stores**.</span></span> <span data-ttu-id="37cf8-128">Los microservicios son normalmente sin estado y escriben el estado en almacenes de datos externos, como Azure SQL Database o Cosmos DB.</span><span class="sxs-lookup"><span data-stu-id="37cf8-128">Microservices are typically stateless and write state to external data stores, such as Azure SQL Database or Cosmos DB.</span></span>

<span data-ttu-id="37cf8-129">**Azure Active Directory**.</span><span class="sxs-lookup"><span data-stu-id="37cf8-129">**Azure Active Directory**.</span></span> <span data-ttu-id="37cf8-130">AKS usa una identidad de Azure Active Directory (Azure AD) para crear y administrar otros recursos de Azure, como los equilibradores de carga de Azure.</span><span class="sxs-lookup"><span data-stu-id="37cf8-130">AKS uses an Azure Active Directory (Azure AD) identity to create and manage other Azure resources such as Azure load balancers.</span></span> <span data-ttu-id="37cf8-131">Azure AD también se recomienda para la autenticación de usuario en aplicaciones cliente.</span><span class="sxs-lookup"><span data-stu-id="37cf8-131">Azure AD is also recommended for user authentication in client applications.</span></span>

<span data-ttu-id="37cf8-132">**Azure Container Registry**.</span><span class="sxs-lookup"><span data-stu-id="37cf8-132">**Azure Container Registry**.</span></span> <span data-ttu-id="37cf8-133">Utilice Container Registry para almacenar imágenes de Docker privadas, que se implementan en el clúster.</span><span class="sxs-lookup"><span data-stu-id="37cf8-133">Use Container Registry to store private Docker images, which are deployed to the cluster.</span></span> <span data-ttu-id="37cf8-134">AKS se puede autenticar con Container Registry con su identidad de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="37cf8-134">AKS can authenticate with Container Registry using its Azure AD identity.</span></span> <span data-ttu-id="37cf8-135">Tenga en cuenta que AKS no requiere Azure Container Registry.</span><span class="sxs-lookup"><span data-stu-id="37cf8-135">Note that AKS does not require Azure Container Registry.</span></span> <span data-ttu-id="37cf8-136">Puede usar otros registros de contenedor, como Docker Hub.</span><span class="sxs-lookup"><span data-stu-id="37cf8-136">You can use other container registries, such as Docker Hub.</span></span>

<span data-ttu-id="37cf8-137">**Azure Pipelines**.</span><span class="sxs-lookup"><span data-stu-id="37cf8-137">**Azure Pipelines**.</span></span> <span data-ttu-id="37cf8-138">Pipelines es parte de Azure DevOps Services y ejecuta compilaciones, pruebas e implementaciones automatizadas.</span><span class="sxs-lookup"><span data-stu-id="37cf8-138">Pipelines is part of Azure DevOps Services and runs automated builds, tests, and deployments.</span></span> <span data-ttu-id="37cf8-139">También puede usar soluciones de CI/CD de terceros como Jenkins.</span><span class="sxs-lookup"><span data-stu-id="37cf8-139">You can also use third-party CI/CD solutions such as Jenkins.</span></span> 

<span data-ttu-id="37cf8-140">**Helm**.</span><span class="sxs-lookup"><span data-stu-id="37cf8-140">**Helm**.</span></span> <span data-ttu-id="37cf8-141">Helm es un administrador de paquetes para Kubernetes: una manera de agrupar objetos de Kubernetes en una sola unidad que se puede publicar, implementar, versionar y actualizar.</span><span class="sxs-lookup"><span data-stu-id="37cf8-141">Helm is as a package manager for Kubernetes &mdash; a way to bundle Kubernetes objects into a single unit that you can publish, deploy, version, and update.</span></span>

<span data-ttu-id="37cf8-142">**Azure Monitor**.</span><span class="sxs-lookup"><span data-stu-id="37cf8-142">**Azure Monitor**.</span></span> <span data-ttu-id="37cf8-143">Azure Monitor recopila y almacena métricas y registros, incluidas las métricas de plataforma para los servicios de Azure de la solución y los datos de telemetría de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="37cf8-143">Azure Monitor collects and stores metrics and logs, including platform metrics for the Azure services in the solution and application telemetry.</span></span> <span data-ttu-id="37cf8-144">Use estos datos para supervisar la aplicación, configurar alertas y paneles y realizar el análisis de causa principal de los errores.</span><span class="sxs-lookup"><span data-stu-id="37cf8-144">Use this data to monitor the application, set up alerts and dashboards, and perform root cause analysis of failures.</span></span> <span data-ttu-id="37cf8-145">Azure Monitor se integra con AKS para recopilar métricas de controladores, nodos y contenedores, así como los registros de contenedor y los registros del nodo maestro.</span><span class="sxs-lookup"><span data-stu-id="37cf8-145">Azure Monitor integrates with AKS to collect metrics from controllers, nodes, and containers, as well as container logs and master node logs.</span></span>

## <a name="design-considerations"></a><span data-ttu-id="37cf8-146">Consideraciones de diseño</span><span class="sxs-lookup"><span data-stu-id="37cf8-146">Design considerations</span></span>

<span data-ttu-id="37cf8-147">Esta arquitectura de referencia se centra en las arquitecturas de microservicios, aunque muchos de los procedimientos recomendados se aplicarán a otras cargas de trabajo que se ejecutan en AKS.</span><span class="sxs-lookup"><span data-stu-id="37cf8-147">This reference architecture is focused on microservices architectures, although many of the recommended practices will apply to other workloads running on AKS.</span></span>

### <a name="microservices"></a><span data-ttu-id="37cf8-148">Microservicios</span><span class="sxs-lookup"><span data-stu-id="37cf8-148">Microservices</span></span>

<span data-ttu-id="37cf8-149">El objeto de Kubernetes Service es una manera natural para modelar microservicios en Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-149">The Kubernetes Service object is a natural way to model microservices in Kubernetes.</span></span> <span data-ttu-id="37cf8-150">Un microservicio es una unidad de código de acoplamiento flexible que se puede implementar de forma independiente.</span><span class="sxs-lookup"><span data-stu-id="37cf8-150">A microservice is a loosely coupled, independently deployable unit of code.</span></span> <span data-ttu-id="37cf8-151">Los microservicios normalmente se comunican mediante API bien definidas y son detectables por algún tipo de detección de servicios.</span><span class="sxs-lookup"><span data-stu-id="37cf8-151">Microservices typically communicate through well-defined APIs, and are discoverable through some form of service discovery.</span></span> <span data-ttu-id="37cf8-152">El objeto de Kubernetes Service proporciona un conjunto de funcionalidades que coinciden con estos requisitos:</span><span class="sxs-lookup"><span data-stu-id="37cf8-152">The Kubernetes Service object provides a set of capabilities that match these requirements:</span></span>

- <span data-ttu-id="37cf8-153">Dirección IP.</span><span class="sxs-lookup"><span data-stu-id="37cf8-153">IP address.</span></span> <span data-ttu-id="37cf8-154">El objeto del servicio proporciona una dirección IP interna estática para un grupo de pods (conjunto de réplicas).</span><span class="sxs-lookup"><span data-stu-id="37cf8-154">The Service object provides a static internal IP address for a group of pods (ReplicaSet).</span></span> <span data-ttu-id="37cf8-155">A medida que los pods se crean o se mueven, el servicio siempre está accesible en esta dirección IP interna.</span><span class="sxs-lookup"><span data-stu-id="37cf8-155">As pods are created or moved around, the service is always reachable at this internal IP address.</span></span>

- <span data-ttu-id="37cf8-156">Equilibrio de carga.</span><span class="sxs-lookup"><span data-stu-id="37cf8-156">Load balancing.</span></span> <span data-ttu-id="37cf8-157">La carga del tráfico enviado a la dirección IP del servicio se equilibra en los pods.</span><span class="sxs-lookup"><span data-stu-id="37cf8-157">Traffic sent to the service's IP address is load balanced to the pods.</span></span> 

- <span data-ttu-id="37cf8-158">Detección de servicios.</span><span class="sxs-lookup"><span data-stu-id="37cf8-158">Service discovery.</span></span> <span data-ttu-id="37cf8-159">El servicio DNS de Kubernetes asigna entradas DNS internas a los servicios.</span><span class="sxs-lookup"><span data-stu-id="37cf8-159">Services are assigned internal DNS entries by the Kubernetes DNS service.</span></span> <span data-ttu-id="37cf8-160">Esto significa que la puerta de enlace de API puede llamar a un servicio de back-end con el nombre DNS.</span><span class="sxs-lookup"><span data-stu-id="37cf8-160">That means the API gateway can call a backend service using the DNS name.</span></span> <span data-ttu-id="37cf8-161">Se puede usar el mismo mecanismo para la comunicación de servicio a servicio.</span><span class="sxs-lookup"><span data-stu-id="37cf8-161">The same mechanism can be used for service-to-service communication.</span></span> <span data-ttu-id="37cf8-162">Las entradas DNS están organizadas por espacio de nombres, por lo que si los espacios de nombres se corresponden con contextos limitados, el nombre DNS de un servicio se asignará de forma natural al dominio de aplicación.</span><span class="sxs-lookup"><span data-stu-id="37cf8-162">The DNS entries are organized by namespace, so if your namespaces correspond to bounded contexts, then the DNS name for a service will map naturally to the application domain.</span></span>

<span data-ttu-id="37cf8-163">El diagrama siguiente muestra la relación conceptual entre servicios y pods.</span><span class="sxs-lookup"><span data-stu-id="37cf8-163">The following diagram show the conceptual relation between services and pods.</span></span> <span data-ttu-id="37cf8-164">La asignación real a los puertos y las direcciones IP del punto de conexión se realiza mediante kube-proxy, el proxy de red de Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-164">The actual mapping to endpoint IP addresses and ports is done by kube-proxy, the Kubernetes network proxy.</span></span>

![Servicios y pods](./_images/aks-services.png)

### <a name="api-gateway"></a><span data-ttu-id="37cf8-166">API Gateway</span><span class="sxs-lookup"><span data-stu-id="37cf8-166">API Gateway</span></span>

<span data-ttu-id="37cf8-167">Una *puerta de enlace de API* es una puerta de enlace que se encuentra entre los clientes externos y los microservicios.</span><span class="sxs-lookup"><span data-stu-id="37cf8-167">An *API gateway* is a gateway that sits between external clients and the microservices.</span></span> <span data-ttu-id="37cf8-168">Actúa como un proxy inverso, enrutando las solicitudes de los clientes a los microservicios.</span><span class="sxs-lookup"><span data-stu-id="37cf8-168">It acts as a reverse proxy, routing requests from clients to microservices.</span></span> <span data-ttu-id="37cf8-169">También puede realizar diversas tareas transversales como la autenticación, la terminación SSL y la limitación de velocidad.</span><span class="sxs-lookup"><span data-stu-id="37cf8-169">It may also perform various cross-cutting tasks such as authentication, SSL termination, and rate limiting.</span></span> 

<span data-ttu-id="37cf8-170">La funcionalidad proporcionada por una puerta de enlace se puede agrupar como sigue:</span><span class="sxs-lookup"><span data-stu-id="37cf8-170">Functionality provided by a gateway can be grouped as follows:</span></span>

- <span data-ttu-id="37cf8-171">[Enrutamiento de puerta de enlace](../../patterns/gateway-routing.md): Enrutamiento de las solicitudes de cliente a los servicios de back-end correctos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-171">[Gateway Routing](../../patterns/gateway-routing.md): Routing client requests to the right backend services.</span></span> <span data-ttu-id="37cf8-172">Esto proporciona un único punto de conexión para los clientes y ayuda a desacoplar los clientes de los servicios.</span><span class="sxs-lookup"><span data-stu-id="37cf8-172">This provides a single endpoint for clients, and helps to decouple clients from services.</span></span>

- <span data-ttu-id="37cf8-173">[Agregación de puerta de enlace](../../patterns/gateway-aggregation.md): Agregación de varias solicitudes en una sola solicitud, para reducir el intercambio de mensajes entre el cliente y el back-end.</span><span class="sxs-lookup"><span data-stu-id="37cf8-173">[Gateway Aggregation](../../patterns/gateway-aggregation.md): Aggregation of multiple requests into a single request, to reduce chattiness between the client and the backend.</span></span>

- <span data-ttu-id="37cf8-174">[Descarga con puertas de enlace](../../patterns/gateway-offloading.md).</span><span class="sxs-lookup"><span data-stu-id="37cf8-174">[Gateway Offloading](../../patterns/gateway-offloading.md).</span></span> <span data-ttu-id="37cf8-175">Una puerta de enlace puede descargar de funcionalidades a los servicios de back-end, como la terminación SSL, la autenticación, las listas de direcciones IP permitidas o la limitación de velocidad de cliente.</span><span class="sxs-lookup"><span data-stu-id="37cf8-175">A gateway can offload functionality from the backend services, such as SSL termination, authentication, IP whitelisting, or client rate limiting (throttling).</span></span>

<span data-ttu-id="37cf8-176">Las puertas de enlace de API son un [patrón de diseño de microservicios](https://microservices.io/patterns/apigateway.html) general.</span><span class="sxs-lookup"><span data-stu-id="37cf8-176">API gateways are a general [microservices design pattern](https://microservices.io/patterns/apigateway.html).</span></span> <span data-ttu-id="37cf8-177">Se pueden implementar mediante una serie de tecnologías diferentes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-177">They can be implemented using a number of different technologies.</span></span> <span data-ttu-id="37cf8-178">Probablemente la implementación más común es implementar un enrutador perimetral o un proxy inverso, como Nginx, HAProxy o Traefik, dentro del clúster.</span><span class="sxs-lookup"><span data-stu-id="37cf8-178">Probably the most common implementation is to deploy an edge router or reverse proxy, such as Nginx, HAProxy, or Traefik, inside the cluster.</span></span> 

<span data-ttu-id="37cf8-179">Otras opciones incluyen:</span><span class="sxs-lookup"><span data-stu-id="37cf8-179">Other options include:</span></span>

- <span data-ttu-id="37cf8-180">Azure Application Gateway o Azure API-Management, que son servicios administrados que residen fuera del clúster.</span><span class="sxs-lookup"><span data-stu-id="37cf8-180">Azure Application Gateway and/or Azure API-Management, which are both managed services that reside outside of the cluster.</span></span> <span data-ttu-id="37cf8-181">Actualmente está en versión beta un controlador de entrada de la puerta de enlace de aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="37cf8-181">An Application Gateway Ingress Controller is currently in beta.</span></span>

- <span data-ttu-id="37cf8-182">Azure Functions Proxies.</span><span class="sxs-lookup"><span data-stu-id="37cf8-182">Azure Functions Proxies.</span></span> <span data-ttu-id="37cf8-183">Los servidores proxy pueden modificar las solicitudes y las respuestas y enrutar las solicitudes en función de direcciones URL.</span><span class="sxs-lookup"><span data-stu-id="37cf8-183">Proxies can modify requests and responses and route requests based on URL.</span></span>

<span data-ttu-id="37cf8-184">El tipo de recurso **Entrada** de Kubernetes abstrae las opciones de configuración de un servidor proxy.</span><span class="sxs-lookup"><span data-stu-id="37cf8-184">The Kubernetes **Ingress** resource type abstracts the configuration settings for a proxy server.</span></span> <span data-ttu-id="37cf8-185">Funciona junto con un controlador de entrada, que proporciona la implementación subyacente de la entrada.</span><span class="sxs-lookup"><span data-stu-id="37cf8-185">It works in conjunction with an ingress controller, which provides the underlying implementation of the Ingress.</span></span> <span data-ttu-id="37cf8-186">Hay controladores de entrada para Nginx, HAProxy, Traefik y Application Gateway (versión preliminar), entre otros.</span><span class="sxs-lookup"><span data-stu-id="37cf8-186">There are ingress controllers for Nginx, HAProxy, Traefik, and Application Gateway (preview), among others.</span></span>

<span data-ttu-id="37cf8-187">El controlador de entrada controla la configuración del servidor proxy.</span><span class="sxs-lookup"><span data-stu-id="37cf8-187">The ingress controller handles configuring the proxy server.</span></span> <span data-ttu-id="37cf8-188">A menudo requieren archivos de configuración complejos, que pueden ser difíciles de ajustar si no es un experto, por lo que el controlador de entrada es una buena abstracción.</span><span class="sxs-lookup"><span data-stu-id="37cf8-188">Often these require complex configuration files, which can be hard to tune if you aren't an expert, so the ingress controller is a nice abstraction.</span></span> <span data-ttu-id="37cf8-189">Además, el controlador de entrada tiene acceso a la API de Kubernetes, por lo que puede tomar decisiones inteligentes sobre enrutamiento y equilibrio de carga.</span><span class="sxs-lookup"><span data-stu-id="37cf8-189">In addition, the Ingress Controller has access to the Kubernetes API, so it can make intelligent decisions about routing and load balancing.</span></span> <span data-ttu-id="37cf8-190">Por ejemplo, el controlador de entrada Nginx omite al proxy de red kube-proxy.</span><span class="sxs-lookup"><span data-stu-id="37cf8-190">For example, the Nginx ingress controller bypasses the kube-proxy network proxy.</span></span>

<span data-ttu-id="37cf8-191">Por otro lado, si necesita control absoluto sobre la configuración, puede omitir esta abstracción y configurar manualmente el servidor proxy.</span><span class="sxs-lookup"><span data-stu-id="37cf8-191">On the other hand, if you need complete control over the settings, you may want to bypass this abstraction and configure the proxy server manually.</span></span> 

<span data-ttu-id="37cf8-192">Un servidor proxy inverso es un posible cuello de botella o un único punto de error, por lo que siempre debe implementar al menos dos réplicas para la alta disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="37cf8-192">A reverse proxy server is a potential bottleneck or single point of failure, so always deploy at least two replicas for high availability.</span></span>

### <a name="data-storage"></a><span data-ttu-id="37cf8-193">Almacenamiento de datos</span><span class="sxs-lookup"><span data-stu-id="37cf8-193">Data storage</span></span>

<span data-ttu-id="37cf8-194">En una arquitectura de microservicios, los servicios no deben compartir el almacenamiento de datos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-194">In a microservices architecture, services should not share data storage.</span></span> <span data-ttu-id="37cf8-195">Cada servicio debe ser propietario de sus propios datos privados en un almacenamiento lógico independiente, para evitar dependencias ocultas entre servicios.</span><span class="sxs-lookup"><span data-stu-id="37cf8-195">Each service should own its own private data in a separate logical storage, to avoid hidden dependencies among services.</span></span> <span data-ttu-id="37cf8-196">La razón es evitar el acoplamiento involuntario entre servicios, lo que puede suceder cuando los servicios comparten los mismos esquemas de datos subyacentes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-196">The reason is to avoid unintentional coupling between services, which can happen when services share the same underlying data schemas.</span></span> <span data-ttu-id="37cf8-197">Además, cuando los servicios administran sus propios almacenes de datos, pueden usar el almacén de datos adecuado para sus requisitos particulares.</span><span class="sxs-lookup"><span data-stu-id="37cf8-197">Also, when services manage their own data stores, they can use the right data store for their particular requirements.</span></span> <span data-ttu-id="37cf8-198">Para más información, consulte [Diseño de microservicios: consideraciones sobre los datos](/azure/architecture/microservices/data-considerations).</span><span class="sxs-lookup"><span data-stu-id="37cf8-198">For more information, see [Designing microservices: Data considerations](/azure/architecture/microservices/data-considerations).</span></span>

<span data-ttu-id="37cf8-199">Evite almacenar datos permanentes en el almacenamiento del clúster local, ya que esto ata los datos al nodo.</span><span class="sxs-lookup"><span data-stu-id="37cf8-199">Avoid storing persistent data in local cluster storage, because that ties the data to the node.</span></span> <span data-ttu-id="37cf8-200">En su lugar:</span><span class="sxs-lookup"><span data-stu-id="37cf8-200">Instead,</span></span> 

- <span data-ttu-id="37cf8-201">Use un servicio externo como Azure SQL Database o Cosmos DB. *O bien,*</span><span class="sxs-lookup"><span data-stu-id="37cf8-201">Use an external service such as Azure SQL Database or Cosmos DB, *or*</span></span>

- <span data-ttu-id="37cf8-202">Monte un volumen persistente con discos de Azure o Azure Files.</span><span class="sxs-lookup"><span data-stu-id="37cf8-202">Mount a persistent volume using Azure Disks or Azure Files.</span></span> <span data-ttu-id="37cf8-203">Use Azure Files si el mismo volumen debe ser compartido por varios pods.</span><span class="sxs-lookup"><span data-stu-id="37cf8-203">Use Azure Files if the same volume needs to be shared by multiple pods.</span></span>

### <a name="namespaces"></a><span data-ttu-id="37cf8-204">Espacios de nombres</span><span class="sxs-lookup"><span data-stu-id="37cf8-204">Namespaces</span></span>

<span data-ttu-id="37cf8-205">Use espacios de nombres para organizar los servicios dentro del clúster.</span><span class="sxs-lookup"><span data-stu-id="37cf8-205">Use namespaces to organize services within the cluster.</span></span> <span data-ttu-id="37cf8-206">Todos los objetos de un clúster de Kubernetes pertenecen a un espacio de nombres.</span><span class="sxs-lookup"><span data-stu-id="37cf8-206">Every object in a Kubernetes cluster belongs to a namespace.</span></span> <span data-ttu-id="37cf8-207">De forma predeterminada, cuando se crea un nuevo objeto, este se coloca en el espacio de nombres `default`.</span><span class="sxs-lookup"><span data-stu-id="37cf8-207">By default, when you create a new object, it goes into the `default` namespace.</span></span> <span data-ttu-id="37cf8-208">Pero es una buena práctica crear espacios de nombres más descriptivos para ayudar a organizar los recursos del clúster.</span><span class="sxs-lookup"><span data-stu-id="37cf8-208">But it's a good practice to create namespaces that are more descriptive to help organize the resources in the cluster.</span></span>

<span data-ttu-id="37cf8-209">En primer lugar, los espacios de nombres ayudar a evitar colisiones de nomenclatura.</span><span class="sxs-lookup"><span data-stu-id="37cf8-209">First, namespaces help prevent naming collisions.</span></span> <span data-ttu-id="37cf8-210">Cuando varios equipos implementan microservicios en el mismo clúster, posiblemente con cientos de microservicios, se hace difícil de administrar si todos se incluyen en el mismo espacio de nombres.</span><span class="sxs-lookup"><span data-stu-id="37cf8-210">When multiple teams deploy microservices into the same cluster, with possibly hundreds of microservices, it gets hard to manage if they all go into the same namespace.</span></span> <span data-ttu-id="37cf8-211">Además, los espacios de nombres permiten:</span><span class="sxs-lookup"><span data-stu-id="37cf8-211">In addition, namespaces allow you to:</span></span>

- <span data-ttu-id="37cf8-212">Aplicar restricciones de recursos a un espacio de nombres para que el conjunto total de pods asignados a ese espacio de nombres no pueda superar la cuota de recursos del espacio de nombres.</span><span class="sxs-lookup"><span data-stu-id="37cf8-212">Apply resource constraints to a namespace, so that the total set of pods assigned to that namespace cannot exceed the resource quota of the namespace.</span></span>

- <span data-ttu-id="37cf8-213">Aplicar directivas en el nivel de espacio de nombres, incluidas las directivas de RBAC y seguridad.</span><span class="sxs-lookup"><span data-stu-id="37cf8-213">Apply policies at the namespace level, including RBAC and security policies.</span></span>

<span data-ttu-id="37cf8-214">Para una arquitectura de microservicios, considere la organización de los microservicios en contextos limitados y la creación de espacios de nombres para cada contexto limitado.</span><span class="sxs-lookup"><span data-stu-id="37cf8-214">For a microservices architecture, considering organizing the microservices into bounded contexts, and creating namespaces for each bounded context.</span></span> <span data-ttu-id="37cf8-215">Por ejemplo, todos los microservicios relacionados con el contexto limitado "Pedidos" podrían ir en el mismo espacio de nombres.</span><span class="sxs-lookup"><span data-stu-id="37cf8-215">For example, all microservices related to the "Order Fulfillment" bounded context could go into the same namespace.</span></span> <span data-ttu-id="37cf8-216">Como alternativa, cree un espacio de nombres para cada equipo de desarrollo.</span><span class="sxs-lookup"><span data-stu-id="37cf8-216">Alternatively, create a namespace for each development team.</span></span>

<span data-ttu-id="37cf8-217">Coloque los servicios auxiliares en su propio espacio de nombres independiente.</span><span class="sxs-lookup"><span data-stu-id="37cf8-217">Place utility services into their own separate namespace.</span></span> <span data-ttu-id="37cf8-218">Por ejemplo, podría implementar Elasticsearch o Prometheus para la supervisión de clústeres o Tiller para Helm.</span><span class="sxs-lookup"><span data-stu-id="37cf8-218">For example, you might deploy Elasticsearch or Prometheus for cluster monitoring, or Tiller for Helm.</span></span>

## <a name="scalability-considerations"></a><span data-ttu-id="37cf8-219">Consideraciones sobre escalabilidad</span><span class="sxs-lookup"><span data-stu-id="37cf8-219">Scalability considerations</span></span>

<span data-ttu-id="37cf8-220">Kubernetes admite el escalado horizontal en dos niveles:</span><span class="sxs-lookup"><span data-stu-id="37cf8-220">Kubernetes supports scale-out at two levels:</span></span>

- <span data-ttu-id="37cf8-221">Escalado del número de pods que se asigna a una implementación.</span><span class="sxs-lookup"><span data-stu-id="37cf8-221">Scale the number of pods allocated to a deployment.</span></span>
- <span data-ttu-id="37cf8-222">Escalado de los nodos del clúster, para aumentar los recursos de proceso totales disponibles para el clúster.</span><span class="sxs-lookup"><span data-stu-id="37cf8-222">Scale the nodes in the cluster, to increase the total compute resources available to the cluster.</span></span>

<span data-ttu-id="37cf8-223">Aunque puede escalar horizontalmente los pods y los nodos manualmente, se recomienda usar el escalado automático para minimizar la posibilidad de que los servicios se queden con recursos escasos en cargas elevadas.</span><span class="sxs-lookup"><span data-stu-id="37cf8-223">Although you can scale out pods and nodes manually, we recommend using autoscaling, to minimize the chance that services will become resource starved under high load.</span></span> <span data-ttu-id="37cf8-224">Una estrategia de escalado automático debe tienen en cuenta los pods y los nodos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-224">An autoscaling strategy must take both pods and nodes into account.</span></span> <span data-ttu-id="37cf8-225">Si solo escala horizontalmente los pods, podría alcanzar los límites de recursos de los nodos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-225">If you just scale out the pods, eventually you will reach the resource limits of the nodes.</span></span> 

### <a name="pod-autoscaling"></a><span data-ttu-id="37cf8-226">Escalado automático de pods</span><span class="sxs-lookup"><span data-stu-id="37cf8-226">Pod autoscaling</span></span>

<span data-ttu-id="37cf8-227">Horizontal Pod Autoscaler (HPA) escala los pods en función de la CPU y la memoria observadas o de métricas personalizadas.</span><span class="sxs-lookup"><span data-stu-id="37cf8-227">The Horizontal Pod Autoscaler (HPA) scales pods based on observed CPU, memory, or custom metrics.</span></span> <span data-ttu-id="37cf8-228">Para configurar el escalado horizontal de pods, especifique una métrica de destino (por ejemplo, el 70% de CPU) y el número mínimo y máximo de réplicas.</span><span class="sxs-lookup"><span data-stu-id="37cf8-228">To configure horizontal pod scaling, you specify a target metric (for example, 70% of CPU), and the minimum and maximum number of replicas.</span></span> <span data-ttu-id="37cf8-229">Debe realizar una prueba de carga de los servicios para averiguar estas cifras.</span><span class="sxs-lookup"><span data-stu-id="37cf8-229">You should load test your services to derive these numbers.</span></span>

<span data-ttu-id="37cf8-230">Un efecto secundario del escalado automático es que los pods podrían crearse o expulsarse con más frecuencia, a medida que se producen eventos de escalado horizontal y reducción horizontal.</span><span class="sxs-lookup"><span data-stu-id="37cf8-230">A side-effect of autoscaling is that pods may be created or evicted more frequently, as scale-out and scale-in events happen.</span></span> <span data-ttu-id="37cf8-231">Para mitigar los efectos de esto:</span><span class="sxs-lookup"><span data-stu-id="37cf8-231">To mitigate the effects of this:</span></span>

- <span data-ttu-id="37cf8-232">Use sondeos de preparación para que Kubernetes sepa cuándo está listo un pod nuevo para aceptar tráfico.</span><span class="sxs-lookup"><span data-stu-id="37cf8-232">Use readiness probes to let Kubernetes know when a new pod is ready to accept traffic.</span></span>
- <span data-ttu-id="37cf8-233">Use presupuestos de interrupciones de pods para limitar el número de pods que se puede expulsar de un servicio a la vez.</span><span class="sxs-lookup"><span data-stu-id="37cf8-233">Use pod disruption budgets to limit how many pods can be evicted from a service at a time.</span></span>

### <a name="cluster-autoscaling"></a><span data-ttu-id="37cf8-234">Escalado automático del clúster</span><span class="sxs-lookup"><span data-stu-id="37cf8-234">Cluster autoscaling</span></span>

<span data-ttu-id="37cf8-235">El escalador automático del clúster escala el número de nodos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-235">The cluster autoscaler scales the number of nodes.</span></span> <span data-ttu-id="37cf8-236">Si no se pueden programar pods debido a restricciones de recursos, el escalador automático del clúster aprovisionará más nodos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-236">If pods can't be scheduled because of resource constraints, the cluster autoscaler will provision more nodes.</span></span>  <span data-ttu-id="37cf8-237">(Nota: La integración entre AKS y el escalador automático del clúster está actualmente en versión preliminar).</span><span class="sxs-lookup"><span data-stu-id="37cf8-237">(Note: Integration between AKS and the cluster autoscaler is currently in preview.)</span></span>

<span data-ttu-id="37cf8-238">Mientras que HPA examina los recursos reales consumidos u otras métricas de la ejecución de pods, el escalador automático del clúster aprovisiona nodos para pods que no están programados todavía.</span><span class="sxs-lookup"><span data-stu-id="37cf8-238">Whereas HPA looks at actual resources consumed or other metrics from running pods, the cluster autoscaler is provisioning nodes for pods that aren't scheduled yet.</span></span> <span data-ttu-id="37cf8-239">Por lo tanto, examina los recursos solicitados, como se especifica en la especificación de pods de Kubernetes para una implementación.</span><span class="sxs-lookup"><span data-stu-id="37cf8-239">Therefore, it looks at the requested resources, as specified in the Kubernetes pod spec for a deployment.</span></span> <span data-ttu-id="37cf8-240">Use pruebas de carga para ajustar estos valores.</span><span class="sxs-lookup"><span data-stu-id="37cf8-240">Use load testing to fine-tune these values.</span></span>

<span data-ttu-id="37cf8-241">No se puede cambiar el tamaño de máquina virtual después de crear el clúster, por lo que debe realizar algún planeamiento inicial de capacidad para elegir un tamaño de máquina virtual adecuado para los nodos de agente cuando se crea el clúster.</span><span class="sxs-lookup"><span data-stu-id="37cf8-241">You can't change the VM size after you create the cluster, so you should do some initial capacity planning to choose an appropriate VM size for the agent nodes when you create the cluster.</span></span> 

## <a name="availability-considerations"></a><span data-ttu-id="37cf8-242">Consideraciones sobre disponibilidad</span><span class="sxs-lookup"><span data-stu-id="37cf8-242">Availability considerations</span></span>

### <a name="health-probes"></a><span data-ttu-id="37cf8-243">Sondeos de estado</span><span class="sxs-lookup"><span data-stu-id="37cf8-243">Health probes</span></span>

<span data-ttu-id="37cf8-244">Kubernetes define dos tipos de sondeo de mantenimiento que puede exponer un pod:</span><span class="sxs-lookup"><span data-stu-id="37cf8-244">Kubernetes defines two types of health probe that a pod can expose:</span></span>

- <span data-ttu-id="37cf8-245">Sondeo de preparación: indica a Kubernetes si el pod está listo para aceptar solicitudes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-245">Readiness probe: Tells Kubernetes whether the pod is ready to accept requests.</span></span>

- <span data-ttu-id="37cf8-246">Sondeo de ejecución: indica a Kubernetes si se debería quitar un pod e iniciar una nueva instancia.</span><span class="sxs-lookup"><span data-stu-id="37cf8-246">Liveness probe: Tells Kubernetes whether a pod should be removed and a new instance started.</span></span>

<span data-ttu-id="37cf8-247">Al pensar en los sondeos, es útil recordar cómo funciona un servicio en Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-247">When thinking about probes, it's useful to recall how a service works in Kubernetes.</span></span> <span data-ttu-id="37cf8-248">Un servicio tiene un selector de etiqueta que coincide con un conjunto de pods (cero o más).</span><span class="sxs-lookup"><span data-stu-id="37cf8-248">A service has a label selector that matches a set of (zero or more) pods.</span></span> <span data-ttu-id="37cf8-249">Kubernetes equilibra el tráfico a los pods que coinciden con el selector.</span><span class="sxs-lookup"><span data-stu-id="37cf8-249">Kubernetes load balances traffic to the pods that match the selector.</span></span> <span data-ttu-id="37cf8-250">Solo los pods que se iniciaron correctamente y que están en buen estado recibirán tráfico.</span><span class="sxs-lookup"><span data-stu-id="37cf8-250">Only pods that started successfully and are healthy receive traffic.</span></span> <span data-ttu-id="37cf8-251">Si se bloquea un contenedor, Kubernetes elimina el pod y programa un reemplazo.</span><span class="sxs-lookup"><span data-stu-id="37cf8-251">If a container crashes, Kubernetes kills the pod and schedules a replacement.</span></span>

<span data-ttu-id="37cf8-252">En ocasiones, un pod puede no estar listo para recibir tráfico aunque el pod se inició correctamente.</span><span class="sxs-lookup"><span data-stu-id="37cf8-252">Sometimes, a pod may not be ready to receive traffic, even though the pod started successfully.</span></span> <span data-ttu-id="37cf8-253">Por ejemplo, puede haber tareas de inicialización, en las que la aplicación que se ejecuta en el contenedor carga elementos en la memoria o lee datos de configuración.</span><span class="sxs-lookup"><span data-stu-id="37cf8-253">For example, there may be initialization tasks, where the application running in the container loads things into memory or reads configuration data.</span></span> <span data-ttu-id="37cf8-254">Para indicar que un pod está correcto pero no está listo para recibir tráfico, defina un sondeo de preparación.</span><span class="sxs-lookup"><span data-stu-id="37cf8-254">To indicate that a pod is healthy but not ready to receive traffic, define a readiness probe.</span></span> 

<span data-ttu-id="37cf8-255">Los sondeos de ejecución controlan el caso de un pod que sigue en ejecución, pero está en mal estado y se debe reciclar.</span><span class="sxs-lookup"><span data-stu-id="37cf8-255">Liveness probes handle the case where a pod is still running, but is unhealthy and should be recycled.</span></span> <span data-ttu-id="37cf8-256">Por ejemplo, suponga que un contenedor da servicio a solicitudes HTTP, pero se bloquea por algún motivo.</span><span class="sxs-lookup"><span data-stu-id="37cf8-256">For example, suppose that a container is serving HTTP requests but hangs for some reason.</span></span> <span data-ttu-id="37cf8-257">El contenedor no se bloquea, pero ha dejado de servir solicitudes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-257">The container doesn't crash, but it has stopped serving any requests.</span></span> <span data-ttu-id="37cf8-258">Si define un sondeo de ejecución HTTP, el sondeo dejará de responder y esto informa a Kubernetes para reiniciar el pod.</span><span class="sxs-lookup"><span data-stu-id="37cf8-258">If you define an HTTP liveness probe, the probe will stop responding and that informs Kubernetes to restart the pod.</span></span>

<span data-ttu-id="37cf8-259">Estas son algunas consideraciones al diseñar los sondeos:</span><span class="sxs-lookup"><span data-stu-id="37cf8-259">Here are some considerations when designing probes:</span></span>

- <span data-ttu-id="37cf8-260">Si el código tiene un tiempo de inicio elevado, hay un riesgo de que un sondeo de ejecución notifique un error antes de que finalice el inicio.</span><span class="sxs-lookup"><span data-stu-id="37cf8-260">If your code has a long startup time, there is a danger that a liveness probe will report failure before the startup completes.</span></span> <span data-ttu-id="37cf8-261">Para evitar esto, use la configuración initialDelaySeconds, que retrasa el inicio del sondeo.</span><span class="sxs-lookup"><span data-stu-id="37cf8-261">To prevent this, use the initialDelaySeconds setting, which delays the probe from starting.</span></span>

- <span data-ttu-id="37cf8-262">Un sondeo de ejecución no ayuda a menos que reiniciar el pod lo restaure a un estado correcto.</span><span class="sxs-lookup"><span data-stu-id="37cf8-262">A liveness probe doesn't help unless restarting the pod is likely to restore it to a healthy state.</span></span> <span data-ttu-id="37cf8-263">Puede usar un sondeo de ejecución para mitigar bloqueos inesperados o fugas de memoria, pero no hay ningún interés en reiniciar un pod que va a producir inmediatamente un nuevo error.</span><span class="sxs-lookup"><span data-stu-id="37cf8-263">You can use a liveness probe to mitigate against memory leaks or unexpected deadlocks, but there's no point in restarting a pod that's going to immediately fail again.</span></span>

- <span data-ttu-id="37cf8-264">A veces se usan sondeos de preparación para comprobar los servicios dependientes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-264">Sometimes readiness probes are used to check dependent services.</span></span> <span data-ttu-id="37cf8-265">Por ejemplo, si un pod tiene una dependencia en una base de datos, el sondeo de ejecución podría comprobar la conexión de base de datos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-265">For example, if a pod has a dependency on a database, the liveness probe might check the database connection.</span></span> <span data-ttu-id="37cf8-266">Sin embargo, este enfoque puede crear problemas inesperados.</span><span class="sxs-lookup"><span data-stu-id="37cf8-266">However, this approach can create unexpected problems.</span></span> <span data-ttu-id="37cf8-267">Un servicio externo podría no estar disponible temporalmente por algún motivo.</span><span class="sxs-lookup"><span data-stu-id="37cf8-267">An external service might be temporarily unavailable for some reason.</span></span> <span data-ttu-id="37cf8-268">Esto hará que el sondeo de preparación genere un error para todos los pods del servicio, causando la eliminación de todos ellos del equilibrio de carga y así crear errores en cascada ascendentes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-268">That will cause the readiness probe to fail for all the pods in your service, causing all of them to be removed from load balancing, and thus creating cascading failures upstream.</span></span> <span data-ttu-id="37cf8-269">Un enfoque mejor consiste en implementar un control de reintentos en el servicio, para que el servicio se pueda recuperar correctamente de errores transitorios.</span><span class="sxs-lookup"><span data-stu-id="37cf8-269">A better approach is to implement retry handling within your service, so that your service can recover correctly from transient failures.</span></span>

### <a name="resource-constraints"></a><span data-ttu-id="37cf8-270">Restricciones de recursos</span><span class="sxs-lookup"><span data-stu-id="37cf8-270">Resource constraints</span></span>

<span data-ttu-id="37cf8-271">La contención de recursos puede afectar a la disponibilidad de un servicio.</span><span class="sxs-lookup"><span data-stu-id="37cf8-271">Resource contention can affect the availability of a service.</span></span> <span data-ttu-id="37cf8-272">Defina restricciones de recursos para los contenedores, para que un único contenedor no pueda sobrecargar los recursos de clúster (memoria y CPU).</span><span class="sxs-lookup"><span data-stu-id="37cf8-272">Define resource constraints for containers, so that a single container cannot overwhelm the cluster resources (memory and CPU).</span></span> <span data-ttu-id="37cf8-273">Para recursos que no están en contenedores, como los subprocesos o las conexiones de red, considere el uso del [patrón Bulkhead](/azure/architecture/patterns/bulkhead) para aislar los recursos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-273">For non-container resources, such as threads or network connections, consider using the [Bulkhead Pattern](/azure/architecture/patterns/bulkhead) to isolate resources.</span></span>

<span data-ttu-id="37cf8-274">Utilice cuotas de recursos para limitar los recursos totales permitidos para un espacio de nombres.</span><span class="sxs-lookup"><span data-stu-id="37cf8-274">Use resource quotas to limit the total resources allowed for a namespace.</span></span> <span data-ttu-id="37cf8-275">De este modo, el front-end no puede dejar sin recursos a los servicios de back-end o viceversa.</span><span class="sxs-lookup"><span data-stu-id="37cf8-275">That way, the front end can't starve the backend services for resources or vice-versa.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="37cf8-276">Consideraciones sobre la seguridad</span><span class="sxs-lookup"><span data-stu-id="37cf8-276">Security considerations</span></span>

### <a name="role-based-access-control-rbac"></a><span data-ttu-id="37cf8-277">Control de acceso basado en roles (RBAC)</span><span class="sxs-lookup"><span data-stu-id="37cf8-277">Role based access control (RBAC)</span></span>

<span data-ttu-id="37cf8-278">Kubernetes y Azure tienen mecanismos de control de acceso basado en rol (RBAC):</span><span class="sxs-lookup"><span data-stu-id="37cf8-278">Kubernetes and Azure both have mechanisms for role-based access control (RBAC):</span></span>

- <span data-ttu-id="37cf8-279">El control de acceso basado en rol de Azure controla el acceso a los recursos de Azure, incluida la capacidad de crear nuevos recursos de Azure.</span><span class="sxs-lookup"><span data-stu-id="37cf8-279">Azure RBAC controls access to resources in Azure, including the ability to create new Azure resources.</span></span> <span data-ttu-id="37cf8-280">Los permisos se pueden asignar a usuarios, grupos o entidades de servicio.</span><span class="sxs-lookup"><span data-stu-id="37cf8-280">Permissions can be assigned to users, groups, or service principals.</span></span> <span data-ttu-id="37cf8-281">(Una entidad de servicio es una identidad de seguridad utilizada por las aplicaciones).</span><span class="sxs-lookup"><span data-stu-id="37cf8-281">(A service principal is a security identity used by applications.)</span></span>

- <span data-ttu-id="37cf8-282">El control de acceso basado en rol de Kubernetes controla los permisos para la API de Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-282">Kubernetes RBAC controls permissions to the Kubernetes API.</span></span> <span data-ttu-id="37cf8-283">Por ejemplo, la creación de pods y la enumeración de pods son acciones que se pueden autorizar (o denegar) a un usuario mediante RBAC.</span><span class="sxs-lookup"><span data-stu-id="37cf8-283">For example, creating pods and listing pods are actions that can be authorized (or denied) to a user through RBAC.</span></span> <span data-ttu-id="37cf8-284">Para asignar permisos de Kubernetes a los usuarios, puede crear *roles* y *enlaces de rol*:</span><span class="sxs-lookup"><span data-stu-id="37cf8-284">To assign Kubernetes permissions to users, you create *roles* and *role bindings*:</span></span>

  - <span data-ttu-id="37cf8-285">Un rol es un conjunto de permisos que se aplican dentro de un espacio de nombres.</span><span class="sxs-lookup"><span data-stu-id="37cf8-285">A Role is a set of permissions that apply within a namespace.</span></span> <span data-ttu-id="37cf8-286">Los permisos se definen como verbos (obtener, actualizar, crear, eliminar) en los recursos (pods, implementaciones, etc).</span><span class="sxs-lookup"><span data-stu-id="37cf8-286">Permissions are defined as verbs (get, update, create, delete) on resources (pods, deployments, etc.).</span></span>

  - <span data-ttu-id="37cf8-287">Un enlace de rol asigna usuarios o grupos a un rol.</span><span class="sxs-lookup"><span data-stu-id="37cf8-287">A RoleBinding assigns users or groups to a Role.</span></span>

  - <span data-ttu-id="37cf8-288">También hay un objeto ClusterRole, que es similar a un rol, pero se aplica a todo el clúster en todos los espacios de nombres.</span><span class="sxs-lookup"><span data-stu-id="37cf8-288">There is also a ClusterRole object, which is like a Role but applies to the entire cluster, across all namespaces.</span></span> <span data-ttu-id="37cf8-289">Para asignar usuarios o grupos a un objeto ClusterRole, cree un objeto ClusterRoleBinding.</span><span class="sxs-lookup"><span data-stu-id="37cf8-289">To assign users or groups to a ClusterRole, create a ClusterRoleBinding.</span></span>

<span data-ttu-id="37cf8-290">AKS integra estos dos mecanismos de RBAC.</span><span class="sxs-lookup"><span data-stu-id="37cf8-290">AKS integrates these two RBAC mechanisms.</span></span> <span data-ttu-id="37cf8-291">Cuando se crea un clúster de AKS, puede configurarlo para usar Azure AD para la autenticación de usuario.</span><span class="sxs-lookup"><span data-stu-id="37cf8-291">When you create an AKS cluster, you can configure it to use Azure AD for user authentication.</span></span> <span data-ttu-id="37cf8-292">Para más información sobre cómo configurar esta opción, consulte [Integración de Azure Active Directory con Azure Kubernetes Service](/azure/aks/aad-integration).</span><span class="sxs-lookup"><span data-stu-id="37cf8-292">For details on how to set this up, see [Integrate Azure Active Directory with Azure Kubernetes Service](/azure/aks/aad-integration).</span></span>

<span data-ttu-id="37cf8-293">Una vez configurado, un usuario que desea acceder a la API de Kubernetes (por ejemplo, mediante kubectl) debe iniciar sesión con sus credenciales de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="37cf8-293">Once this is configured, a user who wants to access the Kubernetes API (for example, through kubectl) must sign in using their Azure AD credentials.</span></span>

<span data-ttu-id="37cf8-294">De forma predeterminada, un usuario de Azure AD no tiene acceso al clúster.</span><span class="sxs-lookup"><span data-stu-id="37cf8-294">By default, an Azure AD user has no access to the cluster.</span></span> <span data-ttu-id="37cf8-295">Para conceder acceso, el administrador del clúster crea enlaces de rol que hacen referencia a usuarios o grupos de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="37cf8-295">To grant access, the cluster administrator creates RoleBindings that refer to Azure AD users or groups.</span></span> <span data-ttu-id="37cf8-296">Si un usuario no tiene permisos para una operación determinada, se producirá un error.</span><span class="sxs-lookup"><span data-stu-id="37cf8-296">If a user doesn't have permissions for a particular operation, it will fail.</span></span>

<span data-ttu-id="37cf8-297">Si los usuarios no tienen acceso de forma predeterminada, ¿cómo tiene permisos el administrador del clúster para crear los enlaces de rol en primer lugar?</span><span class="sxs-lookup"><span data-stu-id="37cf8-297">If users have no access by default, how does the cluster admin have permission to create the role bindings in the first place?</span></span> <span data-ttu-id="37cf8-298">Un clúster de AKS realmente tiene dos tipos de credenciales para llamar al servidor de API de Kubernetes: usuario del clúster y administrador del clúster. Las credenciales de administrador del clúster otorgan acceso completo al clúster.</span><span class="sxs-lookup"><span data-stu-id="37cf8-298">An AKS cluster actually has two types of credentials for calling the Kubernetes API server: cluster user and cluster admin. The cluster admin credentials grant full access to the cluster.</span></span> <span data-ttu-id="37cf8-299">El comando `az aks get-credentials --admin` de la CLI de Azure descarga las credenciales de administrador del clúster y las guarda en el archivo kubeconfig.</span><span class="sxs-lookup"><span data-stu-id="37cf8-299">The Azure CLI command `az aks get-credentials --admin` downloads the cluster admin credentials and saves them into your kubeconfig file.</span></span> <span data-ttu-id="37cf8-300">El administrador del clúster puede utilizar este archivo kubeconfig para crear roles y enlaces de rol.</span><span class="sxs-lookup"><span data-stu-id="37cf8-300">The cluster administrator can use this kubeconfig to create roles and role bindings.</span></span>

<span data-ttu-id="37cf8-301">Dado que las credenciales de administrador del clúster son muy potentes, utilice RBAC de Azure para restringir su acceso:</span><span class="sxs-lookup"><span data-stu-id="37cf8-301">Because the cluster admin credentials are so powerful, use Azure RBAC to restrict access to them:</span></span>

- <span data-ttu-id="37cf8-302">El "rol de administrador del clúster de Azure Kubernetes Service" tiene permisos para descargar las credenciales de administrador del clúster.</span><span class="sxs-lookup"><span data-stu-id="37cf8-302">The "Azure Kubernetes Service Cluster Admin Role" has permission to download the cluster admin credentials.</span></span> <span data-ttu-id="37cf8-303">Solo se debe asignar este rol a los administradores del clúster.</span><span class="sxs-lookup"><span data-stu-id="37cf8-303">Only cluster administrators should be assigned to this role.</span></span>

- <span data-ttu-id="37cf8-304">El "rol de usuario del clúster de Azure Kubernetes Service" tiene permisos para descargar las credenciales de usuario del clúster.</span><span class="sxs-lookup"><span data-stu-id="37cf8-304">The "Azure Kubernetes Service Cluster User Role" has permission to download the cluster user credentials.</span></span> <span data-ttu-id="37cf8-305">Se puede asignar este rol a los usuarios que no son administradores.</span><span class="sxs-lookup"><span data-stu-id="37cf8-305">Non-admin users can be assigned to this role.</span></span> <span data-ttu-id="37cf8-306">Este rol no otorga permisos específicos sobre los recursos de Kubernetes del clúster; simplemente permite que un usuario se conecte al servidor de API.</span><span class="sxs-lookup"><span data-stu-id="37cf8-306">This role does not give any particular permissions on Kubernetes resources inside the cluster &mdash; it just allows a user to connect to the API server.</span></span> 

<span data-ttu-id="37cf8-307">Al definir las directivas de RBAC (en Kubernetes y Azure), piense en los roles de la organización:</span><span class="sxs-lookup"><span data-stu-id="37cf8-307">When you define your RBAC policies (both Kubernetes and Azure), think about the roles in your organization:</span></span>

- <span data-ttu-id="37cf8-308">¿Quién puede crear o eliminar un clúster de AKS y descargar las credenciales de administrador?</span><span class="sxs-lookup"><span data-stu-id="37cf8-308">Who can create or delete an AKS cluster and download the admin credentials?</span></span>
- <span data-ttu-id="37cf8-309">¿Quién puede administrar un clúster?</span><span class="sxs-lookup"><span data-stu-id="37cf8-309">Who can administer a cluster?</span></span>
- <span data-ttu-id="37cf8-310">¿Quién puede crear o actualizar los recursos de un espacio de nombres?</span><span class="sxs-lookup"><span data-stu-id="37cf8-310">Who can create or update resources within a namespace?</span></span>

<span data-ttu-id="37cf8-311">Es una buena práctica delimitar el ámbito de los permisos de RBAC de Kubernetes por espacio de nombres, mediante roles y enlaces de roles, en lugar de utilizar objetos ClusterRoles y ClusterRoleBindings.</span><span class="sxs-lookup"><span data-stu-id="37cf8-311">It's a good practice to scope Kubernetes RBAC permissions by namespace, using Roles and RoleBindings, rather than ClusterRoles and ClusterRoleBindings.</span></span>

<span data-ttu-id="37cf8-312">Por último, queda la pregunta de qué permisos tiene el clúster de AKS para crear y administrar recursos de Azure, como equilibradores de carga, redes o almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="37cf8-312">Finally, there is the question of what permissions the AKS cluster has to create and manage Azure resources, such as load balancers, networking, or storage.</span></span> <span data-ttu-id="37cf8-313">Para autenticarse a sí mismo con las API de Azure, el clúster usa a una entidad de servicio de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="37cf8-313">To authenticate itself with Azure APIs, the cluster uses an Azure AD service principal.</span></span> <span data-ttu-id="37cf8-314">Si no se especifica una entidad de servicio al crear el clúster, se crea una automáticamente.</span><span class="sxs-lookup"><span data-stu-id="37cf8-314">If you don't specify a service principal when you create the cluster, one is created automatically.</span></span> <span data-ttu-id="37cf8-315">Sin embargo, es una buena práctica de seguridad crear la entidad de servicio en primer lugar y asignarle permisos de RBAC mínimos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-315">However, it's a good security practice to create the service principal first and assign the minimal RBAC permissions to it.</span></span> <span data-ttu-id="37cf8-316">Para más información, consulte [Entidades de servicio con Azure Kubernetes Service](/azure/aks/kubernetes-service-principal).</span><span class="sxs-lookup"><span data-stu-id="37cf8-316">For more information, see [Service principals with Azure Kubernetes Service](/azure/aks/kubernetes-service-principal).</span></span>

### <a name="secrets-management-and-application-credentials"></a><span data-ttu-id="37cf8-317">Administración de secretos y credenciales de aplicaciones</span><span class="sxs-lookup"><span data-stu-id="37cf8-317">Secrets management and application credentials</span></span>

<span data-ttu-id="37cf8-318">Las aplicaciones y los servicios a menudo necesitan credenciales para conectarse a servicios externos, como Azure Storage o SQL Database.</span><span class="sxs-lookup"><span data-stu-id="37cf8-318">Applications and services often need credentials that allow them to connect to external services such as Azure Storage or SQL Database.</span></span> <span data-ttu-id="37cf8-319">El desafío consiste en proteger estas credenciales y que no se filtren.</span><span class="sxs-lookup"><span data-stu-id="37cf8-319">The challenge is to keep these credentials safe and not leak them.</span></span> 

<span data-ttu-id="37cf8-320">Para los recursos de Azure, una opción es usar identidades administradas.</span><span class="sxs-lookup"><span data-stu-id="37cf8-320">For Azure resources, one option is to use managed identities.</span></span> <span data-ttu-id="37cf8-321">La idea de una identidad administrada es que una aplicación o un servicio tienen una identidad que se almacena en Azure AD y usan esta identidad para autenticarse con un servicio de Azure.</span><span class="sxs-lookup"><span data-stu-id="37cf8-321">The idea of a managed identity is that an application or service has an identity stored in Azure AD, and uses this identity to authenticate with an Azure service.</span></span> <span data-ttu-id="37cf8-322">La aplicación o el servicio tienen una entidad de servicio creada en Azure AD y se autentican mediante tokens de OAuth 2.0.</span><span class="sxs-lookup"><span data-stu-id="37cf8-322">The application or service has a Service Principal created for it in Azure AD, and authenticates using OAuth 2.0 tokens.</span></span> <span data-ttu-id="37cf8-323">El proceso en ejecución llama a una dirección de host local para obtener el token.</span><span class="sxs-lookup"><span data-stu-id="37cf8-323">The executing process calls a localhost address to get the token.</span></span> <span data-ttu-id="37cf8-324">De este modo, no es necesario almacenar contraseñas ni cadenas de conexión.</span><span class="sxs-lookup"><span data-stu-id="37cf8-324">That way, you don't need to store any passwords or connection strings.</span></span> <span data-ttu-id="37cf8-325">Puede utilizar identidades administradas en AKS mediante la asignación de identidades a pods individuales, con el proyecto [aad-pod-identity](https://github.com/Azure/aad-pod-identity).</span><span class="sxs-lookup"><span data-stu-id="37cf8-325">You can use managed identities in AKS by assigning identities to individual pods, using the [aad-pod-identity](https://github.com/Azure/aad-pod-identity) project.</span></span>

<span data-ttu-id="37cf8-326">Actualmente, no todos los servicios de Azure admiten la autenticación con identidades administradas.</span><span class="sxs-lookup"><span data-stu-id="37cf8-326">Currently, not all Azure services support authentication using managed identities.</span></span> <span data-ttu-id="37cf8-327">Para obtener una lista, consulte [Servicios de Azure que admiten la autenticación de Azure AD](/azure/active-directory/managed-identities-azure-resources/services-support-msi).</span><span class="sxs-lookup"><span data-stu-id="37cf8-327">For a list, see [Azure services that support Azure AD authentication](/azure/active-directory/managed-identities-azure-resources/services-support-msi).</span></span>

<span data-ttu-id="37cf8-328">Incluso con identidades administradas, probablemente necesitará almacenar algunas credenciales u otros secretos de aplicación, ya sea para servicios de Azure que no admiten identidades administradas, servicios de terceros o claves de API.</span><span class="sxs-lookup"><span data-stu-id="37cf8-328">Even with managed identities, you'll probably need to store some credentials or other application secrets, whether for Azure services that don't support managed identities, third-party services, API keys, and so on.</span></span> <span data-ttu-id="37cf8-329">Estas son algunas opciones para almacenar secretos de forma segura:</span><span class="sxs-lookup"><span data-stu-id="37cf8-329">Here are some options for storing secrets securely:</span></span>

- <span data-ttu-id="37cf8-330">Azure Key Vault.</span><span class="sxs-lookup"><span data-stu-id="37cf8-330">Azure Key Vault.</span></span> <span data-ttu-id="37cf8-331">En AKS, puede montar uno o más secretos de Key Vault como un volumen.</span><span class="sxs-lookup"><span data-stu-id="37cf8-331">In AKS, you can mount one or more secrets from Key Vault as a volume.</span></span> <span data-ttu-id="37cf8-332">El volumen lee los secretos de Key Vault.</span><span class="sxs-lookup"><span data-stu-id="37cf8-332">The volume reads the secrets from Key Vault.</span></span> <span data-ttu-id="37cf8-333">El pod, a continuación, puede leer los secretos al igual que en un volumen normal.</span><span class="sxs-lookup"><span data-stu-id="37cf8-333">The pod can then read the secrets just like a regular volume.</span></span> <span data-ttu-id="37cf8-334">Para más información, consulte el proyecto [Kubernetes-KeyVault-FlexVolume](https://github.com/Azure/kubernetes-keyvault-flexvol) en GitHub.</span><span class="sxs-lookup"><span data-stu-id="37cf8-334">For more information, see the [Kubernetes-KeyVault-FlexVolume](https://github.com/Azure/kubernetes-keyvault-flexvol) project on GitHub.</span></span>

    <span data-ttu-id="37cf8-335">El pod se autentica mediante una identidad de pod (descrita anteriormente) o mediante el uso de una entidad de servicio de Azure AD junto con un secreto de cliente.</span><span class="sxs-lookup"><span data-stu-id="37cf8-335">The pod authenticates itself by using either a pod identity (described above) or by using an Azure AD Service Principal along with a client secret.</span></span> <span data-ttu-id="37cf8-336">Se recomienda el uso de identidades de pod porque el secreto de cliente no es necesario en ese caso.</span><span class="sxs-lookup"><span data-stu-id="37cf8-336">Using pod identities is recommended because the client secret isn't needed in that case.</span></span> 

- <span data-ttu-id="37cf8-337">HashiCorp Vault.</span><span class="sxs-lookup"><span data-stu-id="37cf8-337">HashiCorp Vault.</span></span> <span data-ttu-id="37cf8-338">Las aplicaciones de Kubernetes se pueden autenticar con HashiCorp Vault mediante identidades administradas de Azure AD.</span><span class="sxs-lookup"><span data-stu-id="37cf8-338">Kubernetes applications can authenticate with HashiCorp Vault using Azure AD managed identities.</span></span> <span data-ttu-id="37cf8-339">Consulte [HashiCorp Vault speaks Azure Active Directory](https://open.microsoft.com/2018/04/10/scaling-tips-hashicorp-vault-azure-active-directory/) (HashiCorp Vault se comunica con Azure Active Directory).</span><span class="sxs-lookup"><span data-stu-id="37cf8-339">See [HashiCorp Vault speaks Azure Active Directory](https://open.microsoft.com/2018/04/10/scaling-tips-hashicorp-vault-azure-active-directory/).</span></span> <span data-ttu-id="37cf8-340">Puede implementar el propio almacén en Kubernetes, pero es aconsejable ejecutarlo en un clúster dedicado independiente del clúster de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="37cf8-340">You can deploy Vault itself to Kubernetes, but it's recommend to run it in a separate dedicated cluster from your application cluster.</span></span> 

- <span data-ttu-id="37cf8-341">Secretos de Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-341">Kubernetes secrets.</span></span> <span data-ttu-id="37cf8-342">Otra opción es usar secretos de Kubernetes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-342">Another option is simply to use Kubernetes secrets.</span></span> <span data-ttu-id="37cf8-343">Esta opción es la más fácil de configurar pero tiene algunos desafíos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-343">This option is the easiest to configure but has some challenges.</span></span> <span data-ttu-id="37cf8-344">Los secretos se almacenan en etcd, que es un almacén distribuido de pares clave-valor.</span><span class="sxs-lookup"><span data-stu-id="37cf8-344">Secrets are stored in etcd, which is a distributed key-value store.</span></span> <span data-ttu-id="37cf8-345">AKS [cifra etcd en reposo](https://github.com/Azure/kubernetes-kms#azure-kubernetes-service-aks).</span><span class="sxs-lookup"><span data-stu-id="37cf8-345">AKS [encrypts etcd at rest](https://github.com/Azure/kubernetes-kms#azure-kubernetes-service-aks).</span></span> <span data-ttu-id="37cf8-346">Microsoft administra las claves de cifrado.</span><span class="sxs-lookup"><span data-stu-id="37cf8-346">Microsoft manages the encryption keys.</span></span>

<span data-ttu-id="37cf8-347">El uso de un sistema como HashiCorp Vault o Azure Key Vault proporciona varias ventajas, como:</span><span class="sxs-lookup"><span data-stu-id="37cf8-347">Using a system like HashiCorp Vault or Azure Key Vault provides several advantages, such as:</span></span>

- <span data-ttu-id="37cf8-348">Control centralizado de los secretos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-348">Centralized control of secrets.</span></span>
- <span data-ttu-id="37cf8-349">Garantías de que todos los secretos se cifran en reposo.</span><span class="sxs-lookup"><span data-stu-id="37cf8-349">Ensuring that all secrets are encrypted at rest.</span></span>
- <span data-ttu-id="37cf8-350">Administración de claves centralizada.</span><span class="sxs-lookup"><span data-stu-id="37cf8-350">Centralized key management.</span></span>
- <span data-ttu-id="37cf8-351">Control de acceso a los secretos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-351">Access control of secrets.</span></span>
- <span data-ttu-id="37cf8-352">Auditoría</span><span class="sxs-lookup"><span data-stu-id="37cf8-352">Auditing</span></span>

### <a name="pod-and-container-security"></a><span data-ttu-id="37cf8-353">Seguridad del pod y el contenedor</span><span class="sxs-lookup"><span data-stu-id="37cf8-353">Pod and container security</span></span>

<span data-ttu-id="37cf8-354">Esta lista ciertamente no es exhaustiva, pero estos son algunos procedimientos recomendados para proteger los pods y los contenedores:</span><span class="sxs-lookup"><span data-stu-id="37cf8-354">This list is certainly not exhaustive, but here are some recommended practices for securing your pods and containers:</span></span> 

<span data-ttu-id="37cf8-355">No ejecute contenedores en modo con privilegios.</span><span class="sxs-lookup"><span data-stu-id="37cf8-355">Don't run containers in privileged mode.</span></span> <span data-ttu-id="37cf8-356">El modo con privilegios otorga a un contenedor acceso a todos los dispositivos del host.</span><span class="sxs-lookup"><span data-stu-id="37cf8-356">Privileged mode gives a container access to all devices on the host.</span></span> <span data-ttu-id="37cf8-357">Puede establecer una directiva de seguridad del pod para no permitir que los contenedores se ejecuten en modo con privilegios.</span><span class="sxs-lookup"><span data-stu-id="37cf8-357">You can set Pod Security Policy to disallow containers from running in privileged mode.</span></span> 

<span data-ttu-id="37cf8-358">Cuando sea posible, evite ejecutar procesos como root dentro de los contenedores.</span><span class="sxs-lookup"><span data-stu-id="37cf8-358">When possible, avoid running processes as root inside containers.</span></span> <span data-ttu-id="37cf8-359">Los contenedores no proporcionan un aislamiento completo desde la perspectiva de la seguridad, por lo que es mejor ejecutar un proceso de contenedor como un usuario sin privilegios.</span><span class="sxs-lookup"><span data-stu-id="37cf8-359">Containers do not provide complete isolation from a security standpoint, so it's better to run a container process as a non-privileged user.</span></span> 

<span data-ttu-id="37cf8-360">Almacene las imágenes en un registro privado de confianza, como Azure Container Registry o Docker Trusted Registry.</span><span class="sxs-lookup"><span data-stu-id="37cf8-360">Store images in a trusted private registry, such as Azure Container Registry or Docker Trusted Registry.</span></span> <span data-ttu-id="37cf8-361">Use un webhook de validación de admisión en Kubernetes para asegurarse de que los pods solo pueden extraer imágenes desde el registro de confianza.</span><span class="sxs-lookup"><span data-stu-id="37cf8-361">Use a validating admission webhook in Kubernetes to ensure that pods can only pull images from the trusted registry.</span></span>

<span data-ttu-id="37cf8-362">Examine las imágenes en busca de vulnerabilidades conocidas, mediante una solución de análisis como Twistlock y Aqua, que están disponibles en Azure Marketplace.</span><span class="sxs-lookup"><span data-stu-id="37cf8-362">Scan images for known vulnerabilities, using a scanning solution such as Twistlock and Aqua, which are available through the Azure Marketplace.</span></span>

<span data-ttu-id="37cf8-363">Automatice la aplicación de revisiones de imágenes con ACR Tasks, una característica de Azure Container Registry.</span><span class="sxs-lookup"><span data-stu-id="37cf8-363">Automate image patching using ACR Tasks, a feature of Azure Container Registry.</span></span> <span data-ttu-id="37cf8-364">Una imagen de contenedor se compone de capas.</span><span class="sxs-lookup"><span data-stu-id="37cf8-364">A container image is built up from layers.</span></span> <span data-ttu-id="37cf8-365">Las capas de base incluyen la imagen del sistema operativo y las imágenes del marco de trabajo de la aplicación, como ASP.NET Core o Node.js.</span><span class="sxs-lookup"><span data-stu-id="37cf8-365">The base layers include the OS image and application framework images, such as ASP.NET Core or Node.js.</span></span> <span data-ttu-id="37cf8-366">Los desarrolladores de aplicaciones normalmente crean de modo ascendente las imágenes de base y otros desarrolladores del proyecto las mantienen.</span><span class="sxs-lookup"><span data-stu-id="37cf8-366">The base images are typically created upstream from the application developers, and are maintained by other project maintainers.</span></span> <span data-ttu-id="37cf8-367">Cuando se aplican revisiones de modo ascendente a estas imágenes, es importante actualizar, probar y volver a implementar las propias imágenes para no dejar vulnerabilidades de seguridad conocidas.</span><span class="sxs-lookup"><span data-stu-id="37cf8-367">When these images are patched upstream, it's important to update, test, and redeploy your own images, so that you don't leave any known security vulnerabilities.</span></span> <span data-ttu-id="37cf8-368">ACR Tasks puede ayudar a automatizar este proceso.</span><span class="sxs-lookup"><span data-stu-id="37cf8-368">ACR Tasks can help to automate this process.</span></span>

## <a name="deployment-cicd-considerations"></a><span data-ttu-id="37cf8-369">Consideraciones de implementación (CI/CD)</span><span class="sxs-lookup"><span data-stu-id="37cf8-369">Deployment (CI/CD) considerations</span></span>

<span data-ttu-id="37cf8-370">Estos son algunos objetivos de un proceso de CI/CD sólido para una arquitectura de microservicios:</span><span class="sxs-lookup"><span data-stu-id="37cf8-370">Here are some goals of a robust CI/CD process for a microservices architecture:</span></span>

- <span data-ttu-id="37cf8-371">Cada equipo puede compilar e implementar los servicios que posee de forma independiente, sin afectar ni interrumpir a otros equipos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-371">Each team can build and deploy the services that it owns independently, without affecting or disrupting other teams.</span></span> 

- <span data-ttu-id="37cf8-372">Antes de implementar en producción una nueva versión de un servicio, se implementa en entornos de desarrollo, pruebas y control de calidad para su validación.</span><span class="sxs-lookup"><span data-stu-id="37cf8-372">Before a new version of a service is deployed to production, it gets deployed to dev/test/QA environments for validation.</span></span> <span data-ttu-id="37cf8-373">Se aplican pruebas de calidad en cada fase.</span><span class="sxs-lookup"><span data-stu-id="37cf8-373">Quality gates are enforced at each stage.</span></span>

- <span data-ttu-id="37cf8-374">Se puede implementar una nueva versión de un servicio en paralelo con la versión anterior.</span><span class="sxs-lookup"><span data-stu-id="37cf8-374">A new version of a service can be deployed side-by-side with the previous version.</span></span>

- <span data-ttu-id="37cf8-375">Hay en vigor directivas de control de acceso suficientes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-375">Sufficient access control policies are in place.</span></span>

- <span data-ttu-id="37cf8-376">Puede confiar en las imágenes de contenedor que se implementan en producción.</span><span class="sxs-lookup"><span data-stu-id="37cf8-376">You can trust the container images that are deployed to production.</span></span>

### <a name="isolation-of-environments"></a><span data-ttu-id="37cf8-377">Aislamiento de los entornos</span><span class="sxs-lookup"><span data-stu-id="37cf8-377">Isolation of environments</span></span>

<span data-ttu-id="37cf8-378">Tendrá varios entornos en los que implementa los servicios, incluidos los entornos de desarrollo, prueba de aceptación de la compilación, pruebas de integración, pruebas de carga y, por último, producción.</span><span class="sxs-lookup"><span data-stu-id="37cf8-378">You will have multiple environments where you deploy services, including environments for development, smoke testing, integration testing, load testing, and finally production.</span></span> <span data-ttu-id="37cf8-379">Estos entornos necesitan cierto nivel de aislamiento.</span><span class="sxs-lookup"><span data-stu-id="37cf8-379">These environments need some level of isolation.</span></span> <span data-ttu-id="37cf8-380">En Kubernetes, puede optar entre el aislamiento físico y el aislamiento lógico.</span><span class="sxs-lookup"><span data-stu-id="37cf8-380">In Kubernetes, you have a choice between physical isolation and logical isolation.</span></span> <span data-ttu-id="37cf8-381">El aislamiento físico significa implementar en clústeres independientes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-381">Physical isolation means deploying to separate clusters.</span></span> <span data-ttu-id="37cf8-382">El aislamiento lógico hace uso de espacios de nombres y directivas, como se describió anteriormente.</span><span class="sxs-lookup"><span data-stu-id="37cf8-382">Logical isolation makes use of namespaces and policies, as described earlier.</span></span>

<span data-ttu-id="37cf8-383">Nuestra recomendación es crear un clúster de producción dedicado junto con un clúster independiente para los entornos de desarrollo y pruebas.</span><span class="sxs-lookup"><span data-stu-id="37cf8-383">Our recommendation is to create a dedicated production cluster along with a separate cluster for your dev/test environments.</span></span> <span data-ttu-id="37cf8-384">Use el aislamiento lógico para separar los entornos dentro del clúster de desarrollo y pruebas.</span><span class="sxs-lookup"><span data-stu-id="37cf8-384">Use logical isolation to separate environments within the dev/test cluster.</span></span> <span data-ttu-id="37cf8-385">Los servicios implementados en el clúster de desarrollo y pruebas nunca deben tener acceso a almacenes de datos que contengan datos empresariales.</span><span class="sxs-lookup"><span data-stu-id="37cf8-385">Services deployed to the dev/test cluster should never have access to data stores that hold business data.</span></span> 

### <a name="helm"></a><span data-ttu-id="37cf8-386">Helm</span><span class="sxs-lookup"><span data-stu-id="37cf8-386">Helm</span></span>

<span data-ttu-id="37cf8-387">Considere el uso de Helm para administrar la creación e implementación de servicios.</span><span class="sxs-lookup"><span data-stu-id="37cf8-387">Consider using Helm to manage building and deploying services.</span></span> <span data-ttu-id="37cf8-388">Algunas de las características de Helm que ayudan en CI/CD son:</span><span class="sxs-lookup"><span data-stu-id="37cf8-388">Some of the features of Helm that help with CI/CD include:</span></span>

- <span data-ttu-id="37cf8-389">Organización de todos los objetos de Kubernetes de un microservicio determinado en un único gráfico de Helm.</span><span class="sxs-lookup"><span data-stu-id="37cf8-389">Organizing all of the Kubernetes objects for a particular microservice into a single Helm chart.</span></span>
- <span data-ttu-id="37cf8-390">Implementación del gráfico como un comando de Helm único, en lugar de una serie de comandos de kubectl.</span><span class="sxs-lookup"><span data-stu-id="37cf8-390">Deploying the chart as a single helm command, rather than a series of kubectl commands.</span></span>
- <span data-ttu-id="37cf8-391">Seguimiento de actualizaciones y revisiones, con control de versiones semántico, junto con la capacidad de revertir a una versión anterior.</span><span class="sxs-lookup"><span data-stu-id="37cf8-391">Tracking updates and revisions, using semantic versioning, along with the ability to roll back to a previous version.</span></span>
- <span data-ttu-id="37cf8-392">El uso de plantillas para evitar la duplicación de información, como etiquetas y selectores, en muchos archivos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-392">The use of templates to avoid duplicating information, such as labels and selectors, across many files.</span></span>
- <span data-ttu-id="37cf8-393">Administración de dependencias entre gráficos.</span><span class="sxs-lookup"><span data-stu-id="37cf8-393">Managing dependencies between charts.</span></span>
- <span data-ttu-id="37cf8-394">Publicación de gráficos en un repositorio de Helm, como Azure Container Registry y su integración con la canalización de compilación.</span><span class="sxs-lookup"><span data-stu-id="37cf8-394">Publishing charts to a Helm repository, such as Azure Container Registry, and integrating them with the build pipeline.</span></span> 

<span data-ttu-id="37cf8-395">Para más información sobre el uso de Container Registry como un repositorio de Helm, consulte [Uso de Azure Container Registry como un repositorio de Helm para los gráficos de aplicación](/azure/container-registry/container-registry-helm-repos).</span><span class="sxs-lookup"><span data-stu-id="37cf8-395">For more information about using Container Registry as a Helm repository, see [Use Azure Container Registry as a Helm repository for your application charts](/azure/container-registry/container-registry-helm-repos).</span></span>

### <a name="cicd-workflow"></a><span data-ttu-id="37cf8-396">Flujo de trabajo de CI/CD</span><span class="sxs-lookup"><span data-stu-id="37cf8-396">CI/CD workflow</span></span>

<span data-ttu-id="37cf8-397">El siguiente diagrama muestra un posible flujo de trabajo de CI/CD.</span><span class="sxs-lookup"><span data-stu-id="37cf8-397">The following diagram shows a possible CI/CD workflow.</span></span> <span data-ttu-id="37cf8-398">En este ejemplo se da por supuesto que hay un rol de control de calidad que es independiente del rol de desarrollador.</span><span class="sxs-lookup"><span data-stu-id="37cf8-398">This example assumes there is a QA role that is separate from the developer role.</span></span>

![Flujo de trabajo de CI/CD](./_images/aks-cicd.png)

1. <span data-ttu-id="37cf8-400">El desarrollador confirma un cambio, que</span><span class="sxs-lookup"><span data-stu-id="37cf8-400">The developer commits a change, which</span></span>
1. <span data-ttu-id="37cf8-401">Desencadena la canalización de CI.</span><span class="sxs-lookup"><span data-stu-id="37cf8-401">Triggers the CI pipeline.</span></span> <span data-ttu-id="37cf8-402">Esta canalización compila el código, ejecuta las pruebas y crea la imagen de contenedor.</span><span class="sxs-lookup"><span data-stu-id="37cf8-402">This pipeline builds the code, runs tests, and builds the container image.</span></span>
1. <span data-ttu-id="37cf8-403">Si se pasan todas las validaciones, la imagen se inserta el repositorio de imágenes.</span><span class="sxs-lookup"><span data-stu-id="37cf8-403">If all gates are passed, the image is pushed the image repository.</span></span>
1. <span data-ttu-id="37cf8-404">Cuando una nueva versión de un servicio está lista para su implementación, se agrega una etiqueta, que</span><span class="sxs-lookup"><span data-stu-id="37cf8-404">When a new version of a service is ready to deploy, a tag is added, which</span></span>
1. <span data-ttu-id="37cf8-405">Desencadena la canalización de CD de prueba, que ejecuta un comando de actualización de Helm para actualizar el clúster de prueba.</span><span class="sxs-lookup"><span data-stu-id="37cf8-405">Triggers the test CD pipeline, which runs a helm upgrade command to update the test cluster.</span></span>
1. <span data-ttu-id="37cf8-406">Si la nueva versión está lista para su implementación en producción, el rol de control de calidad desencadena manualmente la canalización de CD de producción.</span><span class="sxs-lookup"><span data-stu-id="37cf8-406">If the new version is ready to deploy to production, the QA role manually triggers the production CD pipeline.</span></span>

### <a name="recommended-cicd-practices"></a><span data-ttu-id="37cf8-407">Procedimientos recomendados de CI/CD</span><span class="sxs-lookup"><span data-stu-id="37cf8-407">Recommended CI/CD practices</span></span>

<span data-ttu-id="37cf8-408">Utilice la directiva imagePullPolicy establecida en Always (Siempre), de manera que Kubernetes siempre extraerá la imagen más reciente del repositorio y no usará una imagen almacenada en caché.</span><span class="sxs-lookup"><span data-stu-id="37cf8-408">Use imagePullPolicy of Always, so that Kubernetes will always pull the latest image from the repository, and not use a cached image.</span></span> <span data-ttu-id="37cf8-409">Puede aplicar esto en todo el clúster con el controlador de admisión AlwaysPullImages.</span><span class="sxs-lookup"><span data-stu-id="37cf8-409">You can enforce this across the cluster by using the AlwaysPullImages admission controller.</span></span>

<span data-ttu-id="37cf8-410">No use la etiqueta `latest` para las imágenes de una especificación de pod. Especifique siempre la versión de la imagen.</span><span class="sxs-lookup"><span data-stu-id="37cf8-410">Don't use the `latest` tag for images in a pod spec. Always specify the image version.</span></span>

<span data-ttu-id="37cf8-411">Use espacios de nombres en Azure Container Service para organizar las imágenes de contenedor por microservicio o equipo de desarrollo.</span><span class="sxs-lookup"><span data-stu-id="37cf8-411">Use namespaces in Azure Container Service to organize container images by microservice or development team.</span></span>
