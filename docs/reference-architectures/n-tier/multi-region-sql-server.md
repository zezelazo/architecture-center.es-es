---
title: Aplicación de n niveles para varias regiones para obtener alta disponibilidad
titleSuffix: Azure Reference Architectures
description: Implemente una aplicación en máquinas virtuales de Azure en varias regiones para alta disponibilidad y resistencia.
author: MikeWasson
ms.date: 07/19/2018
ms.custom: seodec18
ms.openlocfilehash: 84da8aaef7e552beff1f06befbaa2e50a3ac3d8b
ms.sourcegitcommit: bb7fcffbb41e2c26a26f8781df32825eb60df70c
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 12/20/2018
ms.locfileid: "53643720"
---
# <a name="run-an-n-tier-application-in-multiple-azure-regions-for-high-availability"></a><span data-ttu-id="fafc6-103">Ejecución de una aplicación de n niveles en varias regiones de Azure para lograr alta disponibilidad</span><span class="sxs-lookup"><span data-stu-id="fafc6-103">Run an N-tier application in multiple Azure regions for high availability</span></span>

<span data-ttu-id="fafc6-104">Esta arquitectura de referencia muestra un conjunto de procedimientos de demostrada eficacia para la ejecución de una aplicación de N niveles en varias regiones de Azure, con la finalidad de conseguir disponibilidad y una sólida estructura de recuperación ante desastres.</span><span class="sxs-lookup"><span data-stu-id="fafc6-104">This reference architecture shows a set of proven practices for running an N-tier application in multiple Azure regions, in order to achieve availability and a robust disaster recovery infrastructure.</span></span>

![Arquitectura de red de alta disponibilidad para aplicaciones de n niveles en Azure](./images/multi-region-sql-server.png)

<span data-ttu-id="fafc6-106">*Descargue un [archivo Visio][visio-download] de esta arquitectura.*</span><span class="sxs-lookup"><span data-stu-id="fafc6-106">*Download a [Visio file][visio-download] of this architecture.*</span></span>

## <a name="architecture"></a><span data-ttu-id="fafc6-107">Arquitectura</span><span class="sxs-lookup"><span data-stu-id="fafc6-107">Architecture</span></span>

<span data-ttu-id="fafc6-108">Esta arquitectura se basa en la que se muestra en [Aplicación de n niveles con SQL Server](n-tier-sql-server.md).</span><span class="sxs-lookup"><span data-stu-id="fafc6-108">This architecture builds on the one shown in [N-tier application with SQL Server](n-tier-sql-server.md).</span></span>

- <span data-ttu-id="fafc6-109">**Regiones primarias y secundarias**</span><span class="sxs-lookup"><span data-stu-id="fafc6-109">**Primary and secondary regions**.</span></span> <span data-ttu-id="fafc6-110">Use dos regiones para lograr una mayor disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="fafc6-110">Use two regions to achieve higher availability.</span></span> <span data-ttu-id="fafc6-111">Una es la región primaria.</span><span class="sxs-lookup"><span data-stu-id="fafc6-111">One is the primary region.</span></span> <span data-ttu-id="fafc6-112">La otra región es para la conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="fafc6-112">The other region is for failover.</span></span>

- <span data-ttu-id="fafc6-113">**Azure Traffic Manager**.</span><span class="sxs-lookup"><span data-stu-id="fafc6-113">**Azure Traffic Manager**.</span></span> <span data-ttu-id="fafc6-114">[Traffic Manager][traffic-manager] enruta las solicitudes entrantes a una de las regiones.</span><span class="sxs-lookup"><span data-stu-id="fafc6-114">[Traffic Manager][traffic-manager] routes incoming requests to one of the regions.</span></span> <span data-ttu-id="fafc6-115">Durante las operaciones normales enruta las solicitudes a la región primaria.</span><span class="sxs-lookup"><span data-stu-id="fafc6-115">During normal operations, it routes requests to the primary region.</span></span> <span data-ttu-id="fafc6-116">Si dicha región no está disponible, Traffic Manager conmuta por error a la región secundaria.</span><span class="sxs-lookup"><span data-stu-id="fafc6-116">If that region becomes unavailable, Traffic Manager fails over to the secondary region.</span></span> <span data-ttu-id="fafc6-117">Para más información, consulte la sección [Configuración de Traffic Manager](#traffic-manager-configuration).</span><span class="sxs-lookup"><span data-stu-id="fafc6-117">For more information, see the section [Traffic Manager configuration](#traffic-manager-configuration).</span></span>

- <span data-ttu-id="fafc6-118">**Grupos de recursos**.</span><span class="sxs-lookup"><span data-stu-id="fafc6-118">**Resource groups**.</span></span> <span data-ttu-id="fafc6-119">Cree [grupos de recursos][resource groups] independientes para la región primaria, la región secundaria y para Traffic Manager.</span><span class="sxs-lookup"><span data-stu-id="fafc6-119">Create separate [resource groups][resource groups] for the primary region, the secondary region, and for Traffic Manager.</span></span> <span data-ttu-id="fafc6-120">De esta manera, obtiene la flexibilidad para administrar cada región como una única colección de recursos.</span><span class="sxs-lookup"><span data-stu-id="fafc6-120">This gives you the flexibility to manage each region as a single collection of resources.</span></span> <span data-ttu-id="fafc6-121">Por ejemplo, podría volver a implementar una región, sin quitar la otra.</span><span class="sxs-lookup"><span data-stu-id="fafc6-121">For example, you could redeploy one region, without taking down the other one.</span></span> <span data-ttu-id="fafc6-122">[Vincule los grupos de recursos][resource-group-links], de modo que pueda ejecutar una consulta para obtener una lista de todos los recursos de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="fafc6-122">[Link the resource groups][resource-group-links], so that you can run a query to list all the resources for the application.</span></span>

- <span data-ttu-id="fafc6-123">**Redes virtuales**.</span><span class="sxs-lookup"><span data-stu-id="fafc6-123">**VNets**.</span></span> <span data-ttu-id="fafc6-124">Cree una red virtual independiente para cada región.</span><span class="sxs-lookup"><span data-stu-id="fafc6-124">Create a separate VNet for each region.</span></span> <span data-ttu-id="fafc6-125">Asegúrese de que los espacios de direcciones no se superpongan.</span><span class="sxs-lookup"><span data-stu-id="fafc6-125">Make sure the address spaces do not overlap.</span></span>

- <span data-ttu-id="fafc6-126">**Grupo de disponibilidad AlwaysOn de SQL Server**</span><span class="sxs-lookup"><span data-stu-id="fafc6-126">**SQL Server Always On Availability Group**.</span></span> <span data-ttu-id="fafc6-127">Si usa SQL Server, se recomiendan los [grupos de disponibilidad AlwaysOn de SQL][sql-always-on] para conseguir alta disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="fafc6-127">If you are using SQL Server, we recommend [SQL Always On Availability Groups][sql-always-on] for high availability.</span></span> <span data-ttu-id="fafc6-128">Cree un único grupo de disponibilidad que incluya las instancias de SQL Server en ambas regiones.</span><span class="sxs-lookup"><span data-stu-id="fafc6-128">Create a single availability group that includes the SQL Server instances in both regions.</span></span>

    > [!NOTE]
    > <span data-ttu-id="fafc6-129">Tenga en cuenta también [Azure SQL Database][azure-sql-db], que proporciona una base de datos relacional como un servicio en la nube.</span><span class="sxs-lookup"><span data-stu-id="fafc6-129">Also consider [Azure SQL Database][azure-sql-db], which provides a relational database as a cloud service.</span></span> <span data-ttu-id="fafc6-130">Con SQL Database, no es necesario configurar un grupo de disponibilidad ni administrar la conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="fafc6-130">With SQL Database, you don't need to configure an availability group or manage failover.</span></span>
    >

- <span data-ttu-id="fafc6-131">**Puertas de enlace de VPN**.</span><span class="sxs-lookup"><span data-stu-id="fafc6-131">**VPN Gateways**.</span></span> <span data-ttu-id="fafc6-132">Cree una [puerta de enlace de VPN][vpn-gateway] en cada red virtual y configure una [conexión entre redes virtuales][vnet-to-vnet], para permitir el tráfico entre ellas.</span><span class="sxs-lookup"><span data-stu-id="fafc6-132">Create a [VPN gateway][vpn-gateway] in each VNet, and configure a [VNet-to-VNet connection][vnet-to-vnet], to enable network traffic between the two VNets.</span></span> <span data-ttu-id="fafc6-133">Este es un requisito de los grupos de disponibilidad AlwaysOn de SQL.</span><span class="sxs-lookup"><span data-stu-id="fafc6-133">This is required for the SQL Always On Availability Group.</span></span>

## <a name="recommendations"></a><span data-ttu-id="fafc6-134">Recomendaciones</span><span class="sxs-lookup"><span data-stu-id="fafc6-134">Recommendations</span></span>

<span data-ttu-id="fafc6-135">Una arquitectura de varias regiones puede proporcionar una mayor disponibilidad que la implementación en una sola región.</span><span class="sxs-lookup"><span data-stu-id="fafc6-135">A multi-region architecture can provide higher availability than deploying to a single region.</span></span> <span data-ttu-id="fafc6-136">Si una interrupción regional afecta a la región primaria, puede usar [Traffic Manager][traffic-manager] para conmutar por error en la región secundaria.</span><span class="sxs-lookup"><span data-stu-id="fafc6-136">If a regional outage affects the primary region, you can use [Traffic Manager][traffic-manager] to fail over to the secondary region.</span></span> <span data-ttu-id="fafc6-137">Esta arquitectura también puede ayudar si un determinado subsistema de la aplicación produce un error.</span><span class="sxs-lookup"><span data-stu-id="fafc6-137">This architecture can also help if an individual subsystem of the application fails.</span></span>

<span data-ttu-id="fafc6-138">Existen varios enfoques generales para lograr una alta disponibilidad en regiones:</span><span class="sxs-lookup"><span data-stu-id="fafc6-138">There are several general approaches to achieving high availability across regions:</span></span>

- <span data-ttu-id="fafc6-139">Activo/pasivo con espera activa.</span><span class="sxs-lookup"><span data-stu-id="fafc6-139">Active/passive with hot standby.</span></span> <span data-ttu-id="fafc6-140">Un tráfico se dirige a una región, mientras el otro se encuentra en espera activa.</span><span class="sxs-lookup"><span data-stu-id="fafc6-140">Traffic goes to one region, while the other waits on hot standby.</span></span> <span data-ttu-id="fafc6-141">Espera activa significa que las máquinas virtuales de la región secundaria están siempre asignadas y en funcionamiento.</span><span class="sxs-lookup"><span data-stu-id="fafc6-141">Hot standby means the VMs in the secondary region are allocated and running at all times.</span></span>
- <span data-ttu-id="fafc6-142">Activo/pasivo con espera pasiva.</span><span class="sxs-lookup"><span data-stu-id="fafc6-142">Active/passive with cold standby.</span></span> <span data-ttu-id="fafc6-143">El tráfico se dirige a una región, mientras el otro se encuentra en espera pasiva.</span><span class="sxs-lookup"><span data-stu-id="fafc6-143">Traffic goes to one region, while the other waits on cold standby.</span></span> <span data-ttu-id="fafc6-144">Espera pasiva significa que las máquinas virtuales de la región secundaria no se asignan hasta que son necesarias para una conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="fafc6-144">Cold standby means the VMs in the secondary region are not allocated until needed for failover.</span></span> <span data-ttu-id="fafc6-145">Este enfoque tiene un coste menor de ejecución, pero generalmente tarda más en ponerse en línea durante un error.</span><span class="sxs-lookup"><span data-stu-id="fafc6-145">This approach costs less to run, but will generally take longer to come online during a failure.</span></span>
- <span data-ttu-id="fafc6-146">Activo/activo.</span><span class="sxs-lookup"><span data-stu-id="fafc6-146">Active/active.</span></span> <span data-ttu-id="fafc6-147">Ambas regiones están activas y se equilibra la carga de las solicitudes entre ellas.</span><span class="sxs-lookup"><span data-stu-id="fafc6-147">Both regions are active, and requests are load balanced between them.</span></span> <span data-ttu-id="fafc6-148">Si una región no está disponible, se saca de la rotación.</span><span class="sxs-lookup"><span data-stu-id="fafc6-148">If one region becomes unavailable, it is taken out of rotation.</span></span>

<span data-ttu-id="fafc6-149">Esta arquitectura de referencia se centra en el enfoque activo/pasivo con espera activa y usa Traffic Manager para la conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="fafc6-149">This reference architecture focuses on active/passive with hot standby, using Traffic Manager for failover.</span></span> <span data-ttu-id="fafc6-150">Tenga en cuenta que podría implementar un número pequeño de máquinas virtuales para la espera activa y luego escalarlas horizontalmente si es necesario.</span><span class="sxs-lookup"><span data-stu-id="fafc6-150">Note that you could deploy a small number of VMs for hot standby and then scale out as needed.</span></span>

### <a name="regional-pairing"></a><span data-ttu-id="fafc6-151">Emparejamiento regional</span><span class="sxs-lookup"><span data-stu-id="fafc6-151">Regional pairing</span></span>

<span data-ttu-id="fafc6-152">Cada región de Azure se empareja con otra región de la misma zona geográfica.</span><span class="sxs-lookup"><span data-stu-id="fafc6-152">Each Azure region is paired with another region within the same geography.</span></span> <span data-ttu-id="fafc6-153">En general, elija regiones del mismo par de regional (por ejemplo, Este de EE. UU. 2 y Centro de EE. UU.).</span><span class="sxs-lookup"><span data-stu-id="fafc6-153">In general, choose regions from the same regional pair (for example, East US 2 and US Central).</span></span> <span data-ttu-id="fafc6-154">Las ventajas de hacerlo son:</span><span class="sxs-lookup"><span data-stu-id="fafc6-154">Benefits of doing so include:</span></span>

- <span data-ttu-id="fafc6-155">Si se produce una interrupción prolongada, se establece como prioridad la recuperación de al menos una región de cada par.</span><span class="sxs-lookup"><span data-stu-id="fafc6-155">If there is a broad outage, recovery of at least one region out of every pair is prioritized.</span></span>
- <span data-ttu-id="fafc6-156">Las actualizaciones planeadas del sistema de Azure se implementan en las regiones emparejadas de manera secuencial para reducir el posible tiempo de inactividad.</span><span class="sxs-lookup"><span data-stu-id="fafc6-156">Planned Azure system updates are rolled out to paired regions sequentially, to minimize possible downtime.</span></span>
- <span data-ttu-id="fafc6-157">Los pares residen dentro de la misma zona geográfica, de forma que se cumplen los requisitos de residencia de los datos.</span><span class="sxs-lookup"><span data-stu-id="fafc6-157">Pairs reside within the same geography, to meet data residency requirements.</span></span>

<span data-ttu-id="fafc6-158">Sin embargo, asegúrese de que ambas regiones admitan todos los servicios de Azure que necesita su aplicación (consulte [Servicios por región][services-by-region]).</span><span class="sxs-lookup"><span data-stu-id="fafc6-158">However, make sure that both regions support all of the Azure services needed for your application (see [Services by region][services-by-region]).</span></span> <span data-ttu-id="fafc6-159">Para más información sobre los pares regionales, consulte [Continuidad empresarial y recuperación ante desastres (BCDR): regiones emparejadas de Azure][regional-pairs].</span><span class="sxs-lookup"><span data-stu-id="fafc6-159">For more information about regional pairs, see [Business continuity and disaster recovery (BCDR): Azure Paired Regions][regional-pairs].</span></span>

### <a name="traffic-manager-configuration"></a><span data-ttu-id="fafc6-160">Configuración de Traffic Manager</span><span class="sxs-lookup"><span data-stu-id="fafc6-160">Traffic Manager configuration</span></span>

<span data-ttu-id="fafc6-161">Al configurar Traffic Manager, tenga en cuenta lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="fafc6-161">Consider the following points when configuring Traffic Manager:</span></span>

- <span data-ttu-id="fafc6-162">**Enrutamiento**.</span><span class="sxs-lookup"><span data-stu-id="fafc6-162">**Routing**.</span></span> <span data-ttu-id="fafc6-163">Traffic Manager admite varios [algoritmos de enrutamiento][tm-routing].</span><span class="sxs-lookup"><span data-stu-id="fafc6-163">Traffic Manager supports several [routing algorithms][tm-routing].</span></span> <span data-ttu-id="fafc6-164">Para el escenario descrito en este artículo, use el enrutamiento de *prioridad* (anteriormente conocido como enrutamiento de *conmutación por error*).</span><span class="sxs-lookup"><span data-stu-id="fafc6-164">For the scenario described in this article, use *priority* routing (formerly called *failover* routing).</span></span> <span data-ttu-id="fafc6-165">Con esta configuración, Traffic Manager envía todas las solicitudes a la región primaria, a no ser que no sea posible comunicarse con ella.</span><span class="sxs-lookup"><span data-stu-id="fafc6-165">With this setting, Traffic Manager sends all requests to the primary region, unless the primary region becomes unreachable.</span></span> <span data-ttu-id="fafc6-166">En ese momento, conmuta por error automáticamente a la región secundaria.</span><span class="sxs-lookup"><span data-stu-id="fafc6-166">At that point, it automatically fails over to the secondary region.</span></span> <span data-ttu-id="fafc6-167">Consulte [Configuración del método de conmutación por error][tm-configure-failover].</span><span class="sxs-lookup"><span data-stu-id="fafc6-167">See [Configure Failover routing method][tm-configure-failover].</span></span>
- <span data-ttu-id="fafc6-168">**Sondeo de mantenimiento**.</span><span class="sxs-lookup"><span data-stu-id="fafc6-168">**Health probe**.</span></span> <span data-ttu-id="fafc6-169">Traffic Manager usa un [sondeo][tm-monitoring] HTTP (o HTTPS) para supervisar la disponibilidad de cada región.</span><span class="sxs-lookup"><span data-stu-id="fafc6-169">Traffic Manager uses an HTTP (or HTTPS) [probe][tm-monitoring] to monitor the availability of each region.</span></span> <span data-ttu-id="fafc6-170">El sondeo comprueba si hay una respuesta HTTP 200 para una ruta de acceso de dirección URL especificada.</span><span class="sxs-lookup"><span data-stu-id="fafc6-170">The probe checks for an HTTP 200 response for a specified URL path.</span></span> <span data-ttu-id="fafc6-171">Como procedimiento recomendado, cree un punto de conexión que indique el estado general de la aplicación y úselo para el sondeo de estado.</span><span class="sxs-lookup"><span data-stu-id="fafc6-171">As a best practice, create an endpoint that reports the overall health of the application, and use this endpoint for the health probe.</span></span> <span data-ttu-id="fafc6-172">En caso contrario, el sondeo podría informar de un punto de conexión correcto cuando realmente se producen errores en partes críticas de la aplicación.</span><span class="sxs-lookup"><span data-stu-id="fafc6-172">Otherwise, the probe might report a healthy endpoint when critical parts of the application are actually failing.</span></span> <span data-ttu-id="fafc6-173">Para más información, consulte [Health Endpoint Monitoring Pattern][health-endpoint-monitoring-pattern] (Patrón Health Endpoint Monitoring).</span><span class="sxs-lookup"><span data-stu-id="fafc6-173">For more information, see [Health Endpoint Monitoring Pattern][health-endpoint-monitoring-pattern].</span></span>

<span data-ttu-id="fafc6-174">Cuando Traffic Manager conmuta por error, hay un período de tiempo en que los clientes no pueden comunicarse con la aplicación.</span><span class="sxs-lookup"><span data-stu-id="fafc6-174">When Traffic Manager fails over there is a period of time when clients cannot reach the application.</span></span> <span data-ttu-id="fafc6-175">La duración viene determinada por los siguientes factores:</span><span class="sxs-lookup"><span data-stu-id="fafc6-175">The duration is affected by the following factors:</span></span>

- <span data-ttu-id="fafc6-176">El sondeo de estado debe detectar que la región primaria se ha vuelto inaccesible.</span><span class="sxs-lookup"><span data-stu-id="fafc6-176">The health probe must detect that the primary region has become unreachable.</span></span>
- <span data-ttu-id="fafc6-177">Los servidores DNS deben actualizar los registros DNS almacenados en caché con la dirección IP, lo cual depende del período de vida (TTL) de DNS.</span><span class="sxs-lookup"><span data-stu-id="fafc6-177">DNS servers must update the cached DNS records for the IP address, which depends on the DNS time-to-live (TTL).</span></span> <span data-ttu-id="fafc6-178">El TTL predeterminado es de 300 segundos (5 minutos), pero puede configurar este valor al crear el perfil de Traffic Manager.</span><span class="sxs-lookup"><span data-stu-id="fafc6-178">The default TTL is 300 seconds (5 minutes), but you can configure this value when you create the Traffic Manager profile.</span></span>

<span data-ttu-id="fafc6-179">Para más información, consulte [Acerca de la supervisión de Traffic Manager][tm-monitoring].</span><span class="sxs-lookup"><span data-stu-id="fafc6-179">For details, see [About Traffic Manager Monitoring][tm-monitoring].</span></span>

<span data-ttu-id="fafc6-180">Si Traffic Manager conmuta por error, se recomienda realizar una conmutación por recuperación manual en lugar de implementar una automática.</span><span class="sxs-lookup"><span data-stu-id="fafc6-180">If Traffic Manager fails over, we recommend performing a manual failback rather than implementing an automatic failback.</span></span> <span data-ttu-id="fafc6-181">En caso contrario, puede crear una situación donde la aplicación va y viene incesantemente entre regiones.</span><span class="sxs-lookup"><span data-stu-id="fafc6-181">Otherwise, you can create a situation where the application flips back and forth between regions.</span></span> <span data-ttu-id="fafc6-182">Compruebe que todos los subsistemas de aplicación tengan un estado correcto antes de la conmutación por recuperación.</span><span class="sxs-lookup"><span data-stu-id="fafc6-182">Verify that all application subsystems are healthy before failing back.</span></span>

<span data-ttu-id="fafc6-183">Tenga en cuenta que Traffic Manager conmuta por recuperación automáticamente de forma predeterminada.</span><span class="sxs-lookup"><span data-stu-id="fafc6-183">Note that Traffic Manager automatically fails back by default.</span></span> <span data-ttu-id="fafc6-184">Para evitar esto, reduzca manualmente la prioridad de la región primaria después de un evento de conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="fafc6-184">To prevent this, manually lower the priority of the primary region after a failover event.</span></span> <span data-ttu-id="fafc6-185">Por ejemplo, suponga que la región primaria tiene la prioridad 1 y la secundaria la prioridad 2.</span><span class="sxs-lookup"><span data-stu-id="fafc6-185">For example, suppose the primary region is priority 1 and the secondary is priority 2.</span></span> <span data-ttu-id="fafc6-186">Después de una conmutación por error, establezca la región primaria en la prioridad 3 para evitar la conmutación por recuperación automática.</span><span class="sxs-lookup"><span data-stu-id="fafc6-186">After a failover, set the primary region to priority 3, to prevent automatic failback.</span></span> <span data-ttu-id="fafc6-187">Cuando esté listo para cambiar de nuevo, actualice la prioridad a 1.</span><span class="sxs-lookup"><span data-stu-id="fafc6-187">When you are ready to switch back, update the priority to 1.</span></span>

<span data-ttu-id="fafc6-188">El siguiente comando de la [CLI de Azure][azure-cli] actualiza la prioridad:</span><span class="sxs-lookup"><span data-stu-id="fafc6-188">The following [Azure CLI][azure-cli] command updates the priority:</span></span>

```azurecli
az network traffic-manager endpoint update --resource-group <resource-group> --profile-name <profile>
    --name <endpoint-name> --type azureEndpoints --priority 3
```

<span data-ttu-id="fafc6-189">Otro enfoque consiste en deshabilitar temporalmente el punto de conexión hasta que esté listo para conmutar por recuperación:</span><span class="sxs-lookup"><span data-stu-id="fafc6-189">Another approach is to temporarily disable the endpoint until you are ready to fail back:</span></span>

```azurecli
az network traffic-manager endpoint update --resource-group <resource-group> --profile-name <profile>
    --name <endpoint-name> --type azureEndpoints --endpoint-status Disabled
```

<span data-ttu-id="fafc6-190">Dependiendo de la causa de una conmutación por error, tendrá que volver a implementar los recursos dentro de una región.</span><span class="sxs-lookup"><span data-stu-id="fafc6-190">Depending on the cause of a failover, you might need to redeploy the resources within a region.</span></span> <span data-ttu-id="fafc6-191">Antes de proceder a la conmutación por recuperación, realice una prueba de preparación operativa.</span><span class="sxs-lookup"><span data-stu-id="fafc6-191">Before failing back, perform an operational readiness test.</span></span> <span data-ttu-id="fafc6-192">La prueba debe comprobar aspectos como:</span><span class="sxs-lookup"><span data-stu-id="fafc6-192">The test should verify things like:</span></span>

- <span data-ttu-id="fafc6-193">Máquinas virtuales configuradas correctamente.</span><span class="sxs-lookup"><span data-stu-id="fafc6-193">VMs are configured correctly.</span></span> <span data-ttu-id="fafc6-194">(Todo el software necesario está instalado, IIS está en funcionamiento, etc.).</span><span class="sxs-lookup"><span data-stu-id="fafc6-194">(All required software is installed, IIS is running, and so on.)</span></span>
- <span data-ttu-id="fafc6-195">El estado de los subsistemas de aplicación es correcto.</span><span class="sxs-lookup"><span data-stu-id="fafc6-195">Application subsystems are healthy.</span></span>
- <span data-ttu-id="fafc6-196">Pruebas funcionales.</span><span class="sxs-lookup"><span data-stu-id="fafc6-196">Functional testing.</span></span> <span data-ttu-id="fafc6-197">(Por ejemplo, la capa de base de datos es accesible desde la capa web).</span><span class="sxs-lookup"><span data-stu-id="fafc6-197">(For example, the database tier is reachable from the web tier.)</span></span>

### <a name="configure-sql-server-always-on-availability-groups"></a><span data-ttu-id="fafc6-198">Configuración de los grupos de disponibilidad AlwaysOn de SQL Server</span><span class="sxs-lookup"><span data-stu-id="fafc6-198">Configure SQL Server Always On Availability Groups</span></span>

<span data-ttu-id="fafc6-199">Antes de Windows Server 2016, los grupos de disponibilidad AlwaysOn de SQL Server requerían un controlador de dominio y todos los nodos del grupo de disponibilidad debían estar en el mismo dominio de Active Directory (AD).</span><span class="sxs-lookup"><span data-stu-id="fafc6-199">Prior to Windows Server 2016, SQL Server Always On Availability Groups require a domain controller, and all nodes in the availability group must be in the same Active Directory (AD) domain.</span></span>

<span data-ttu-id="fafc6-200">Para configurar el grupo de disponibilidad:</span><span class="sxs-lookup"><span data-stu-id="fafc6-200">To configure the availability group:</span></span>

- <span data-ttu-id="fafc6-201">Coloque dos controladores de dominio, como mínimo, en cada región.</span><span class="sxs-lookup"><span data-stu-id="fafc6-201">At a minimum, place two domain controllers in each region.</span></span>
- <span data-ttu-id="fafc6-202">Asigne una dirección IP estática a cada controlador de dominio.</span><span class="sxs-lookup"><span data-stu-id="fafc6-202">Give each domain controller a static IP address.</span></span>
- <span data-ttu-id="fafc6-203">Cree una conexión de red virtual a red virtual para permitir la comunicación entre las redes virtuales.</span><span class="sxs-lookup"><span data-stu-id="fafc6-203">Create a VNet-to-VNet connection to enable communication between the VNets.</span></span>
- <span data-ttu-id="fafc6-204">Para cada red virtual, agregue las direcciones IP de los controladores de dominio (de ambas regiones) a la lista de servidores DNS.</span><span class="sxs-lookup"><span data-stu-id="fafc6-204">For each VNet, add the IP addresses of the domain controllers (from both regions) to the DNS server list.</span></span> <span data-ttu-id="fafc6-205">Puede usar el siguiente comando de la CLI.</span><span class="sxs-lookup"><span data-stu-id="fafc6-205">You can use the following CLI command.</span></span> <span data-ttu-id="fafc6-206">Para más información, consulte [Cambio de servidores DNS][vnet-dns].</span><span class="sxs-lookup"><span data-stu-id="fafc6-206">For more information, see [Change DNS servers][vnet-dns].</span></span>

    ```azurecli
    az network vnet update --resource-group <resource-group> --name <vnet-name> --dns-servers "10.0.0.4,10.0.0.6,172.16.0.4,172.16.0.6"
    ```

- <span data-ttu-id="fafc6-207">Cree un clúster de [Clústeres de conmutación por error de Windows Server][wsfc] (WSFC) que incluya las instancias de SQL Server en ambas regiones.</span><span class="sxs-lookup"><span data-stu-id="fafc6-207">Create a [Windows Server Failover Clustering][wsfc] (WSFC) cluster that includes the SQL Server instances in both regions.</span></span>
- <span data-ttu-id="fafc6-208">Cree un grupo de disponibilidad AlwaysOn de SQL Server que incluya las instancias de SQL Server en las regiones primaria y secundaria.</span><span class="sxs-lookup"><span data-stu-id="fafc6-208">Create a SQL Server Always On Availability Group that includes the SQL Server instances in both the primary and secondary regions.</span></span> <span data-ttu-id="fafc6-209">Consulte [Extending Always On Availability Group to Remote Azure Datacenter (PowerShell)](https://blogs.msdn.microsoft.com/sqlcat/2014/09/22/extending-alwayson-availability-group-to-remote-azure-datacenter-powershell/) (Extensión de un grupo de disponibilidad AlwaysOn para el acceso remoto a un centro de datos de Azure [PowerShell)] para conocer los pasos.</span><span class="sxs-lookup"><span data-stu-id="fafc6-209">See [Extending Always On Availability Group to Remote Azure Datacenter (PowerShell)](https://blogs.msdn.microsoft.com/sqlcat/2014/09/22/extending-alwayson-availability-group-to-remote-azure-datacenter-powershell/) for the steps.</span></span>

  - <span data-ttu-id="fafc6-210">Coloque la réplica principal en la región primaria.</span><span class="sxs-lookup"><span data-stu-id="fafc6-210">Put the primary replica in the primary region.</span></span>
  - <span data-ttu-id="fafc6-211">Coloque una o varias réplicas secundarias en la región primaria.</span><span class="sxs-lookup"><span data-stu-id="fafc6-211">Put one or more secondary replicas in the primary region.</span></span> <span data-ttu-id="fafc6-212">Configure estos elementos para usar la confirmación sincrónica con conmutación automática por error.</span><span class="sxs-lookup"><span data-stu-id="fafc6-212">Configure these to use synchronous commit with automatic failover.</span></span>
  - <span data-ttu-id="fafc6-213">Coloque una o varias réplicas secundarias en la región secundaria.</span><span class="sxs-lookup"><span data-stu-id="fafc6-213">Put one or more secondary replicas in the secondary region.</span></span> <span data-ttu-id="fafc6-214">Por motivos de rendimiento, configure estas opciones para usar confirmación *asincrónica*.</span><span class="sxs-lookup"><span data-stu-id="fafc6-214">Configure these to use *asynchronous* commit, for performance reasons.</span></span> <span data-ttu-id="fafc6-215">(De lo contrario, todas las transacciones de T-SQL deberán esperar el recorrido de ida y vuelta a través de la red hasta la región secundaria).</span><span class="sxs-lookup"><span data-stu-id="fafc6-215">(Otherwise, all T-SQL transactions have to wait on a round trip over the network to the secondary region.)</span></span>

    > [!NOTE]
    > <span data-ttu-id="fafc6-216">Las réplicas de confirmación asincrónica no admiten la conmutación automática por error.</span><span class="sxs-lookup"><span data-stu-id="fafc6-216">Asynchronous commit replicas do not support automatic failover.</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="fafc6-217">Consideraciones sobre disponibilidad</span><span class="sxs-lookup"><span data-stu-id="fafc6-217">Availability considerations</span></span>

<span data-ttu-id="fafc6-218">Con una aplicación de N niveles compleja, no es necesario replicar toda la aplicación en la región secundaria.</span><span class="sxs-lookup"><span data-stu-id="fafc6-218">With a complex N-tier app, you may not need to replicate the entire application in the secondary region.</span></span> <span data-ttu-id="fafc6-219">En su lugar, puede replicar simplemente un subsistema crítico que sea necesario para permitir la continuidad empresarial.</span><span class="sxs-lookup"><span data-stu-id="fafc6-219">Instead, you might just replicate a critical subsystem that is needed to support business continuity.</span></span>

<span data-ttu-id="fafc6-220">Traffic Manager es un posible punto de error en el sistema.</span><span class="sxs-lookup"><span data-stu-id="fafc6-220">Traffic Manager is a possible failure point in the system.</span></span> <span data-ttu-id="fafc6-221">Si se produce un error en Traffic Manager, los clientes no podrán acceder a la aplicación durante el tiempo de inactividad.</span><span class="sxs-lookup"><span data-stu-id="fafc6-221">If the Traffic Manager service fails, clients cannot access your application during the downtime.</span></span> <span data-ttu-id="fafc6-222">Revise el [SLA de Traffic Manager][tm-sla] y determine si el uso de Traffic Manager por sí solo cumple sus requisitos empresariales de alta disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="fafc6-222">Review the [Traffic Manager SLA][tm-sla], and determine whether using Traffic Manager alone meets your business requirements for high availability.</span></span> <span data-ttu-id="fafc6-223">Si no es así, considere la posibilidad de agregar otra solución de administración de tráfico como una conmutación por recuperación.</span><span class="sxs-lookup"><span data-stu-id="fafc6-223">If not, consider adding another traffic management solution as a failback.</span></span> <span data-ttu-id="fafc6-224">Si el servicio Azure Traffic Manager no funciona, cambie los registros CNAME en DNS para que apunten a otro servicio de administración del tráfico.</span><span class="sxs-lookup"><span data-stu-id="fafc6-224">If the Azure Traffic Manager service fails, change your CNAME records in DNS to point to the other traffic management service.</span></span> <span data-ttu-id="fafc6-225">(Este paso debe realizarse manualmente, y la aplicación dejará de estar disponible hasta que se propaguen los cambios de DNS).</span><span class="sxs-lookup"><span data-stu-id="fafc6-225">(This step must be performed manually, and your application will be unavailable until the DNS changes are propagated.)</span></span>

<span data-ttu-id="fafc6-226">Para el clúster de SQL Server, hay dos escenarios de conmutación por error que se deben tener en cuenta:</span><span class="sxs-lookup"><span data-stu-id="fafc6-226">For the SQL Server cluster, there are two failover scenarios to consider:</span></span>

- <span data-ttu-id="fafc6-227">Todas las réplicas de base de datos de SQL Server de la región primaria generarán un error.</span><span class="sxs-lookup"><span data-stu-id="fafc6-227">All of the SQL Server database replicas in the primary region fail.</span></span> <span data-ttu-id="fafc6-228">Esto podría ocurrir, por ejemplo, durante una interrupción regional.</span><span class="sxs-lookup"><span data-stu-id="fafc6-228">For example, this could happen during a regional outage.</span></span> <span data-ttu-id="fafc6-229">En ese caso, debe conmutar por error manualmente el grupo de disponibilidad, aunque Traffic Manager conmute por error automáticamente en el servidor front-end.</span><span class="sxs-lookup"><span data-stu-id="fafc6-229">In that case, you must manually fail over the availability group, even though Traffic Manager automatically fails over on the front end.</span></span> <span data-ttu-id="fafc6-230">Siga los pasos que se indican en [Perform a Forced Manual Failover of a SQL Server Availability Group](https://msdn.microsoft.com/library/ff877957.aspx) (Realización de una conmutación por error manual forzada de un grupo de disponibilidad de SQL Server), donde se describe cómo realizar una conmutación por error forzada mediante SQL Server Management Studio, Transact-SQL o PowerShell en SQL Server 2016.</span><span class="sxs-lookup"><span data-stu-id="fafc6-230">Follow the steps in [Perform a Forced Manual Failover of a SQL Server Availability Group](https://msdn.microsoft.com/library/ff877957.aspx), which describes how to perform a forced failover by using SQL Server Management Studio, Transact-SQL, or PowerShell in SQL Server 2016.</span></span>

   > [!WARNING]
   > <span data-ttu-id="fafc6-231">Con la conmutación por error forzada, se corre el riesgo de pérdida de datos.</span><span class="sxs-lookup"><span data-stu-id="fafc6-231">With forced failover, there is a risk of data loss.</span></span> <span data-ttu-id="fafc6-232">Una vez que la región primaria vuelve a estar en línea, tome una instantánea de la base de datos y use [tablediff] para encontrar las diferencias.</span><span class="sxs-lookup"><span data-stu-id="fafc6-232">Once the primary region is back online, take a snapshot of the database and use [tablediff] to find the differences.</span></span>

- <span data-ttu-id="fafc6-233">Traffic Manager conmuta por error a la región secundaria, pero la réplica principal de base de datos SQL Server sigue estando disponible.</span><span class="sxs-lookup"><span data-stu-id="fafc6-233">Traffic Manager fails over to the secondary region, but the primary SQL Server database replica is still available.</span></span> <span data-ttu-id="fafc6-234">Por ejemplo, si el nivel de front-end produjera un error, las máquinas virtuales de SQL Server no se verían afectadas.</span><span class="sxs-lookup"><span data-stu-id="fafc6-234">For example, the front-end tier might fail, without affecting the SQL Server VMs.</span></span> <span data-ttu-id="fafc6-235">En ese caso, el tráfico de Internet se enrutaría a la región secundaria y esa región podría seguir conectándose a la réplica principal.</span><span class="sxs-lookup"><span data-stu-id="fafc6-235">In that case, Internet traffic is routed to the secondary region, and that region can still connect to the primary replica.</span></span> <span data-ttu-id="fafc6-236">Sin embargo, habrá una mayor latencia, ya que las conexiones de SQL Server atraviesan las regiones.</span><span class="sxs-lookup"><span data-stu-id="fafc6-236">However, there will be increased latency, because the SQL Server connections are going across regions.</span></span> <span data-ttu-id="fafc6-237">En esta situación, debe realizar una conmutación por error manual como se indica a continuación:</span><span class="sxs-lookup"><span data-stu-id="fafc6-237">In this situation, you should perform a manual failover as follows:</span></span>

   1. <span data-ttu-id="fafc6-238">Cambie temporalmente una réplica de base de datos de SQL Server de la región secundaria a confirmación *sincrónica*.</span><span class="sxs-lookup"><span data-stu-id="fafc6-238">Temporarily switch a SQL Server database replica in the secondary region to *synchronous* commit.</span></span> <span data-ttu-id="fafc6-239">De esta forma, se garantiza que no haya pérdida de datos durante la conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="fafc6-239">This ensures there won't be data loss during the failover.</span></span>
   2. <span data-ttu-id="fafc6-240">Conmute por error a esa réplica.</span><span class="sxs-lookup"><span data-stu-id="fafc6-240">Fail over to that replica.</span></span>
   3. <span data-ttu-id="fafc6-241">Cuando conmute por recuperación a la región primaria, restaure el valor de configuración de confirmación asincrónica.</span><span class="sxs-lookup"><span data-stu-id="fafc6-241">When you fail back to the primary region, restore the asynchronous commit setting.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="fafc6-242">Consideraciones sobre la manejabilidad</span><span class="sxs-lookup"><span data-stu-id="fafc6-242">Manageability considerations</span></span>

<span data-ttu-id="fafc6-243">Al actualizar la implementación, actualice una región cada vez para reducir la probabilidad de un error global derivado de una configuración incorrecta o un error en la aplicación.</span><span class="sxs-lookup"><span data-stu-id="fafc6-243">When you update your deployment, update one region at a time to reduce the chance of a global failure from an incorrect configuration or an error in the application.</span></span>

<span data-ttu-id="fafc6-244">Pruebe la resistencia del sistema a los errores.</span><span class="sxs-lookup"><span data-stu-id="fafc6-244">Test the resiliency of the system to failures.</span></span> <span data-ttu-id="fafc6-245">Estos son algunos escenarios comunes de error que se pueden probar:</span><span class="sxs-lookup"><span data-stu-id="fafc6-245">Here are some common failure scenarios to test:</span></span>

- <span data-ttu-id="fafc6-246">Apagado de las instancias de máquina virtual.</span><span class="sxs-lookup"><span data-stu-id="fafc6-246">Shut down VM instances.</span></span>
- <span data-ttu-id="fafc6-247">Recursos de presión, como CPU y memoria.</span><span class="sxs-lookup"><span data-stu-id="fafc6-247">Pressure resources such as CPU and memory.</span></span>
- <span data-ttu-id="fafc6-248">Desconexión o retraso de la red.</span><span class="sxs-lookup"><span data-stu-id="fafc6-248">Disconnect/delay network.</span></span>
- <span data-ttu-id="fafc6-249">Bloqueo de procesos.</span><span class="sxs-lookup"><span data-stu-id="fafc6-249">Crash processes.</span></span>
- <span data-ttu-id="fafc6-250">Caducidad de certificados.</span><span class="sxs-lookup"><span data-stu-id="fafc6-250">Expire certificates.</span></span>
- <span data-ttu-id="fafc6-251">Simulación de errores de hardware.</span><span class="sxs-lookup"><span data-stu-id="fafc6-251">Simulate hardware faults.</span></span>
- <span data-ttu-id="fafc6-252">Apagado del servicio DNS en los controladores de dominio.</span><span class="sxs-lookup"><span data-stu-id="fafc6-252">Shut down the DNS service on the domain controllers.</span></span>

<span data-ttu-id="fafc6-253">Medición de los tiempos de recuperación y comprobación de que cumplen los requisitos empresariales.</span><span class="sxs-lookup"><span data-stu-id="fafc6-253">Measure the recovery times and verify they meet your business requirements.</span></span> <span data-ttu-id="fafc6-254">Pruebe también combinaciones de modos de error.</span><span class="sxs-lookup"><span data-stu-id="fafc6-254">Test combinations of failure modes, as well.</span></span>

## <a name="related-resources"></a><span data-ttu-id="fafc6-255">Recursos relacionados</span><span class="sxs-lookup"><span data-stu-id="fafc6-255">Related resources</span></span>

<span data-ttu-id="fafc6-256">Puede examinar los siguientes [escenarios de ejemplo de Azure](/azure/architecture/example-scenario) que muestran soluciones específicas que usan algunas tecnologías similares:</span><span class="sxs-lookup"><span data-stu-id="fafc6-256">You may wish to review the following [Azure example scenarios](/azure/architecture/example-scenario) that demonstrate specific solutions using some of the same technologies:</span></span>

- [<span data-ttu-id="fafc6-257">Aplicación web de varios niveles creada para lograr alta disponibilidad y recuperación ante desastres en Azure</span><span class="sxs-lookup"><span data-stu-id="fafc6-257">Multitier web application built for high availability and disaster recovery on Azure</span></span>](/azure/architecture/example-scenario/infrastructure/multi-tier-app-disaster-recovery)
- [<span data-ttu-id="fafc6-258">Compilación de aplicaciones web seguras con máquinas virtuales Windows en Azure</span><span class="sxs-lookup"><span data-stu-id="fafc6-258">Building secure web applications with Windows virtual machines on Azure</span></span>](/azure/architecture/example-scenario/infrastructure/regulated-multitier-app)

<!-- links -->

[hybrid-vpn]: ../hybrid-networking/vpn.md
[azure-dns]: /azure/dns/dns-overview
[azure-sla]: https://azure.microsoft.com/support/legal/sla/
[azure-sql-db]: https://azure.microsoft.com/documentation/services/sql-database/
[health-endpoint-monitoring-pattern]: https://msdn.microsoft.com/library/dn589789.aspx
[azure-cli]: /cli/azure/
[regional-pairs]: /azure/best-practices-availability-paired-regions
[resource groups]: /azure/azure-resource-manager/resource-group-overview
[resource-group-links]: /azure/resource-group-link-resources
[resource-manager-overview]: /azure/azure-resource-manager/resource-group-overview
[services-by-region]: https://azure.microsoft.com/regions/#services
[sql-always-on]: https://msdn.microsoft.com/library/hh510230.aspx
[tablediff]: https://msdn.microsoft.com/library/ms162843.aspx
[tm-configure-failover]: /azure/traffic-manager/traffic-manager-configure-failover-routing-method
[tm-monitoring]: /azure/traffic-manager/traffic-manager-monitoring
[tm-routing]: /azure/traffic-manager/traffic-manager-routing-methods
[tm-sla]: https://azure.microsoft.com/support/legal/sla/traffic-manager
[traffic-manager]: https://azure.microsoft.com/services/traffic-manager
[visio-download]: https://archcenter.blob.core.windows.net/cdn/vm-reference-architectures.vsdx
[vnet-dns]: /azure/virtual-network/manage-virtual-network#change-dns-servers
[vnet-to-vnet]: /azure/vpn-gateway/vpn-gateway-vnet-vnet-rm-ps
[vpn-gateway]: /azure/vpn-gateway/vpn-gateway-about-vpngateways
[wsfc]: https://msdn.microsoft.com/library/hh270278.aspx
