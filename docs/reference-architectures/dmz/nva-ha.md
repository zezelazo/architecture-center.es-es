---
title: Implementación de aplicaciones virtuales de red de alta disponibilidad
titleSuffix: Azure Reference Architectures
description: Implementación de aplicaciones virtuales de red con alta disponibilidad.
author: telmosampaio
ms.date: 12/08/2018
ms.custom: seodec18
ms.openlocfilehash: 646721f80d19f493b7674884f8108762d743201b
ms.sourcegitcommit: 680c9cef945dff6fee5e66b38e24f07804510fa9
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 01/04/2019
ms.locfileid: "54011096"
---
# <a name="deploy-highly-available-network-virtual-appliances"></a><span data-ttu-id="8872b-103">Implementación de aplicaciones virtuales de red de alta disponibilidad</span><span class="sxs-lookup"><span data-stu-id="8872b-103">Deploy highly available network virtual appliances</span></span>

<span data-ttu-id="8872b-104">En este artículo se muestra cómo implementar un conjunto de aplicaciones de red virtual (NVA) de alta disponibilidad en Azure.</span><span class="sxs-lookup"><span data-stu-id="8872b-104">This article shows how to deploy a set of network virtual appliances (NVAs) for high availability in Azure.</span></span> <span data-ttu-id="8872b-105">Una NVA se usa normalmente para controlar el flujo del tráfico de red desde una red perimetral, conocida también como DMZ, hasta otras redes o subredes.</span><span class="sxs-lookup"><span data-stu-id="8872b-105">An NVA is typically used to control the flow of network traffic from a perimeter network, also known as a DMZ, to other networks or subnets.</span></span> <span data-ttu-id="8872b-106">Para aprender sobre la implementación de una red perimetral en Azure, consulte [Servicios en la nube de Microsoft y seguridad de red][cloud-security].</span><span class="sxs-lookup"><span data-stu-id="8872b-106">To learn about implementing a DMZ in Azure, see [Microsoft cloud services and network security][cloud-security].</span></span> <span data-ttu-id="8872b-107">El artículo incluye arquitecturas de ejemplo de solo entrada, solo salida y de entrada y salida.</span><span class="sxs-lookup"><span data-stu-id="8872b-107">The article includes example architectures for ingress only, egress only, and both ingress and egress.</span></span>

<span data-ttu-id="8872b-108">**Requisitos previos:** En este artículo se presupone un conocimiento básico de redes de Azure, [equilibradores de carga de Azure][lb-overview] y [rutas definidas por el usuario][udr-overview] (UDR).</span><span class="sxs-lookup"><span data-stu-id="8872b-108">**Prerequisites:** This article assumes a basic understanding of Azure networking, [Azure load balancers][lb-overview], and [user-defined routes][udr-overview] (UDRs).</span></span>

## <a name="architecture-diagrams"></a><span data-ttu-id="8872b-109">Diagramas de arquitectura</span><span class="sxs-lookup"><span data-stu-id="8872b-109">Architecture diagrams</span></span>

<span data-ttu-id="8872b-110">Una aplicación de red virtual se puede implementar en una red perimetral en muchas arquitecturas diferentes.</span><span class="sxs-lookup"><span data-stu-id="8872b-110">An NVA can be deployed to a DMZ in many different architectures.</span></span> <span data-ttu-id="8872b-111">Por ejemplo, en la siguiente ilustración se muestra el uso de una [única NVA][ nva-scenario] para la entrada.</span><span class="sxs-lookup"><span data-stu-id="8872b-111">For example, the following figure illustrates the use of a [single NVA][nva-scenario] for ingress.</span></span>

<span data-ttu-id="8872b-112">![[0]][0]</span><span class="sxs-lookup"><span data-stu-id="8872b-112">![[0]][0]</span></span>

<span data-ttu-id="8872b-113">En esta arquitectura, la aplicación de red virtual proporciona un límite de red segura, ya que comprueba todo el tráfico de red de entrada y salida y solo deja pasar aquel que cumple las reglas de seguridad de la red.</span><span class="sxs-lookup"><span data-stu-id="8872b-113">In this architecture, the NVA provides a secure network boundary by checking all inbound and outbound network traffic and passing only the traffic that meets network security rules.</span></span> <span data-ttu-id="8872b-114">Sin embargo, el hecho de que todo el tráfico de la red deba pasar por la aplicación de red virtual significa que dicha aplicación es un único punto de error en la red.</span><span class="sxs-lookup"><span data-stu-id="8872b-114">However, the fact that all network traffic must pass through the NVA means that the NVA is a single point of failure in the network.</span></span> <span data-ttu-id="8872b-115">Así que, si se produce un error en la aplicación de red virtual, no habrá ninguna otra ruta para el tráfico de red ni ninguna subred back-end disponible.</span><span class="sxs-lookup"><span data-stu-id="8872b-115">If the NVA fails, there is no other path for network traffic and all the back-end subnets are unavailable.</span></span>

<span data-ttu-id="8872b-116">Para conseguir que una aplicación virtual de red tenga una alta disponibilidad, implemente varias de estas aplicaciones en un conjunto de disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="8872b-116">To make an NVA highly available, deploy more than one NVA into an availability set.</span></span>

<span data-ttu-id="8872b-117">Las arquitecturas siguientes describen los recursos y la configuración que son necesarios para dotar a las aplicaciones virtuales de red de una alta disponibilidad:</span><span class="sxs-lookup"><span data-stu-id="8872b-117">The following architectures describe the resources and configuration necessary for highly available NVAs:</span></span>

<!-- markdownlint-disable MD033 -->

| <span data-ttu-id="8872b-118">Solución</span><span class="sxs-lookup"><span data-stu-id="8872b-118">Solution</span></span> | <span data-ttu-id="8872b-119">Ventajas</span><span class="sxs-lookup"><span data-stu-id="8872b-119">Benefits</span></span> | <span data-ttu-id="8872b-120">Consideraciones</span><span class="sxs-lookup"><span data-stu-id="8872b-120">Considerations</span></span> |
| --- | --- | --- |
| <span data-ttu-id="8872b-121">[Entrada con NVA de capa 7][ingress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="8872b-121">[Ingress with layer 7 NVAs][ingress-with-layer-7]</span></span> |<span data-ttu-id="8872b-122">Todos los nodos NVA están activos.</span><span class="sxs-lookup"><span data-stu-id="8872b-122">All NVA nodes are active</span></span> |<span data-ttu-id="8872b-123">Requiere una aplicación virtual de red que pueda terminar las conexiones y usar SNAT.</span><span class="sxs-lookup"><span data-stu-id="8872b-123">Requires an NVA that can terminate connections and use SNAT</span></span><br/> <span data-ttu-id="8872b-124">Requiere un conjunto independiente de NVA para el tráfico procedente de Internet y de Azure.</span><span class="sxs-lookup"><span data-stu-id="8872b-124">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> <br/> <span data-ttu-id="8872b-125">Solo puede usarse con el tráfico que se origina fuera de Azure.</span><span class="sxs-lookup"><span data-stu-id="8872b-125">Can only be used for traffic originating outside Azure</span></span> |
| <span data-ttu-id="8872b-126">[Salida con NVA de capa 7][egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="8872b-126">[Egress with layer 7 NVAs][egress-with-layer-7]</span></span> |<span data-ttu-id="8872b-127">Todos los nodos NVA están activos.</span><span class="sxs-lookup"><span data-stu-id="8872b-127">All NVA nodes are active</span></span> | <span data-ttu-id="8872b-128">Requiere una aplicación virtual de red que pueda terminar las conexiones e implemente la traducción de direcciones de red de origen (SNAT).</span><span class="sxs-lookup"><span data-stu-id="8872b-128">Requires an NVA that can terminate connections and implements source network address translation (SNAT)</span></span>
| <span data-ttu-id="8872b-129">[Entrada y salida con NVA de capa 7][ingress-egress-with-layer-7]</span><span class="sxs-lookup"><span data-stu-id="8872b-129">[Ingress-Egress with layer 7 NVAs][ingress-egress-with-layer-7]</span></span> |<span data-ttu-id="8872b-130">Todos los nodos están activos.</span><span class="sxs-lookup"><span data-stu-id="8872b-130">All nodes are active</span></span><br/><span data-ttu-id="8872b-131">Puede controlar el tráfico que se origina en Azure.</span><span class="sxs-lookup"><span data-stu-id="8872b-131">Able to handle traffic originated in Azure</span></span> |<span data-ttu-id="8872b-132">Requiere una aplicación virtual de red que pueda terminar las conexiones y usar SNAT.</span><span class="sxs-lookup"><span data-stu-id="8872b-132">Requires an NVA that can terminate connections and use SNAT</span></span><br/><span data-ttu-id="8872b-133">Requiere un conjunto independiente de NVA para el tráfico procedente de Internet y de Azure.</span><span class="sxs-lookup"><span data-stu-id="8872b-133">Requires a separate set of NVAs for traffic coming from the Internet and from Azure</span></span> |
| <span data-ttu-id="8872b-134">[Conmutador PIP-UDR][pip-udr-switch]</span><span class="sxs-lookup"><span data-stu-id="8872b-134">[PIP-UDR switch][pip-udr-switch]</span></span> |<span data-ttu-id="8872b-135">Un solo conjunto de NVA para todo el tráfico.</span><span class="sxs-lookup"><span data-stu-id="8872b-135">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="8872b-136">Puede controlar todo el tráfico (sin límite en las reglas de puerto).</span><span class="sxs-lookup"><span data-stu-id="8872b-136">Can handle all traffic (no limit on port rules)</span></span> |<span data-ttu-id="8872b-137">Activo-pasivo</span><span class="sxs-lookup"><span data-stu-id="8872b-137">Active-passive</span></span><br/><span data-ttu-id="8872b-138">Requiere un proceso de conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="8872b-138">Requires a failover process</span></span> |
| [<span data-ttu-id="8872b-139">PIP-UDR sin SNAT</span><span class="sxs-lookup"><span data-stu-id="8872b-139">PIP-UDR without SNAT</span></span>](#pip-udr-nvas-without-snat) | <span data-ttu-id="8872b-140">Un solo conjunto de NVA para todo el tráfico.</span><span class="sxs-lookup"><span data-stu-id="8872b-140">Single set of NVAs for all traffic</span></span><br/><span data-ttu-id="8872b-141">Puede controlar todo el tráfico (sin límite en las reglas de puerto).</span><span class="sxs-lookup"><span data-stu-id="8872b-141">Can handle all traffic (no limit on port rules)</span></span><br/><span data-ttu-id="8872b-142">No requiere la configuración de SNAT para las solicitudes entrantes</span><span class="sxs-lookup"><span data-stu-id="8872b-142">Does not require configuring SNAT for inbound requests</span></span> |<span data-ttu-id="8872b-143">Activo-pasivo</span><span class="sxs-lookup"><span data-stu-id="8872b-143">Active-passive</span></span><br/><span data-ttu-id="8872b-144">Requiere un proceso de conmutación por error.</span><span class="sxs-lookup"><span data-stu-id="8872b-144">Requires a failover process</span></span><br/><span data-ttu-id="8872b-145">La lógica de sondeo y de conmutación por error se ejecutan fuera de la red virtual</span><span class="sxs-lookup"><span data-stu-id="8872b-145">Probing and failover logic run outside the virtual network</span></span> |

<!-- markdown-enable MD033 -->

## <a name="ingress-with-layer-7-nvas"></a><span data-ttu-id="8872b-146">Entrada con NVA de capa 7</span><span class="sxs-lookup"><span data-stu-id="8872b-146">Ingress with layer 7 NVAs</span></span>

<span data-ttu-id="8872b-147">En la siguiente ilustración se muestra una arquitectura de alta disponibilidad que implementa una red perimetral de entrada detrás de un equilibrador de carga accesible desde Internet.</span><span class="sxs-lookup"><span data-stu-id="8872b-147">The following figure shows a high availability architecture that implements an ingress DMZ behind an internet-facing load balancer.</span></span> <span data-ttu-id="8872b-148">Esta arquitectura está diseñada para proporcionar conectividad a las cargas de trabajo de Azure con tráfico de capa de 7, como HTTP o HTTPS:</span><span class="sxs-lookup"><span data-stu-id="8872b-148">This architecture is designed to provide connectivity to Azure workloads for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="8872b-149">![[1]][1]</span><span class="sxs-lookup"><span data-stu-id="8872b-149">![[1]][1]</span></span>

<span data-ttu-id="8872b-150">La ventaja de esta arquitectura es que todas las aplicaciones virtuales de red están activas y, si una no funciona correctamente, el equilibrador de carga dirige el tráfico de red a la otra.</span><span class="sxs-lookup"><span data-stu-id="8872b-150">The benefit of this architecture is that all NVAs are active, and if one fails the load balancer directs network traffic to the other NVA.</span></span> <span data-ttu-id="8872b-151">Ambas aplicaciones virtuales de red enrutan el tráfico al equilibrador de carga interno, de modo que, mientras una aplicación virtual de red esté activa, el tráfico seguirá fluyendo.</span><span class="sxs-lookup"><span data-stu-id="8872b-151">Both NVAs route traffic to the internal load balancer so as long as one NVA is active, traffic continues to flow.</span></span> <span data-ttu-id="8872b-152">Las aplicaciones virtuales de red son necesarias para terminar el tráfico de SSL destinado a las máquinas virtuales de nivel web.</span><span class="sxs-lookup"><span data-stu-id="8872b-152">The NVAs are required to terminate SSL traffic intended for the web tier VMs.</span></span> <span data-ttu-id="8872b-153">Estas aplicaciones virtuales de red no se pueden ampliar para administrar el tráfico local puesto que este necesita otro conjunto dedicado de aplicaciones virtuales de red con sus propias rutas de red.</span><span class="sxs-lookup"><span data-stu-id="8872b-153">These NVAs cannot be extended to handle on-premises traffic because on-premises traffic requires another dedicated set of NVAs with their own network routes.</span></span>

> [!NOTE]
> <span data-ttu-id="8872b-154">Esta arquitectura se usa en las arquitecturas de referencia de [red perimetral entre Azure y el centro de datos local][dmz-on-prem] y [red perimetral entre Internet y Azure][ dmz-internet].</span><span class="sxs-lookup"><span data-stu-id="8872b-154">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-prem] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="8872b-155">Cada una de estas arquitecturas de referencia incluye una solución de implementación que puede usar.</span><span class="sxs-lookup"><span data-stu-id="8872b-155">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="8872b-156">Para más información, siga los vínculos.</span><span class="sxs-lookup"><span data-stu-id="8872b-156">Follow the links for more information.</span></span>

## <a name="egress-with-layer-7-nvas"></a><span data-ttu-id="8872b-157">Salida con NVA de capa 7</span><span class="sxs-lookup"><span data-stu-id="8872b-157">Egress with layer 7 NVAs</span></span>

<span data-ttu-id="8872b-158">La arquitectura anterior puede ampliarse para proporcionar una red perimetral de salida para las solicitudes que se originan en la carga de trabajo de Azure.</span><span class="sxs-lookup"><span data-stu-id="8872b-158">The previous architecture can be expanded to provide an egress DMZ for requests originating in the Azure workload.</span></span> <span data-ttu-id="8872b-159">La siguiente arquitectura está diseñada para proporcionar alta disponibilidad de las aplicaciones virtuales de red en la red perimetral para el tráfico de capa 7, como HTTP o HTTPS:</span><span class="sxs-lookup"><span data-stu-id="8872b-159">The following architecture is designed to provide high availability of the NVAs in the DMZ for layer 7 traffic, such as HTTP or HTTPS:</span></span>

<span data-ttu-id="8872b-160">![[2]][2]</span><span class="sxs-lookup"><span data-stu-id="8872b-160">![[2]][2]</span></span>

<span data-ttu-id="8872b-161">En esta arquitectura, todo el tráfico que se origina en Azure se enruta a un equilibrador de carga interno.</span><span class="sxs-lookup"><span data-stu-id="8872b-161">In this architecture, all traffic originating in Azure is routed to an internal load balancer.</span></span> <span data-ttu-id="8872b-162">El equilibrador de carga distribuye las solicitudes salientes entre un conjunto de aplicaciones virtuales de red.</span><span class="sxs-lookup"><span data-stu-id="8872b-162">The load balancer distributes outgoing requests between a set of NVAs.</span></span> <span data-ttu-id="8872b-163">Estas aplicaciones virtuales de red dirigen el tráfico a Internet mediante sus direcciones IP públicas individuales.</span><span class="sxs-lookup"><span data-stu-id="8872b-163">These NVAs direct traffic to the Internet using their individual public IP addresses.</span></span>

> [!NOTE]
> <span data-ttu-id="8872b-164">Esta arquitectura se usa en las arquitecturas de referencia de [red perimetral entre Azure y el centro de datos local][dmz-on-prem] y [red perimetral entre Internet y Azure][ dmz-internet].</span><span class="sxs-lookup"><span data-stu-id="8872b-164">This architecture is used in the [DMZ between Azure and your on-premises datacenter][dmz-on-prem] reference architecture and the [DMZ between Azure and the Internet][dmz-internet] reference architecture.</span></span> <span data-ttu-id="8872b-165">Cada una de estas arquitecturas de referencia incluye una solución de implementación que puede usar.</span><span class="sxs-lookup"><span data-stu-id="8872b-165">Each of these reference architectures includes a deployment solution that you can use.</span></span> <span data-ttu-id="8872b-166">Para más información, siga los vínculos.</span><span class="sxs-lookup"><span data-stu-id="8872b-166">Follow the links for more information.</span></span>

## <a name="ingress-egress-with-layer-7-nvas"></a><span data-ttu-id="8872b-167">Entrada y salida con NVA de capa 7</span><span class="sxs-lookup"><span data-stu-id="8872b-167">Ingress-egress with layer 7 NVAs</span></span>

<span data-ttu-id="8872b-168">En las dos arquitecturas anteriores, había una red perimetral distinta para la entrada y la salida.</span><span class="sxs-lookup"><span data-stu-id="8872b-168">In the two previous architectures, there was a separate DMZ for ingress and egress.</span></span> <span data-ttu-id="8872b-169">La siguiente arquitectura muestra cómo crear una red perimetral que puede usarse para la entrada y la salida con el tráfico de capa 7, como HTTP o HTTPS:</span><span class="sxs-lookup"><span data-stu-id="8872b-169">The following architecture demonstrates how to create a DMZ that can be used for both ingress and egress for layer 7 traffic, such as HTTP or HTTPS:</span></span>

![[4]][4]

<span data-ttu-id="8872b-171">En esta arquitectura, las aplicaciones virtuales de red procesan las solicitudes que entran desde la puerta de enlace de aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="8872b-171">In this architecture, the NVAs process incoming requests from the application gateway.</span></span> <span data-ttu-id="8872b-172">Las aplicaciones virtuales de red también procesan las solicitudes que salen de las máquinas virtuales de carga de trabajo en el grupo back-end del equilibrador de carga.</span><span class="sxs-lookup"><span data-stu-id="8872b-172">The NVAs also process outgoing requests from the workload VMs in the back-end pool of the load balancer.</span></span> <span data-ttu-id="8872b-173">Como el tráfico entrante se enruta con una puerta de enlace de aplicaciones y el tráfico saliente lo hace con un equilibrador de carga, las aplicaciones virtuales de red son responsables de mantener la afinidad de la sesión.</span><span class="sxs-lookup"><span data-stu-id="8872b-173">Because incoming traffic is routed with an application gateway and outgoing traffic is routed with a load balancer, the NVAs are responsible for maintaining session affinity.</span></span> <span data-ttu-id="8872b-174">Es decir, la puerta de enlace de aplicaciones mantiene una asignación de solicitudes entrantes y salientes, de forma que pueda reenviar la respuesta correcta al solicitante original.</span><span class="sxs-lookup"><span data-stu-id="8872b-174">That is, the application gateway maintains a mapping of inbound and outbound requests so it can forward the correct response to the original requestor.</span></span> <span data-ttu-id="8872b-175">Sin embargo, el equilibrador de carga interno no tiene acceso a las asignaciones de la puerta de enlace de aplicaciones, así que emplea su propia lógica para enviar las respuestas a las aplicaciones virtuales de red.</span><span class="sxs-lookup"><span data-stu-id="8872b-175">However, the internal load balancer does not have access to the application gateway mappings, and uses its own logic to send responses to the NVAs.</span></span> <span data-ttu-id="8872b-176">Es posible que el equilibrador de carga envíe una respuesta a una aplicación virtual de red que inicialmente no recibió la solicitud de la puerta de enlace de aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="8872b-176">It's possible the load balancer could send a response to an NVA that did not initially receive the request from the application gateway.</span></span> <span data-ttu-id="8872b-177">En este caso, las aplicaciones virtuales de red deben comunicarse y transferirse la respuesta para que la aplicación virtual de red correcta pueda reenviar la respuesta a la puerta de enlace de aplicaciones.</span><span class="sxs-lookup"><span data-stu-id="8872b-177">In this case, the NVAs must communicate and transfer the response between them so the correct NVA can forward the response to the application gateway.</span></span>

> [!NOTE]
> <span data-ttu-id="8872b-178">Otra manera de resolver el problema del enrutamiento asimétrico es asegurarse de que las aplicaciones virtuales de red realicen la traducción de las direcciones de red de origen (SNAT).</span><span class="sxs-lookup"><span data-stu-id="8872b-178">You can also solve the asymmetric routing issue by ensuring the NVAs perform inbound source network address translation (SNAT).</span></span> <span data-ttu-id="8872b-179">De esta forma, se reemplazaría la dirección IP de origen original del solicitante por una de las direcciones IP de la aplicación virtual de red usada en el flujo de entrada.</span><span class="sxs-lookup"><span data-stu-id="8872b-179">This would replace the original source IP of the requestor to one of the IP addresses of the NVA used on the inbound flow.</span></span> <span data-ttu-id="8872b-180">Con ello se garantiza que pueda usar varias aplicaciones virtuales de red al mismo tiempo sin perder la simetría de la ruta.</span><span class="sxs-lookup"><span data-stu-id="8872b-180">This ensures that you can use multiple NVAs at a time, while preserving the route symmetry.</span></span>

## <a name="pip-udr-switch-with-layer-4-nvas"></a><span data-ttu-id="8872b-181">Conmutador PIP-UDR con NVA de capa 4</span><span class="sxs-lookup"><span data-stu-id="8872b-181">PIP-UDR switch with layer 4 NVAs</span></span>

<span data-ttu-id="8872b-182">La siguiente arquitectura ilustra una arquitectura con una aplicación virtual de red activa y otra pasiva.</span><span class="sxs-lookup"><span data-stu-id="8872b-182">The following architecture demonstrates an architecture with one active and one passive NVA.</span></span> <span data-ttu-id="8872b-183">Esta arquitectura administra tanto la entrada como la salida del tráfico de capa 4:</span><span class="sxs-lookup"><span data-stu-id="8872b-183">This architecture handles both ingress and egress for layer 4 traffic:</span></span>

<span data-ttu-id="8872b-184">![[3]][3]</span><span class="sxs-lookup"><span data-stu-id="8872b-184">![[3]][3]</span></span>

> [!TIP]
> <span data-ttu-id="8872b-185">Hay disponible una solución completa de esta arquitectura en [GitHub][pnp-ha-nva].</span><span class="sxs-lookup"><span data-stu-id="8872b-185">A complete solution for this architecture is available on [GitHub][pnp-ha-nva].</span></span>

<span data-ttu-id="8872b-186">Esta arquitectura es parecida a la primera arquitectura descrita en este artículo, que</span><span class="sxs-lookup"><span data-stu-id="8872b-186">This architecture is similar to the first architecture discussed in this article.</span></span> <span data-ttu-id="8872b-187">incluía una única aplicación virtual de red que acepta y filtra las solicitudes entrantes de capa 4.</span><span class="sxs-lookup"><span data-stu-id="8872b-187">That architecture included a single NVA accepting and filtering incoming layer 4 requests.</span></span> <span data-ttu-id="8872b-188">Pero a diferencia de ella, agrega una segunda aplicación virtual de red pasiva para proporcionar alta disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="8872b-188">This architecture adds a second passive NVA to provide high availability.</span></span> <span data-ttu-id="8872b-189">Si se produce un error en la aplicación virtual de red activa, la aplicación virtual de red pasiva se vuelve activa y el UDR y la PIP cambian para apuntar a las tarjetas NIC de la aplicación virtual de red ahora activa.</span><span class="sxs-lookup"><span data-stu-id="8872b-189">If the active NVA fails, the passive NVA is made active and the UDR and PIP are changed to point to the NICs on the now active NVA.</span></span> <span data-ttu-id="8872b-190">Estos cambios en el UDR y la PIP pueden realizarse manualmente o mediante un proceso automatizado.</span><span class="sxs-lookup"><span data-stu-id="8872b-190">These changes to the UDR and PIP can either be done manually or using an automated process.</span></span> <span data-ttu-id="8872b-191">El proceso automatizado suele ser un demonio u otro servicio de supervisión que se ejecuta en Azure.</span><span class="sxs-lookup"><span data-stu-id="8872b-191">The automated process is typically daemon or other monitoring service running in Azure.</span></span> <span data-ttu-id="8872b-192">Lo que hace es consultar un sondeo de estado en la aplicación virtual de red activa y realizar la conmutación del UDR y la PIP cuando detecta un error de la aplicación virtual de red.</span><span class="sxs-lookup"><span data-stu-id="8872b-192">It queries a health probe on the active NVA and performs the UDR and PIP switch when it detects a failure of the NVA.</span></span>

<span data-ttu-id="8872b-193">En la ilustración anterior se muestra un clúster [ZooKeeper][zookeeper] de ejemplo que proporciona un demonio de alta disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="8872b-193">The preceding figure shows an example [ZooKeeper][zookeeper] cluster providing a high availability daemon.</span></span> <span data-ttu-id="8872b-194">En el clúster ZooKeeper, un cuórum de nodos elige un nodo principal.</span><span class="sxs-lookup"><span data-stu-id="8872b-194">Within the ZooKeeper cluster, a quorum of nodes elects a leader.</span></span> <span data-ttu-id="8872b-195">Si se produce un error en el nodo principal, el resto de los nodos celebran elecciones para elegir uno nuevo principal.</span><span class="sxs-lookup"><span data-stu-id="8872b-195">If the leader fails, the remaining nodes hold an election to elect a new leader.</span></span> <span data-ttu-id="8872b-196">En esta arquitectura, el nodo principal ejecuta el demonio que consulta el punto de conexión de mantenimiento en la aplicación virtual de red.</span><span class="sxs-lookup"><span data-stu-id="8872b-196">For this architecture, the leader node executes the daemon that queries the health endpoint on the NVA.</span></span> <span data-ttu-id="8872b-197">Si la aplicación virtual de red no logra responder al sondeo de estado, el demonio activa la aplicación virtual de red pasiva.</span><span class="sxs-lookup"><span data-stu-id="8872b-197">If the NVA fails to respond to the health probe, the daemon activates the passive NVA.</span></span> <span data-ttu-id="8872b-198">A continuación, el demonio llama a la API de REST de Azure para quitar la PIP de la aplicación virtual de red con errores y asociarla a la aplicación virtual de red recién creada.</span><span class="sxs-lookup"><span data-stu-id="8872b-198">The daemon then calls the Azure REST API to remove the PIP from the failed NVA and attaches it to newly activated NVA.</span></span> <span data-ttu-id="8872b-199">Seguidamente, el demonio modifica el UDR para que apunte a la dirección IP interna de la aplicación virtual de red recién activada.</span><span class="sxs-lookup"><span data-stu-id="8872b-199">The daemon then modifies the UDR to point to the newly activated NVA's internal IP address.</span></span>

<span data-ttu-id="8872b-200">No incluya los nodos ZooKeeper en una subred a la que solo se pueda acceder mediante una ruta que incluya la aplicación virtual de red.</span><span class="sxs-lookup"><span data-stu-id="8872b-200">Do not include the ZooKeeper nodes in a subnet that is only accessible using a route that includes the NVA.</span></span> <span data-ttu-id="8872b-201">Si lo hace, los nodos ZooKeeper serán inaccesibles en caso de que se produzca un error en la aplicación virtual de red.</span><span class="sxs-lookup"><span data-stu-id="8872b-201">Otherwise, the ZooKeeper nodes are inaccessible if the NVA fails.</span></span> <span data-ttu-id="8872b-202">Si por alguna razón se produce un error en el demonio, no podrá acceder a ninguno de los nodos ZooKeeper para diagnosticar el problema.</span><span class="sxs-lookup"><span data-stu-id="8872b-202">Should the daemon fail for any reason, you won't be able to access any of the ZooKeeper nodes to diagnose the problem.</span></span>

<span data-ttu-id="8872b-203">Para ver la solución completa, incluido el código de ejemplo, consulte los archivos en el [repositorio de GitHub][pnp-ha-nva].</span><span class="sxs-lookup"><span data-stu-id="8872b-203">To see the complete solution including sample code, see the files in the [GitHub repository][pnp-ha-nva].</span></span>

## <a name="pip-udr-nvas-without-snat"></a><span data-ttu-id="8872b-204">Aplicaciones virtuales de red PIP-UDR sin SNAT</span><span class="sxs-lookup"><span data-stu-id="8872b-204">PIP-UDR NVAs without SNAT</span></span>

<span data-ttu-id="8872b-205">Esta arquitectura emplea dos máquinas virtuales de Azure para hospedar el firewall de aplicación virtual de red en una configuración activo/pasivo que admite la conmutación por error automática, pero no requiere la traducción de direcciones de red de origen (SNAT).</span><span class="sxs-lookup"><span data-stu-id="8872b-205">This architecture uses two Azure virtual machines to host the NVA firewall in an active-passive configuration that supports automated failover but does not require Source Network Address Translation (SNAT).</span></span>

![Arquitectura de aplicaciones virtuales de red PIP-UDR sin SNAT](./images/nva-ha/pip-udr-without-snat.png)

> [!TIP]
> <span data-ttu-id="8872b-207">Hay disponible una solución completa de esta arquitectura en [GitHub][ha-nva-fo].</span><span class="sxs-lookup"><span data-stu-id="8872b-207">A complete solution for this architecture is available on [GitHub][ha-nva-fo].</span></span>

<span data-ttu-id="8872b-208">Esta solución está diseñada para clientes de Azure que no pueden configurar SNAT para las solicitudes entrantes en los firewalls de aplicación virtual de red.</span><span class="sxs-lookup"><span data-stu-id="8872b-208">This solution is designed for Azure customers who cannot configure SNAT for inbound requests on their NVA firewalls.</span></span> <span data-ttu-id="8872b-209">SNAT oculta la dirección IP de cliente de origen original.</span><span class="sxs-lookup"><span data-stu-id="8872b-209">SNAT hides the original source client IP address.</span></span> <span data-ttu-id="8872b-210">Si necesita registrar las direcciones IP originales o usarlas en otros componentes de seguridad por capas detrás de las aplicaciones virtuales de red, esta solución ofrece un enfoque básico.</span><span class="sxs-lookup"><span data-stu-id="8872b-210">If you need to log the original IPs or used them within other layered security components behind your NVAs, this solution offers a basic approach.</span></span>

<span data-ttu-id="8872b-211">La conmutación por error de las entradas de la tabla UDR se automatiza mediante una dirección de próximo salto establecida en la dirección IP de una interfaz en la máquina de virtual del firewall de la aplicación virtual de red activa.</span><span class="sxs-lookup"><span data-stu-id="8872b-211">The failover of UDR table entries is automated by a next-hop address set to the IP address of an interface on the active NVA firewall virtual machine.</span></span> <span data-ttu-id="8872b-212">La lógica de conmutación por error automatizada se hospeda en una aplicación de función que se crea con [Azure Functions](/azure/azure-functions/).</span><span class="sxs-lookup"><span data-stu-id="8872b-212">The automated failover logic is hosted in a function app that you create using [Azure Functions](/azure/azure-functions/).</span></span> <span data-ttu-id="8872b-213">El código de la conmutación por error se ejecuta como una función sin servidor en Azure Functions.</span><span class="sxs-lookup"><span data-stu-id="8872b-213">The failover code runs as a serverless function inside Azure Functions.</span></span> <span data-ttu-id="8872b-214">La implementación es cómoda, rentable y fácil de mantener y personalizar.</span><span class="sxs-lookup"><span data-stu-id="8872b-214">Deployment is convenient, cost-effective, and easy to maintain and customize.</span></span> <span data-ttu-id="8872b-215">Además, la aplicación de función se hospeda en Azure Functions, por lo que no tiene ninguna dependencia en la red virtual.</span><span class="sxs-lookup"><span data-stu-id="8872b-215">In addition, the function app is hosted within Azure Functions, so it has no dependencies on the virtual network.</span></span> <span data-ttu-id="8872b-216">Si los cambios realizados en la red virtual afectan a los firewalls de aplicación virtual de red, la aplicación de función continúa su ejecución de forma independiente.</span><span class="sxs-lookup"><span data-stu-id="8872b-216">If changes to the virtual network impact the NVA firewalls, the function app continues to run independently.</span></span> <span data-ttu-id="8872b-217">Así, las pruebas son más precisas porque tienen lugar fuera de la red virtual con la misma ruta que las solicitudes de cliente entrantes.</span><span class="sxs-lookup"><span data-stu-id="8872b-217">Testing is more accurate as well, because it takes place outside the virtual network using the same route as the inbound client requests.</span></span>

<span data-ttu-id="8872b-218">Para comprobar la disponibilidad del firewall de la aplicación virtual de red, el código de la aplicación de función realiza sondeos de dos maneras:</span><span class="sxs-lookup"><span data-stu-id="8872b-218">To check the availability of the NVA firewall, the function app code probes it in one of two ways:</span></span>

- <span data-ttu-id="8872b-219">Mediante la supervisión del estado de las máquinas virtuales de Azure que hospedan el firewall de la aplicación virtual de red.</span><span class="sxs-lookup"><span data-stu-id="8872b-219">By monitoring the state of the Azure virtual machines hosting the NVA firewall.</span></span>

- <span data-ttu-id="8872b-220">Mediante pruebas de la existencia de un puerto abierto en el firewall hacia el servidor web de back-end.</span><span class="sxs-lookup"><span data-stu-id="8872b-220">By testing whether there is an open port through the firewall to the back-end web server.</span></span> <span data-ttu-id="8872b-221">Para esta opción, el dispositivo virtual de red debe exponer un socket mediante PIP para que el código de la aplicación de función pueda hacer pruebas.</span><span class="sxs-lookup"><span data-stu-id="8872b-221">For this option, the NVA must expose a socket via PIP for the function app code to test.</span></span>

<span data-ttu-id="8872b-222">Elija el tipo de sondeo que desea usar al configurar la aplicación de función.</span><span class="sxs-lookup"><span data-stu-id="8872b-222">You choose the type of probe you want to use when you configure the function app.</span></span> <span data-ttu-id="8872b-223">Para ver la solución completa, incluido el código de ejemplo, consulte los archivos en el [repositorio de GitHub][ha-nva-fo].</span><span class="sxs-lookup"><span data-stu-id="8872b-223">To see the complete solution including sample code, see the files in the [GitHub repository][ha-nva-fo].</span></span>

## <a name="next-steps"></a><span data-ttu-id="8872b-224">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="8872b-224">Next steps</span></span>

- <span data-ttu-id="8872b-225">Aprenda a [implementar una red perimetral entre Azure y el centro de datos local][dmz-on-prem] mediante aplicaciones virtuales de red de capa 7.</span><span class="sxs-lookup"><span data-stu-id="8872b-225">Learn how to [implement a DMZ between Azure and your on-premises datacenter][dmz-on-prem] using layer-7 NVAs.</span></span>
- <span data-ttu-id="8872b-226">Aprenda a [implementar una red perimetral entre Azure e Internet] [dmz-internet] mediante aplicaciones virtuales de red de capa 7.</span><span class="sxs-lookup"><span data-stu-id="8872b-226">Learn how to [implement a DMZ between Azure and the Internet][dmz-internet] using layer-7 NVAs.</span></span>
- [<span data-ttu-id="8872b-227">Solución de problemas de aplicaciones virtuales de red en Azure</span><span class="sxs-lookup"><span data-stu-id="8872b-227">Troubleshoot network virtual appliance issues in Azure</span></span>](/azure/virtual-network/virtual-network-troubleshoot-nva)

<!-- links -->

[cloud-security]: /azure/best-practices-network-security
[dmz-on-prem]: ./secure-vnet-hybrid.md
[dmz-internet]: ./secure-vnet-dmz.md
[egress-with-layer-7]: #egress-with-layer-7-nvas
[ingress-with-layer-7]: #ingress-with-layer-7-nvas
[ingress-egress-with-layer-7]: #ingress-egress-with-layer-7-nvas
[lb-overview]: /azure/load-balancer/load-balancer-overview/
[nva-scenario]: /azure/virtual-network/virtual-network-scenario-udr-gw-nva/
[pip-udr-switch]: #pip-udr-switch-with-layer-4-nvas
[udr-overview]: /azure/virtual-network/virtual-networks-udr-overview/
[zookeeper]: https://zookeeper.apache.org/
[pnp-ha-nva]: https://github.com/mspnp/ha-nva
[ha-nva-fo]: https://aka.ms/ha-nva-fo

<!-- images -->

[0]: ./images/nva-ha/single-nva.png "Arquitectura de una única aplicación virtual de red"
[1]: ./images/nva-ha/l7-ingress.png "Entrada de capa 7"
[2]: ./images/nva-ha/l7-ingress-egress.png "Salida de capa 7"
[3]: ./images/nva-ha/active-passive.png "Clústeres activo/pasivo"
[4]: ./images/nva-ha/l7-ingress-egress-ag.png
