---
title: Implementación de los Servicios de federación de Active Directory (AD FS) en Azure
description: >-
  Procedimiento para implementar una arquitectura de red híbrida segura con la autorización de los Servicios de Federación de Active Directory en Azure.

  guidance,vpn-gateway,expressroute,load-balancer,virtual-network,active-directory
author: telmosampaio
ms.date: 11/28/2016
pnp.series.title: Identity management
pnp.series.prev: adds-forest
cardTitle: Extend AD FS to Azure
ms.openlocfilehash: adf989ec40f837ce95000e75b7bc642db446f396
ms.sourcegitcommit: 1287d635289b1c49e94f839b537b4944df85111d
ms.translationtype: HT
ms.contentlocale: es-ES
ms.lasthandoff: 11/27/2018
ms.locfileid: "52332347"
---
# <a name="extend-active-directory-federation-services-ad-fs-to-azure"></a><span data-ttu-id="9268f-104">Extensión de Servicios de federación de Active Directory (AD FS) a Azure</span><span class="sxs-lookup"><span data-stu-id="9268f-104">Extend Active Directory Federation Services (AD FS) to Azure</span></span>

<span data-ttu-id="9268f-105">Esta arquitectura de referencia implementa una red segura híbrida que extiende la red local a Azure y usa los [Servicios de federación de Active Directory (AD FS)][active-directory-federation-services] para realizar la autenticación y la autorización federada para los componentes que se ejecutan en Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-105">This reference architecture implements a secure hybrid network that extends your on-premises network to Azure and uses [Active Directory Federation Services (AD FS)][active-directory-federation-services] to perform federated authentication and authorization for components running in Azure.</span></span> [<span data-ttu-id="9268f-106">**Implemente esta solución**.</span><span class="sxs-lookup"><span data-stu-id="9268f-106">**Deploy this solution**.</span></span>](#deploy-the-solution)

<span data-ttu-id="9268f-107">[![0]][0]</span><span class="sxs-lookup"><span data-stu-id="9268f-107">[![0]][0]</span></span>

<span data-ttu-id="9268f-108">*Descargue un [archivo Visio][visio-download] de esta arquitectura.*</span><span class="sxs-lookup"><span data-stu-id="9268f-108">*Download a [Visio file][visio-download] of this architecture.*</span></span>

<span data-ttu-id="9268f-109">AD FS puede hospedarse de forma local, pero, si la aplicación es un híbrido en el que algunas partes se implementan en Azure, puede ser más eficaz replicar AD FS en la nube.</span><span class="sxs-lookup"><span data-stu-id="9268f-109">AD FS can be hosted on-premises, but if your application is a hybrid in which some parts are implemented in Azure, it may be more efficient to replicate AD FS in the cloud.</span></span> 

<span data-ttu-id="9268f-110">El diagrama muestra los siguientes escenarios:</span><span class="sxs-lookup"><span data-stu-id="9268f-110">The diagram shows the following scenarios:</span></span>

* <span data-ttu-id="9268f-111">El código de la aplicación de una organización asociada tiene acceso a una aplicación web que se hospeda dentro de la red virtual de Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-111">Application code from a partner organization accesses a web application hosted inside your Azure VNet.</span></span>
* <span data-ttu-id="9268f-112">Un usuario externo y registrado con las credenciales almacenadas en Active Directory Domain Services (DS) tiene acceso a una aplicación web que se hospeda dentro de la red virtual de Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-112">An external, registered user with credentials stored inside Active Directory Domain Services (DS) accesses a web application hosted inside your Azure VNet.</span></span>
* <span data-ttu-id="9268f-113">Un usuario conectado a la red virtual con un dispositivo autorizado ejecuta una aplicación web que se hospeda dentro de la red virtual de Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-113">A user connected to your VNet using an authorized device executes a web application hosted inside your Azure VNet.</span></span>

<span data-ttu-id="9268f-114">Los usos habituales de esta arquitectura incluyen:</span><span class="sxs-lookup"><span data-stu-id="9268f-114">Typical uses for this architecture include:</span></span>

* <span data-ttu-id="9268f-115">Aplicaciones híbridas donde una parte de las cargas de trabajo se ejecutan de forma local y otra parte en Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-115">Hybrid applications where workloads run partly on-premises and partly in Azure.</span></span>
* <span data-ttu-id="9268f-116">Soluciones que usan autorización federada para exponer las aplicaciones web a las organizaciones asociadas.</span><span class="sxs-lookup"><span data-stu-id="9268f-116">Solutions that use federated authorization to expose web applications to partner organizations.</span></span>
* <span data-ttu-id="9268f-117">Sistemas que permiten el acceso desde exploradores web que se ejecutan fuera del firewall de la organización.</span><span class="sxs-lookup"><span data-stu-id="9268f-117">Systems that support access from web browsers running outside of the organizational firewall.</span></span>
* <span data-ttu-id="9268f-118">Sistemas que permiten a los usuarios el acceso a las aplicaciones web mediante la conexión de dispositivos externos autorizados como equipos remotos, portátiles y otros dispositivos móviles.</span><span class="sxs-lookup"><span data-stu-id="9268f-118">Systems that enable users to access to web applications by connecting from authorized external devices such as remote computers, notebooks, and other mobile devices.</span></span> 

<span data-ttu-id="9268f-119">Esta arquitectura de referencia se centra en la *federación pasiva*, en la que los servidores de federación deciden cómo y cuándo autenticar a un usuario.</span><span class="sxs-lookup"><span data-stu-id="9268f-119">This reference architecture focuses on *passive federation*, in which the federation servers decide how and when to authenticate a user.</span></span> <span data-ttu-id="9268f-120">El usuario proporciona información de inicio de sesión cuando se inicia la aplicación.</span><span class="sxs-lookup"><span data-stu-id="9268f-120">The user provides sign in information when the application is started.</span></span> <span data-ttu-id="9268f-121">Este mecanismo se usa normalmente en los exploradores web e implica un protocolo que redirige el explorador a un sitio donde el usuario se autentica.</span><span class="sxs-lookup"><span data-stu-id="9268f-121">This mechanism is most commonly used by web browsers and involves a protocol that redirects the browser to a site where the user authenticates.</span></span> <span data-ttu-id="9268f-122">AD FS también admite la *federación activa*, en la que una aplicación asume la responsabilidad de proporcionar las credenciales sin la intervención del usuario, pero ese escenario está fuera del ámbito de esta arquitectura.</span><span class="sxs-lookup"><span data-stu-id="9268f-122">AD FS also supports *active federation*, where an application takes on responsibility for supplying credentials without further user interaction, but that scenario is outside the scope of this architecture.</span></span>

<span data-ttu-id="9268f-123">Para consideraciones adicionales, consulte [Selección de una solución para la integración de Active Directory local con Azure][considerations].</span><span class="sxs-lookup"><span data-stu-id="9268f-123">For additional considerations, see [Choose a solution for integrating on-premises Active Directory with Azure][considerations].</span></span> 

## <a name="architecture"></a><span data-ttu-id="9268f-124">Arquitectura</span><span class="sxs-lookup"><span data-stu-id="9268f-124">Architecture</span></span>

<span data-ttu-id="9268f-125">Esta arquitectura amplía la implementación que se describe en [Extensión de AD DS a Azure][extending-ad-to-azure].</span><span class="sxs-lookup"><span data-stu-id="9268f-125">This architecture extends the implementation described in [Extending AD DS to Azure][extending-ad-to-azure].</span></span> <span data-ttu-id="9268f-126">Contiene los componentes siguientes:</span><span class="sxs-lookup"><span data-stu-id="9268f-126">It contains the followign components.</span></span>

* <span data-ttu-id="9268f-127">**Subred de AD DS**.</span><span class="sxs-lookup"><span data-stu-id="9268f-127">**AD DS subnet**.</span></span> <span data-ttu-id="9268f-128">Los servidores de AD DS se encuentran en su propia subred con reglas de grupo de seguridad de red (NSG) que actúan como un firewall.</span><span class="sxs-lookup"><span data-stu-id="9268f-128">The AD DS servers are contained in their own subnet with network security group (NSG) rules acting as a firewall.</span></span>

* <span data-ttu-id="9268f-129">**Servidores de AD FS**.</span><span class="sxs-lookup"><span data-stu-id="9268f-129">**AD DS servers**.</span></span> <span data-ttu-id="9268f-130">Controladores de dominio que se ejecutan como máquinas virtuales en Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-130">Domain controllers running as VMs in Azure.</span></span> <span data-ttu-id="9268f-131">Estos servidores proporcionan autenticación de las identidades locales dentro del dominio.</span><span class="sxs-lookup"><span data-stu-id="9268f-131">These servers provide authentication of local identities within the domain.</span></span>

* <span data-ttu-id="9268f-132">**Subred de AD FS**.</span><span class="sxs-lookup"><span data-stu-id="9268f-132">**AD FS subnet**.</span></span> <span data-ttu-id="9268f-133">Los servidores de AD FS se encuentran dentro de su propia subred con reglas NSG que actúan como un firewall.</span><span class="sxs-lookup"><span data-stu-id="9268f-133">The AD FS servers are located within their own subnet with NSG rules acting as a firewall.</span></span>

* <span data-ttu-id="9268f-134">**Servidores de AD FS**.</span><span class="sxs-lookup"><span data-stu-id="9268f-134">**AD FS servers**.</span></span> <span data-ttu-id="9268f-135">Los servidores de AD FS proporcionan autenticación y autorización federadas.</span><span class="sxs-lookup"><span data-stu-id="9268f-135">The AD FS servers provide federated authorization and authentication.</span></span> <span data-ttu-id="9268f-136">En esta arquitectura, se realizan las siguientes tareas:</span><span class="sxs-lookup"><span data-stu-id="9268f-136">In this architecture, they perform the following tasks:</span></span>
  
  * <span data-ttu-id="9268f-137">Recibir tokens de seguridad que contienen notificaciones realizadas por un servidor de federación asociado en nombre del usuario asociado.</span><span class="sxs-lookup"><span data-stu-id="9268f-137">Receiving security tokens containing claims made by a partner federation server on behalf of a partner user.</span></span> <span data-ttu-id="9268f-138">AD FS comprueba que los tokens son válidos antes de pasar las notificaciones a la aplicación web que se ejecuta en Azure para autorizar las solicitudes.</span><span class="sxs-lookup"><span data-stu-id="9268f-138">AD FS verifies that the tokens are valid before passing the claims to the web application running in Azure to authorize requests.</span></span> 
  
    <span data-ttu-id="9268f-139">La aplicación web que se ejecuta en Azure es el *usuario de confianza*.</span><span class="sxs-lookup"><span data-stu-id="9268f-139">The web application running in Azure is the *relying party*.</span></span> <span data-ttu-id="9268f-140">El servidor de federación asociado debe emitir notificaciones que la aplicación web entienda.</span><span class="sxs-lookup"><span data-stu-id="9268f-140">The partner federation server must issue claims that are understood by the web application.</span></span> <span data-ttu-id="9268f-141">Los servidores de federación asociados se conocen como *asociados de cuenta*, ya que envían las solicitudes de acceso en nombre de las cuentas autenticadas en la organización del asociado.</span><span class="sxs-lookup"><span data-stu-id="9268f-141">The partner federation servers are referred to as *account partners*, because they submit access requests on behalf of authenticated accounts in the partner organization.</span></span> <span data-ttu-id="9268f-142">Los servidores de AD FS se denominan *asociados de recursos* ya que proporcionan acceso a los recursos (la aplicación web).</span><span class="sxs-lookup"><span data-stu-id="9268f-142">The AD FS servers are called *resource partners* because they provide access to resources (the web application).</span></span>

  * <span data-ttu-id="9268f-143">Autenticar y autorizar las solicitudes entrantes de los usuarios externos que ejecutan un explorador web o un dispositivo que necesita tener acceso a las aplicaciones web, mediante AD DS y el [Servicio de registro de dispositivos de Active Directory][ADDRS].</span><span class="sxs-lookup"><span data-stu-id="9268f-143">Authenticating and authorizing incoming requests from external users running a web browser or device that needs access to web applications, by using AD DS and the [Active Directory Device Registration Service][ADDRS].</span></span>
    
  <span data-ttu-id="9268f-144">Los servidores de AD FS se configuran como una granja de servidores a los que se accede a través de un equilibrador de carga de Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-144">The AD FS servers are configured as a farm accessed through an Azure load balancer.</span></span> <span data-ttu-id="9268f-145">Esta implementación mejora la disponibilidad y la escalabilidad.</span><span class="sxs-lookup"><span data-stu-id="9268f-145">This implementation improves availability and scalability.</span></span> <span data-ttu-id="9268f-146">Los servidores de AD FS no se exponen directamente a Internet.</span><span class="sxs-lookup"><span data-stu-id="9268f-146">The AD FS servers are not exposed directly to the Internet.</span></span> <span data-ttu-id="9268f-147">Todo el tráfico de Internet se filtra a través de servidores proxy de aplicación web de AD FS y una red perimetral (también conocida como DMZ).</span><span class="sxs-lookup"><span data-stu-id="9268f-147">All Internet traffic is filtered through AD FS web application proxy servers and a DMZ (also referred to as a perimeter network).</span></span>

  <span data-ttu-id="9268f-148">Para obtener más información acerca del funcionamiento de AD FS, consulte [Introducción a los Servicios de federación de Active Directory][active-directory-federation-services-overview].</span><span class="sxs-lookup"><span data-stu-id="9268f-148">For more information about how AD FS works, see [Active Directory Federation Services Overview][active-directory-federation-services-overview].</span></span> <span data-ttu-id="9268f-149">Además, el artículo [Implementación de AD FS en Azure][adfs-intro] contiene una introducción detallada paso a paso para la implementación.</span><span class="sxs-lookup"><span data-stu-id="9268f-149">Also, the article [AD FS deployment in Azure][adfs-intro] contains a detailed step-by-step introduction to implementation.</span></span>

* <span data-ttu-id="9268f-150">**Subred de proxy de AD FS**.</span><span class="sxs-lookup"><span data-stu-id="9268f-150">**AD FS proxy subnet**.</span></span> <span data-ttu-id="9268f-151">Los servidores proxy de AD FS pueden estar dentro de su propia subred, con reglas NSG que proporcionan la protección.</span><span class="sxs-lookup"><span data-stu-id="9268f-151">The AD FS proxy servers can be contained within their own subnet, with NSG rules providing protection.</span></span> <span data-ttu-id="9268f-152">Los servidores de esta subred se exponen a Internet a través de un conjunto de aplicaciones virtuales de red que proporcionan un firewall entre la red virtual de Azure e Internet.</span><span class="sxs-lookup"><span data-stu-id="9268f-152">The servers in this subnet are exposed to the Internet through a set of network virtual appliances that provide a firewall between your Azure virtual network and the Internet.</span></span>

* <span data-ttu-id="9268f-153">**Servidores proxy de aplicación web (WAP) de AD FS**.</span><span class="sxs-lookup"><span data-stu-id="9268f-153">**AD FS web application proxy (WAP) servers**.</span></span> <span data-ttu-id="9268f-154">Estas máquinas virtuales actúan como servidores de AD FS para las solicitudes entrantes de las organizaciones asociadas y los dispositivos externos.</span><span class="sxs-lookup"><span data-stu-id="9268f-154">These VMs act as AD FS servers for incoming requests from partner organizations and external devices.</span></span> <span data-ttu-id="9268f-155">Los servidores WAP actúan como un filtro, blindando a los servidores de AD FS frente al acceso directo desde Internet.</span><span class="sxs-lookup"><span data-stu-id="9268f-155">The WAP servers act as a filter, shielding the AD FS servers from direct access from the Internet.</span></span> <span data-ttu-id="9268f-156">Al igual que con los servidores de AD FS, implementar los servidores WAP en una granja de servidores con equilibrio de carga ofrece mayor disponibilidad y escalabilidad que la implementación de una colección de servidores independientes.</span><span class="sxs-lookup"><span data-stu-id="9268f-156">As with the AD FS servers, deploying the WAP servers in a farm with load balancing gives you greater availability and scalability than deploying a collection of stand-alone servers.</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="9268f-157">Para información detallada acerca de cómo instalar los servidores WAP, consulte [Instalar y configurar el servidor de Proxy de aplicación web][install_and_configure_the_web_application_proxy_server]</span><span class="sxs-lookup"><span data-stu-id="9268f-157">For detailed information about installing WAP servers, see [Install and Configure the Web Application Proxy Server][install_and_configure_the_web_application_proxy_server]</span></span>
  > 
  > 

* <span data-ttu-id="9268f-158">**Organización del asociado**.</span><span class="sxs-lookup"><span data-stu-id="9268f-158">**Partner organization**.</span></span> <span data-ttu-id="9268f-159">La organización de un asociado ejecuta una aplicación web que solicita acceso a una aplicación web que se ejecuta en Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-159">A partner organization running a web application that requests access to a web application running in Azure.</span></span> <span data-ttu-id="9268f-160">El servidor de federación de la organización del asociado autentica localmente las solicitudes y envía tokens de seguridad que contienen notificaciones a AD FS que se ejecuta en Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-160">The federation server at the partner organization authenticates requests locally, and submits security tokens containing claims to AD FS running in Azure.</span></span> <span data-ttu-id="9268f-161">AD FS en Azure valida los tokens de seguridad y, si son válidos, puede pasar las notificaciones a la aplicación web que se ejecuta en Azure para que las autorice.</span><span class="sxs-lookup"><span data-stu-id="9268f-161">AD FS in Azure validates the security tokens, and if valid can pass the claims to the web application running in Azure to authorize them.</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="9268f-162">También puede configurar un túnel VPN con la puerta de enlace de Azure para proporcionar acceso directo a AD FS para los asociados de confianza.</span><span class="sxs-lookup"><span data-stu-id="9268f-162">You can also configure a VPN tunnel using Azure gateway to provide direct access to AD FS for trusted partners.</span></span> <span data-ttu-id="9268f-163">Las solicitudes recibidas desde estos asociados no pasan a través de los servidores WAP.</span><span class="sxs-lookup"><span data-stu-id="9268f-163">Requests received from these partners do not pass through the WAP servers.</span></span>
  > 
  > 

<span data-ttu-id="9268f-164">Para más información sobre los elementos de la arquitectura que no están relacionados con AD FS, vea lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="9268f-164">For more information about the parts of the architecture that are not related to AD FS, see the following:</span></span>
- <span data-ttu-id="9268f-165">[Implementación de una arquitectura de red híbrida segura en Azure][implementing-a-secure-hybrid-network-architecture]</span><span class="sxs-lookup"><span data-stu-id="9268f-165">[Implementing a secure hybrid network architecture in Azure][implementing-a-secure-hybrid-network-architecture]</span></span>
- <span data-ttu-id="9268f-166">[Implementación de una arquitectura de red híbrida segura con acceso a Internet en Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access]</span><span class="sxs-lookup"><span data-stu-id="9268f-166">[Implementing a secure hybrid network architecture with Internet access in Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access]</span></span>
- <span data-ttu-id="9268f-167">[Implementación de una arquitectura de red híbrida segura con identidades de Active Directory en Azure][extending-ad-to-azure].</span><span class="sxs-lookup"><span data-stu-id="9268f-167">[Implementing a secure hybrid network architecture with Active Directory identities in Azure][extending-ad-to-azure].</span></span>


## <a name="recommendations"></a><span data-ttu-id="9268f-168">Recomendaciones</span><span class="sxs-lookup"><span data-stu-id="9268f-168">Recommendations</span></span>

<span data-ttu-id="9268f-169">Las siguientes recomendaciones sirven para la mayoría de los escenarios.</span><span class="sxs-lookup"><span data-stu-id="9268f-169">The following recommendations apply for most scenarios.</span></span> <span data-ttu-id="9268f-170">Sígalas a menos que tenga un requisito concreto que las invalide.</span><span class="sxs-lookup"><span data-stu-id="9268f-170">Follow these recommendations unless you have a specific requirement that overrides them.</span></span> 

### <a name="vm-recommendations"></a><span data-ttu-id="9268f-171">Recomendaciones de VM</span><span class="sxs-lookup"><span data-stu-id="9268f-171">VM recommendations</span></span>

<span data-ttu-id="9268f-172">Cree máquinas virtuales con recursos suficientes para controlar el volumen de tráfico esperado.</span><span class="sxs-lookup"><span data-stu-id="9268f-172">Create VMs with sufficient resources to handle the expected volume of traffic.</span></span> <span data-ttu-id="9268f-173">Utilice el tamaño de las máquinas existentes que hospedan AD FS en una instalación local como punto de partida.</span><span class="sxs-lookup"><span data-stu-id="9268f-173">Use the size of the existing machines hosting AD FS on premises as a starting point.</span></span> <span data-ttu-id="9268f-174">Supervise la utilización de recursos.</span><span class="sxs-lookup"><span data-stu-id="9268f-174">Monitor the resource utilization.</span></span> <span data-ttu-id="9268f-175">Puede cambiar el tamaño de las máquinas virtuales y reducirlas verticalmente si son demasiado grandes.</span><span class="sxs-lookup"><span data-stu-id="9268f-175">You can resize the VMs and scale down if they are too large.</span></span>

<span data-ttu-id="9268f-176">Siga las recomendaciones enumeradas en [Ejecución de una máquina virtual Windows en Azure][vm-recommendations].</span><span class="sxs-lookup"><span data-stu-id="9268f-176">Follow the recommendations listed in [Running a Windows VM on Azure][vm-recommendations].</span></span>

### <a name="networking-recommendations"></a><span data-ttu-id="9268f-177">Recomendaciones de redes</span><span class="sxs-lookup"><span data-stu-id="9268f-177">Networking recommendations</span></span>

<span data-ttu-id="9268f-178">Configure la interfaz de red para cada una de las máquinas virtuales que hospedan servidores de AD FS y WAP con direcciones IP privadas estáticas.</span><span class="sxs-lookup"><span data-stu-id="9268f-178">Configure the network interface for each of the VMs hosting AD FS and WAP servers with static private IP addresses.</span></span>

<span data-ttu-id="9268f-179">No conceda a las máquinas virtuales de AD FS direcciones IP públicas.</span><span class="sxs-lookup"><span data-stu-id="9268f-179">Do not give the AD FS VMs public IP addresses.</span></span> <span data-ttu-id="9268f-180">Para más información, consulte la sección Consideraciones de seguridad.</span><span class="sxs-lookup"><span data-stu-id="9268f-180">For more information, see the Security considerations section.</span></span>

<span data-ttu-id="9268f-181">Establezca la dirección IP de los servidores del servicio de nombres de dominio preferido y secundario (DNS) para las interfaces de red de cada máquina virtual AD FS y WAP para hacer referencia a las máquinas virtuales de Active Directory DS.</span><span class="sxs-lookup"><span data-stu-id="9268f-181">Set the IP address of the preferred and secondary domain name service (DNS) servers for the network interfaces for each AD FS and WAP VM to reference the Active Directory DS VMs.</span></span> <span data-ttu-id="9268f-182">Las máquinas virtuales de Active Directory DS deben estar ejecutando DNS.</span><span class="sxs-lookup"><span data-stu-id="9268f-182">The Active Directory DS VMS should be running DNS.</span></span> <span data-ttu-id="9268f-183">Este paso es necesario para permitir que cada máquina virtual se una al dominio.</span><span class="sxs-lookup"><span data-stu-id="9268f-183">This step is necessary to enable each VM to join the domain.</span></span>

### <a name="ad-fs-availability"></a><span data-ttu-id="9268f-184">Disponibilidad de AD FS</span><span class="sxs-lookup"><span data-stu-id="9268f-184">AD FS availability</span></span> 

<span data-ttu-id="9268f-185">Cree una granja de servidores de AD FS con al menos dos servidores para aumentar la disponibilidad del servicio.</span><span class="sxs-lookup"><span data-stu-id="9268f-185">Create an AD FS farm with at least two servers to increase availability of the service.</span></span> <span data-ttu-id="9268f-186">Use cuentas de almacenamiento diferentes para cada máquina virtual de AD FS en la granja de servidores.</span><span class="sxs-lookup"><span data-stu-id="9268f-186">Use different storage accounts for each AD FS VM in the farm.</span></span> <span data-ttu-id="9268f-187">Este enfoque ayuda a garantizar que un error en una única cuenta de almacenamiento no haga que toda la granja quede inaccesible.</span><span class="sxs-lookup"><span data-stu-id="9268f-187">This approach helps to ensure that a failure in a single storage account does not make the entire farm inaccessible.</span></span>

> [!IMPORTANT]
> <span data-ttu-id="9268f-188">Se recomienda usar [discos administrados](/azure/storage/storage-managed-disks-overview).</span><span class="sxs-lookup"><span data-stu-id="9268f-188">We recommend the use of [managed disks](/azure/storage/storage-managed-disks-overview).</span></span> <span data-ttu-id="9268f-189">Los discos administrados no requieren una cuenta de almacenamiento.</span><span class="sxs-lookup"><span data-stu-id="9268f-189">Managed disks do not require a storage account.</span></span> <span data-ttu-id="9268f-190">Solo debe especificar el tamaño y el tipo de disco, y se implementa en un modo de alta disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="9268f-190">You simply specify the size and type of disk and it is deployed in a highly available way.</span></span> <span data-ttu-id="9268f-191">Nuestras [arquitecturas de referencia](/azure/architecture/reference-architectures/) no implementan actualmente discos administrados, pero los [bloques de creación de plantillas](https://github.com/mspnp/template-building-blocks/wiki) se actualizarán para implementar los discos administrados en la versión 2.</span><span class="sxs-lookup"><span data-stu-id="9268f-191">Our [reference architectures](/azure/architecture/reference-architectures/) do not currently deploy managed disks but the [template building blocks](https://github.com/mspnp/template-building-blocks/wiki) will be updated to deploy managed disks in version 2.</span></span>

<span data-ttu-id="9268f-192">Cree conjuntos de disponibilidad de Azure diferentes para las máquinas virtuales de AD FS y WAP.</span><span class="sxs-lookup"><span data-stu-id="9268f-192">Create separate Azure availability sets for the AD FS and WAP VMs.</span></span> <span data-ttu-id="9268f-193">Asegúrese de que hay al menos dos máquinas virtuales en cada conjunto.</span><span class="sxs-lookup"><span data-stu-id="9268f-193">Ensure that there are at least two VMs in each set.</span></span> <span data-ttu-id="9268f-194">Cada conjunto de disponibilidad debe tener dos dominios de actualización y dos dominios de error, como mínimo.</span><span class="sxs-lookup"><span data-stu-id="9268f-194">Each availability set must have at least two update domains and two fault domains.</span></span>

<span data-ttu-id="9268f-195">Configure los equilibradores de carga para las máquinas virtuales de AD FS y WAP de la manera siguiente:</span><span class="sxs-lookup"><span data-stu-id="9268f-195">Configure the load balancers for the AD FS VMs and WAP VMs as follows:</span></span>

* <span data-ttu-id="9268f-196">Use un equilibrador de carga de Azure para proporcionar acceso externo a las máquinas virtuales de WAP y uno interno para distribuir la carga entre los servidores de AD FS en la granja de servidores.</span><span class="sxs-lookup"><span data-stu-id="9268f-196">Use an Azure load balancer to provide external access to the WAP VMs, and an internal load balancer to distribute the load across the AD FS servers in the farm.</span></span>
* <span data-ttu-id="9268f-197">Pase únicamente el tráfico que aparezca en el puerto 443 (HTTPS) a los servidores de AD FS y WAP.</span><span class="sxs-lookup"><span data-stu-id="9268f-197">Only pass traffic appearing on port 443 (HTTPS) to the AD FS/WAP servers.</span></span>
* <span data-ttu-id="9268f-198">Asigne al equilibrador de carga una dirección IP estática.</span><span class="sxs-lookup"><span data-stu-id="9268f-198">Give the load balancer a static IP address.</span></span>
* <span data-ttu-id="9268f-199">Crear un sondeo de mantenimiento mediante HTTP en `/adfs/probe`.</span><span class="sxs-lookup"><span data-stu-id="9268f-199">Create a health probe using HTTP against `/adfs/probe`.</span></span> <span data-ttu-id="9268f-200">Para más información, consulte [Hardware Load Balancer Health Checks and Web Application Proxy / AD FS 2012 R2](https://blogs.technet.microsoft.com/applicationproxyblog/2014/10/17/hardware-load-balancer-health-checks-and-web-application-proxy-ad-fs-2012-r2/) (Comprobaciones de mantenimiento de equilibrador de carga de hardware y proxy de aplicación web / AD FS 2012 R2).</span><span class="sxs-lookup"><span data-stu-id="9268f-200">For more information, see [Hardware Load Balancer Health Checks and Web Application Proxy / AD FS 2012 R2](https://blogs.technet.microsoft.com/applicationproxyblog/2014/10/17/hardware-load-balancer-health-checks-and-web-application-proxy-ad-fs-2012-r2/).</span></span>
  
  > [!NOTE]
  > <span data-ttu-id="9268f-201">Los servidores de AD FS usan el protocolo Indicación de nombre de servidor (SNI), por lo que el intento de sondear con un punto de conexión HTTPS desde el equilibrador de carga fracasa.</span><span class="sxs-lookup"><span data-stu-id="9268f-201">AD FS servers use the Server Name Indication (SNI) protocol, so attempting to probe using an HTTPS endpoint from the load balancer fails.</span></span>
  > 
  > 
* <span data-ttu-id="9268f-202">Agregue un registro *A* DNS al dominio para el equilibrador de carga de AD FS.</span><span class="sxs-lookup"><span data-stu-id="9268f-202">Add a DNS *A* record to the domain for the AD FS load balancer.</span></span> <span data-ttu-id="9268f-203">Especifique la dirección IP del equilibrador de carga y asígnele un nombre en el dominio (por ejemplo, adfs.contoso.com).</span><span class="sxs-lookup"><span data-stu-id="9268f-203">Specify the IP address of the load balancer, and give it a name in the domain (such as adfs.contoso.com).</span></span> <span data-ttu-id="9268f-204">Se trata del nombre que los clientes y los servidores WAP usan para tener acceso a la granja de servidores de AD FS.</span><span class="sxs-lookup"><span data-stu-id="9268f-204">This is the name clients and the WAP servers use to access the AD FS server farm.</span></span>

### <a name="ad-fs-security"></a><span data-ttu-id="9268f-205">Seguridad de AD FS</span><span class="sxs-lookup"><span data-stu-id="9268f-205">AD FS security</span></span> 

<span data-ttu-id="9268f-206">Evite la exposición directa de los servidores de AD FS a Internet.</span><span class="sxs-lookup"><span data-stu-id="9268f-206">Prevent direct exposure of the AD FS servers to the Internet.</span></span> <span data-ttu-id="9268f-207">Los servidores de AD FS son equipos unidos a un dominio que tienen autorización completa para conceder tokens de seguridad.</span><span class="sxs-lookup"><span data-stu-id="9268f-207">AD FS servers are domain-joined computers that have full authorization to grant security tokens.</span></span> <span data-ttu-id="9268f-208">Si un servidor se ve comprometido, un usuario malintencionado puede emitir tokens de acceso completo a todas las aplicaciones web y a todos los servidores de federación que estén protegidos por AD FS.</span><span class="sxs-lookup"><span data-stu-id="9268f-208">If a server is compromised, a malicious user can issue full access tokens to all web applications and to all federation servers that are protected by AD FS.</span></span> <span data-ttu-id="9268f-209">Si el sistema debe controlar las solicitudes de los usuarios externos que no se conectan desde sitios de confianza asociados, use los servidores WAP para controlar estas solicitudes.</span><span class="sxs-lookup"><span data-stu-id="9268f-209">If your system must handle requests from external users not connecting from trusted partner sites, use WAP servers to handle these requests.</span></span> <span data-ttu-id="9268f-210">Para más información, consulte [Ubicación de un servidor proxy de federación][where-to-place-an-fs-proxy].</span><span class="sxs-lookup"><span data-stu-id="9268f-210">For more information, see [Where to Place a Federation Server Proxy][where-to-place-an-fs-proxy].</span></span>

<span data-ttu-id="9268f-211">Coloque los servidores de AD FS y los servidores WAP en subredes independientes con sus propios firewalls.</span><span class="sxs-lookup"><span data-stu-id="9268f-211">Place AD FS servers and WAP servers in separate subnets with their own firewalls.</span></span> <span data-ttu-id="9268f-212">Puede usar las reglas NSG para definir las reglas de firewall.</span><span class="sxs-lookup"><span data-stu-id="9268f-212">You can use NSG rules to define firewall rules.</span></span> <span data-ttu-id="9268f-213">Si necesita una protección más completa, puede implementar un perímetro de seguridad adicional alrededor de los servidores mediante el uso de un par de subredes y aplicaciones virtuales de red (NVA), como se describe en el documento [Implementación de una arquitectura de red híbrida segura con acceso a Internet en Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access].</span><span class="sxs-lookup"><span data-stu-id="9268f-213">If you require more comprehensive protection you can implement an additional security perimeter around servers by using a pair of subnets and network virtual appliances (NVAs), as described in the document [Implementing a secure hybrid network architecture with Internet access in Azure][implementing-a-secure-hybrid-network-architecture-with-internet-access].</span></span> <span data-ttu-id="9268f-214">Todos los firewalls deben permitir el tráfico en el puerto 443 (HTTPS).</span><span class="sxs-lookup"><span data-stu-id="9268f-214">All firewalls should allow traffic on port 443 (HTTPS).</span></span>

<span data-ttu-id="9268f-215">Restrinja el acceso de inicio de sesión directo a los servidores de AD FS y WAP.</span><span class="sxs-lookup"><span data-stu-id="9268f-215">Restrict direct sign in access to the AD FS and WAP servers.</span></span> <span data-ttu-id="9268f-216">Solo el personal de DevOps debe ser capaz de conectarse.</span><span class="sxs-lookup"><span data-stu-id="9268f-216">Only DevOps staff should be able to connect.</span></span>

<span data-ttu-id="9268f-217">No una los servidores WAP al dominio.</span><span class="sxs-lookup"><span data-stu-id="9268f-217">Do not join the WAP servers to the domain.</span></span>

### <a name="ad-fs-installation"></a><span data-ttu-id="9268f-218">Instalación de AD FS</span><span class="sxs-lookup"><span data-stu-id="9268f-218">AD FS installation</span></span> 

<span data-ttu-id="9268f-219">El artículo [Implementación de una granja de servidores de federación] [ Deploying_a_federation_server_farm] proporciona instrucciones detalladas para instalar y configurar AD FS.</span><span class="sxs-lookup"><span data-stu-id="9268f-219">The article [Deploying a Federation Server Farm][Deploying_a_federation_server_farm] provides detailed instructions for installing and configuring AD FS.</span></span> <span data-ttu-id="9268f-220">Antes de configurar el primer servidor de AD FS en la granja de servidores, haga lo siguiente:</span><span class="sxs-lookup"><span data-stu-id="9268f-220">Perform the following tasks before configuring the first AD FS server in the farm:</span></span>

1. <span data-ttu-id="9268f-221">Obtenga un certificado público de confianza para realizar la autenticación de los servidores.</span><span class="sxs-lookup"><span data-stu-id="9268f-221">Obtain a publicly trusted certificate for performing server authentication.</span></span> <span data-ttu-id="9268f-222">El *nombre de sujeto* debe contener el nombre que los clientes usan para tener acceso al servicio de federación.</span><span class="sxs-lookup"><span data-stu-id="9268f-222">The *subject name* must contain the name clients use to access the federation service.</span></span> <span data-ttu-id="9268f-223">Puede tratarse del nombre DNS registrado para el equilibrador de carga, por ejemplo *adfs.contoso.com* (por motivos de seguridad, evite utilizar nombres con caracteres comodín como \**.contoso.com*).</span><span class="sxs-lookup"><span data-stu-id="9268f-223">This can be the DNS name registered for the load balancer, for example, *adfs.contoso.com* (avoid using wildcard names such as \**.contoso.com*, for security reasons).</span></span> <span data-ttu-id="9268f-224">Use el mismo certificado en todas las máquinas virtuales de servidores de AD FS.</span><span class="sxs-lookup"><span data-stu-id="9268f-224">Use the same certificate on all AD FS server VMs.</span></span> <span data-ttu-id="9268f-225">Puede adquirir un certificado de una entidad de certificación de confianza, pero, si su organización usa Servicios de certificados de Active Directory, puede crear los suyos propios.</span><span class="sxs-lookup"><span data-stu-id="9268f-225">You can purchase a certificate from a trusted certification authority, but if your organization uses Active Directory Certificate Services you can create your own.</span></span> 
   
    <span data-ttu-id="9268f-226">El *nombre alternativo del firmante* se utiliza en el servicio de registro de dispositivos (DRS) para habilitar el acceso desde dispositivos externos.</span><span class="sxs-lookup"><span data-stu-id="9268f-226">The *subject alternative name* is used by the device registration service (DRS) to enable access from external devices.</span></span> <span data-ttu-id="9268f-227">Debe tener el formato *enterpriseregistration.contoso.com*.</span><span class="sxs-lookup"><span data-stu-id="9268f-227">This should be of the form *enterpriseregistration.contoso.com*.</span></span>
   
    <span data-ttu-id="9268f-228">Para más información, consulte [Obtain and Configure a Secure Sockets Layer (SSL) Certificate for AD FS][adfs_certificates] [Obtención y configuración de un certificado Capa de sockets seguros (SSL) para AD FS].</span><span class="sxs-lookup"><span data-stu-id="9268f-228">For more information, see [Obtain and Configure a Secure Sockets Layer (SSL) Certificate for AD FS][adfs_certificates].</span></span>

2. <span data-ttu-id="9268f-229">En el controlador de dominio, genere una nueva clave raíz para el Servicio de distribución de claves.</span><span class="sxs-lookup"><span data-stu-id="9268f-229">On the domain controller, generate a new root key for the Key Distribution Service.</span></span> <span data-ttu-id="9268f-230">Establezca el tiempo efectivo en la hora actual menos 10 horas (esta configuración reduce el retardo que se puede producir en la distribución y la sincronización de las claves a través del dominio).</span><span class="sxs-lookup"><span data-stu-id="9268f-230">Set the effective time to the current time minus 10 hours (this configuration reduces the delay that can occur in distributing and synchronizing keys across the domain).</span></span> <span data-ttu-id="9268f-231">Este paso es necesario para permitir la creación de la cuenta del servicio de grupo que se usa para ejecutar el servicio AD FS.</span><span class="sxs-lookup"><span data-stu-id="9268f-231">This step is necessary to support creating the group service account that is used to run the AD FS service.</span></span> <span data-ttu-id="9268f-232">El siguiente comando de PowerShell muestra un ejemplo de cómo hacerlo:</span><span class="sxs-lookup"><span data-stu-id="9268f-232">The following PowerShell command shows an example of how to do this:</span></span>
   
    ```powershell
    Add-KdsRootKey -EffectiveTime (Get-Date).AddHours(-10)
    ```

3. <span data-ttu-id="9268f-233">Agregue cada máquina virtual del servidor de AD FS al dominio.</span><span class="sxs-lookup"><span data-stu-id="9268f-233">Add each AD FS server VM to the domain.</span></span>

> [!NOTE]
> <span data-ttu-id="9268f-234">Para instalar AD FS, el controlador de dominio que ejecuta el rol de Operaciones de maestro único flexible (FSMO) del emulador del controlador de dominio principal (PDC) para el dominio debe estar ejecutándose y ser accesible desde las máquinas virtuales de AD FS.</span><span class="sxs-lookup"><span data-stu-id="9268f-234">To install AD FS, the domain controller running the primary domain controller (PDC) emulator flexible single master operation (FSMO) role for the domain must be running and accessible from the AD FS VMs.</span></span> <span data-ttu-id="9268f-235"><<RBC: ¿hay alguna manera de hacerlo menos repetitivo?>></span><span class="sxs-lookup"><span data-stu-id="9268f-235"><<RBC: Is there a way to make this less repetitive?>></span></span>
> 
> 

### <a name="ad-fs-trust"></a><span data-ttu-id="9268f-236">Confianza de AD FS</span><span class="sxs-lookup"><span data-stu-id="9268f-236">AD FS trust</span></span> 

<span data-ttu-id="9268f-237">Establezca la confianza de federación entre la instalación de AD FS y los servidores de federación de las organizaciones asociadas.</span><span class="sxs-lookup"><span data-stu-id="9268f-237">Establish federation trust between your AD FS installation, and the federation servers of any partner organizations.</span></span> <span data-ttu-id="9268f-238">Configure las notificaciones de filtrado y asignación necesarias.</span><span class="sxs-lookup"><span data-stu-id="9268f-238">Configure any claims filtering and mapping required.</span></span> 

* <span data-ttu-id="9268f-239">El personal de DevOps de cada organización asociada debe agregar una relación de confianza para las aplicaciones web accesibles a través de los servidores de AD FS.</span><span class="sxs-lookup"><span data-stu-id="9268f-239">DevOps staff at each partner organization must add a relying party trust for the web applications accessible through your AD FS servers.</span></span>
* <span data-ttu-id="9268f-240">El personal de DevOps de la organización debe configurar la confianza del proveedor de notificaciones a fin de habilitar los servidores de AD FS para confiar en las notificaciones que las organizaciones asociadas proporcionan.</span><span class="sxs-lookup"><span data-stu-id="9268f-240">DevOps staff in your organization must configure claims-provider trust to enable your AD FS servers to trust the claims that partner organizations provide.</span></span>
* <span data-ttu-id="9268f-241">También debe configurar AD FS para pasar las notificaciones a las aplicaciones web de la organización.</span><span class="sxs-lookup"><span data-stu-id="9268f-241">DevOps staff in your organization must also configure AD FS to pass claims on to your organization's web applications.</span></span>
  
<span data-ttu-id="9268f-242">Para más información, consulte [Establishing Federation Trust][establishing-federation-trust] (Establecimiento de la confianza de la federación).</span><span class="sxs-lookup"><span data-stu-id="9268f-242">For more information, see [Establishing Federation Trust][establishing-federation-trust].</span></span>

<span data-ttu-id="9268f-243">Publique las aplicaciones web de su organización y haga que estén disponibles para los asociados externos con la autenticación previa a través de servidores WAP.</span><span class="sxs-lookup"><span data-stu-id="9268f-243">Publish your organization's web applications and make them available to external partners by using preauthentication through the WAP servers.</span></span> <span data-ttu-id="9268f-244">Para más información, consulte [Publish Applications using AD FS Preauthentication][publish_applications_using_AD_FS_preauthentication] (Publicación de aplicaciones mediante la autenticación previa de Azure AD)</span><span class="sxs-lookup"><span data-stu-id="9268f-244">For more information, see [Publish Applications using AD FS Preauthentication][publish_applications_using_AD_FS_preauthentication]</span></span>

<span data-ttu-id="9268f-245">AD FS admite el aumento y la transformación de tokens.</span><span class="sxs-lookup"><span data-stu-id="9268f-245">AD FS supports token transformation and augmentation.</span></span> <span data-ttu-id="9268f-246">Azure Active Directory no proporciona esta característica.</span><span class="sxs-lookup"><span data-stu-id="9268f-246">Azure Active Directory does not provide this feature.</span></span> <span data-ttu-id="9268f-247">Con AD FS, al configurar las relaciones de confianza, puede:</span><span class="sxs-lookup"><span data-stu-id="9268f-247">With AD FS, when you set up the trust relationships, you can:</span></span>

* <span data-ttu-id="9268f-248">Configurar transformaciones de notificación para las reglas de autorización.</span><span class="sxs-lookup"><span data-stu-id="9268f-248">Configure claim transformations for authorization rules.</span></span> <span data-ttu-id="9268f-249">Por ejemplo, puede asignar la seguridad de grupo desde una representación utilizada por una organización asociada diferente de Microsoft a algo que Active Directory DS pueda autorizar en la organización.</span><span class="sxs-lookup"><span data-stu-id="9268f-249">For example, you can map group security from a representation used by a non-Microsoft partner organization to something that that Active Directory DS can authorize in your organization.</span></span>
* <span data-ttu-id="9268f-250">Transformar las notificaciones de un formato a otro.</span><span class="sxs-lookup"><span data-stu-id="9268f-250">Transform claims from one format to another.</span></span> <span data-ttu-id="9268f-251">Por ejemplo, puede pasar de SAML 2.0 a SAML 1.1, si la aplicación solo admite las notificaciones de SAML 1.1.</span><span class="sxs-lookup"><span data-stu-id="9268f-251">For example, you can map from SAML 2.0 to SAML 1.1 if your application only supports SAML 1.1 claims.</span></span>

### <a name="ad-fs-monitoring"></a><span data-ttu-id="9268f-252">Supervisión de AD FS</span><span class="sxs-lookup"><span data-stu-id="9268f-252">AD FS monitoring</span></span> 

<span data-ttu-id="9268f-253">El [Módulo de administración de Microsoft System Center para Active Directory Federation Services 2012 R2][oms-adfs-pack] proporciona la supervisión tanto reactiva como proactiva de la implementación de AD FS para el servidor de federación.</span><span class="sxs-lookup"><span data-stu-id="9268f-253">The [Microsoft System Center Management Pack for Active Directory Federation Services 2012 R2][oms-adfs-pack] provides both proactive and reactive monitoring of your AD FS deployment for the federation server.</span></span> <span data-ttu-id="9268f-254">Este módulo de administración supervisa:</span><span class="sxs-lookup"><span data-stu-id="9268f-254">This management pack monitors:</span></span>

* <span data-ttu-id="9268f-255">Los eventos que el servicio AD FS incluye en sus registros de eventos.</span><span class="sxs-lookup"><span data-stu-id="9268f-255">Events that the AD FS service records in its event logs.</span></span>
* <span data-ttu-id="9268f-256">Los datos de rendimiento que los contadores de rendimiento de AD FS recopilan.</span><span class="sxs-lookup"><span data-stu-id="9268f-256">The performance data that the AD FS performance counters collect.</span></span> 
* <span data-ttu-id="9268f-257">El estado general del sistema AD FS y las aplicaciones web (usuarios de confianza), además de proporcionar alertas para los problemas críticos y las advertencias.</span><span class="sxs-lookup"><span data-stu-id="9268f-257">The overall health of the AD FS system and web applications (relying parties), and provides alerts for critical issues and warnings.</span></span> 

## <a name="scalability-considerations"></a><span data-ttu-id="9268f-258">Consideraciones sobre escalabilidad</span><span class="sxs-lookup"><span data-stu-id="9268f-258">Scalability considerations</span></span>

<span data-ttu-id="9268f-259">Las consideraciones siguientes, que se resumen a partir del artículo [Planear la implementación de AD FS][plan-your-adfs-deployment], proporcionan un punto de partida para ajustar el tamaño de las granjas de servidores de AD FS:</span><span class="sxs-lookup"><span data-stu-id="9268f-259">The following considerations, summarized from the article [Plan your AD FS deployment][plan-your-adfs-deployment], give a starting point for sizing AD FS farms:</span></span>

* <span data-ttu-id="9268f-260">Si tiene menos de 1 000 usuarios, no cree servidores dedicados, sino que, en su lugar, instale AD FS en cada uno de los servidores de Active Directory DS de la nube.</span><span class="sxs-lookup"><span data-stu-id="9268f-260">If you have fewer than 1000 users, do not create dedicated servers, but instead install AD FS on each of the Active Directory DS servers in the cloud.</span></span> <span data-ttu-id="9268f-261">Asegúrese de que tiene al menos dos servidores de Active Directory DS para mantener la disponibilidad.</span><span class="sxs-lookup"><span data-stu-id="9268f-261">Make sure that you have at least two Active Directory DS servers to maintain availability.</span></span> <span data-ttu-id="9268f-262">Cree un único servidor WAP.</span><span class="sxs-lookup"><span data-stu-id="9268f-262">Create a single WAP server.</span></span>
* <span data-ttu-id="9268f-263">Si tiene entre 1 000 y 15 000 usuarios, cree dos servidores de AD FS dedicados y dos servidores WAP dedicados.</span><span class="sxs-lookup"><span data-stu-id="9268f-263">If you have between 1000 and 15000 users, create two dedicated AD FS servers and two dedicated WAP servers.</span></span>
* <span data-ttu-id="9268f-264">Si tiene entre 15 000 y 60 000 usuarios, cree entre tres y cinco servidores AD FS dedicados y al menos dos servidores WAP dedicados.</span><span class="sxs-lookup"><span data-stu-id="9268f-264">If you have between 15000 and 60000 users, create between three and five dedicated AD FS servers and at least two dedicated WAP servers.</span></span>

<span data-ttu-id="9268f-265">En estas consideraciones se supone que se utilizan los tamaños de máquinas virtuales duales de cuatro núcleos (D4_v2 estándar o posterior) en Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-265">These considerations assume that you are using dual quad-core VM (Standard D4_v2, or better) sizes in Azure.</span></span>

<span data-ttu-id="9268f-266">Si usa Windows Internal Database para almacenar los datos de configuración de AD FS, estará limitado a ocho servidores de AD FS en la granja de servidores.</span><span class="sxs-lookup"><span data-stu-id="9268f-266">If you are using the Windows Internal Database to store AD FS configuration data, you are limited to eight AD FS servers in the farm.</span></span> <span data-ttu-id="9268f-267">Si prevé que necesitará más en el futuro, utilice SQL Server.</span><span class="sxs-lookup"><span data-stu-id="9268f-267">If you anticipate that you will need more in the future, use SQL Server.</span></span> <span data-ttu-id="9268f-268">Para más información, consulte [La función de la base de datos de configuración de AD FS][adfs-configuration-database].</span><span class="sxs-lookup"><span data-stu-id="9268f-268">For more information, see [The Role of the AD FS Configuration Database][adfs-configuration-database].</span></span>

## <a name="availability-considerations"></a><span data-ttu-id="9268f-269">Consideraciones sobre disponibilidad</span><span class="sxs-lookup"><span data-stu-id="9268f-269">Availability considerations</span></span>

<span data-ttu-id="9268f-270">Puede usar SQL Server o Windows Internal Database para contener la información de configuración de AD FS.</span><span class="sxs-lookup"><span data-stu-id="9268f-270">You can use either SQL Server or the Windows Internal Database to hold AD FS configuration information.</span></span> <span data-ttu-id="9268f-271">Windows Internal Database proporciona redundancia básica.</span><span class="sxs-lookup"><span data-stu-id="9268f-271">The Windows Internal Database provides basic redundancy.</span></span> <span data-ttu-id="9268f-272">Los cambios se escriben directamente en una de las bases de datos de AD FS en el clúster de AD FS, mientras que los demás servidores usan replicación de extracción para mantener sus bases de datos actualizadas.</span><span class="sxs-lookup"><span data-stu-id="9268f-272">Changes are written directly to only one of the AD FS databases in the AD FS cluster, while the other servers use pull replication to keep their databases up to date.</span></span> <span data-ttu-id="9268f-273">Con SQL Server, puede proporcionar una redundancia completa de las bases de datos y una elevada disponibilidad mediante clústeres de conmutación por error o la creación de reflejo.</span><span class="sxs-lookup"><span data-stu-id="9268f-273">Using SQL Server can provide full database redundancy and high availability using failover clustering or mirroring.</span></span>

## <a name="manageability-considerations"></a><span data-ttu-id="9268f-274">Consideraciones sobre la manejabilidad</span><span class="sxs-lookup"><span data-stu-id="9268f-274">Manageability considerations</span></span>

<span data-ttu-id="9268f-275">El personal de DevOps debe estar preparado para realizar las siguientes tareas:</span><span class="sxs-lookup"><span data-stu-id="9268f-275">DevOps staff should be prepared to perform the following tasks:</span></span>

* <span data-ttu-id="9268f-276">Administración de los servidores de federación, incluida la administración de la granja de servidores de AD FS, de la directiva de confianza en los servidores de federación y de los certificados usados por los servicios de federación.</span><span class="sxs-lookup"><span data-stu-id="9268f-276">Managing the federation servers, including managing the AD FS farm, managing trust policy on the federation servers, and managing the certificates used by the federation services.</span></span>
* <span data-ttu-id="9268f-277">Administración de los servidores WAP, incluida la administración de la granja de servidores WAP y certificados.</span><span class="sxs-lookup"><span data-stu-id="9268f-277">Managing the WAP servers including managing the WAP farm and certificates.</span></span>
* <span data-ttu-id="9268f-278">Administración de las aplicaciones web, incluida la configuración de los usuarios de confianza, los métodos de autenticación y las asignaciones de notificaciones.</span><span class="sxs-lookup"><span data-stu-id="9268f-278">Managing web applications including configuring relying parties, authentication methods, and claims mappings.</span></span>
* <span data-ttu-id="9268f-279">Copia de seguridad de los componentes de AD FS.</span><span class="sxs-lookup"><span data-stu-id="9268f-279">Backing up AD FS components.</span></span>

## <a name="security-considerations"></a><span data-ttu-id="9268f-280">Consideraciones sobre la seguridad</span><span class="sxs-lookup"><span data-stu-id="9268f-280">Security considerations</span></span>

<span data-ttu-id="9268f-281">AD FS usa el protocolo HTTPS, así que asegúrese de que las reglas NSG para la subred que contienen las máquinas virtuales del nivel web permiten las solicitudes HTTPS.</span><span class="sxs-lookup"><span data-stu-id="9268f-281">AD FS utilizes the HTTPS protocol, so make sure that the NSG rules for the subnet containing the web tier VMs permit HTTPS requests.</span></span> <span data-ttu-id="9268f-282">Estas solicitudes pueden originarse en la red local, las subredes que contienen el nivel web, el nivel empresarial, el nivel de datos, la red perimetral privada, la red perimetral pública y la subred que contiene los servidores de AD FS.</span><span class="sxs-lookup"><span data-stu-id="9268f-282">These requests can originate from the on-premises network, the subnets containing the web tier, business tier, data tier, private DMZ, public DMZ, and the subnet containing the AD FS servers.</span></span>

<span data-ttu-id="9268f-283">Considere usar un conjunto de aplicaciones de red virtual que registre información detallada sobre el tráfico que atraviesa la frontera de la red virtual con fines de auditoría.</span><span class="sxs-lookup"><span data-stu-id="9268f-283">Consider using a set of network virtual appliances that logs detailed information on traffic traversing the edge of your virtual network for auditing purposes.</span></span>

## <a name="deploy-the-solution"></a><span data-ttu-id="9268f-284">Implementación de la solución</span><span class="sxs-lookup"><span data-stu-id="9268f-284">Deploy the solution</span></span>

<span data-ttu-id="9268f-285">Hay una solución disponible en [GitHub][github] para implementar esta arquitectura de referencia.</span><span class="sxs-lookup"><span data-stu-id="9268f-285">A solution is available on [GitHub][github] to deploy this reference architecture.</span></span> <span data-ttu-id="9268f-286">Necesitará la versión más reciente de la [CLI de Azure][azure-cli] para ejecutar el script de Powershell que implementa la solución.</span><span class="sxs-lookup"><span data-stu-id="9268f-286">You will need the latest version of the [Azure CLI][azure-cli] to run the Powershell script that deploys the solution.</span></span> <span data-ttu-id="9268f-287">Para implementar la arquitectura de referencia, siga estos pasos:</span><span class="sxs-lookup"><span data-stu-id="9268f-287">To deploy the reference architecture, follow these steps:</span></span>

1. <span data-ttu-id="9268f-288">Descargue o clone la carpeta de soluciones de [GitHub][github] en la máquina local.</span><span class="sxs-lookup"><span data-stu-id="9268f-288">Download or clone the solution folder from [GitHub][github] to your local machine.</span></span>

2. <span data-ttu-id="9268f-289">Abra la CLI de Azure y navegue hasta la carpeta local de la solución.</span><span class="sxs-lookup"><span data-stu-id="9268f-289">Open the Azure CLI and navigate to the local solution folder.</span></span>

3. <span data-ttu-id="9268f-290">Ejecute el siguiente comando:</span><span class="sxs-lookup"><span data-stu-id="9268f-290">Run the following command:</span></span>
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> <mode>
    ```
   
    <span data-ttu-id="9268f-291">Reemplace `<subscription id>` con la identificación de su suscripción de Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-291">Replace `<subscription id>` with your Azure subscription ID.</span></span>
   
    <span data-ttu-id="9268f-292">Para `<location>`, especifique una región de Azure, como `eastus` o `westus`.</span><span class="sxs-lookup"><span data-stu-id="9268f-292">For `<location>`, specify an Azure region, such as `eastus` or `westus`.</span></span>
   
    <span data-ttu-id="9268f-293">El parámetro `<mode>` controla la granularidad de la implementación y puede ser uno de los siguientes valores:</span><span class="sxs-lookup"><span data-stu-id="9268f-293">The `<mode>` parameter controls the granularity of the deployment, and can be one of the following values:</span></span>
   
   * <span data-ttu-id="9268f-294">`Onpremise`: implementa un entorno local simulado.</span><span class="sxs-lookup"><span data-stu-id="9268f-294">`Onpremise`: Deploys a simulated on-premises environment.</span></span> <span data-ttu-id="9268f-295">También puede usar esta implementación para pruebas y experimentar si no tiene una red local existente o si desea probar esta arquitectura de referencia sin cambiar la configuración de la red local existente.</span><span class="sxs-lookup"><span data-stu-id="9268f-295">You can use this deployment to test and experiment if you do not have an existing on-premises network, or if you want to test this reference architecture without changing the configuration of your existing on-premises network.</span></span>
   * <span data-ttu-id="9268f-296">`Infrastructure`: implementa la infraestructura de VNet y el JumBox.</span><span class="sxs-lookup"><span data-stu-id="9268f-296">`Infrastructure`: deploys the VNet infrastructure and jump box.</span></span>
   * <span data-ttu-id="9268f-297">`CreateVpn`: implementa la puerta de enlace de red virtual de Azure y la conecta a la red local simulada.</span><span class="sxs-lookup"><span data-stu-id="9268f-297">`CreateVpn`: deploys an Azure virtual network gateway and connects it to the simulated on-premises network.</span></span>
   * <span data-ttu-id="9268f-298">`AzureADDS`: implementa las máquinas virtuales que actúan como servidores de Active Directory DS, implementa Active Directory en estas máquinas virtuales y crea el dominio en Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-298">`AzureADDS`: deploys the VMs acting as Active Directory DS servers, deploys Active Directory to these VMs, and creates the domain in Azure.</span></span>
   * <span data-ttu-id="9268f-299">`AdfsVm`: implementa la máquina virtual de AD FS y se une al dominio en Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-299">`AdfsVm`: deploys the AD FS VMs and joins them to the domain in Azure.</span></span>
   * <span data-ttu-id="9268f-300">`PublicDMZ`: implementa la red perimetral pública en Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-300">`PublicDMZ`: deploys the public DMZ in Azure.</span></span>
   * <span data-ttu-id="9268f-301">`ProxyVm`: implementa las máquinas virtuales de proxy de AD FS y la une al dominio en Azure.</span><span class="sxs-lookup"><span data-stu-id="9268f-301">`ProxyVm`: deploys the AD FS proxy VMs and joins them to the domain in Azure.</span></span>
   * <span data-ttu-id="9268f-302">`Prepare`: implementa todas las implementaciones anteriores.</span><span class="sxs-lookup"><span data-stu-id="9268f-302">`Prepare`: deploys all of the preceding deployments.</span></span> <span data-ttu-id="9268f-303">**Esta es la opción recomendada si va a crear una implementación totalmente nueva y no tiene una infraestructura local existente.**</span><span class="sxs-lookup"><span data-stu-id="9268f-303">**This is the recommended option if you are building an entirely new deployment and you don't have an existing on-premises infrastructure.**</span></span> 
   * <span data-ttu-id="9268f-304">`Workload`: opcionalmente, implementa las máquinas virtuales del nivel web, el nivel empresarial y el nivel de datos, así como la red auxiliar.</span><span class="sxs-lookup"><span data-stu-id="9268f-304">`Workload`: optionally deploys web, business, and data tier VMs and supporting network.</span></span> <span data-ttu-id="9268f-305">No se incluyen en el modo de implementación `Prepare`.</span><span class="sxs-lookup"><span data-stu-id="9268f-305">Not included in the `Prepare` deployment mode.</span></span>
   * <span data-ttu-id="9268f-306">`PrivateDMZ`: opcionalmente, implementa la red perimetral privada en Azure delante de las máquinas virtuales `Workload` implementadas por encima.</span><span class="sxs-lookup"><span data-stu-id="9268f-306">`PrivateDMZ`: optionally deploys the private DMZ in Azure in front of the `Workload` VMs deployed above.</span></span> <span data-ttu-id="9268f-307">No se incluye en el modo de implementación `Prepare`.</span><span class="sxs-lookup"><span data-stu-id="9268f-307">Not included in the `Prepare` deployment mode.</span></span>

4. <span data-ttu-id="9268f-308">Espere a que la implementación se complete.</span><span class="sxs-lookup"><span data-stu-id="9268f-308">Wait for the deployment to complete.</span></span> <span data-ttu-id="9268f-309">Si usó la opción `Prepare`, la implementación tarda varias horas en completarse y finaliza con el mensaje`Preparation is completed. Please install certificate to all AD FS and proxy VMs.`</span><span class="sxs-lookup"><span data-stu-id="9268f-309">If you used the `Prepare` option, the deployment takes several hours to complete, and finishes with the message `Preparation is completed. Please install certificate to all AD FS and proxy VMs.`</span></span>

5. <span data-ttu-id="9268f-310">Reinicie el JumBox (*ra-adfs-mgmt-vm1* en el grupo *ra-adfs-security-rg*) para permitir que su configuración DNS surta efecto.</span><span class="sxs-lookup"><span data-stu-id="9268f-310">Restart the jump box (*ra-adfs-mgmt-vm1* in the *ra-adfs-security-rg* group) to allow its DNS settings to take effect.</span></span>

6. <span data-ttu-id="9268f-311">[Obtenga un certificado SSL para AD FS][adfs_certificates] e instálelo en las máquinas virtuales de AD FS.</span><span class="sxs-lookup"><span data-stu-id="9268f-311">[Obtain an SSL Certificate for AD FS][adfs_certificates] and install this certificate on the AD FS VMs.</span></span> <span data-ttu-id="9268f-312">Tenga en cuenta que puede conectarse a ellas a través del JumBox.</span><span class="sxs-lookup"><span data-stu-id="9268f-312">Note that you can connect to them through the jump box.</span></span> <span data-ttu-id="9268f-313">Las direcciones IP son <em>10.0.5.4</em> y <em>10.0.5.5</em>.</span><span class="sxs-lookup"><span data-stu-id="9268f-313">The IP addresses are <em>10.0.5.4</em> and <em>10.0.5.5</em>.</span></span> <span data-ttu-id="9268f-314">El nombre de usuario predeterminado es <em>contoso\testuser</em> y la contraseña <em>AweSome@PW</em>.</span><span class="sxs-lookup"><span data-stu-id="9268f-314">The default username is <em>contoso\testuser</em> with password <em>AweSome@PW</em>.</span></span>
   
   > [!NOTE]
   > <span data-ttu-id="9268f-315">Los comentarios en el script de Deploy-ReferenceArchitecture.ps1 proporcionan instrucciones detalladas para crear un certificado de prueba autofirmado y una entidad utilizando el comando `makecert`.</span><span class="sxs-lookup"><span data-stu-id="9268f-315">The comments in the Deploy-ReferenceArchitecture.ps1 script at this point provides detailed instructions for creating a self-signed test certificate and authority using the `makecert` command.</span></span> <span data-ttu-id="9268f-316">Sin embargo, siga estos pasos solo como una **prueba** y no use los certificados generados por makecert en un entorno de producción.</span><span class="sxs-lookup"><span data-stu-id="9268f-316">However, perform these steps as a **test** only and do not use the certificates generated by makecert in a production environment.</span></span>
   > 
   > 

7. <span data-ttu-id="9268f-317">Ejecute el comando de PowerShell siguiente para implementar la granja de servidores AD FS:</span><span class="sxs-lookup"><span data-stu-id="9268f-317">Run the following PowerShell command to deploy the AD FS server farm:</span></span>
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Adfs
    ``` 

8. <span data-ttu-id="9268f-318">En el JumpBox, vaya a `https://adfs.contoso.com/adfs/ls/idpinitiatedsignon.htm` para probar la instalación de AD FS (puede recibir una advertencia sobre el certificado, que puede ignorar en esta prueba).</span><span class="sxs-lookup"><span data-stu-id="9268f-318">On the jump box, browse to `https://adfs.contoso.com/adfs/ls/idpinitiatedsignon.htm` to test the AD FS installation (you may receive a certificate warning that you can ignore for this test).</span></span> <span data-ttu-id="9268f-319">Compruebe que aparece la página de inicio de sesión de Contoso Corporation.</span><span class="sxs-lookup"><span data-stu-id="9268f-319">Verify that the Contoso Corporation sign-in page appears.</span></span> <span data-ttu-id="9268f-320">Inicie sesión como <em>contoso\testuser</em> con la contraseña <em>AweS0me@PW</em>.</span><span class="sxs-lookup"><span data-stu-id="9268f-320">Sign in as <em>contoso\testuser</em> with password <em>AweS0me@PW</em>.</span></span>

9. <span data-ttu-id="9268f-321">Instale el certificado SSL en las máquinas virtuales de proxy de AD FS.</span><span class="sxs-lookup"><span data-stu-id="9268f-321">Install the SSL certificate on the AD FS proxy VMs.</span></span> <span data-ttu-id="9268f-322">Las direcciones IP son *10.0.6.4* y *10.0.6.5*.</span><span class="sxs-lookup"><span data-stu-id="9268f-322">The IP addresses are *10.0.6.4* and *10.0.6.5*.</span></span>

10. <span data-ttu-id="9268f-323">Ejecute el comando de PowerShell siguiente para implementar el primer servidor proxy AD FS:</span><span class="sxs-lookup"><span data-stu-id="9268f-323">Run the following PowerShell command to deploy the first AD FS proxy server:</span></span>
   
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Proxy1
    ```

11. <span data-ttu-id="9268f-324">Siga las instrucciones que muestra el script para probar la instalación del primer servidor proxy.</span><span class="sxs-lookup"><span data-stu-id="9268f-324">Follow the instructions displayed by the script to test the installation of the first proxy server.</span></span>

12. <span data-ttu-id="9268f-325">Ejecute el comando de PowerShell siguiente para implementar el segundo servidor proxy:</span><span class="sxs-lookup"><span data-stu-id="9268f-325">Run the following PowerShell command to deploy the second proxy server:</span></span>
    
    ```powershell
    .\Deploy-ReferenceArchitecture.ps1 <subscription id> <location> Proxy2
    ```

13. <span data-ttu-id="9268f-326">Siga las instrucciones que muestra el script para probar la configuración del proxy completo.</span><span class="sxs-lookup"><span data-stu-id="9268f-326">Follow the instructions displayed by the script to test the complete proxy configuration.</span></span>

## <a name="next-steps"></a><span data-ttu-id="9268f-327">Pasos siguientes</span><span class="sxs-lookup"><span data-stu-id="9268f-327">Next steps</span></span>

* <span data-ttu-id="9268f-328">Información acerca de [Azure Active Directory][aad].</span><span class="sxs-lookup"><span data-stu-id="9268f-328">Learn about [Azure Active Directory][aad].</span></span>
* <span data-ttu-id="9268f-329">Información acerca de [Azure Active Directory B2C][aadb2c].</span><span class="sxs-lookup"><span data-stu-id="9268f-329">Learn about [Azure Active Directory B2C][aadb2c].</span></span>

<!-- links -->
[extending-ad-to-azure]: adds-extend-domain.md

[vm-recommendations]: ../virtual-machines-windows/single-vm.md
[implementing-a-secure-hybrid-network-architecture]: ../dmz/secure-vnet-hybrid.md
[implementing-a-secure-hybrid-network-architecture-with-internet-access]: ../dmz/secure-vnet-dmz.md
[hybrid-azure-on-prem-vpn]: ../hybrid-networking/vpn.md

[azure-cli]: /azure/azure-resource-manager/xplat-cli-azure-resource-manager
[DRS]: https://technet.microsoft.com/library/dn280945.aspx
[where-to-place-an-fs-proxy]: https://technet.microsoft.com/library/dd807048.aspx
[ADDRS]: https://technet.microsoft.com/library/dn486831.aspx
[plan-your-adfs-deployment]: https://msdn.microsoft.com/library/azure/dn151324.aspx
[ad_network_recommendations]: #network_configuration_recommendations_for_AD_DS_VMs
[adfs_certificates]: https://technet.microsoft.com/library/dn781428(v=ws.11).aspx
[create_service_account_for_adfs_farm]: https://technet.microsoft.com/library/dd807078.aspx
[adfs-configuration-database]: https://technet.microsoft.com/library/ee913581(v=ws.11).aspx
[active-directory-federation-services]: https://technet.microsoft.com/windowsserver/dd448613.aspx
[security-considerations]: #security-considerations
[recommendations]: #recommendations
[active-directory-federation-services-overview]: https://technet.microsoft.com/library/hh831502(v=ws.11).aspx
[establishing-federation-trust]: https://blogs.msdn.microsoft.com/alextch/2011/06/27/establishing-federation-trust/
[Deploying_a_federation_server_farm]:  /windows-server/identity/ad-fs/deployment/deploying-a-federation-server-farm
[install_and_configure_the_web_application_proxy_server]: https://technet.microsoft.com/library/dn383662.aspx
[publish_applications_using_AD_FS_preauthentication]: https://technet.microsoft.com/library/dn383640.aspx
[managing-adfs-components]: https://technet.microsoft.com/library/cc759026.aspx
[oms-adfs-pack]: https://www.microsoft.com/download/details.aspx?id=41184
[azure-powershell-download]: https://azure.microsoft.com/documentation/articles/powershell-install-configure/
[aad]: https://azure.microsoft.com/documentation/services/active-directory/
[aadb2c]: https://azure.microsoft.com/documentation/services/active-directory-b2c/
[adfs-intro]: /azure/active-directory/hybrid/whatis-hybrid-identity
[github]: https://github.com/mspnp/identity-reference-architectures/tree/master/adfs
[adfs_certificates]: https://technet.microsoft.com/library/dn781428(v=ws.11).aspx
[considerations]: ./considerations.md
[visio-download]: https://archcenter.blob.core.windows.net/cdn/identity-architectures.vsdx
[0]: ./images/adfs.png "Protección de la arquitectura de red híbrida con Active Directory"
